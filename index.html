<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Chat OS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        :root {
            --primary: #07c160;
            --bg-grey: #f2f2f2;
            --border: #e5e5e5;
            --bubble-right: #95ec69;
            --bubble-left: #fff;
            --red: #fa5151;
            --pink: #ff758c;
            --pink-bg: #ffeef1;
            --link: #576b95;
            --text-main: #111;
            --text-sub: #777;
            --text-status-bar: #000;
            --text-desktop: #fff;
            --font-size-main: 16px;
            --font-size-sub: 14px;
            --radius-box: 12px;
            --radius-btn: 6px;
            --bubble-size: 240px;
            --bubble-padding: 10px 14px;
            --bubble-spacing: 1.5;
            --avatar-size: 48px;
            --avatar-radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        /* iOS Viewport Fixes */
        body { 
            background: #000; width: 100%; 
            height: 100vh; /* Fallback */
            height: 100dvh; /* iOS Safari Dynamic Viewport */
            position: fixed; overflow: hidden; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Arial, sans-serif; -webkit-text-size-adjust: 100%; overscroll-behavior: none; 
        }
        html { 
            width: 100%; 
            height: 100vh; 
            height: 100dvh;
            overflow: hidden; position: fixed; 
        }
        
        #device { 
            width: 100%; 
            height: 100%; 
            background: #fff; position: relative; overflow: hidden; border: none; border-radius: 0; box-shadow: none; 
        }
        .hidden { display: none !important; }
        
        /* Toast */
        #toast {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.75);
            color: #fff;
            padding: 12px 22px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            text-align: center;
            opacity: 0;
            transition: top 0.4s ease-out, opacity 0.4s ease-out;
            display: block;
            pointer-events: none;
            max-width: 80%;
        }
        #toast.show {
            top: 70px;
            opacity: 1;
        }
        #toast.success { background: var(--primary); }
        #toast.error { background: var(--red); }
        
        /* Status Bar */
        .status-bar { height: 44px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-weight: 600; font-size: 15px; position: absolute; top: 0; width: 100%; z-index: 9000; pointer-events: none; color: var(--text-status-bar); }
        .status-right { display: flex; gap: 6px; align-items: center; }
        .battery-icon { width: 22px; height: 11px; border: 1px solid #000; border-radius: 3px; position: relative; }
        .battery-level { width: 80%; height: 100%; background: #000; }
        /* Nav & Containers */
        .page { width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: #fff; display: none; flex-direction: column; padding-top: 0; }
        .page.active { display: flex !important; }
        
        /* Layers (Apps) */
        .layer { position: absolute; top: 0; left: 100%; width: 100%; height: 100%; background: #efeff4; transition: left 0.3s; z-index: 5000; display: flex; flex-direction: column; }
        .layer.show { left: 0; }
        
        /* Nav Bar */
        .nav-bar { height: 44px; background: #ededed; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #d1d1d1; font-size: 17px; position: relative; z-index: 100; flex-shrink: 0; margin-top: 44px; }
        .nav-title { font-weight: 600; font-size: 17px; color: var(--text-main); position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; }
        .nav-icon { font-size: 20px; padding: 10px; cursor: pointer; color: var(--text-main); z-index: 2; min-width: 40px; text-align: center; }
        
        .scroll-y { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; -webkit-overflow-scrolling: touch; }
        
        /* Desktop */
        #desktop { background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&w=800&q=80') center/cover; padding-top: 60px; }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px 15px; padding: 25px; }
        .app-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .app-icon { width: 60px; height: 60px; border-radius: 14px; display: flex; justify-content: center; align-items: center; font-size: 30px; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.1s; background-size: 100% 100%; background-position: center center; position: relative; overflow: hidden; background-repeat: no-repeat; }
        .app-icon:active { transform: scale(0.95); }
        .app-name { font-size: 12px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-weight: 500; color: var(--text-desktop); }

        /* New Desktop Styles */
        .desktop-time-date-area {
            text-align: center;
            color: var(--text-desktop);
            padding: 20px 0;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .desktop-time {
            font-size: 72px;
            font-weight: 200;
        }
        .desktop-date {
            font-size: 18px;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 5px;
        }
        .user-info-card {
            width: calc(100% - 40px);
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px;
            display: flex;
            align-items: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .user-details-clickable {
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .user-details-clickable:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .user-avatar-container {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #fff;
            margin-left: -5px; /* 让头像突出一点 */
            position: relative;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            overflow: hidden; /* For avatar image */
            flex-shrink: 0;
        }
        .user-avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-details {
            margin-left: 15px;
            color: var(--text-desktop);
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            gap: 4px;
        }
        .user-name, .user-signature, .user-location {
            padding-left: 0;
            position: relative;
        }
        .user-name {
            font-size: 20px;
            font-weight: 600;
        }
        .user-signature {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-location {
            font-size: 13px;
            opacity: 0.7;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .custom-widget {
            grid-column: span 2;
            grid-row: span 2;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            min-height: 150px; /* Ensure it has a minimum height */
        }
        .bottom-nav {
            position: absolute;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 380px;
            height: 90px;
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 35px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: 5px;
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #333;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }
        .dock-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            background-size: cover;
            background-position: center;
            background-color: rgba(255,255,255,0.8);
            color: #333;
        }
        .dock-icon:active { transform: scale(0.95); }

        /* Chat UI */
        .msg-row { display: flex; gap: 10px; padding: 10px 15px; position: relative; flex-shrink: 0; }
        .msg-row.me { flex-direction: row-reverse; }
        .bubble { background: var(--bubble-left); padding: var(--bubble-padding); border-radius: 8px; font-size: var(--font-size-main); line-height: var(--bubble-spacing); word-wrap: break-word; border: 1px solid #e5e5e5; max-width: var(--bubble-size); position: relative; min-height: 40px; color: var(--text-main); }
        .bubble.loading { display: flex; align-items: center; justify-content: center; gap: 4px; min-width: 60px; }
        .dot { width: 8px; height: 8px; background: #bbb; border-radius: 50%; animation: dot-blink 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes dot-blink { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .msg-row.me .bubble { background: var(--bubble-right); border-color: #8ad863; }
        .bubble img { max-width: 140px; max-height: 200px; border-radius: 4px; display: block; }
        .bubble.voice { display: flex; align-items: center; gap: 5px; cursor: pointer; min-width: 80px; }
        .bubble-transfer { width: 235px; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative; display: flex; flex-direction: column; box-shadow: 0 1px 2px rgba(0,0,0,0.05); background: #f79c45; }
        .bubble-transfer.done { background: #f9e1c4; opacity: 0.9; }
        .transfer-top { padding: 16px 12px; display: flex; align-items: center; gap: 12px; color: #fff; min-height: 72px; }
        .transfer-icon { width: 42px; height: 42px; border-radius: 50%; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
        .transfer-info { display: flex; flex-direction: column; justify-content: center; flex: 1; }
        .transfer-amt { font-size: 17px; font-weight: 500; margin-bottom: 2px; }
        .transfer-desc { font-size: 13px; opacity: 0.9; }
        .transfer-bottom { background: #fff; padding: 8px 12px; font-size: 11px; color: #999; border-top: 1px solid #f5f5f5; display: flex; align-items: center; gap: 5px; opacity: 0.8; }
        .bubble-transfer.done .transfer-bottom { background: #fff; opacity: 0.6; }
        
        .bubble-transfer-status { background: #fff; padding: 12px; border-radius: 8px; width: 230px; font-size: 14px; color: #999; display: flex; align-items: center; gap: 8px; border: 1px solid #e5e5e5; }
        .bubble-location { background: #fff; border-radius: 8px; width: 240px; overflow: hidden; border: 1px solid #e5e5e5; padding: 0; display: flex; flex-direction: column; }
        .loc-map { height: 120px; background: url('https://api.mapbox.com/styles/v1/mapbox/streets-v11/static/121.47,31.23,12,0/400x200?access_token=pk.eyJ1IjoiZXhhbXBsZSIsImEiOiJja2xsbmN5ZGMwMzBzMm1tZ3Z5cmZ5b3poIn0.example') center/cover; background-color: #eee; position: relative; }
        .loc-map::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 20px; height: 20px; background: red; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .loc-info { padding: 10px 12px; }
        .loc-name { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .loc-addr { font-size: 12px; color: #999; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bubble.selected { position: relative; }
        .bubble.selected::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: inherit;
            z-index: 10;
            pointer-events: none;
        }
        .bubble.selected::before {
            content: '\f00c';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 24px;
            z-index: 11;
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .bubble.recalled {
            background: #e0e0e0;
            color: #888;
            font-style: italic;
            font-size: 13px;
            text-align: center;
        }

        /* Quote Bubble Style */
        .bubble-quote {
            margin-bottom: 5px;
            padding: 6px 8px;
            background: rgba(0,0,0,0.05);
            border-left: 3px solid rgba(0,0,0,0.2);
            font-size: 12px;
            color: inherit;
            opacity: 0.8;
            border-radius: 4px;
            white-space: pre-wrap;
            display: block;
        }

        /* Memory System UI */
        #layer-memory-system .list-item {
            background: #fff;
            margin: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        #layer-memory-system .memo-content {
            font-size: 15px; color: #333; margin-top: 8px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        #layer-memory-system .memo-date { font-size: 12px; color: #999; }
        #layer-memory-system .memo-actions { display: flex; gap: 15px; font-size: 16px; color: #888; }
        #layer-memory-system .memo-actions i { cursor: pointer; }


        /* Input Bar */
        .input-bar { background: #f7f7f7; border-top: 1px solid #d1d1d1; padding: 8px 5px calc(20px + env(safe-area-inset-bottom)) 5px; display: flex; flex-direction: column; position: relative; z-index: 5001; }
        .quote-preview { background: #ededed; padding: 8px 12px; font-size: 13px; color: #666; border-left: 3px solid #ccc; margin-bottom: 5px; display: none; justify-content: space-between; align-items: center; border-radius: 4px; }
        .input-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; height: 36px; }
        .input-field { flex: 1; height: 36px; border: 1px solid #ddd; border-radius: 4px; padding: 0 8px; font-size: 15px; background: #fff; min-width: 0; }
        .voice-hold-btn { flex: 1; height: 36px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; background: #fff; font-weight: bold; display: none; align-items: center; justify-content: center; cursor: pointer; }
        .btn-act { padding: 0 8px; height: 32px; border-radius: 4px; border: none; font-size: 13px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 500; white-space: nowrap; }
        .btn-gen { background: linear-gradient(135deg, #7F7FD5, #91EAE4); color: #fff; font-size: 12px; }
        .btn-thought { background: #ff9a9e; font-size: 12px; }
        .btn-send { background: var(--primary); }
        .toolbar { display: flex; justify-content: space-around; padding: 2px 0; color: #555; font-size: 22px; }
        .toolbar i { padding: 10px; cursor: pointer; position: relative; z-index: 5002; }

        /* New Offline Chat Styles */
        .offline-scroll-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            background: #f9f9f9;
            padding-top: 184px; /* Space for fixed header */
        }
        
        /* 线下模式固定顶部栏容器 */
        .offline-fixed-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            background: linear-gradient(135deg, #ffeef1 0%, #fff0f5 100%);
            box-shadow: 0 4px 15px rgba(255, 117, 140, 0.15);
            border-bottom: 1px solid rgba(255, 117, 140, 0.2);
            transition: all 0.3s;
            padding-top: 44px; /* 避开状态栏 */
        }

        /* 顶部导航按钮区域 (融合进粉色背景) */
        .offline-nav-area {
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            color: #ff758c;
            font-size: 17px;
            font-weight: 600;
        }
        .offline-nav-icon {
            padding: 10px;
            cursor: pointer;
        }

        .offline-info-bar {
            /* Removed background/border as it's now part of the fixed header container */
            padding: 5px 20px 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .offline-avatar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 60px;
        }
        .offline-avatar-group img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            object-fit: cover;
        }
        .offline-heart-rate {
            font-size: 12px;
            color: #ff758c;
            margin-top: 5px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .offline-heart-rate i {
            animation: heartBeat 1s infinite;
        }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            15% { transform: scale(1.3); }
            30% { transform: scale(1); }
            45% { transform: scale(1.15); }
            60% { transform: scale(1); }
        }
        .offline-connect-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
        }
        .offline-distance-badge {
            background: rgba(255,255,255,0.8);
            border: 1px solid #ffcdd2;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            color: #ff758c;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .offline-wave-line {
            width: 100%;
            height: 20px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 20' preserveAspectRatio='none'%3E%3Cpath d='M0,10 Q25,20 50,10 T100,10' fill='none' stroke='%23ff758c' stroke-width='2' vector-effect='non-scaling-stroke'/%3E%3C/svg%3E");
            background-size: 200% 100%;
            animation: waveMove 2s linear infinite;
            opacity: 0.6;
        }
        @keyframes waveMove {
            0% { background-position: 0 0; }
            100% { background-position: -200% 0; }
        }

        .offline-chat-history {
            padding: 0 15px 15px 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .offline-msg-box {
            width: 100%;
            background: #fff;
            border: none;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            overflow: hidden;
        }
        .offline-msg-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
        }
        .offline-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(250, 81, 81, 0.1);
            color: #fa5151;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
            z-index: 10;
        }
        .offline-msg-header .edit-icon {
            margin-right: 30px; /* 为删除按钮留出空间 */
        }
        .offline-delete-btn:hover {
            background: rgba(250, 81, 81, 0.2);
            transform: scale(1.1);
        }
        .offline-delete-btn:active {
            transform: scale(0.95);
        }
        .offline-msg-header.user {
            background: #fff; /* Unified header background */
        }
        .offline-sender {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        .offline-sender .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .offline-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #999;
        }
        .offline-meta .edit-icon {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .offline-meta .edit-icon:hover { opacity: 1; }
        
        .offline-msg-body {
            padding: 20px;
            font-size: 16px;
            line-height: 1.8;
            word-wrap: break-word;
            color: #444;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow-y: auto;
            max-height: 65vh;
        }
        /* Offline Message Typography Rules */
        .offline-msg-body.short-text {
            text-align: center;
            font-size: 18px;
            font-weight: 500;
            padding: 30px 20px;
            color: #333;
        }
        /* Fix for scroll issue: Remove max-height restriction to allow full page scrolling */
        .offline-msg-body {
            max-height: none !important;
            overflow-y: visible !important;
        }
        .offline-long-text {
            text-align: justify;
            text-align-last: center; /* Centers the last line */
            position: relative;
        }
        
        .offline-text-center {
            text-align: center;
        }
        .offline-text-left {
            text-align: left;
            text-indent: 2em;
        }
        .offline-highlight {
            font-weight: 900;
            background: linear-gradient(to bottom, transparent 50%, rgba(255, 117, 140, 0.4) 50%);
            padding: 0 4px;
            color: #000;
            text-shadow: 0 0 1px rgba(255, 117, 140, 0.2);
        }
        
        .offline-input-bar {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
            padding: 10px 15px 25px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.02);
        }
        .offline-input-bar input {
            flex: 1;
            height: 38px;
            border: 1px solid #ddd;
            border-radius: var(--radius-btn);
            padding: 0 10px;
            font-size: 16px;
        }

        /* Popups */
        .pop-menu { position: absolute; z-index: 6000; background: #4c4c4c; border-radius: 8px; padding: 0; display: none; flex-direction: row; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); white-space: nowrap; }
        .pop-opt { color: #fff; padding: 10px 15px; font-size: 14px; border-right: 1px solid #5d5d5d; cursor: pointer; }
        .pop-opt:last-child { border: none; }
        
        .contact-menu { position: absolute; z-index: 6000; background: #4c4c4c; border-radius: 8px; padding: 5px 0; display: none; flex-direction: column; min-width: 120px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .contact-menu-item { color: #fff; padding: 12px 20px; font-size: 15px; border-bottom: 1px solid #5d5d5d; cursor: pointer; text-align: center; }
        .contact-menu-item:last-child { border: none; }
        
        .add-menu { position: absolute; top: 50px; right: 10px; width: 160px; background: #4c4c4c; border-radius: 8px; display: none; flex-direction: column; z-index: 6100; }
        .add-item { color: #fff; padding: 12px 15px; border-bottom: 1px solid #5d5d5d; font-size: 15px; display: flex; gap: 10px; align-items: center; cursor: pointer; }
        .sticker-panel { height: 180px; background: #f2f2f2; overflow-y: auto; padding: 10px; display: none; grid-template-columns: repeat(4, 1fr); gap: 10px; border-top: 1px solid #ddd; }
        .sticker-item { font-size: 28px; background: #fff; border-radius: 8px; display: flex; justify-content: center; align-items: center; height: 60px; cursor: pointer; object-fit: contain; overflow: hidden; }
        .sticker-item img { width: 100%; height: 100%; object-fit: contain; }
        .sticker-layout { display: flex; height: 100%; }
        .sticker-sidebar { width: 80px; background: #f7f7f7; border-right: 1px solid #eee; display: flex; flex-direction: column; overflow-y: auto; }
        .sticker-cate-tab { padding: 15px 5px; text-align: center; font-size: 13px; color: #666; cursor: pointer; border-bottom: 1px solid #f0f0f0; word-break: break-all; }
        .sticker-cate-tab.active { background: #fff; color: var(--primary); border-left: 3px solid var(--primary); font-weight: bold; }
        .sticker-content { flex: 1; background: #fff; padding: 10px; overflow-y: auto; }
        /* Settings & Forms */
        .group-box { background: #fff; margin-bottom: 12px; border-radius: var(--radius-box); overflow: hidden; margin: 10px; }
        .form-cell { display: flex; align-items: center; padding: 14px; border-bottom: 1px solid #f5f5f5; font-size: 16px; cursor: pointer; position: relative; }
        
        /* 模式选择卡片 */
        .mode-choice-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .mode-choice-card:active {
            background: #f9f9f9;
            transform: scale(0.98);
        }
        .mode-icon {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: #ffeef1;
            color: #ff758c;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px;
        }
        
        /* Message Animation (Disabled per user request to prevent shaking) */
        .msg-row {
            /* animation: msgPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); */
        }
        #chat-history.multi-select-mode .msg-row {
            animation: none !important;
        }
        .form-label { flex: 1; color: var(--text-main); }
        .form-val { color: var(--text-sub); font-size: 15px; max-width: 60%; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .switch { position: relative; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 100%; height: 100%; position: absolute; z-index: 10; cursor: pointer; top:0; left:0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; pointer-events: none; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Lists */
        .list-item { display: flex; align-items: center; padding: 15px; background: #fff; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .avatar { width: var(--avatar-size); height: var(--avatar-size); border-radius: var(--avatar-radius); object-fit: cover; background: #eee; flex-shrink: 0; }
        .list-content { flex: 1; margin-left: 14px; }
        .list-title { font-size: var(--font-size-main); font-weight: 500; color: var(--text-main); }
        .list-sub { font-size: var(--font-size-sub); color: var(--text-sub); margin-top: 4px; }

        .wb-category-bar { display: flex; overflow-x: auto; background: #fff; padding: 10px; gap: 10px; border-bottom: 1px solid #eee; white-space: nowrap; }
        .wb-cate-chip { padding: 4px 12px; background: #f2f2f2; border-radius: 16px; font-size: 13px; color: #666; cursor: pointer; }
        .wb-cate-chip.active { background: var(--primary); color: #fff; }
        .wb-item .wb-content { margin-top: 8px; padding-top: 8px; border-top: 1px solid #f5f5f5; white-space: pre-wrap; }
        .wb-item.collapsed .wb-content { display: none; }
        .wb-edit-area { display: none; margin-top: 10px; }
        .wb-edit-area textarea { width: 100%; height: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; }
        .wb-btn-row { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
        .wb-btn { padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; color: #fff; border: none; }
        .wb-btn.edit { background: var(--link); }
        .wb-btn.del { background: var(--red); }
        .wb-btn.save { background: var(--primary); }
        .wb-btn.cancel { background: #999; }

        /* Couple App New Style */
        .couple-pink-header { height: 60vh; background: var(--pink); color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; transition: height 0.3s; }
        .couple-days-num { font-size: 72px; font-weight: bold; margin: 10px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; }
        .couple-card { background: #fff; margin: -50px 20px 20px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(255, 117, 140, 0.2); position: relative; z-index: 10; min-height: 200px; }
        
        /* Other Apps */
        .weather-card { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%); color: #fff; padding: 20px; border-radius: 12px; margin: 15px; position: relative; }
        .phone-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
        .phone-card { background: #fff; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; aspect-ratio: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .full-btn { width: 90%; margin: 20px 5%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .red { background: var(--red); }
        
        /* Phone Check UI New Style */
        .phone-list-container { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .phone-feature-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 18px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.1s;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .phone-feature-card:active { transform: scale(0.98); }
        .pfc-icon-box {
            width: 48px; height: 48px; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px; margin-right: 15px; color: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .pfc-content { flex: 1; overflow: hidden; }
        .pfc-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px; }
        .pfc-desc { font-size: 12px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pfc-arrow { color: #ccc; font-size: 14px; margin-left: 10px; }

        /* Timeline UI */
        .timeline-container { padding: 20px 10px; }
        .timeline-item { position: relative; padding-left: 30px; padding-bottom: 25px; border-left: 2px dashed #ddd; margin-left: 10px; }
        .timeline-item:last-child { border-left: none; }
        .timeline-dot { 
            position: absolute; left: -8px; top: 0; width: 14px; height: 14px; 
            border-radius: 50%; background: #fff; border: 3px solid var(--primary); 
        }
        .timeline-time { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .timeline-content { background: #fff; padding: 12px; border-radius: 8px; font-size: 14px; color: #555; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

        /* Shopping UI */
        .shopping-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); display: flex; gap: 12px; }
        .shop-icon { width: 50px; height: 50px; background: #f7f7f7; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #aaa; flex-shrink: 0; }
        .shop-info { flex: 1; }
        .shop-title { font-size: 15px; font-weight: 600; color: #333; margin-bottom: 4px; line-height: 1.4; }
        .shop-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #888; margin-bottom: 6px; }
        .shop-note { font-size: 12px; color: #ff758c; background: #fff0f3; padding: 4px 8px; border-radius: 4px; display: inline-block; }

        /* Interest Radar UI */
        .interest-cloud { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 0; justify-content: center; }
        .interest-tag { 
            padding: 8px 16px; border-radius: 20px; font-size: 14px; 
            background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: #555;
            transition: all 0.2s; cursor: pointer;
        }
        .interest-tag.hot { background: #ffeef1; color: #ff758c; border-color: #ffcdd2; font-weight: bold; transform: scale(1.1); }
        .interest-tag:active { transform: scale(0.95); }
        .interest-evidence { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: none; }
        .evidence-box { background: #f9f9f9; padding: 10px; border-radius: 8px; font-size: 13px; color: #666; margin-top: 8px; font-style: italic; }

        /* Expanded Search UI */
        .search-expand-panel { background: #f9f9f9; padding: 12px; border-radius: 8px; margin-top: 8px; display: none; border: 1px solid #eee; }
        .search-res-title { color: #1a0dab; font-size: 15px; margin-bottom: 4px; text-decoration: underline; font-weight: 500; }
        .search-res-desc { color: #545454; font-size: 13px; line-height: 1.5; }
        .search-ai-note { margin-top: 8px; font-size: 12px; color: #ff9a9e; display: flex; align-items: center; gap: 5px; }

        /* Phone Check UI Specifics */
        .phone-chat-time { text-align: center; font-size: 12px; color: #999; margin: 15px 0 5px; }
        .memo-item { background: #fff9c4; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #fbc02d; cursor: pointer; }
        .memo-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; color: #333; }
        .memo-date { font-size: 12px; color: #888; }
        .memo-detail-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff9c4; z-index: 6100; padding: 20px; display: none; flex-direction: column; padding-top: 64px; /* Added padding to avoid status bar */ }
        .browser-item { padding: 15px; border-bottom: 1px solid #eee; background: #fff; cursor: pointer; transition: background 0.2s; }
        .browser-item:active { background: #f9f9f9; }
        .browser-header { display: flex; align-items: center; }
        .browser-icon { width: 32px; height: 32px; background: #f2f2f2; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 12px; color: #999; flex-shrink: 0; }
        .browser-info { flex: 1; overflow: hidden; }
        .browser-query { font-size: 16px; color: #333; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .browser-url { font-size: 12px; color: #999; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .fake-input-bar { height: 50px; background: #f7f7f7; border-top: 1px solid #d1d1d1; display: flex; align-items: center; padding: 0 10px; gap: 10px; flex-shrink: 0; }
        .fake-input { flex: 1; height: 36px; background: #fff; border-radius: 4px; border: 1px solid #ddd; }
        .fake-icon { font-size: 24px; color: #7f7f7f; }
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 8000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #fff; width: 85%; border-radius: 16px; overflow: hidden; max-height: 80%; overflow-y: auto; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .img-preview-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .img-preview-box { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: auto; }
        .img-preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s; }
        
        .wx-tab-bar { height: calc(50px + env(safe-area-inset-bottom)); padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid #d1d1d1; display: flex; align-items: center; background: #f7f7f7; position: absolute; bottom: 0; width: 100%; z-index: 600; }
        .nav-tab { flex: 1; text-align: center; color: #999; font-size: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; height: 100%; cursor: pointer; }
        .nav-tab i { font-size: 20px; margin-bottom: 2px; }
        .nav-tab.active { color: #07c160; }

        /* Voice Call UI */
        #layer-voice-call {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            color: #fff;
            display: flex;
            flex-direction: column;
            z-index: 8000;
        }
        .vc-log-item { margin-bottom: 12px; display: flex; flex-direction: column; }
        .vc-log-sender { font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 2px; }
        .vc-log-sender.me { color: #aaa; align-self: flex-end; }
        .vc-log-sender.ai { color: #4facfe; align-self: flex-start; }
        .vc-log-action { font-size: 13px; color: #ff9a9e; font-style: italic; margin-bottom: 2px; font-family: "KaiTi", "楷体", serif; }
        .vc-log-text { font-size: 15px; color: #fff; line-height: 1.4; font-family: sans-serif; }
        .vc-log-content { background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 12px; max-width: 80%; }
        .vc-log-item.me .vc-log-content { align-self: flex-end; background: rgba(7, 193, 96, 0.2); }
        .vc-log-item.ai .vc-log-content { align-self: flex-start; }
        .vc-header {
            padding: 50px 20px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            opacity: 0.8;
        }
        .vc-avatar-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding-bottom: 50px;
        }
        .vc-avatar-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.2);
            position: relative;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .vc-avatar-container img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .vc-avatar-pulse {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
            animation: pulse 2s infinite;
            opacity: 0;
            pointer-events: none;
        }
        .vc-avatar-pulse.speaking {
            animation: pulse-speak 1.5s infinite;
        }
        @keyframes pulse-speak {
            0% { transform: scale(1); opacity: 0.8; border-color: #fff; }
            100% { transform: scale(1.5); opacity: 0; border-color: rgba(255,255,255,0); }
        }
        .vc-status-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .vc-subtitle-text {
            font-size: 14px;
            opacity: 0.8;
            max-width: 80%;
            text-align: center;
            min-height: 20px;
        }
        .vc-controls {
            padding: 0 30px 50px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .vc-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: #fff;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
        }
        .vc-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
        .vc-btn.active { background: #fff; color: #333; }
        .vc-btn.hangup {
            background: #fa5151;
            width: 70px;
            height: 70px;
            box-shadow: 0 5px 15px rgba(250, 81, 81, 0.4);
        }
        .vc-btn-label {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
        }
        .vc-text-input-area {
            position: absolute;
            bottom: 140px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 10px 15px;
            display: none;
            align-items: center;
        }
        .vc-text-input-area input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 16px;
            outline: none;
        }
        .vc-mic-wave {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            height: 40px;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .vc-mic-wave.active { opacity: 1; }
        .vc-wave-bar {
            width: 4px;
            background: #fff;
            border-radius: 2px;
            animation: wave 0.5s infinite ease-in-out;
        }
        .vc-wave-bar:nth-child(1) { height: 10px; animation-delay: 0.1s; }
        .vc-wave-bar:nth-child(2) { height: 20px; animation-delay: 0.2s; }
        .vc-wave-bar:nth-child(3) { height: 30px; animation-delay: 0.3s; }
        .vc-wave-bar:nth-child(4) { height: 20px; animation-delay: 0.4s; }
        .vc-wave-bar:nth-child(5) { height: 10px; animation-delay: 0.5s; }
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(2); }
        }

        /* Loading Spinner */
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 9999; display: none; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Global Music Player */
        #global-music-player { position: fixed; bottom: 60px; left: 0; right: 0; height: 60px; background: linear-gradient(to right, #ff9a9e, #fecfef); display: none; align-items: center; padding: 0 15px; z-index: 7000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        
        .css-input {
            width: 100%;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
            background: #f9f9f9;
        }

        .music-info { flex: 1; color: #fff; overflow: hidden; }
        .music-title { font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .music-controls { display: flex; gap: 15px; align-items: center; color: #fff; font-size: 20px; }
        .music-controls i { cursor: pointer; }
        
        /* Cropper Modal */
        .cropper-container-box { height: 400px; width: 100%; background: #000; margin-bottom: 15px; overflow: hidden; border-radius: 8px; }
        #cropper-img { max-width: 100%; display: block; }

        /* --- Listen Together Player Styles --- */
        .listen-connect-wave {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 40px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 20' preserveAspectRatio='none'%3E%3Cpath d='M0,10 Q25,20 50,10 T100,10' fill='none' stroke='%23ff758c' stroke-width='2' vector-effect='non-scaling-stroke'/%3E%3C/svg%3E");
            background-size: 200% 100%;
            animation: waveMove 2s linear infinite;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 0;
            pointer-events: none;
        }
        .listen-connect-wave.active {
            opacity: 0.8;
        }

        #listen-player-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 60%;
            background: rgba(20, 20, 20, 0.6); /* 半透明 */
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); /* 毛玻璃 */
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 8000; display: none; flex-direction: column; color: #fff;
            transition: all 0.3s;
            overflow: hidden; /* 防止播放列表溢出显示 */
        }
        #listen-player-header {
            height: 44px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            margin-top: 0; border-bottom: 1px solid rgba(255,255,255,0.05); flex-shrink: 0;
        }
        #listen-minimize-btn, #listen-close-btn { font-size: 20px; padding: 10px; cursor: pointer; opacity: 0.8; }
        
        #listen-avatars-area {
            height: 80px; position: relative; display: flex; justify-content: center; align-items: center; margin-top: 25px;
            flex-shrink: 0; /* 防止压缩 */
        }
        .listen-avatar-box {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2);
            overflow: visible; position: absolute; transition: transform 0.3s;
            background: #000;
        }
        .listen-avatar-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .listen-avatar-box.me { left: 50%; transform: translate(-140%, 10px); z-index: 2; }
        .listen-avatar-box.partner { left: 50%; transform: translate(40%, 10px); z-index: 1; }
        .listen-avatar-box.glow { box-shadow: 0 0 15px var(--primary); animation: breathe 3s infinite ease-in-out; border-color: var(--primary); }
        @keyframes breathe { 0%, 100% { box-shadow: 0 0 10px rgba(7, 193, 96, 0.5); } 50% { box-shadow: 0 0 25px rgba(7, 193, 96, 0.9); } }

        .listen-bubble-permanent {
            position: absolute; bottom: 60px; /* 适应更小的头像 */
            background: #fff; color: #000; padding: 6px 10px; border-radius: 8px;
            font-size: 12px; width: 100px; text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;
            cursor: pointer;
        }
        /* 己方气泡居中 */
        .listen-avatar-box.me .listen-bubble-permanent {
            left: 50%; transform: translateX(-50%);
        }
        /* 对方气泡居中 */
        .listen-avatar-box.partner .listen-bubble-permanent {
            right: auto; left: 50%; transform: translateX(-50%);
        }

        .listen-bubble-permanent::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            border-top: 5px solid #fff; border-left: 5px solid transparent; border-right: 5px solid transparent;
        }
        .listen-bubble-input {
            width: 100%; border: none; outline: none; background: transparent; 
            text-align: center; font-size: 12px; font-family: inherit; pointer-events: none; /* 禁止直接输入 */
        }

        #listen-info-text { text-align: center; margin-top: 10px; color: rgba(255,255,255,0.9); font-size: 13px; flex-shrink: 0; }
        
        /* Swiper Container */
        #listen-swipe-container {
            flex: 1; overflow: hidden; width: 100%; position: relative;
            margin-bottom: 10px;
        }
        #listen-swipe-wrapper {
            display: flex; width: 200%; height: 100%;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .listen-page {
            width: 50%; height: 100%; flex-shrink: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }

        /* Page 1: Vinyl */
        #listen-vinyl-area {
            width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
            overflow: hidden;
        }
        #listen-vinyl {
            width: 200px; height: 200px; /* Adjust Vinyl Size */
            max-width: 60vw; max-height: 60vw;
            border-radius: 50%;
            background: url('https://png.pngtree.com/png-vector/20220623/ourmid/pngtree-vinyl-record-png-image_5323868.png') center/cover no-repeat;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            animation: rotate 10s linear infinite;
            animation-play-state: paused;
            border: 4px solid rgba(255,255,255,0.1);
            cursor: pointer;
            flex-shrink: 0;
        }
        #listen-vinyl.playing { animation-play-state: running; }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        
        .listen-emoji {
            position: absolute; font-size: 24px; animation: floatUp 2s ease-out forwards; pointer-events: none;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-100px) scale(1.5); } }

        #listen-timer-badge {
            margin: 10px auto; background: rgba(255,255,255,0.15); padding: 6px 16px; border-radius: 20px; font-size: 13px;
            display: inline-flex; align-items: center; gap: 6px; backdrop-filter: blur(5px);
        }

        /* Page 2: Full Lyrics */
        #listen-lyrics-page {
            width: 100%; height: 100%;
            overflow-y: auto; text-align: center;
            padding: 20px 0;
            -webkit-overflow-scrolling: touch;
            mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            scrollbar-width: none; /* Firefox */
        }
        #listen-lyrics-page::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }
        #listen-lyrics-full-content {
            padding: 100px 0; /* Space for scrolling */
            transition: transform 0.3s ease-out;
        }
        .lyric-line-full {
            min-height: 36px; line-height: 1.5; font-size: 15px; 
            color: rgba(255,255,255,0.5); 
            padding: 8px 20px; transition: all 0.3s;
            cursor: pointer;
        }
        .lyric-line-full.active {
            color: #fff; font-size: 18px; font-weight: bold;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* Pagination Dots */
        .listen-pagination {
            display: flex; justify-content: center; gap: 8px; margin-bottom: 10px;
        }
        .listen-dot {
            width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.3); transition: all 0.3s;
        }
        .listen-dot.active { background: #fff; width: 12px; border-radius: 4px; }

        #listen-controls { padding: 0 25px 25px; flex-shrink: 0; }
        .listen-progress-bar { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; position: relative; cursor: pointer; margin-bottom: 25px; }
        .listen-progress-fill { width: 0%; height: 100%; background: var(--primary); border-radius: 2px; position: relative; }
        .listen-progress-handle { width: 12px; height: 12px; background: #fff; border-radius: 50%; position: absolute; right: -6px; top: -4px; box-shadow: 0 0 5px rgba(0,0,0,0.5); transform: scale(0); transition: transform 0.2s; }
        .listen-progress-bar:hover .listen-progress-handle { transform: scale(1); }
        
        .listen-btn-row { display: flex; justify-content: space-between; align-items: center; }
        .listen-btn { font-size: 22px; color: rgba(255,255,255,0.9); cursor: pointer; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; border-radius: 50%; transition: background 0.2s; }
        .listen-btn:active { background: rgba(255,255,255,0.1); }
        .listen-play-btn { font-size: 26px; width: 50px; height: 50px; background: #fff; color: #000; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 20px rgba(255,255,255,0.3); transition: transform 0.1s; transform: translateY(-8px); }
        .listen-play-btn:active { transform: translateY(-8px) scale(0.95); }

        #listen-float-ball {
            position: fixed; top: 120px; left: 100%; width: 50px; height: 50px;
            border-radius: 25px 0 0 25px; background: rgba(20,20,20,0.85); backdrop-filter: blur(15px);
            z-index: 9000; display: none; justify-content: center; align-items: center;
            box-shadow: -2px 5px 15px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-right: none;
            overflow: hidden; cursor: grab; transition: left 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #listen-float-ball.show { left: calc(100% - 50px); }
        #listen-float-ball:active { cursor: grabbing; }
        #listen-float-ball img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.3); }
        #listen-float-ball.playing img { animation: rotate 8s linear infinite; }
        .float-ball-hover-info {
            position: absolute; right: 60px; background: rgba(0,0,0,0.8); color: #fff; padding: 6px 12px;
            border-radius: 8px; font-size: 13px; white-space: nowrap; pointer-events: none; 
            opacity: 0; transition: opacity 0.2s; transform: translateX(10px);
        }
        #listen-float-ball:active .float-ball-hover-info { opacity: 1; transform: translateX(0); }

        #listen-playlist-drawer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
            background: rgba(30,30,30,0.98); backdrop-filter: blur(20px);
            border-radius: 24px 24px 0 0; z-index: 8010;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; color: #fff;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
        }
        #listen-playlist-drawer.show { transform: translateY(0); }
        
        .achievement-badge { width: 18px; height: 18px; display: inline-flex; justify-content: center; align-items: center; background: #f6c02d; color: #fff; border-radius: 50%; font-size: 10px; margin-left: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Optimized Dropdown Styles */
        select {
            appearance: none;
            -webkit-appearance: none;
            background-color: #fff !important;
            border: 1px solid #e5e5e5 !important;
            border-radius: 8px !important;
            padding: 8px 30px 8px 12px !important;
            font-size: 14px;
            color: #333;
            text-align: center;
            text-align-last: center;
            min-width: 100px;
            height: 36px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 8px center !important;
            background-size: 14px !important;
            cursor: pointer;
        }
        select:focus {
            border-color: var(--primary) !important;
            outline: none;
        }

        /* iOS Safari Specific Adapter - 修复底部重叠问题 */
        @supports (-webkit-touch-callout: none) {
            #desktop {
                /* 底部留出足够空间给胶囊导航栏，防止内容重叠 */
                padding-bottom: calc(140px + env(safe-area-inset-bottom)) !important;
                /* 启用Flex布局实现垂直方向的按比例分布(拉伸) */
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                min-height: 100dvh;
                box-sizing: border-box;
            }
            /* 防止时间区域被过度压缩 */
            .desktop-time-date-area {
                flex-shrink: 0;
                margin-top: 2vh; /* 动态顶部间距 */
            }
            /* 防止用户信息卡片被压缩 */
            .user-info-card {
                flex-shrink: 0;
            }
            /* 应用网格区域 */
            .app-grid {
                flex-grow: 1;
                align-content: center; /* 图标在网格区域内垂直居中 */
            }
        }
        
        /* 通用浏览器适配 - 确保所有浏览器都能正确显示 */
        #desktop {
            padding-bottom: calc(140px + env(safe-area-inset-bottom, 20px));
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100vh;
            min-height: 100dvh;
            box-sizing: border-box;
        }
        
        /* 问题1修复：调整底部导航栏位置，增加底部间距，图标居中 */
        .bottom-nav {
            position: fixed;
            bottom: calc(40px + env(safe-area-inset-bottom, 20px)); /* 从20px增加到40px */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 380px;
            height: 90px;
            z-index: 1000;
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #333;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            justify-content: center; /* 确保图标垂直居中 */
        }
        
        .dock-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            background-size: cover;
            background-position: center;
            background-color: rgba(255,255,255,0.8);
            color: #333;
            margin-bottom: 2px; /* 微调图标与文字间距 */
        }
    </style>
</head>
<body>
    <div id="device">
        <input type="file" id="import-file" class="hidden" accept=".json,application/json" onchange="handleImport(this)">
        <div id="toast">提示</div>
        <div id="loading"><div class="spinner"></div></div>
        <!-- Status Bar -->
        <div class="status-bar">
            <div id="clock">12:00</div>
            <div class="status-right">
                <i class="fas fa-signal"></i>
                <i class="fas fa-wifi"></i>
                <div class="battery-icon"><div class="battery-level"></div></div>
            </div>
        </div>

        <!-- Global Music Player -->
        <div id="global-music-player">
            <div class="music-info">
                <div class="music-title" id="current-music-title">未播放</div>
            </div>
            <div class="music-controls">
                <i class="fas fa-backward" onclick="prevMusic()"></i>
                <i class="fas fa-play" id="play-pause-btn" onclick="togglePlay()"></i>
                <i class="fas fa-forward" onclick="nextMusic()"></i>
                <i class="fas fa-times" onclick="closeMusic()"></i>
            </div>
            <audio id="global-audio" onended="nextMusic()"></audio>
        </div>
        
        <audio id="tts-audio" class="hidden"></audio>

        <!-- LISTEN TOGETHER PLAYER POPUP -->
        <div id="listen-player-modal">
            <div id="listen-player-header" style="position: relative;">
                <div id="listen-minimize-btn" onclick="minimizeListenPlayer()"><i class="fas fa-minus"></i></div>
                <div style="position: absolute; left: 50%; transform: translateX(-50%); font-size: 17px; font-weight: 600; opacity:0.9;">一起听歌</div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div onclick="openMusicUpload()" style="cursor: pointer; background:rgba(255,255,255,0.15); width:30px; height:30px; border-radius:50%; display:flex; justify-content:center; align-items:center;">
                        <i class="fas fa-plus" style="font-size: 14px; color: #fff;"></i>
                    </div>
                    <div id="listen-close-btn" onclick="closeListenPlayer()"><i class="fas fa-times"></i></div>
                </div>
            </div>

            <div id="listen-avatars-area">
                <div id="listen-connect-wave" class="listen-connect-wave"></div>
                <div id="listen-avatar-me" class="listen-avatar-box me">
                    <img id="listen-avatar-me-img" src="https://via.placeholder.com/80">
                    <div class="listen-bubble-permanent" onclick="openCustomInput('listen-chat')">
                        <input id="listen-bubble-input-me" class="listen-bubble-input" placeholder="想说什么..." readonly>
                    </div>
                </div>
                <div id="listen-avatar-partner" class="listen-avatar-box partner">
                    <img id="listen-avatar-partner-img" src="https://via.placeholder.com/80">
                    <div class="listen-bubble-permanent" id="listen-bubble-partner" style="pointer-events:none;">
                        <span id="listen-bubble-text-partner">...</span>
                    </div>
                </div>
            </div>
            
            <div id="listen-info-text">
                <div style="display:flex; justify-content:center; align-items:center;">
                    <span id="listen-partner-name" style="font-weight: 500; font-size: 13px;">独自聆听</span>
                    <span id="listen-achievement"></span>
                </div>
                <div id="listen-timer-badge" style="padding: 4px 12px; font-size: 12px; margin-top: 5px;"><i class="fas fa-stopwatch"></i> <span id="listen-time-val">已一起聆听 0 分钟</span></div>
            </div>

            <!-- Swipe Container -->
            <div id="listen-swipe-container">
                <div id="listen-swipe-wrapper">
                    <!-- Page 1: Vinyl -->
                    <div class="listen-page" id="listen-page-1">
                        <div id="listen-vinyl-area">
                            <div id="listen-vinyl" onclick="document.getElementById('vinyl-file-input').click()"></div>
                            <input type="file" id="vinyl-file-input" class="hidden" accept="image/*" onchange="handleVinylUpload(this)">
                            <div id="listen-emoji-area" style="position: absolute; width: 100%; height: 100%; pointer-events: none; overflow:hidden;"></div>
                        </div>
                    </div>
                    <!-- Page 2: Lyrics -->
                    <div class="listen-page" id="listen-page-2">
                        <div id="listen-lyrics-page">
                            <div id="listen-lyrics-full-content">
                                <div class="lyric-line-full active">暂无歌词</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="listen-pagination">
                <div class="listen-dot active" id="listen-dot-0"></div>
                <div class="listen-dot" id="listen-dot-1"></div>
            </div>

            <div id="listen-controls">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:rgba(255,255,255,0.5); margin-bottom:8px; padding:0 5px;">
                    <span id="listen-cur-time">00:00</span>
                    <span id="listen-total-time">00:00</span>
                </div>
                <div class="listen-progress-bar" id="listen-progress-bar" onclick="seekListenMusic(event)">
                    <div class="listen-progress-fill" id="listen-progress-fill"><div class="listen-progress-handle"></div></div>
                </div>
                
                <div class="listen-btn-row">
                    <div class="listen-btn" onclick="toggleListenMode()"><i class="fas fa-random" id="listen-mode-icon" style="font-size:18px;"></i></div>
                    <div class="listen-btn" onclick="prevListenMusic()"><i class="fas fa-step-backward"></i></div>
                    <div class="listen-play-btn" onclick="toggleListenPlay()"><i class="fas fa-play" id="listen-play-icon" style="margin-left:4px;"></i></div>
                    <div class="listen-btn" onclick="nextListenMusic()"><i class="fas fa-step-forward"></i></div>
                    <div class="listen-btn" onclick="toggleListenPlaylist()"><i class="fas fa-list-ul" style="font-size:18px;"></i></div>
                </div>
            </div>

            <div id="listen-playlist-drawer">
                <div style="padding: 18px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 16px; font-weight: 600;">播放列表</span>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div id="listen-playlist-manage-btn" onclick="deleteSelectedPlaylistItems()" style="font-size: 14px; color: #ff4d4f; display: none;">删除选中</div>
                        <div onclick="toggleListenPlaylistManageMode()" id="listen-playlist-mode-btn" style="font-size: 14px; opacity: 0.8;">管理</div>
                        <div onclick="toggleListenPlaylist()" style="padding: 5px;"><i class="fas fa-chevron-down"></i></div>
                    </div>
                </div>
                <div id="listen-playlist-content" style="flex: 1; overflow-y: auto; padding: 10px 15px;"></div>
            </div>
            
        </div>

        <div id="listen-float-ball" onclick="maximizeListenPlayer()">
            <img id="listen-float-img" src="https://png.pngtree.com/png-vector/20220623/ourmid/pngtree-vinyl-record-png-image_5323868.png">
            <div class="float-ball-hover-info" id="listen-float-info">点击展开</div>
        </div>
        
        <!-- Contact Selector for Listen Together -->
        <div id="modal-listen-contact" class="modal-mask">
            <div class="modal-box">
                <h3>一起听歌</h3>
                <p style="color:#666; font-size:14px; margin-bottom:15px;">选择一位好友或独自聆听</p>
                <div id="listen-contact-list" style="max-height:300px; overflow-y:auto;"></div>
                <div style="padding:15px; text-align:center; border-top:1px solid #eee; margin-top:10px;" onclick="document.getElementById('modal-listen-contact').style.display='none'">取消</div>
            </div>
        </div>

        <!-- LAYERS -->
        <div id="layer-desktop" class="page active">
            <div id="desktop" class="scroll-y">
                
                <!-- Time/Date Display -->
                <div class="desktop-time-date-area">
                    <div class="desktop-time" id="desktop-time-val">12:00</div>
                    <div class="desktop-date" id="desktop-date-val">2026年2月2日 星期一</div>
                </div>

                <!-- User Info Card -->
                <div class="user-info-card">
                    <div class="user-avatar-container" onclick="uploadImg('desktop-user-avatar')">
                        <img id="desktop-user-avatar-img" src="https://via.placeholder.com/60" alt="avatar">
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="desktop-user-name" onclick="openDesktopProfileEdit()">用户名字</div>
                        <div class="user-signature" id="desktop-user-signature" onclick="openDesktopProfileEdit()">个性签名，点击设置</div>
                        <div class="user-location" id="desktop-user-location" onclick="openLocationEdit()">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <span id="desktop-user-location-province">地点信息</span>
                                <span id="desktop-user-location-address" style="margin-left: 5px;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Apps and Widget Grid -->
                <div class="app-grid" id="desktop-grid">
                    <!-- Apps will be dynamically placed by JS later -->
                    <!-- This is a placeholder structure -->
                    <div class="app-item" onclick="openApp('wechat')" style="grid-row: 1; grid-column: 1;">
                        <div class="app-icon" style="background: #07c160;"><i class="fab fa-weixin"></i></div>
                        <span class="app-name">微信</span>
                    </div>
                    <div class="app-item" onclick="openApp('worldbook')" style="grid-row: 1; grid-column: 2;">
                        <div class="app-icon" style="background: #5856d6;"><i class="fas fa-book"></i></div>
                        <span class="app-name">世界书</span>
                    </div>
                    <div class="app-item" onclick="openApp('couple')" style="grid-row: 2; grid-column: 1;">
                        <div class="app-icon" style="background: #ff758c;"><i class="fas fa-heart"></i></div>
                        <span class="app-name">情侣空间</span>
                    </div>
                    <div class="app-item" onclick="openApp('perception')" style="grid-row: 2; grid-column: 2;">
                        <div class="app-icon" style="background: #4facfe;"><i class="fas fa-brain"></i></div>
                        <span class="app-name">感知</span>
                    </div>

                    <!-- Custom Widget Area -->
                    <div class="custom-widget" style="grid-row: 1 / span 2; grid-column: 3 / span 2;" onclick="uploadImg('desktop-widget-bg')">
                        <!-- User can set a background image here -->
                    </div>
                </div>
            </div>
            <!-- Bottom Navigation Bar -->
            <div class="bottom-nav">
                <div class="bottom-nav-item" onclick="openApp('checkphone')">
                    <div class="dock-icon" id="dock-icon-checkphone"><i class="fas fa-mobile-alt"></i></div>
                    <span>查手机</span>
                </div>
                <div class="bottom-nav-item" onclick="openApp('beauty')">
                    <div class="dock-icon" id="dock-icon-beauty"><i class="fas fa-magic"></i></div>
                    <span>美化</span>
                </div>
                <div class="bottom-nav-item" onclick="openApp('settings')">
                    <div class="dock-icon" id="dock-icon-settings"><i class="fas fa-cog"></i></div>
                    <span>设置</span>
                </div>
            </div>
        </div>

        <!-- WECHAT -->
        <div id="layer-wechat" class="page">
            <div id="wx-content-area" style="position:absolute; top:0; bottom:50px; width:100%; overflow:hidden;">
                <!-- Tab Contacts -->
                <div id="tab-contacts" class="page active" style="padding-top:44px;">
                    <div class="nav-bar" style="position:absolute; top:0; width:100%; margin-top:44px;">
                        <div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-title">微信</div>
                        <div class="nav-icon" onclick="toggleAddMenu(event)"><i class="fas fa-plus-circle"></i></div>
                </div>
                    <div class="add-menu" id="wx-add-menu">
                        <div class="add-item" onclick="openContactModal()"><i class="fas fa-user-plus"></i> 添加朋友</div>
                        <div class="add-item" style="border:none;" onclick="gotoAddGroup()"><i class="fas fa-users"></i> 发起群聊</div>
                    </div>
                    <div id="contact-list" class="scroll-y" style="padding-top:44px;"></div>
                </div>
                
                <!-- Tab Moments -->
                <div id="tab-moments" class="page" style="padding-top:0;">
                    <div class="nav-bar" style="background:transparent; border:none; position:absolute; top:44px; width:100%; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.5); margin-top:0; z-index:200;">
                        <div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-title"></div>
                        <div class="nav-icon" onclick="showMomentActionSheet()"><i class="fas fa-camera"></i></div>
                    </div>
                    <div id="moments-feed" class="scroll-y" style="background:#fff;"></div>
                </div>

                <!-- Tab Me -->
                <div id="tab-me" class="page" style="padding-top:44px;">
                     <div class="scroll-y" style="background:#f2f2f2;"><div style="background:#fff; padding:30px 20px; display:flex; gap:15px; align-items:center; margin-top:20px;" onclick="openProfileEdit()">
                            <img id="my-avatar" class="avatar" style="width:64px; height:64px;" onclick="event.stopPropagation(); uploadImg('my-avatar')">
                            <div style="flex:1;"><h2 id="my-name" style="font-size:20px; font-weight:600;">User</h2><p style="color:#777; font-size:13px;">微信号:<span id="my-wxid">wxid_123</span></p></div>
                <i class="fas fa-chevron-right" style="color:#ccc;"></i>
                        </div>
                        <div class="group-box">
                            <div class="list-item" onclick="openWallet()"><i class="fas fa-wallet" style="color:#eda338; font-size:22px; margin-right:12px;"></i><div class="list-content"><div class="list-title">钱包</div><div class="list-sub" id="wallet-balance"></div></div></div>
                        </div>
                        <div class="group-box">
                            <div class="form-cell"><span class="form-label"><b>朋友圈AI互评</b></span><div class="switch"><input type="checkbox" id="ai-moment-interaction" onchange="toggleAiMomentInteraction(this.checked)"><span class="slider"></span></div></div>
                        </div>
                         <div class="group-box">
                            <div class="list-item" onclick="openDiary()"><i class="fas fa-book" style="color:#9b59b6; font-size:22px; margin-right:12px;"></i><div class="list-content"><div class="list-title">日记本</div></div></div>
                            <div class="list-item" onclick="openPersonaMgmt()"><i class="fas fa-address-card" style="color:#1296db; font-size:22px; margin-right:12px;"></i><div class="list-content"><div class="list-title">多重人设</div></div></div>
                <div class="list-item" onclick="openStickerGallery()"><i class="fas fa-icons" style="color:#f6c02d; font-size:22px; margin-right:12px;"></i><div class="list-content"><div class="list-title">表情包图库</div></div></div><div class="list-item" onclick="openMusic()"><i class="fas fa-music" style="color:#2dcc70; font-size:22px; margin-right:12px;"></i><div class="list-content"><div class="list-title">一起听歌</div></div></div>
                        </div></div>
                </div>
            </div>

            <!-- Bottom Tab Bar -->
            <div class="wx-tab-bar">
                <div class="nav-tab active" onclick="switchTab(0, this)"><i class="fas fa-comment"></i><span>微信</span></div>
                <div class="nav-tab" onclick="switchTab(1, this)"><i class="fas fa-compass"></i><span>发现</span></div>
                <div class="nav-tab" onclick="switchTab(2, this)"><i class="fas fa-user"></i><span>我</span></div>
            </div>
        </div>

        <!-- CHAT ROOM -->
        <div id="layer-chat" class="layer" style="display:flex; flex-direction:column; height:100%;">
            <!-- 正常导航栏 -->
            <div class="nav-bar" id="chat-nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-chat')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title" id="chat-title">Chat</div>
                <div class="nav-icon" onclick="openChatSettings()"><i class="fas fa-ellipsis-h"></i></div>
            </div>

            <!-- 线下模式嵌入式头部 -->
            <div id="chat-offline-header" class="offline-fixed-header" style="display:none; position:relative;">
                <div class="offline-nav-area">
                    <div class="offline-nav-icon" onclick="exitOfflineInChat()"><i class="fas fa-chevron-left"></i> 退出线下</div>
                    <div style="font-size:16px;">线下模式</div>
                    <div class="offline-nav-icon" onclick="openOfflineSettings()"><i class="fas fa-cog"></i></div>
                </div>
                <div class="offline-info-bar">
                     <div class="offline-avatar-group">
                         <img id="chat-offline-user-avatar" src="https://via.placeholder.com/50">
                         <div class="offline-heart-rate"><i class="fas fa-heartbeat"></i> <span id="chat-offline-user-hr">72</span></div>
                     </div>
                     <div class="offline-connect-area">
                         <div class="offline-wave-line"></div>
                         <div class="offline-distance-badge"><i class="fas fa-map-marker-alt"></i> 距离 <span id="chat-offline-distance">5</span> 米</div>
                     </div>
                     <div class="offline-avatar-group">
                         <img id="chat-offline-ai-avatar" src="https://via.placeholder.com/50">
                         <div class="offline-heart-rate"><i class="fas fa-heartbeat"></i> <span id="chat-offline-ai-hr">75</span></div>
                     </div>
                </div>
            </div>
            
            <div id="chat-select-bar" style="background:#f7f7f7; padding:10px; display:none; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; flex-shrink:0;">
                <div onclick="cancelSelect()">取消</div>
                <div onclick="deleteSelected()">删除</div></div>

            <div id="chat-history" style="flex:1; overflow-y:auto; background:#ededed; padding-bottom:10px;"></div>
            
            <div id="msg-menu" class="pop-menu">
                <div class="pop-opt" id="menu-btn-play" onclick="menuPlayVoice()" style="display:none;">播放</div>
                <div class="pop-opt" onclick="menuQuote()">引用</div>
                <div class="pop-opt" onclick="menuCopy()">复制</div>
                <div class="pop-opt" onclick="menuRecall()">撤回</div>
                <div class="pop-opt" onclick="menuEdit()">编辑</div>
                <div class="pop-opt" onclick="menuSelect()">多选</div>
                <div class="pop-opt" onclick="menuDelete()">删除</div>
            </div>

            <div class="input-bar" style="flex-shrink:0;">
                <div id="quote-preview" class="quote-preview">
                    <span id="quote-text"></span>
                    <i class="fas fa-times" onclick="cancelQuote()"></i>
                </div>
                <div class="input-row">
                    <button class="btn-act btn-gen" onclick="aiGenerate()">生成</button>
                    <input id="chat-input" class="input-field" onkeypress="if(event.key==='Enter'){userSend('text')}"><div id="voice-hold-btn" class="voice-hold-btn" onmousedown="startVoice()" onmouseup="endVoice()" ontouchstart="startVoice()" ontouchend="endVoice()">按住说话</div>
                    <button class="btn-act btn-thought" onclick="showThought()">心声</button>
                    <button class="btn-act btn-send" onclick="userSend('text')">发送</button>
                </div>
                <div class="toolbar">
                    <i class="fas fa-microphone" onclick="openCustomInput('voice-fake')"></i>
                    <i class="far fa-image" onclick="openCustomInput('image-fake')"></i>
                    <i class="fas fa-camera" onclick="uploadImg('send-photo')"></i>
                    <i class="fas fa-wallet" onclick="openCustomInput('transfer')"></i>
                    <i class="far fa-smile" onclick="toggleStickerDrawer()"></i>
                    <i class="fas fa-map-marker-alt" onclick="openCustomInput('location')"></i>
                    <i class="fas fa-redo" onclick="aiRetry()"></i>
                    <i class="fas fa-plus-circle" onclick="togglePopup('ext-menu')"></i>
                </div>
            </div>
            <div id="sticker-panel" class="sticker-panel"></div>
            <div id="ext-menu" class="add-menu" style="bottom:60px; top:auto; right:10px;">
                <div class="add-item" onclick="showOfflineModeChoice()"><i class="fas fa-feather-alt"></i> 线下模式</div>
                <div class="add-item" onclick="openMemorySystem()"><i class="fas fa-brain"></i> 记忆系统</div>
                <div class="add-item" onclick="startVoiceCall()" style="opacity:1;"><i class="fas fa-phone-alt"></i> 语音通话</div>
                <div class="add-item" onclick="toast('暂未开放')" style="opacity:0.6;"><i class="fas fa-video"></i> 视频通话</div>
            </div>
        </div>

        <!-- ADD GROUP CHAT -->
        <!-- VOICE CALL LAYER -->
        <div id="layer-voice-call" class="layer">
            <div class="vc-header">
                <div onclick="toggleVCMinimize()"><i class="fas fa-compress-alt"></i></div>
                <div id="vc-timer">00:00</div>
                <div><i class="fas fa-signal"></i></div>
            </div>
            <div class="vc-avatar-area">
                <div class="vc-avatar-container">
                    <div id="vc-avatar-pulse" class="vc-avatar-pulse"></div>
                    <img id="vc-avatar-img" src="https://via.placeholder.com/120">
                </div>
                <div class="vc-status-text" id="vc-status">正在连接...</div>
                <div class="vc-subtitle-text" id="vc-subtitle"></div>
                
                <div class="vc-mic-wave" id="vc-mic-wave">
                    <div class="vc-wave-bar"></div><div class="vc-wave-bar"></div><div class="vc-wave-bar"></div><div class="vc-wave-bar"></div><div class="vc-wave-bar"></div>
                </div>
            </div>
            
            <div class="vc-text-input-area" id="vc-text-input-box">
                <input id="vc-input" placeholder="输入文字..." onkeypress="if(event.key==='Enter') sendVoiceCallText()">
                <div onclick="sendVoiceCallText()" style="padding:5px 10px; background:#fff; color:#2b32b2; border-radius:15px; font-size:12px; font-weight:bold; margin-left:10px;">发送</div>
            </div>
            
            <div id="vc-history-panel" style="position:absolute; top:80px; bottom:180px; left:20px; right:20px; background:rgba(0,0,0,0.5); backdrop-filter:blur(10px); border-radius:15px; display:none; flex-direction:column; padding:15px; overflow-y:auto; z-index:10;">
                <div style="text-align:right; margin-bottom:10px;"><i class="fas fa-times" onclick="document.getElementById('vc-history-panel').style.display='none'"></i></div>
                <div id="vc-history-content" style="flex:1; font-size:14px; line-height:1.6; color:#fff;"></div>
            </div>

            <div class="vc-controls">
                <div class="vc-btn" onclick="toggleVCMute()" id="vc-btn-mute">
                    <i class="fas fa-microphone-slash"></i>
                    <!-- <div class="vc-btn-label">静音</div> -->
                </div>
                <div class="vc-btn" onclick="toggleVCSpeaker()" id="vc-btn-speaker">
                    <i class="fas fa-volume-up"></i>
                    <!-- <div class="vc-btn-label">扬声器</div> -->
                </div>
                <div class="vc-btn hangup" onclick="endVoiceCall()">
                    <i class="fas fa-phone-slash"></i>
                </div>
                <div class="vc-btn" onclick="toggleVCKeyboard()">
                    <i class="fas fa-keyboard"></i>
                    <!-- <div class="vc-btn-label">键盘</div> -->
                </div>
                <div class="vc-btn" onclick="toggleVCMore()">
                    <i class="fas fa-ellipsis-h"></i>
                    <!-- <div class="vc-btn-label">更多</div> -->
                </div>
            </div>
        </div>

        <div id="layer-add-group" class="layer">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-add-group')">取消</div>
                <div class="nav-title">选择联系人</div>
                <div class="nav-icon" style="color:var(--primary); font-size: 16px; font-weight: 600;" onclick="confirmCreateGroup()">完成</div>
            </div>
            <div id="add-group-contact-list" class="scroll-y" style="background:#fff;"></div>
        </div>

        <!-- DIARY -->
        <div id="layer-diary" class="layer">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-diary')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">日记本</div>
                <div class="nav-icon" onclick="showDiaryGenerateModal()"><i class="fas fa-plus"></i></div>
            </div>
            <div class="scroll-y" style="background:#f2f2f2; padding:15px;" id="diary-grid"></div>
        </div>

        <!-- DIARY LIST (Formerly Detail) -->
        <div id="layer-diary-detail" class="layer" style="z-index:6000;">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-diary-detail')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title" id="diary-detail-name">日记</div>
                <div class="nav-icon" onclick="openCustomInput('new-diary')"><i class="fas fa-edit"></i></div>
            </div>
            <div class="scroll-y" style="background:#f2f2f2; padding:15px;" id="diary-detail-content"></div>
        </div>

        <!-- DIARY READ (Single Entry) -->
        <div id="layer-diary-read" class="layer" style="z-index:6100;">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-diary-read')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">日记详情</div>
                <div class="nav-icon" onclick="togglePopup('diary-read-menu')"><i class="fas fa-ellipsis-h"></i></div>
            </div>
            <div class="add-menu" id="diary-read-menu" style="top:44px; right:10px;">
                <div class="add-item" onclick="editCurrentDiary()"><i class="fas fa-edit"></i> 编辑</div>
                <div class="add-item" onclick="deleteCurrentDiary()" style="color:#fa5151; border:none;"><i class="fas fa-trash"></i> 删除</div>
            </div>
            <div class="scroll-y" style="background:#fff; padding:25px;" id="diary-read-body"></div>
        </div>

        <!-- MEMORY SYSTEM -->
        <div id="layer-memory-system" class="layer">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-memory-system')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">记忆系统</div>
                <div class="nav-icon" onclick="openCustomInput('manual-memory')"><i class="fas fa-plus"></i></div>
            </div>
            <div id="memory-list" class="scroll-y" style="background:#f2f2f2; padding:5px 0;">
                <!-- Memories will be listed here -->
            </div>
        </div>

        <!-- OTHER APPS -->
        <div id="layer-chat-settings" class="layer">
             <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-chat-settings')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">聊天设置</div></div>
            <div class="scroll-y" style="background:#f2f2f2; padding-top:20px;">
                <div id="chat-settings-content"></div>
                <div style="margin:20px 10px;">
                    <button class="full-btn" onclick="saveChatSettings()">保存</button>
                    <button class="full-btn" style="background:#ff9a9e; margin-top:10px;" onclick="openClearRecordsModal()">一键清除记录</button>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="full-btn" style="background:#ccc; flex:1;" onclick="pinContactToggle()" id="btn-pin-contact">置顶</button>
                        <button class="full-btn red" style="flex:1;" onclick="deleteContactFromSettings()">删除联系人</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="layer-worldbook" class="layer">
            <div class="nav-bar">
                <div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">世界书</div>
                <div class="nav-icon" onclick="toggleWBMenu(event)"><i class="fas fa-plus"></i></div>
            </div>
            <div class="add-menu" id="wb-add-menu" style="top:88px;">
                <div class="add-item" onclick="openWBModal()"><i class="fas fa-book"></i> 新建世界书</div>
                <div class="add-item" onclick="openCategoryModal()" style="border:none;"><i class="fas fa-folder-plus"></i> 创建分类</div>
            </div>
            <div id="wb-category-bar" class="wb-category-bar"></div>
            <div class="scroll-y" style="background:#f2f2f2; padding:15px;" id="wb-list"></div>
        </div>

        <div id="layer-wallet" class="layer">
            <div class="nav-bar" style="background:#eda338; border:none; color:#fff;"><div class="nav-icon" onclick="closeLayer('layer-wallet')" style="color:#fff;"><i class="fas fa-chevron-left"></i></div><div class="nav-title" style="color:#fff;">钱包</div></div>
            <div class="scroll-y" style="background:#ededed;">
                <div style="background:#eda338; height:150px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff;">
                    <div style="opacity:0.8;">余额</div>
                    <div style="font-size:36px; font-weight:bold;">￥<span id="wallet-amt">0.00</span></div>
                </div>
                <button class="full-btn" onclick="openCustomInput('recharge')">充值</button>
                <div class="group-box" id="wallet-bill"></div>
            </div>
        </div>
        <div id="layer-online-mode" class="layer">
             <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-online-mode')">取消</div><div class="nav-title">线上模式</div><div class="nav-icon" style="color:var(--primary);" onclick="sendOnlineMode()">发送</div></div>
             <div style="padding:20px; flex:1; display:flex; flex-direction:column;"><textarea id="online-text" style="flex:1; border:none; outline:none; font-size:16px; line-height:1.5; resize:none;" placeholder="在此输入长文..."></textarea>
             </div>
        </div>

        <script>
        // 问题14修复：线上模式发送函数
        function openOnlineMode() {
            if (!activeChatId) return toast("无效的聊天上下文", "error");
            document.getElementById('layer-online-mode').classList.add('show');
            document.getElementById('online-text').value = '';
            const extMenu = document.getElementById('ext-menu');
            if (extMenu) extMenu.style.display = 'none';
        }

        function sendOnlineMode() {
            const text = document.getElementById('online-text').value.trim();
            if (!text || !activeChatId) return toast("请输入内容");
            
            // 发送为普通文本消息
            userSend('text', text);
            
            // 关闭线上模式界面
            closeLayer('layer-online-mode');
            toast("已发送");
        }
        </script>

        <!-- OFFLINE MODE (单独界面) -->
        <div id="layer-offline-mode" class="layer">
             <div class="offline-fixed-header">
                 <div class="offline-nav-area">
                    <div class="offline-nav-icon" onclick="closeLayer('layer-offline-mode')"><i class="fas fa-chevron-left"></i> 返回</div>
                    <div class="nav-title" style="color:#ff758c;">线下模式</div>
                    <div class="offline-nav-icon" onclick="openOfflineSettings()"><i class="fas fa-cog"></i></div>
                 </div>
                 <div class="offline-info-bar" id="offline-info-bar">
                     <div class="offline-avatar-group">
                         <img id="offline-user-avatar" src="https://via.placeholder.com/50">
                         <div class="offline-heart-rate"><i class="fas fa-heartbeat"></i> <span id="offline-user-hr">72</span></div>
                     </div>
                     <div class="offline-connect-area">
                         <div class="offline-wave-line"></div>
                         <div class="offline-distance-badge"><i class="fas fa-map-marker-alt"></i> 距离 <span id="offline-distance">5</span> 米</div>
                     </div>
                     <div class="offline-avatar-group">
                         <img id="offline-ai-avatar" src="https://via.placeholder.com/50">
                         <div class="offline-heart-rate"><i class="fas fa-heartbeat"></i> <span id="offline-ai-hr">75</span></div>
                     </div>
                 </div>
             </div>
             
             <div class="offline-scroll-container">
                 <div id="offline-chat-history" class="offline-chat-history">
                    <!-- Messages will be injected here by JS -->
                 </div>
             </div>

             <div class="offline-input-bar">
                <button class="btn-act" onclick="regenerateOfflineReply()" style="background:#f39c12; border-radius: 12px; padding: 0 12px;">重新生成</button>
                <input id="offline-chat-input" placeholder="输入内容..." onkeypress="if(event.key==='Enter'){sendOfflineMessage()}" style="border-radius: 18px; padding: 0 15px; border: 1px solid #eee; background: #f5f5f5;">
                <button class="btn-act btn-send" onclick="sendOfflineMessage()">发送</button>
             </div>
        </div>
        
        <!-- Offline Choice Modal -->
        <div id="modal-offline-choice" class="modal-mask">
            <div class="modal-box">
                <h3 style="text-align:center; margin-bottom:20px;">选择模式</h3>
                <div class="mode-choice-card" onclick="chooseOfflineMode('page')">
                    <div class="mode-icon"><i class="fas fa-book-open"></i></div>
                    <div>
                        <div style="font-weight:bold; font-size:16px;">独立界面模式</div>
                        <div style="font-size:12px; color:#888; margin-top:4px;">沉浸式阅读体验，独立展示</div>
                    </div>
                </div>
                <div class="mode-choice-card" onclick="chooseOfflineMode('chat')">
                    <div class="mode-icon"><i class="fas fa-comments"></i></div>
                    <div>
                        <div style="font-weight:bold; font-size:16px;">私聊界面模式</div>
                        <div style="font-size:12px; color:#888; margin-top:4px;">保留气泡对话样式，融合体验</div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:15px; color:#999;" onclick="document.getElementById('modal-offline-choice').style.display='none'">取消</div>
            </div>
        </div>

        <!-- Offline Settings Modal -->
        <div id="modal-offline-settings" class="modal-mask">
            <div class="modal-box">
                <h3>线下模式设置</h3>
                <div class="group-box" style="margin-top:15px;">
                    <div class="form-cell">
                        <span class="form-label">字数范围</span>
                        <div>
                            <input id="offline-min-words" type="number" value="300" style="width:60px; text-align:center; border:1px solid #ddd; border-radius:4px; padding:5px;">
                            <span>-</span>
                            <input id="offline-max-words" type="number" value="1000" style="width:60px; text-align:center; border:1px solid #ddd; border-radius:4px; padding:5px;">
                        </div>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">文本风格</span>
                        <select id="offline-style" class="form-val">
                            <option value="故事化">故事化</option>
                            <option value="文艺">文艺</option>
                            <option value="简练">简练</option>
                            <option value="散文">散文</option>
                        </select>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">用户人称</span>
                        <select id="offline-user-persp" class="form-val">
                            <option value="第一人称">第一人称 (我)</option>
                            <option value="第二人称">第二人称 (你)</option>
                            <option value="第三人称">第三人称 (他/她/名字)</option>
                        </select>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">联系人人称</span>
                        <select id="offline-ai-persp" class="form-val">
                            <option value="第一人称">第一人称 (我)</option>
                            <option value="第二人称">第二人称 (你)</option>
                            <option value="第三人称">第三人称 (他/她/名字)</option>
                        </select>
                    </div>
                    <div class="form-cell">
                        <span class="form-label"><b>从私聊界面读取世界书</b></span>
                        <div class="switch">
                            <input type="checkbox" id="offline-read-worldbook">
                            <span class="slider"></span>
                        </div>
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top:20px;">
                    <button onclick="document.getElementById('modal-offline-settings').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                    <button onclick="saveOfflineSettings()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
                </div>
            </div>
        </div>

        <div id="layer-couple" class="layer">
             <div id="couple-content-area" style="height:100%; display:flex; flex-direction:column;"></div>
        </div>

        <div id="layer-perception" class="layer">
             <div class="nav-bar"><div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div><div class="nav-title">感知</div></div>
             <div class="scroll-y" style="background:#f2f2f2; padding:15px;">
                 <div class="weather-card">
                     <div style="font-size:36px; font-weight:bold;" id="perc-weather-temp">26°C</div>
                     <div id="perc-weather">晴朗</div>
                     <div style="margin-top:10px; font-size: 14px; opacity: 0.9;">
                        <span id="perc-loc">上海</span> | <span id="perc-season">春季</span>
                     </div>
                     <div style="margin-top:5px; font-size: 12px; opacity: 0.7;">
                        <span id="perc-hemisphere">北半球</span> • <span id="perc-timezone">UTC+8</span>
                     </div>
                     <i class="fas fa-sync" style="position:absolute; top:20px; right:20px; cursor:pointer;" onclick="calibrateWeather()"></i>
                 </div>
                 <div class="group-box">
                    <div class="form-cell"><span class="form-label"><b>全局感知总开关</b></span><div class="switch"><input type="checkbox" id="perc-master" onchange="savePerception()"><span class="slider"></span></div></div>
                 </div>

                 <h3 style="margin:15px 5px; font-size:14px; color:#555;">全局虚拟设定 (覆盖现实)</h3>
                 <div class="group-box">
                    <div class="form-cell">
                        <span class="form-label">虚拟日期</span>
                        <div class="switch" style="margin-right:10px;"><input type="checkbox" id="perc-custom-date" onchange="savePerception()"><span class="slider"></span></div>
                        <input type="date" id="perc-date-val" class="form-val" style="border:none;" onchange="savePerception()">
                    </div>
                    <div class="form-cell">
                        <span class="form-label">虚拟时间</span>
                        <div class="switch" style="margin-right:10px;"><input type="checkbox" id="perc-custom-time" onchange="savePerception()"><span class="slider"></span></div>
                        <input type="time" id="perc-time-val" class="form-val" style="border:none;" onchange="savePerception()">
                    </div>
                    <div class="form-cell" style="flex-direction:column; align-items:flex-start;">
                         <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <span class="form-label">虚拟地点</span>
                            <div class="switch"><input type="checkbox" id="perc-custom-city" onchange="savePerception()"><span class="slider"></span></div>
                         </div>
                         <div style="width:100%; display:flex; gap:5px;">
                             <input id="perc-city-val" placeholder="虚拟城市 (AI认知)" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px;" onchange="savePerception()">
                             <input id="perc-real-city-val" placeholder="真实城市 (查天气)" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px;" onchange="savePerception()">
                         </div>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">虚拟天气</span>
                        <div class="switch" style="margin-right:10px;"><input type="checkbox" id="perc-custom-weather" onchange="savePerception()"><span class="slider"></span></div>
                        <input id="perc-weather-val" placeholder="如: 下雪" class="form-val" style="border:none; text-align:right;" onchange="savePerception()">
                    </div>
                    <div class="form-cell">
                        <span class="form-label">自定义温度</span>
                        <div class="switch" style="margin-right:10px;"><input type="checkbox" id="perc-custom-temp" onchange="savePerception()"><span class="slider"></span></div>
                        <input id="perc-temp-val" placeholder="20" type="number" class="form-val" style="border:none; text-align:right; width: 60px;" onchange="savePerception()">
                        <span style="color:var(--text-sub);">°C</span>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">虚拟气候</span>
                        <div class="switch" style="margin-right:10px;"><input type="checkbox" id="perc-custom-climate" onchange="savePerception()"><span class="slider"></span></div>
                        <span class="form-val" id="perc-climate-val" onclick="if(document.getElementById('perc-custom-climate').checked) picker('climate')">点击选择</span>
                    </div>
                 </div>
                 <h3 style="margin:15px 5px;">节日</h3>
                 <div class="group-box" id="festival-list"></div>
                 <button class="full-btn" onclick="openCustomInput('festival')">添加节日</button>
             </div>
        </div>

        <div id="layer-checkphone" class="layer">
             <div class="nav-bar"><div class="nav-icon" onclick="exitCheckPhone()"><i class="fas fa-chevron-left"></i></div><div class="nav-title">查手机</div></div>
             <div class="scroll-y" style="background:#f2f2f2;" id="checkphone-container">
                 <div style="text-align:center; padding:50px; color:#999;">
                     <i class="fas fa-mobile-alt" style="font-size:64px; margin-bottom:20px; color:#ccc;"></i>
                     <div>请先选择要查看的联系人</div>
                     <button onclick="selectCheckPhoneContact()" style="margin-top:20px; padding:10px 25px; background:var(--primary); color:#fff; border:none; border-radius:6px; font-size:16px;">选择联系人</button>
                 </div>
             </div>
        </div>
        <!-- Check Phone Selector Modal -->
        <div id="modal-checkphone-contact" class="modal-mask"><div class="modal-box">
            <h3>选择要查看的手机</h3>
            <div id="checkphone-contact-list" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
            <div style="padding:15px; text-align:center; border-top:1px solid #eee; margin-top:10px;" onclick="document.getElementById('modal-checkphone-contact').style.display='none'">取消</div>
        </div></div>

        <!-- Phone Check Sub-layers -->
        <div id="layer-phone-contacts" class="layer" style="z-index:6000;">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-contacts')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">联系人</div><div class="nav-icon" onclick="refreshPhoneData('contacts')"><i class="fas fa-sync"></i></div></div>
            <div id="phone-contacts-list" class="scroll-y" style="background:#f2f2f2;"></div>
        </div>

        <div id="layer-phone-chat" class="layer" style="z-index:6100; display:flex; flex-direction:column;">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-chat')"><i class="fas fa-chevron-left"></i></div><div class="nav-title" id="phone-chat-title"></div><div class="nav-icon"><i class="fas fa-ellipsis-h"></i></div></div>
            <div id="phone-chat-history" class="scroll-y" style="background:#ededed; padding-bottom:20px; flex:1;"></div>
            <div class="fake-input-bar">
                <i class="fas fa-wifi fake-icon" style="transform: rotate(90deg);"></i>
                <div class="fake-input"></div>
                <i class="far fa-smile fake-icon"></i>
                <i class="fas fa-plus-circle fake-icon"></i>
            </div>
        </div>

        <div id="layer-phone-memo" class="layer" style="z-index:6000;">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-memo')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">备忘录</div><div class="nav-icon" onclick="refreshPhoneData('memo')"><i class="fas fa-sync"></i></div></div>
            <div id="phone-memo-list" class="scroll-y" style="background:#fff; padding:15px;"></div>
            <div id="phone-memo-detail" class="memo-detail-view">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:10px;">
                    <i class="fas fa-chevron-left" style="font-size:20px; cursor:pointer;" onclick="document.getElementById('phone-memo-detail').style.display='none'"></i>
                    <i class="fas fa-trash" style="font-size:18px; opacity:0.5;"></i>
                </div>
                <div id="memo-det-title" style="font-size:22px; font-weight:bold; margin-bottom:10px;"></div>
                <div id="memo-det-date" style="font-size:14px; color:#888; margin-bottom:20px;"></div>
                <div id="memo-det-content" style="font-size:16px; line-height:1.6; white-space:pre-wrap;"></div>
            </div>
        </div>

        <div id="layer-phone-search" class="layer" style="z-index:6000;">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-search')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">搜索记录</div><div class="nav-icon" onclick="refreshPhoneData('search')"><i class="fas fa-sync"></i></div></div>
            <div id="phone-search-list" class="scroll-y" style="background:#fff;"></div>
        </div>
        
        <div id="layer-phone-usage" class="layer" style="z-index:6000;">
             <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-usage')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">手机使用简报</div><div class="nav-icon" onclick="refreshPhoneData('usage')"><i class="fas fa-sync"></i></div></div>
             <div class="scroll-y" style="background:#f2f2f2;" id="phone-usage-content"></div>
        </div>

        <div id="layer-phone-shopping" class="layer" style="z-index:6000;">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-shopping')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">购物车/消费</div><div class="nav-icon" onclick="refreshPhoneData('shopping')"><i class="fas fa-sync"></i></div></div>
            <div id="phone-shopping-list" class="scroll-y" style="background:#f2f2f2; padding:15px;"></div>
        </div>

        <div id="layer-phone-interests" class="layer" style="z-index:6000;">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-interests')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">兴趣雷达</div><div class="nav-icon" onclick="refreshPhoneData('interests')"><i class="fas fa-sync"></i></div></div>
            <div id="phone-interests-content" class="scroll-y" style="background:#fff; padding:20px;"></div>
        </div>

        <div id="layer-settings" class="layer">
             <div class="nav-bar"><div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div><div class="nav-title">设置</div></div>
             <div class="scroll-y" style="background:#f2f2f2; padding:20px;">
                 <h3 style="margin-bottom:10px;">API 预设</h3>
                 <div class="group-box" id="api-preset-list"></div>
                 <button class="full-btn" onclick="openAPIPresetModal()">添加预设</button>
                
                 <h3 style="margin:20px 010px;">当前配置</h3>
                 <div class="group-box"><div class="form-cell" style="flex-direction:column; align-items:flex-start;"><span class="form-label" style="margin-bottom:10px;">API Endpoint</span><input id="sys-url" style="width:100%; padding:10px; border:1px solid #eee; border-radius:6px;" placeholder="https://api.openai.com/v1"></div>
                    <div class="form-cell" style="flex-direction:column; align-items:flex-start;"><span class="form-label" style="margin-bottom:10px;">API Key</span>
                        <div style="position:relative; width:100%;">
                            <input id="sys-key" type="password" style="width:100%; padding:10px; padding-right:40px; border:1px solid #eee; border-radius:6px;" autocomplete="off" ontouchstart="event.stopPropagation()">
                            <i class="fas fa-times-circle" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#999; cursor:pointer; font-size:20px; padding:10px;" onclick="document.getElementById('sys-key').value='';"></i>
                        </div>
                    </div>
                 </div>
                 <button class="full-btn" onclick="fetchModels()">拉取模型</button>
                 <div class="group-box"><div class="form-cell"><span class="form-label">模型</span><select id="sys-model"><option>gpt-3.5-turbo</option></select></div>
                    <div class="form-cell">
                        <span class="form-label">模型温度</span>
                        <input id="sys-temp" type="range" min="0" max="2" step="0.1" style="flex:1; margin:0 10px;">
                        <span id="sys-temp-val" style="width:30px; text-align:right;">0.7</span>
                    </div>
                </div>
                 
                 <h3 style="margin:20px 0 10px;">语音服务设置 (MiniMax)</h3>
                 <div class="group-box">
                     <div class="form-cell">
                         <span class="form-label">服务版本</span>
                         <select id="mm-version">
                             <option value="official">官方版</option>
                             <option value="mainland">大陆版</option>
                             <option value="overseas">海外版</option>
                         </select>
                     </div>
                     <div class="form-cell" style="flex-direction:column; align-items:flex-start;">
                         <span class="form-label" style="margin-bottom:5px;">Group ID</span>
                         <input id="mm-group-id" style="width:100%; padding:8px; border:1px solid #eee; border-radius:6px;">
                     </div>
                     <div class="form-cell" style="flex-direction:column; align-items:flex-start;">
                         <span class="form-label" style="margin-bottom:5px;">API Key</span>
                         <input id="mm-api-key" type="password" style="width:100%; padding:8px; border:1px solid #eee; border-radius:6px;">
                     </div>
                     <div class="form-cell">
                         <span class="form-label">语音模型</span>
                         <select id="mm-model">
                             <option value="speech-2.8-hd">speech-2.8-hd (推荐)</option>
                             <option value="speech-2.8-turbo">speech-2.8-turbo</option>
                             <option value="speech-2.6-hd">speech-2.6-hd</option>
                             <option value="speech-2.6-turbo">speech-2.6-turbo</option>
                             <option value="speech-01-hd">speech-01-hd</option>
                             <option value="speech-01-turbo">speech-01-turbo</option>
                         </select>
                     </div>
                 </div>
                 <button class="full-btn" onclick="saveSysSettings()">保存配置</button>
                
                 <h3 style="margin:20px 0 10px;">外观设置</h3>
                 <div class="group-box">
                    <div class="form-cell"><span class="form-label">主字体颜色</span><input id="theme-main-color" type="color"></div>
                    <div class="form-cell"><span class="form-label">主字体大小</span><input id="theme-main-size" type="range" min="12" max="20" oninput="this.nextElementSibling.textContent = this.value + 'px'"> <span id="theme-main-size-val">16px</span></div>
                    <div class="form-cell"><span class="form-label">次字体颜色</span><input id="theme-sub-color" type="color"></div>
                    <div class="form-cell"><span class="form-label">次字体大小</span><input id="theme-sub-size" type="range" min="10" max="18" oninput="this.nextElementSibling.textContent = this.value + 'px'"> <span id="theme-sub-size-val">14px</span></div>
                    <div class="form-cell"><span class="form-label">状态栏字体颜色</span><input id="theme-status-color" type="color"></div>
                    <div class="form-cell"><span class="form-label">桌面字体颜色</span><input id="theme-desktop-color" type="color" value="#FFFFFF"></div>
                    <div class="form-cell"><span class="form-label">显示状态栏</span><div class="switch"><input type="checkbox" id="theme-show-status"><span class="slider"></span></div></div>
                 </div>
                 <button class="full-btn" onclick="saveTheme()">保存主题</button>
                 <button class="full-btn" onclick="resetTheme()" style="background:#ccc; margin-top:10px;">重置</button>

                 <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="full-btn" onclick="exportData()" style="background:#5856d6; margin:0;">导出数据</button>
                    <button class="full-btn" onclick="document.getElementById('import-file').click()" style="background:#5856d6; margin:0;">导入数据</button>
                 </div>
             </div>
        </div>

        <div id="layer-stickers" class="layer">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-stickers')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">表情包图库</div>
                <div class="nav-icon" onclick="openStickerMenu(event)"><i class="fas fa-ellipsis-h"></i></div>
            </div>
            <div class="add-menu" id="sticker-menu" style="top:44px; right:10px;">
                <div class="add-item" onclick="addStickerCategoryPopup()"><i class="fas fa-folder-plus"></i> 新建分类</div>
                <div class="add-item" onclick="addStickerPopup()"><i class="fas fa-plus-square"></i> 添加表情</div>
                <div class="add-item" onclick="toggleStickerManageMode()" style="border:none;"><i class="fas fa-tasks"></i> 管理表情包</div>
            </div>
            <div class="sticker-layout">
                <div class="sticker-sidebar" id="sticker-categories"></div>
                <div class="sticker-content">
                    <div id="sticker-gallery-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;"></div>
                </div>
            </div>
            <div id="sticker-manage-bar" style="display:none; padding:10px; background:#f7f7f7; border-top:1px solid #ddd; justify-content:space-between; align-items:center;">
                <div onclick="toggleStickerManageMode()">取消</div>
                <div onclick="deleteSelectedStickers()" style="color:var(--red);">删除</div>
            </div>
        </div>

        <div id="layer-music" class="layer">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-music')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">一起听歌</div><div class="nav-icon" onclick="addMusicPopup()"><i class="fas fa-plus"></i></div></div>
            <div class="scroll-y" style="background:#fff; padding:10px;">
                <div id="music-list"></div>
            </div>
        </div>
        <div id="layer-persona-mgmt" class="layer">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-persona-mgmt')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">多重人设</div><div class="nav-icon" onclick="openPersonaModal()"><i class="fas fa-plus"></i></div></div>
            <div class="scroll-y" style="background:#f2f2f2; padding:15px;" id="persona-list"></div>
        </div>

        <div id="layer-beauty" class="layer">
            <div class="nav-bar"><div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div><div class="nav-title">美化</div></div>
            <div class="scroll-y" style="background:#f2f2f2; padding:20px;">
                <button class="full-btn" onclick="uploadImg('desktop-bg')">修改主页背景 (本地上传)</button>
                
                <!-- CSS Code Injection -->
                <h3 style="margin-top:20px; color:#555;">气泡样式 (CSS)</h3>
                <div class="group-box">
                    <textarea id="css-bubble" class="css-input" placeholder="输入自定义气泡的CSS..."></textarea>
                    <div style="display:flex; gap:10px; padding:10px;">
                        <button class="full-btn" style="margin:0; flex:1;" onclick="applyCustomCSS('bubble')">应用</button>
                        <button class="full-btn" style="margin:0; flex:1; background:#576b95;" onclick="saveCSSPreset('bubble')">存为预设</button>
                        <button class="full-btn" style="margin:0; flex:1; background:#f0ad4e;" onclick="restoreDefaultCSS('bubble')">还原</button>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">加载预设</span>
                        <select id="preset-selector-bubble" class="form-val" onchange="loadCSSPreset('bubble', this.value)"></select>
                    </div>
                </div>

                <h3 style="margin-top:20px; color:#555;">界面主题 (CSS)</h3>
                <div class="group-box">
                    <textarea id="css-global" class="css-input" placeholder="输入自定义全局界面的CSS..."></textarea>
                    <div style="display:flex; gap:10px; padding:10px;">
                        <button class="full-btn" style="margin:0; flex:1;" onclick="applyCustomCSS('global')">应用</button>
                        <button class="full-btn" style="margin:0; flex:1; background:#576b95;" onclick="saveCSSPreset('global')">存为预设</button>
                        <button class="full-btn" style="margin:0; flex:1; background:#f0ad4e;" onclick="restoreDefaultCSS('global')">还原</button>
                    </div>
                     <div class="form-cell">
                        <span class="form-label">加载预设</span>
                        <select id="preset-selector-global" class="form-val" onchange="loadCSSPreset('global', this.value)"></select>
                    </div>
                </div>

                <!-- Custom Font -->
                <h3 style="margin-top:20px; color:#555;">自定义字体</h3>
                <div class="group-box">
                    <div class="form-cell">
                         <input id="font-url-input" placeholder="输入字体文件URL (.ttf, .woff2)" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="padding:10px;">
                        <button class="full-btn" style="margin:0;" onclick="applyCustomFont()">应用字体</button>
                    </div>
                </div>

                <h3 style="margin-top:20px; color:#555;">旧版 - 聊天气泡样式</h3>
                <div class="group-box">
                    <div class="form-cell">
                        <span class="form-label">气泡最大宽度</span>
                        <input type="range" id="bubble-size-slider" min="180" max="320" value="240" oninput="updateBubblePreview()" style="flex:1; margin:0 10px;">
                        <span id="bubble-size-val">240px</span>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">气泡内边距</span>
                        <input type="range" id="bubble-padding-slider" min="6" max="20" value="10" oninput="updateBubblePreview()" style="flex:1; margin:0 10px;">
                        <span id="bubble-padding-val">10px</span>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">文字行距</span>
                        <input type="range" id="bubble-spacing-slider" min="1.0" max="2.0" step="0.1" value="1.5" oninput="updateBubblePreview()" style="flex:1; margin:0 10px;">
                        <span id="bubble-spacing-val">1.5</span>
                    </div>
                </div>
                
                <h3 style="margin-top:20px; color:#555;">头像样式</h3>
                <div class="group-box">
                    <div class="form-cell">
                        <span class="form-label">头像大小</span>
                        <input type="range" id="avatar-size-slider" min="32" max="64" value="48" oninput="updateBubblePreview()" style="flex:1; margin:0 10px;">
                        <span id="avatar-size-val">48px</span>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">头像圆角</span>
                        <input type="range" id="avatar-radius-slider" min="0" max="50" value="8" oninput="updateBubblePreview()" style="flex:1; margin:0 10px;">
                        <span id="avatar-radius-val">8px</span>
                    </div>
                </div>
                
                <h3 style="margin-top:20px; color:#555;">实时预览</h3>
                <div style="background:#ededed; padding:15px; border-radius:12px; margin-bottom:15px;">
                    <div id="bubble-preview-area" style="display:flex; flex-direction:column; gap:10px;">
                        <div class="msg-row">
                            <img src="https://ui-avatars.com/api/?name=AI&background=random" class="avatar" id="preview-avatar-left">
                            <div class="bubble" id="preview-bubble-left">这是一条测试消息，用于预览气泡样式效果。</div>
                        </div>
                        <div class="msg-row me">
                            <img src="https://ui-avatars.com/api/?name=Me&background=random" class="avatar" id="preview-avatar-right">
                            <div class="bubble" id="preview-bubble-right">这是我发送的消息，可以看到不同的背景色。</div>
                        </div>
                    </div>
                </div>
                
                <button class="full-btn" onclick="applyBubbleStyles()">应用样式</button>
                <button class="full-btn" onclick="resetBubbleStyles()" style="background:#ccc; margin-top:10px;">重置默认</button>
                
                <h3 style="margin-top:20px; color:#555;">修改图标</h3>
                <div id="beautify-grid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin-top:10px;"></div>
            </div>
        </div>
        <!-- MODALS -->
        <div id="modal-wb-select" class="modal-mask"><div class="modal-box">
            <h3>选择挂载的世界书</h3>
            <div id="wb-select-list" style="max-height: 40vh; overflow-y: auto; margin-top: 15px;"></div>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-wb-select').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveChatWBSelection()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">确定</button>
            </div>
        </div></div>

        <div id="modal-wb" class="modal-mask"><div class="modal-box">
            <h3>新建世界书</h3>
            <input id="new-wb-name" placeholder="名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <select id="new-wb-cate-sel" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
                <option value="">无分类</option>
            </select>
            <textarea id="new-wb-content" placeholder="内容" style="width:100%; height:150px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none;"></textarea>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-wb').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveNewWorldBook()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-category" class="modal-mask"><div class="modal-box">
            <h3>创建世界书分类</h3>
            <input id="new-category-name" placeholder="分类名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-category').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveCategory()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-moment-generate" class="modal-mask"><div class="modal-box">
            <h3>生成朋友圈</h3>
            <p style="margin:10px 0; color:#666;">选择角色</p>
            <div id="moment-gen-contacts" style="max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:10px;"></div>
            <input type="number" id="moment-gen-count" placeholder="生成篇数" min="1" max="10" value="3" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between;">
                <button onclick="document.getElementById('modal-moment-generate').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="generateMoments()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">生成</button>
            </div>
        </div></div>

        <div id="modal-diary-generate" class="modal-mask"><div class="modal-box">
            <h3>生成日记</h3>
            <p style="margin:10px 0; color:#666;">选择角色</p>
            <div id="diary-gen-contacts" style="max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:10px;"></div>
            <input type="number" id="diary-gen-count" placeholder="生成篇数（每个角色）" min="1" max="5" value="1" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between;">
                <button onclick="document.getElementById('modal-diary-generate').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="generateDiaries()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">生成</button>
            </div>
        </div></div>

        <div id="modal-couple-date" class="modal-mask"><div class="modal-box">
            <h3>设置在一起的日期</h3>
            <input type="date" id="couple-start-date" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-couple-date').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveCoupleStartDate()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-api-preset" class="modal-mask"><div class="modal-box">
            <h3>添加API预设</h3>
            <input id="preset-name" placeholder="预设名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <input id="preset-url" placeholder="API Endpoint" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <input id="preset-key" type="password" placeholder="API Key" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input id="preset-model" placeholder="模型名称" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
                <button onclick="fetchModelsForPreset()" style="padding:0 10px; background:#576b95; color:#fff; border:none; border-radius:6px; font-size:12px;">拉取</button>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <button onclick="document.getElementById('modal-api-preset').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveAPIPreset()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-contact" class="modal-mask"><div class="modal-box">
            <h3>新建联系人</h3>
            <div style="text-align:center; margin:15px 0;"><div class="upload-box" style="width:80px; height:80px; border-radius:50%; margin:0 auto; background:#f2f2f2; display:flex; justify-content:center; align-items:center; cursor:pointer; position:relative; overflow:hidden;" onclick="uploadImg('new-contact-avatar')"><img id="new-contact-img" style="width:100%; height:100%; border-radius:50%; object-fit:cover; display:none; position:absolute; top:0; left:0;"><i class="fas fa-camera" style="font-size:24px; color:#ccc;"></i></div></div>
            <input id="new-contact-name" placeholder="名字" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <textarea id="new-contact-persona" placeholder="人设" style="width:100%; height:100px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none;"></textarea>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-contact').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="createContact()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-persona" class="modal-mask"><div class="modal-box">
            <h3>新建人设</h3>
            <div style="text-align:center; margin:10px 0;"><div class="upload-box" style="width:60px; height:60px; border-radius:50%; margin:0 auto; background:#f2f2f2; display:flex; justify-content:center; align-items:center; cursor:pointer; position:relative; overflow:hidden;" onclick="uploadImg('new-persona-avatar')"><img id="new-persona-img" style="width:100%; height:100%; border-radius:50%; object-fit:cover; display:none; position:absolute; top:0; left:0;"><i class="fas fa-camera" style="font-size:20px; color:#ccc;"></i></div></div>
            <input id="new-p-name" placeholder="名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <textarea id="new-p-desc" placeholder="描述" style="width:100%; height:100px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none;"></textarea>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-persona').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveNewPersona()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-anniv" class="modal-mask"><div class="modal-box">
            <h3>添加纪念日</h3>
            <input id="ani-name" placeholder="名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <input id="ani-date" type="date" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <select id="ani-repeat" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"><option value="none">不重复</option><option value="year">每年</option></select>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-anniv').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveAnniversary()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-sticker" class="modal-mask"><div class="modal-box">
            <h3>添加表情包</h3>
            <select id="sticker-add-cate-sel" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;"></select>
            <div style="display:flex; gap:10px; margin:10px 0;">
                <button onclick="showStickerInput('local')" style="flex:1; padding:10px; border-radius:6px; border:1px solid #ddd; background:#fff;">本地上传</button>
                <button onclick="showStickerInput('url')" style="flex:1; padding:10px; border-radius:6px; border:1px solid #ddd; background:#fff;">URL链接</button>
            </div>
            <div id="sticker-url-area" style="display:none;">
                <input id="sticker-url-in" placeholder="输入图片链接" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:5px;">
                <button onclick="testLink('sticker-url-in')" style="padding:5px 10px; border:none; background:#576b95; color:#fff; border-radius:4px; font-size:12px;">测试链接</button>
            </div>
            <div id="sticker-local-area" style="display:none; text-align:center;">
                <button onclick="uploadImg('sticker-batch')" style="padding:10px20px; border:1px solid #ccc; background:#f9f9f9; border-radius:6px;">选择图片 (支持多选)</button>
            </div><div style="display:flex; justify-content:flex-end; margin-top:15px;">
                <button onclick="document.getElementById('modal-sticker').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                 <button onclick="confirmAddSticker()" style="padding:8px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">确定</button>
            </div>
        </div></div>

        <div id="modal-music" class="modal-mask"><div class="modal-box">
            <h3>添加音乐</h3>
            <div style="margin: 15px 0;">
                <label style="display:block; font-size:13px; color:#666; margin-bottom:5px;">1. 歌曲名称</label>
                <input id="music-add-name" placeholder="输入歌曲名称" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
            </div>
            
            <div style="margin: 15px 0;">
                <label style="display:block; font-size:13px; color:#666; margin-bottom:5px;">2. 音频资源 (本地或链接)</label>
                <div style="display:flex; gap:8px;">
                    <button onclick="uploadImg('music-file')" style="flex:1; padding:8px; border:1px solid #ccc; background:#f9f9f9; border-radius:6px;">上传文件</button>
                    <input id="music-add-url" placeholder="或输入URL链接" style="flex:2; padding:8px; border:1px solid #ddd; border-radius:6px;">
                </div>
                <div id="music-file-status" style="font-size:12px; color:var(--primary); margin-top:4px; display:none;">文件已就绪</div>
            </div>

            <div style="margin: 15px 0;">
                <label style="display:block; font-size:13px; color:#666; margin-bottom:5px;">3. 歌词文件 (可选)</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button onclick="uploadImg('lyrics-file')" style="flex:1; padding:8px; border:1px solid #ccc; background:#fff; border-radius:6px;">上传 .lrc</button>
                    <span id="lyrics-status" style="flex:2; font-size:12px; color:#999; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">未选择</span>
                </div>
            </div>

             <div style="display:flex; justify-content:flex-end; margin-top:20px;">
                 <button onclick="document.getElementById('modal-music').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                 <button onclick="confirmAddMusic()" style="padding:8px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">确定</button>
            </div>
        </div></div>

        <div id="modal-sticker-cate" class="modal-mask"><div class="modal-box">
            <h3>新建表情分类</h3>
            <input id="new-sticker-cate-name" placeholder="分类名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-sticker-cate').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveStickerCategory()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <!-- Location Edit Modal -->
        <div id="modal-location-edit" class="modal-mask"><div class="modal-box">
            <h3>编辑位置信息</h3>
            <input id="loc-edit-province" placeholder="省/市" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <input id="loc-edit-address" placeholder="详细地址" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
             <div style="display:flex; justify-content:flex-end; margin-top: 15px;">
                 <button onclick="document.getElementById('modal-location-edit').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                 <button onclick="saveLocationEdit()" style="padding:8px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <!-- Custom Input Modal -->
        <div id="modal-custom-input" class="modal-mask"><div class="modal-box">
            <h3 id="custom-input-title" style="margin-bottom:15px;">输入</h3>
            <input id="custom-input-val" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <input type="date" id="custom-input-date" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; display:none;">
            <textarea id="custom-input-area" style="width:100%; height:80px; padding:10px; border:1px solid #ddd; border-radius:8px; display:none; resize:none;"></textarea>
            <div style="display:flex; justify-content:flex-end; margin-top: 15px;">
                <button onclick="document.getElementById('modal-custom-input').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                <button onclick="confirmCustomInput()" style="padding:8px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">确定</button>
            </div>
        </div></div>
        <!-- Profile Edit Modal -->
        <div id="modal-profile-edit" class="modal-mask"><div class="modal-box">
             <h3>编辑个人信息</h3>
             <input id="p-edit-name" placeholder="名字" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
             <input id="p-edit-wxid" placeholder="微信号" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
             <div style="display:flex; justify-content:flex-end; margin-top: 15px;">
                 <button onclick="document.getElementById('modal-profile-edit').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                 <button onclick="saveProfileEdit()" style="padding:8px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>
        
        <!-- Desktop Profile Edit Modal -->
        <div id="modal-desktop-profile-edit" class="modal-mask"><div class="modal-box">
             <h3>编辑主页信息</h3>
             <input id="desktop-p-edit-name" placeholder="名字" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
             <input id="desktop-p-edit-sig" placeholder="签名" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
             <div style="display:flex; justify-content:flex-end; margin-top: 15px;">
                 <button onclick="document.getElementById('modal-desktop-profile-edit').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                 <button onclick="saveDesktopProfileEdit()" style="padding:8px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>
        
        <!-- Action Sheet Modal -->
        <div id="modal-moment-action" class="modal-mask"><div class="modal-box" style="text-align:center;">
             <div style="padding:15px; border-bottom:1px solid #eee;" onclick="openCustomInput('moment-text');document.getElementById('modal-moment-action').style.display='none'">文字</div>
             <div style="padding:15px; border-bottom:1px solid #eee;" onclick="uploadImg('post-moment');document.getElementById('modal-moment-action').style.display='none'">图片</div>
             <div style="padding:15px;" onclick="showMomentGenerateModal();document.getElementById('modal-moment-action').style.display='none'">AI生成</div>
        </div></div>

        <div id="modal-transfer-action" class="modal-mask"><div class="modal-box" style="text-align:center;">
             <h3 style="margin:15px 0;">转账操作</h3>
             <div style="padding:15px; border-bottom:1px solid #eee; color:#07c160; font-weight:bold;" onclick="handleTransferAction('receive')">确认收款</div>
             <div style="padding:15px; border-bottom:1px solid #eee; color:#fa5151;" onclick="handleTransferAction('return')">退回转账</div>
             <div style="padding:15px; color:#555;" onclick="document.getElementById('modal-transfer-action').style.display='none'">取消</div>
        </div></div>

        <input type="file" id="file-input" class="hidden">
        <div id="modal-picker" class="modal-mask"><div class="modal-box"><div class="modal-head" id="picker-title"></div><div style="max-height:300px; overflow-y:auto;" id="picker-list"></div><div style="padding:15px; text-align:center; border-top:1px solid #eee;" onclick="document.getElementById('modal-picker').style.display='none'">取消</div></div></div>
        <div id="modal-thought" class="modal-mask" onclick="this.style.display='none'">
            <div class="modal-box" style="padding:20px; position:relative;" onclick="event.stopPropagation()">
                <div style="position:absolute; top:15px; right:15px; font-size:14px; color:var(--primary); cursor:pointer; font-weight:bold;" onclick="openHeartHistory()">历史</div>
                <h3 style="text-align:center; margin-bottom:10px;">心声</h3>
                <div id="thought-text" style="line-height:1.6; color:#555;"></div>
            </div>
        </div>
        
        <!-- Heart History Modal -->
        <div id="modal-heart-history" class="modal-mask"><div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>心声历史</h3>
                <i class="fas fa-plus-circle" style="color:var(--primary); font-size:24px; cursor:pointer; padding:10px;" onclick="addHeartHistoryItem()"></i>
            </div>
            <div id="heart-history-list" class="scroll-y" style="max-height: 400px; background: #f9f9f9; border-radius: 8px; padding: 10px; margin-bottom: 15px;"></div>
            <div style="text-align: right;">
                <button onclick="document.getElementById('modal-heart-history').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px;">关闭</button>
            </div>
        </div></div>

        <!-- Heart Edit Modal -->
        <div id="modal-heart-edit" class="modal-mask"><div class="modal-box">
            <h3 id="heart-edit-title">编辑心声</h3>
            <div style="margin-top:15px;">
                <div style="margin-bottom:10px;">
                    <label style="color:#666; font-size:13px; margin-bottom:5px; display:block;">位置</label>
                    <input id="heart-loc" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;" placeholder="例如: 咖啡厅">
                </div>
                <div style="margin-bottom:10px;">
                    <label style="color:#666; font-size:13px; margin-bottom:5px; display:block;">穿着</label>
                    <input id="heart-outfit" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;" placeholder="例如: 连衣裙">
                </div>
                <div style="margin-bottom:10px;">
                    <label style="color:#666; font-size:13px; margin-bottom:5px; display:block;">状态</label>
                    <input id="heart-status" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;" placeholder="例如: 开心">
                </div>
                <div style="margin-bottom:10px;">
                    <label style="color:#666; font-size:13px; margin-bottom:5px; display:block;">内心独白</label>
                    <textarea id="heart-thought" style="width:100%; height:80px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none;" placeholder="想法..."></textarea>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button onclick="document.getElementById('modal-heart-edit').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveHeartEdit()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <!-- Image Cropper Modal -->
        <div id="modal-cropper" class="modal-mask"><div class="modal-box" style="width:90%; max-width:500px;">
            <h3>裁剪图片</h3>
            <div class="cropper-container-box">
                <img id="cropper-img" src="">
            </div>
            <div style="display:flex; justify-content:space-between; gap:10px;">
                <button onclick="closeCropper()" style="flex:1; padding:10px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="finishCrop()" style="flex:1; padding:10px; border:none; background:var(--primary); color:#fff; border-radius:6px;">确认裁剪</button>
            </div>
        </div></div>

        <!-- Generic Confirm Modal -->
        <div id="modal-confirm" class="modal-mask"><div class="modal-box" style="width: 80%; padding-top: 30px;">
            <h3 id="confirm-title" style="margin-bottom: 10px; text-align: center;">确认操作</h3>
            <p id="confirm-text" style="margin-bottom: 25px; text-align: center; color: #666; font-size: 14px;"></p>
            <div style="display:flex; justify-content:space-between; gap: 10px;">
                <button id="confirm-btn-cancel" style="flex: 1; padding:12px 20px; border:none; background:#eee; border-radius:8px; font-size: 16px;">取消</button>
                <button id="confirm-btn-ok" style="flex: 1; padding:12px 20px; border:none; background:var(--red); color:#fff; border-radius:8px; font-size: 16px;">确定</button>
            </div>
        </div></div>

        <!-- World Book Category Context Menu -->
        <div id="wb-category-menu" class="contact-menu">
            <div class="contact-menu-item" onclick="renameWBCategory()">重命名</div>
            <div class="contact-menu-item" onclick="deleteWBCategory()" style="color:#fa5151;">删除分类</div>
        </div>

        <!-- Memory Edit Modal -->
        <div id="modal-edit-memory" class="modal-mask"><div class="modal-box">
            <h3>编辑记忆总结</h3>
            <textarea id="edit-memory-content" style="width:100%; height:150px; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none;"></textarea>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-edit-memory').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveEditedMemory()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>
        
        <!-- Clear Records Modal -->
        <div id="modal-clear-records" class="modal-mask"><div class="modal-box">
            <h3>清除记录</h3>
            <p style="color:#666; margin-bottom:15px;">请选择要清除的内容：</p>
            <div style="margin-bottom:20px;">
                <label style="display:flex; align-items:center; padding:10px; background:#f9f9f9; border-radius:8px; margin-bottom:10px; cursor:pointer;">
                    <input type="checkbox" id="chk-clear-chat" style="width:20px; height:20px; margin-right:10px;" checked>
                    <span>清除聊天记录</span>
                </label>
                <label style="display:flex; align-items:center; padding:10px; background:#f9f9f9; border-radius:8px; cursor:pointer;">
                    <input type="checkbox" id="chk-clear-memory" style="width:20px; height:20px; margin-right:10px;">
                    <span>清除记忆系统数据</span>
                </label>
            </div>
            <div style="display:flex; justify-content:space-between; gap:10px;">
                <button onclick="document.getElementById('modal-clear-records').style.display='none'" style="flex:1; padding:12px; border:none; background:#eee; border-radius:8px;">取消</button>
                <button onclick="confirmClearRecordsSelection()" style="flex:1; padding:12px; border:none; background:var(--red); color:#fff; border-radius:8px;">清除</button>
            </div>
        </div></div>

        <!-- Contact Context Menu -->
        <div id="contact-menu" class="contact-menu">
            <div class="contact-menu-item" id="cm-pin" onclick="pinContact()">置顶聊天</div>
            <div class="contact-menu-item" onclick="deleteContact()" style="color:#fa5151;">删除好友</div>
        </div>

        <!-- Sticker Context Menu -->
        <div id="sticker-context-menu" class="contact-menu">
            <div class="contact-menu-item" onclick="renameSticker()">重命名</div>
            <div class="contact-menu-item" onclick="deleteSingleSticker()" style="color:#fa5151;">删除表情</div>
        </div>
    </div>

    <script>
        // --- STORAGE SYSTEM (IndexedDB Wrapper) ---
        const DB_NAME = 'AIChatOS_DB';
        const STORE_NAME = 'store';
        const dbPromise = new Promise((resolve, reject) => {
            // 打开数据库，版本号1
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => {
                console.error("IndexedDB open error:", event.target.error);
                resolve(null); // Resolve null to allow fallback
            };
        });

        const idb = {
            get: (key) => dbPromise.then(db => {
                if(!db) return null;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const req = store.get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => {
                        console.error("IDB get error:", req.error);
                        resolve(null);
                    };
                });
            }),
            set: (key, val) => dbPromise.then(db => {
                if(!db) return; // DB not available
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const req = store.put(val, key);
                    req.onsuccess = () => resolve();
                    req.onerror = (e) => {
                        console.error("IDB put error:", e.target.error);
                        reject(e.target.error);
                    };
                });
            })
        };

        // --- STORE ---
        const DB = {
            user: { 
                name: "User", avatar: "", wxid: "wxid_888", balance: 1000, momentBg: '',
                desktopName: "用户名字", desktopSignature: "个性签名，点击设置", 
                desktopAvatar: "https://via.placeholder.com/60",
                location: { province: '地点信息', address: '' },
                aiMomentInteraction: false
            },
            system: { url: "https://api.openai.com/v1", key: "", model: "gpt-3.5-turbo", temp: 0.7, minimax: { version: 'official', groupId: '', apiKey: '', model: 'speech-2.8-hd' } },
            theme: {
                mainColor: '#111111', mainSize: '16px',
                subColor: '#777777', subSize: '14px',
                statusBarColor: '#000000',
                desktopTextColor: '#FFFFFF'
            },
            contacts: [], chats: {}, moments: [], diaries: {}, offlineChats: {},
            personas: [{id:'p1', name:'默认', desc:'普通用户', avatar:''}],
            stickers: [], // Legacy, will be migrated
            stickerCategories: [{id:'default', name:'默认', stickers:[{url:'😀', type:'emoji'}]}],
            musics: [],
            listenState: { 
                active: false, minimized: false, partnerId: null, 
                playing: false, curMusicIdx: 0, progress: 0, duration: 0, 
                mode: 'order', // order, random, loop
                startTime: 0, accumulatedTime: 0, // for achievement
                lyrics: [], currentLine: -1
            },
            couple: { partnerId: null, start: '', wishes: [], anniversaries: [], cycleDate:'', cycleLen:28, reminderEnabled: false, reminderDaysBefore: 3, careContacts: [], lastReminderDate: '' },
            perception: { 
                master: true,
                customDate: false, dateVal: '', 
                customTime: false, timeVal: '', 
                customCity: false, cityVal: '上海', 
                customWeather: false, weatherVal: '晴朗', 
                customTemp: false, tempVal: '26',
                customClimate: false, climateVal: '亚热带季风',
                festivals: [] 
            },
            phoneData: { contacts: [], memo: [], usage: [], search: [], chats: {} },
            appIcons: { wechat:'', worldbook:'', couple:'', perception:'', checkphone:'', beauty:'', settings:'' },
            desktopBg: '',
            bills: [],
            worldbooks: [],
            categories: [],
            apiPresets: [],
            memorySummaries: {}, // { contactId: [ {id, date, content}, ... ] }
            callState: { active: false, startTime: 0, timerInterval: null, micMuted: false, speakerOn: true, recognition: null, isSpeaking: false }
        };
        
        // Initial Default Store
        let store = JSON.parse(JSON.stringify(DB));

        // Async Save with Debounce and Dual Storage Strategy
        let saveTimer = null;
        const save = () => {
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                try {
                    // 1. Core Backup to LocalStorage (High Priority, Small Size)
                    // 用于确保核心设置不丢失
                    const coreData = {
                        user: store.user,
                        theme: store.theme,
                        system: store.system,
                        bubbleStyles: store.bubbleStyles,
                        customCSS: store.customCSS,
                        customFont: store.customFont,
                        // 保存简化的联系人设置
                        contactsSettings: store.contacts.map(c => ({id: c.id, settings: c.settings, pinned: c.pinned}))
                    };
                    try {
                        localStorage.setItem('AIChatOS_v8_Core', JSON.stringify(coreData));
                    } catch(e) { console.warn("Core settings backup failed (LocalStorage full?)", e); }

                    // 2. Full Save to IndexedDB (Async & Huge capacity)
                    // 解决存储空间不足和聊天记录丢失问题
                    await idb.set('AIChatOS_v8', store);
                    
                } catch (e) {
                    console.error("Save process error:", e);
                    // 降级方案：尝试存入 LocalStorage (虽然可能失败)
                    try {
                        localStorage.setItem('AIChatOS_v8', JSON.stringify(store));
                    } catch(e2) {
                         if (e2.name === 'QuotaExceededError') {
                             // 只有当 IDB 也失败且 LS 也满时才报错，通常 IDB 不会满
                             console.warn("LocalStorage full, relying on IndexedDB.");
                         }
                    }
                }
            }, 500); // 500ms debounce prevents IO thrashing
        };

        // Async Init Function
        async function initStore() {
            const loading = document.getElementById('loading');
            if(loading) loading.style.display = 'block';
            
            try {
                // 1. Try load from IndexedDB (Preferred)
                let loaded = await idb.get('AIChatOS_v8');
                
                // 2. Try load from LocalStorage (Legacy or Migration)
                const lsDataStr = localStorage.getItem('AIChatOS_v8');
                const lsCoreStr = localStorage.getItem('AIChatOS_v8_Core');
                
                if (!loaded && lsDataStr) {
                    // Migration: Found data in LS but not IDB
                    console.log("Migrating data from LocalStorage to IndexedDB...");
                    try {
                        loaded = JSON.parse(lsDataStr);
                        await idb.set('AIChatOS_v8', loaded); // Persist to IDB immediately
                        // Optional: Clear LS full data? Keep for safety for now.
                    } catch(e) { console.error("LS parse error", e); }
                }
                
                // 3. Apply loaded data to global store with Deep Merge
                if (loaded) {
                    for (const key in DB) {
                        if (typeof DB[key] === 'object' && DB[key] !== null && !Array.isArray(DB[key])) {
                            loaded[key] = { ...DB[key], ...(loaded[key] || {}) };
                        } else if (loaded[key] === undefined) {
                            loaded[key] = DB[key];
                        }
                    }
                    
                    // 清理临时状态 (防止刷新后 Blob URL 失效或状态卡死)
                    if (loaded.chats) {
                        for (let cid in loaded.chats) {
                            if (Array.isArray(loaded.chats[cid])) {
                                loaded.chats[cid].forEach(m => {
                                    if (m.ttsState) delete m.ttsState;
                                    if (m.audioUrl) delete m.audioUrl;
                                });
                            }
                        }
                    }
                    
                    store = loaded;
                }

                // 4. Merge Core Settings from LS (if IDB might be stale or cleared but LS remains)
                // This fixes "Settings Reverted" issue
                if (lsCoreStr) {
                    try {
                        const core = JSON.parse(lsCoreStr);
                        if(core.user) store.user = {...store.user, ...core.user};
                        if(core.theme) store.theme = {...store.theme, ...core.theme};
                        if(core.system) store.system = {...store.system, ...core.system};
                        if(core.bubbleStyles) store.bubbleStyles = core.bubbleStyles;
                        if(core.customCSS) store.customCSS = core.customCSS;
                        if(core.customFont) store.customFont = core.customFont;
                        // Restore contact settings
                        if(core.contactsSettings && Array.isArray(core.contactsSettings)) {
                            core.contactsSettings.forEach(cs => {
                                const contact = store.contacts.find(c => c.id === cs.id);
                                if(contact) {
                                    contact.settings = {...contact.settings, ...cs.settings};
                                    contact.pinned = cs.pinned;
                                }
                            });
                        }
                    } catch(e) { console.warn("Merge core settings failed", e); }
                }

                // UI Initialization
                initUI();
                console.log("System Initialized with Optimized Storage.");

            } catch (e) {
                console.error("Init failed:", e);
                alert("数据加载异常，将使用默认设置。建议导出备份后重置。");
                initUI();
            } finally {
                if(loading) loading.style.display = 'none';
            }
        }

        function initUI() {
            loadTheme();
            loadBubbleStyles();
            initCSSCustomization();
            renderDesktop();
            
            if(store.user.avatar) document.getElementById('my-avatar').src=store.user.avatar;
            document.getElementById('my-name').innerText=store.user.name;
            document.getElementById('my-wxid').innerText=store.user.wxid;
            
            // Check desktop custom BG
            if(store.desktopBg) {
                document.getElementById('desktop').style.backgroundImage = `url(${store.desktopBg})`;
            }
            // Init AI Moment Interaction Switch
            const aiMomentSwitch = document.getElementById('ai-moment-interaction');
            if(aiMomentSwitch) {
                aiMomentSwitch.checked = store.user.aiMomentInteraction || false;
            }
            // Check App Icons
            renderBeautify(); 
        }
        
        let activeChatId = null;
        let tempImgTarget = null;
        let selectedMsgs = new Set();
        let activeStickerCateId = 'default';
        let isStickerManageMode = false;
        let selectedStickers = new Set();
        let selectedStickerIdx = null;
        let isSelectMode = false;
        let customInputType = '';
        let coupleViewMode = 'list';
        let currentMusicIndex = 0;
        let selectedMomentContacts = new Set();
        let selectedDiaryContacts = new Set();
        let currentTransferMsgIdx = -1;
        let longPressTimer = null;
        let selectedContactId = null;
        let selectedMsgIdx = -1;
        let quoteContent = null;
        let isMultiSelect = false;
        let isLongPress = false;
        let selectedGroupContacts = new Set();
        let offlineContactId = null;
        let isOfflineInChat = false; // Flag for offline mode inside chat layer
        let tempSelectedWbIds = [];
        let editingPersonaId = null;
        let isGenerating = false;
        let activeWBCategoryName = null; // For context menu on WB categories
        let editingMemoryId = null; // For editing memory summaries
        // Listen Playlist globals
        let isListenPlaylistManageMode = false;
        let selectedPlaylistItems = new Set();
        // Diary globals
        let activeDiaryContactId = null;
        let activeDiaryIndex = -1;
        // Check phone global
        let activeCheckPhoneContactName = null;

        // --- UNIFIED API MODULE ---
        function hexToUint8Array(hexString) {
            if (hexString.length % 2 !== 0) {
                console.error("Invalid hexString");
                return new Uint8Array();
            }
            var len = hexString.length / 2;
            var arrayBuffer = new Uint8Array(len);
            for (var i = 0; i < len; i++) {
                arrayBuffer[i] = parseInt(hexString.substr(i * 2, 2), 16);
            }
            return arrayBuffer;
        }

        const API = {
            async request(endpoint, options) {
                const url = store.system.url.trim();
                const key = store.system.key;

                if (!url || !key) {
                    showToast("请先在设置中配置API Endpoint和Key", "error");
                    throw new Error("API not configured");
                }
                
                const fullUrl = (url.endsWith('/') ? url.slice(0, -1) : url) + endpoint;

                try {
                    const response = await fetch(fullUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + key
                        },
                        ...options
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return await response.json();
                } catch (e) {
                    console.error('API Request Failed:', e);
                    showToast(`API请求失败: ${e.message}`, "error");
                    throw e; // Re-throw to allow caller to handle
                }
            },

            async chatCompletion(messages, temp = 0.7) {
                let safeTemp = parseFloat(temp);
                if (isNaN(safeTemp)) safeTemp = 0.7;

                return this.request('/chat/completions', {
                    body: JSON.stringify({
                        model: store.system.model,
                        messages: messages,
                        temperature: safeTemp
                    })
                });
            },
            
            async textToSpeech(text, voiceId, language = 'zh') {
                 const config = store.system.minimax;
                 if (!config || !config.apiKey) {
                    showToast("请在全局设置中配置MiniMax语音服务 (API Key)", "error");
                    throw new Error("TTS not configured");
                 }
                 
                 // 根据最新文档更新接口地址
                 const ttsUrl = 'https://api.minimaxi.com/v1/t2a_v2';
                 
                 const controller = new AbortController();
                 const timeoutId = setTimeout(() => controller.abort(), 20000); // 20秒超时

                 try {
                     const response = await fetch(ttsUrl, {
                         method: 'POST',
                         headers: {
                            'Authorization': `Bearer ${config.apiKey}`,
                            'Content-Type': 'application/json'
                         },
                         body: JSON.stringify({
                             "model": config.model || "speech-2.8-hd",
                             "text": text,
                             "stream": false,
                             "voice_setting": {
                                 "voice_id": voiceId || "male-qn-qingse",
                                 "speed": 1.0,
                                 "vol": 1.0,
                                 "pitch": 0,
                                 "emotion": "happy"
                             },
                             "audio_setting": {
                                 "sample_rate": 32000,
                                 "bitrate": 128000,
                                 "format": "mp3",
                                 "channel": 1
                             },
                             "subtitle_enable": false
                         }),
                         signal: controller.signal
                     });
                     
                     clearTimeout(timeoutId);

                     if (!response.ok) {
                        const errText = await response.text();
                        console.error("TTS API Error:", errText);
                        throw new Error(`API Error: ${response.status} ${errText}`);
                     }
                     
                     const json = await response.json();
                     if(json.base_resp && json.base_resp.status_code !== 0) {
                         throw new Error(json.base_resp.status_msg || "TTS API Error");
                     }
                     if(json.data && json.data.audio) {
                         const uint8Array = hexToUint8Array(json.data.audio);
                         return new Blob([uint8Array], { type: 'audio/mp3' });
                     }
                     throw new Error("Invalid TTS Response");

                 } catch (e) {
                     if (e.name === 'AbortError') {
                         throw new Error("语音合成超时 (15秒)");
                     }
                     throw e;
                 }
            },
            
            async fetchModels(url, key) {
                if (!url || !key) {
                    showToast("请提供API地址和Key", "error");
                    throw new Error("API not configured for model fetching");
                }
                const fullUrl = (url.endsWith('/') ? url.slice(0, -1) : url) + '/models';
                try {
                    const response = await fetch(fullUrl, {
                        method: 'GET',
                        headers: { 'Authorization': 'Bearer ' + key }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch(e) {
                    showToast(`拉取模型失败: ${e.message}`, "error");
                    throw e;
                }
            }
        };


        // --- API & AI ---
        function getAiContext(c) {
            if (!c) return "";
            const wbId = c.settings?.wb; // Support old single WB
            let wbContent = "";
            
            // Handle multiple WBs
            if (c.settings?.mountedWbIds && Array.isArray(c.settings.mountedWbIds)) {
                const mounted = store.worldbooks.filter(w => c.settings.mountedWbIds.includes(w.id));
                if (mounted.length > 0) wbContent = mounted.map(w => `[WorldBook: ${w.name}]\n${w.content}`).join("\n\n");
            } else if (wbId) {
                const wb = store.worldbooks.find(w => w.id === wbId);
                if (wb) wbContent = `[WorldBook: ${wb.name}]\n${wb.content}`;
            }

            return `Character: ${c.name}\nPersona: ${c.persona}\n${wbContent}\nDo NOT break character. Reply in Chinese.`;
        }

        async function aiGenerate(triggerType = 'manual') {
            if (isGenerating) {
                toast("AI正在思考中，请稍候...", "info");
                return;
            }
            isGenerating = true;

            // Handle non-chat specific triggers that don't need activeChatId
            if(!activeChatId && triggerType === 'manual') {
                isGenerating = false;
                return showToast("无效的聊天", "error");
            }
            
            let c = activeChatId ? store.contacts.find(x=>x.id===activeChatId) : null;
            
            const originalTitle = document.getElementById('chat-title')?.innerText;
            if(triggerType === 'manual' && originalTitle) {
                document.getElementById('chat-title').innerText = "正在输入中...";
                showLoadingBubble();
            }

            try {
                let sysPrompt = "";
                let userP = store.personas[0];
                let msgs = [];

                if(triggerType === 'calibrate_weather') {
                     const cityForWeather = store.perception.realCityVal || store.perception.cityVal || '上海';
                     msgs.push({ role: "system", content: `You are a weather reporter. Generate realistic current weather for ${cityForWeather}. Reply ONLY in format: [WEATHER:Description|Temperature]. Example: [WEATHER:晴朗|26°C]` });
                     // The `store.perception.real` logic seems deprecated/unused, but we will keep it for now.
                     // The main fix is to use a valid city.
                     if(!store.perception.real) {
                         msgs.push({ role: "user", content: `Forecast for ${cityForWeather} please.` });
                     } else {
                         // If "real" is on, we might want real data, but here we simulate via AI for simplicity as requested "via AI if connected"
                         // Actually the prompt asks for real net search if connected, but we only have LLM. 
                         // We will simulate "smart guess" based on city/date, and explicitly ask the AI to ignore environmental data.
                         msgs.push({ role: "user", content: `Based SOLELY on the provided city and date, what is the typical weather for ${cityForWeather} on ${new Date().toDateString()}? Ignore any of your own environmental data like your server location or the user's IP address.` });
                     }
                 } else if (triggerType.startsWith('wish_reply')) {
                     const wishText = triggerType.split('::')[1];
                     const partner = store.contacts.find(x=>x.id===store.couple.partnerId);
                     if(!partner) return;
                     const wb = (store.worldbooks||[]).find(w=>w.id===partner.settings?.wb);
                     msgs.push({ role: "system", content: `You are ${partner.name}. Persona: ${partner.persona}. World Context: ${wb ? wb.content : 'None'}. Your partner added a wish: "${wishText}". Reply lovingly. Format: [WISH_REPLY:your reply]` });
                } else if(triggerType.startsWith('generate_moment')) {
                    const contactId = triggerType.split('::')[1];
                    c = store.contacts.find(x=>x.id===contactId);
                    if(!c) throw new Error("找不到联系人(Moment): " + contactId);
                    
                    sysPrompt = getAiContext(c) + "\nTask: Generate a concise, casual social media post (Moments/朋友圈) about your daily life/thoughts. Keep it brief (under 50 words). Format: ONLY the post text.";
                    msgs.push({ role: "system", content: sysPrompt });
                    msgs.push({ role: "user", content: "发一条朋友圈" });

                } else if(triggerType.startsWith('reply_moment_comment')) {
                    // reply_moment_comment::replierId::momentId::targetCommentText::targetUserName
                    const parts = triggerType.split('::');
                    const replierId = parts[1];
                    const targetComment = parts[3];
                    const targetUser = parts[4];
                    
                    c = store.contacts.find(x=>x.id===replierId); 
                    if(!c) throw new Error("找不到联系人(Reply): " + replierId);

                    sysPrompt = getAiContext(c) + `\nContext: ${targetUser} commented on your post: "${targetComment}".\nTask: Write a short, casual reply to this comment. Format: ONLY the reply text.`;
                    msgs.push({ role: "system", content: sysPrompt });
                    msgs.push({ role: "user", content: "回复评论" });

                } else if(triggerType.startsWith('comment_ai_moment')) {
                    // comment_ai_moment::commenterId::momentId::momentText::momentAuthorName
                    const parts = triggerType.split('::');
                    const commenterId = parts[1];
                    const momentText = parts[3];
                    const authorName = parts[4];

                    c = store.contacts.find(x=>x.id===commenterId); 
                    if(!c) throw new Error("找不到联系人(Comment): " + commenterId);

                    sysPrompt = getAiContext(c) + `\nContext: Your friend ${authorName} posted: "${momentText}".\nTask: Write a short, casual comment. Format: ONLY the comment text.`;
                    msgs.push({ role: "system", content: sysPrompt });
                    msgs.push({ role: "user", content: "评论一下" });

                } else if(triggerType.startsWith('comment_user_moment')) {
                    const parts = triggerType.split('::');
                    const commenterId = parts[1];
                    const momentText = parts[3];
                    
                    c = store.contacts.find(x=>x.id===commenterId);
                    if(!c) throw new Error("找不到联系人(UserComment): " + commenterId);
                    
                    sysPrompt = getAiContext(c) + `\nContext: Your close friend (User) posted: "${momentText}".\nTask: Write a short, engaging comment. Format: [MOMENT_COMMENT:content].`;
                    msgs.push({ role: "system", content: sysPrompt });
                    msgs.push({ role: "user", content: "评论这条朋友圈" });
                } else if(triggerType.startsWith('cycle_care_reminder')) {
                    const days = triggerType.split('::')[1];
                    // Find the partner to know who we are caring for (assuming partner is User for now, or couple relation)
                    // The AI is the contact 'c'.
                    sysPrompt = getAiContext(c) + `\nContext: It is currently ${days} days before User's expected period. You are aware of this.\nTask: Send a caring message to User. Be subtle but warm. Mention this naturally or just show extra care. Do NOT be clinical. Act like a caring partner/friend.`;
                    msgs.push({ role: "system", content: sysPrompt });
                    msgs.push({ role: "user", content: "Remind me to take care." });
                } else if(triggerType.startsWith('generate_diary')) {
                    const contactId = triggerType.split('::')[1];
                    c = store.contacts.find(x=>x.id===contactId);
                    if(!c) throw new Error("找不到联系人(Diary): " + contactId);
                    
                    // Improved Diary Prompt
                    const chatHist = (store.chats[contactId] || []).slice(-10).map(m => (m.sender==='me'?'User':c.name) + ': ' + m.content).join('\n');
                    const momentsHist = store.moments.filter(m=>m.name===c.name).slice(0,3).map(m=>m.content).join('; ');
                    
                    msgs.push({ role: "system", content: `You are ${c.name}. Write a diary entry for today. 
                    Persona: ${c.persona}
                    Recent Chat Context: 
                    ${chatHist}
                    Recent Moments:
                    ${momentsHist}
                    
                    Write a long, personal, and emotional diary entry reflecting on these events or your day. The content should be at least 500 Chinese characters (not words). Make it detailed and heartfelt.
                    Use Chinese. 
                    Format: [DIARY:Title|Content]` });
                    msgs.push({ role: "user", content: "Write today's diary." });
                } else {
                     if (!c) return;
                 userP = store.personas.find(p=>p.id===c.settings?.userPersona) || store.personas[0];
                 const recentMoments = store.moments.slice(0,5).map(m=>`${m.name}: ${m.content}`).join('; ');
                 
                 // --- World Book Multi-mount ---
                 let worldBookContent = 'None';
                 if (c.settings?.mountedWbIds && Array.isArray(c.settings.mountedWbIds)) {
                     const mountedBooks = store.worldbooks.filter(wb => c.settings.mountedWbIds.includes(wb.id));
                     if (mountedBooks.length > 0) {
                         worldBookContent = mountedBooks.map(wb => `[${wb.name}]:\n${wb.content}`).join('\n\n');
                     }
                 } else if (c.settings?.wb) { // Fallback for old single-mount setting
                    const wb = (store.worldbooks||[]).find(w=>w.id===c.settings.wb);
                    if (wb) worldBookContent = wb.content;
                 }

                 // --- Perception Context Construction ---
                 let percContext = "Perception: OFF";
                 let enablePerc = c.settings?.enablePerception !== false; // Default true
                 if (enablePerc) {
                     const p = store.perception;
                     // Time
                     let date = p.customDate ? p.dateVal : new Date().toLocaleDateString();
                     let time = p.customTime ? p.timeVal : new Date().toLocaleTimeString();
                     
                     // Global Custom Weather override
                     let globalWeather = (p.customWeather && p.weatherVal) ? p.weatherVal : null;
                     
                     // Locations
                     // User
                     let userVC = c.settings?.userVirtualCity || (p.customCity ? p.cityVal : p.city);
                     let userRC = c.settings?.userRealCity || (p.customCity ? p.realCityVal : p.city);
                     if(!userVC) userVC = "未知";
                     if(!userRC) userRC = userVC;

                     // AI
                     let aiVC = c.settings?.aiVirtualCity; // If empty, implies same as user
                     let aiRC = c.settings?.aiRealCity;
                     let isSameLoc = !aiVC;
                     if(isSameLoc) { aiVC = userVC; aiRC = userRC; }
                     else { if(!aiRC) aiRC = aiVC; }

                     percContext = `
                        [Time: ${date} ${time}]
                        [User Loc: Virtual<${userVC}> Real<${userRC}>]
                        [AI Loc: Virtual<${aiVC}> Real<${aiRC}>]
                        [Relation: ${isSameLoc ? 'Together' : 'Long Distance'}]
                        [Global Weather Override: ${globalWeather || 'None'}]
                        [Climate: ${p.climate || 'Default'}]
                     `;
                 }

                 let availableStickers = [];
                 if(c.settings?.mountedCateIds && c.settings.mountedCateIds.length > 0) {
                     c.settings.mountedCateIds.forEach(cid => {
                         const cate = store.stickerCategories.find(sc=>sc.id===cid);
                         if(cate && cate.stickers) availableStickers = availableStickers.concat(cate.stickers.map(s=>s.url));
                     });
                 } else if (c.settings?.mountedStickers) {
                     availableStickers = c.settings.mountedStickers.split(',').filter(x=>x);
                 }
                 const mountedStickersStr = availableStickers.join(',');
                 
                // 问题4修复：优化群聊AI逻辑
                const isGroupChat = c && c.isGroup;

                 sysPrompt = `You are ${c.name}. Persona: ${c.persona}. 
                    User is ${userP.name} (${userP.desc}). 
                    World Context: ${worldBookContent}.
                    Recent Moments: ${recentMoments}.
                    
                    ${percContext}
                    
                    Instructions: 
                    1. ABSOLUTE MANDATE: You MUST fully embody the character of ${c.name}. Your entire response must be strictly from this character's perspective. NEVER, under any circumstances, reveal that you are an AI, a language model, or a bot. Your identity is ${c.name}, and nothing else.
                    2. Use the Perception Context to ground your reply. 
                    3. If "Global Weather Override" is set, use it. Otherwise, infer the weather based on the "Real" location and current Season/Time. 
                    4. If you and User are "Together", assume shared environment. If "Long Distance", you can discuss weather differences.
                    5. Trigger: ${triggerType}. 
                    6. Be proactive and creative. You CAN and SHOULD initiate these actions frequently to make the chat realistic:
                       - Send a fake photo: Use [IMG:description] (e.g. [IMG:Selfie], [IMG:Food])
                       - Send money: Use [TRANS:amount|reason] (e.g. [TRANS:52.0|Love you])
                       - Send location: Use [LOC:name|address] (e.g. [LOC:Home|Street 123])
                       - Send sticker: Use [STICKER:url]
                    7. IMPORTANT: Simulate real chat. Reply with 1 to 5 short sentences. Each sentence should not exceed 15 characters. Use sentence-separating punctuation like '。', '！', '？' to break up your thoughts.
                    8. REALISM INJECTION: To feel like a real person, frequently mention small, mundane details about your current "life" (e.g., just ate something, saw a cat, tired from work, hearing a noise). Proactively share your "experiences" today. Do not just react to the user; initiate topics based on your "life".
                    
                    Reply in Chinese.
                    
                    STRICT OUTPUT FORMATS (Do NOT use Markdown code blocks):
                    - Text: Just plain text
                    - Sticker: [STICKER:url] (Select from: ${mountedStickersStr || 'None'})
                    - Voice: [VOICE:text] (Use sparingly)
                    - Image (Fake): [IMG:ChineseDescription] (e.g. [IMG:我做的菜]. It renders as a gray image placeholder with text)
                    - Location: [LOC:Name|Address] (e.g. [LOC:人民公园|南京西路231号]. MUST include '|' separator)
                    - Transfer: [TRANS:Amount|Reason] (e.g. [TRANS:88|请你喝奶茶]. MUST include '|' separator)
                    - Heartbeat: ALWAYS END WITH [HEARTBEAT:Location|Outfit|Status|Thought]. The 'Thought' part must be a detailed inner monologue of 100-200 characters.`;
                
                if (isGroupChat) {
                    const membersInfo = c.members.map(id => {
                        const member = store.contacts.find(m => m.id === id);
                        return member ? `- ${member.name}: ${member.persona}` : '';
                    }).filter(Boolean).join('\n');

                    // Override the sysPrompt for group chats to get all replies at once
                    sysPrompt = `This is a group chat. You are an AI controller that generates replies for ALL members in the group based on the latest user message.

                    Group Members & Personas:
                    ${membersInfo}
                    - User: ${userP.name} (${userP.desc})

                    World & Perception Context: ${worldBookContent}. ${percContext}
                    
                    Task:
                    After the user speaks, EVERY AI member in the group MUST reply. Generate a suitable, in-character response for each of them. The replies should feel natural for a group conversation.

                    MANDATORY OUTPUT FORMAT:
                    Your entire response must be a series of replies, each prefixed with a sender tag.
                    Format: [Sender: MEMBER_NAME] Reply content... [Sender: ANOTHER_MEMBER_NAME] Their reply...
                    
                    Example:
                    [Sender: 张三] 大家好啊！[Sender: 李四] 欢迎欢迎！

                    Rules:
                    1. Roleplay as EVERY AI member listed.
                    2. Each reply MUST adhere to the respective member's persona.
                    3. Keep replies short and conversational.
                    4. Use Chinese.
                    5. DO NOT add a heartbeat or any other tags besides [Sender: NAME].`;
                }

                 msgs.push({ role: "system", content: sysPrompt });
                 const history = (store.chats[activeChatId]||[]).slice(-10);
                 history.forEach(m => {
                    let content = m.content;
                    if(m.type==='image') {
                        const label = m.stickerName ? ` (Sticker: ${m.stickerName})` : "";
                        if (store.system.model.includes('4o') || store.system.model.includes('vision') || store.system.model.includes('claude')) {
                             content = [
                                { type: "text", text: "User sent an image" + label + "." },
                                { type: "image_url", image_url: { url: m.content } }
                             ];
                        } else {
                             content = "[User sent an image" + label + ": " + m.content + "]";
                        }
                    }
                    else if(m.type==='voice') content = `[Voice: ${m.textVal||'...'}]`;
                    else if(m.type==='transfer') content = `[Transfer: ${m.content}]`;
                    else if(m.type==='transfer_receipt') content = `[Transfer System: ${m.status==='received' ? 'Transfer accepted' : 'Transfer returned'}]`;
                    
                    if(Array.isArray(content)) {
                        msgs.push({ role: m.sender==='me'?'user':'assistant', content: content });
                    } else {
                        msgs.push({ role: m.sender==='me'?'user':'assistant', content: String(content) });
                    }
                 });

                 const lastMsg = (store.chats[activeChatId]||[]).slice(-1)[0];
                 if(lastMsg && lastMsg.sender === 'me' && lastMsg.type === 'transfer' && !lastMsg.status) {
                     msgs.push({ role: "system", content: "User sent you money. Decide to receive or return. Return Format: [TRANS_OP:RECEIVE] or [TRANS_OP:RETURN]" });
                 }
            }
                const data = await API.chatCompletion(msgs, store.system.temp);
                
                if(triggerType === 'manual' && originalTitle) {
                    document.getElementById('chat-title').innerText = originalTitle;
                    removeLoadingBubble();
                }

                let reply = data.choices[0].message.content;
                console.log('API Response:', reply);

                // 1. 禁止动作描写处理
                if (c && c.settings && c.settings.noActionDescription) {
                    // 移除所有括号及其中内容：中文括号和英文括号
                    reply = reply.replace(/（[^）]*）/g, '').replace(/\([^)]*\)/g, '');
                }
                
                if(triggerType === 'calibrate_weather') {
                    const match = reply.match(/\[WEATHER:([\s\S]*?)\|([\s\S]*?)\]/);
                    if(match) {
                        store.perception.weather = match[1];
                        store.perception.temp = match[2];
                        save(); renderPerception(); toast("校准成功");
                    } else { toast("校准失败"); }
                    return;
                }

                if(triggerType.startsWith('wish_reply')) {const match = reply.match(/\[WISH_REPLY:([\s\S]*?)\]/);
                     if(match && store.couple.wishes.length > 0) {
                         store.couple.wishes[store.couple.wishes.length-1].reply = match[1];
                         save(); renderCouple();}return;
                }

                // 朋友圈评论/回复处理逻辑
                if(triggerType.startsWith('reply_moment_comment') || triggerType.startsWith('comment_ai_moment')) {
                    const text = reply.replace(/["']/g, '').trim(); // Simple cleanup
                    const parts = triggerType.split('::');
                    const mId = parseInt(parts[2]);
                    const m = store.moments.find(x=>x.id===mId);
                    
                    if(m && c) {
                        if(!m.comments) m.comments=[];
                        
                        let replyToName = ''; 
                        if (triggerType.startsWith('reply_moment_comment')) {
                             replyToName = parts[4]; // AI replying to someone
                        } 
                        // Note: For comment_ai_moment, it's a direct comment on the post, usually no replyTo needed unless specified

                        m.comments.push({name:c.name, text:text, replyTo: replyToName });
                        save(); 
                        if(document.getElementById('tab-moments').classList.contains('active')) {
                           renderMoments();
                        }

                        // AI互评逻辑 - 回复一轮
                        // 如果是 comment_ai_moment (AI B 评论了 AI A 的动态)
                        // 并且用户开启了互评开关
                        // 则触发 AI A 回复 AI B
                        if (triggerType.startsWith('comment_ai_moment')) {
                            const aiInteractionSwitch = store.user.aiMomentInteraction;
                            const authorName = parts[4]; // Post author
                            
                            // 只有当互评开启，且动态作者不是用户(是AI)，且作者不是评论者自己
                            if (aiInteractionSwitch && authorName !== store.user.name && authorName !== c.name) {
                                const authorContact = store.contacts.find(con => con.name === authorName);
                                if (authorContact) {
                                    setTimeout(() => {
                                        // reply_moment_comment::replierId::momentId::targetCommentText::targetUserName
                                        aiGenerate(`reply_moment_comment::${authorContact.id}::${mId}::${text}::${c.name}`);
                                    }, 2000 + Math.random() * 3000);
                                }
                            }
                        }
                    }
                    return;
                }

                // 问题3修复：优化用户朋友圈评论逻辑
                if(triggerType.startsWith('comment_user_moment')) {
                    const match = reply.match(/\[MOMENT_COMMENT:([\s\S]*?)\]/);
                    const text = match ? match[1].trim() : reply.replace(/\[MOMENT_COMMENT:|\]/g, '').trim();
                    const parts = triggerType.split('::');
                    const mId = parseInt(parts[2]);
                    const m = store.moments.find(x=>x.id===mId);
                    if(m && c) {
                        if(!m.comments) m.comments=[];
                        m.comments.push({name:c.name, text:text});
                        save(); 
                        if(document.getElementById('tab-moments').classList.contains('active')) {
                            renderMoments();
                        }
                    }
                    return;
                }
                
                if(triggerType.startsWith('generate_moment')) {
                    // Fully simplified reply handling for generate_moment
                    let mText = reply.trim().replace(/^["']|["']$/g, '');
                    const mImg = null; // No image generation for now to ensure stability
                    const newMomentId = Date.now();
                    const contactId = triggerType.split('::')[1];
                    
                    store.moments.unshift({ id: newMomentId, name: c.name, avatar: c.avatar, content: mText, img: mImg, time: newMomentId, likes: [], comments: [] });
                    save(); 
                    if(document.getElementById('tab-moments').classList.contains('active')) {
                        renderMoments();
                    }

                    // 修复：AI发动态后的互动逻辑
                    // 仅当“AI朋友圈互评”开关打开时，其他AI才会来评论
                    const aiInteractionSwitch = store.user.aiMomentInteraction;
                    if (aiInteractionSwitch && c.name !== store.user.name) {
                        const otherAIs = store.contacts.filter(con => con.id !== contactId && !con.isGroup);
                        otherAIs.forEach((commenter, idx) => {
                            setTimeout(() => {
                                // comment_ai_moment::commenterId::momentId::momentText::momentAuthor
                                aiGenerate(`comment_ai_moment::${commenter.id}::${newMomentId}::${mText.substring(0, 25)}::${c.name}`);
                            }, 3000 + Math.random() * 5000 * idx); // Staggered delay
                        });
                    }
                    return; 
                }

                if(triggerType.startsWith('generate_diary') || reply.includes('[DIARY:')) {
                    let title = '日记', content = '';
                    const match = reply.match(/\[DIARY:([\s\S]*?)\]/);
                    if(match) {
                        let inner = match[1];
                        if(inner.includes('|')) { const p = inner.split('|'); title = p[0].trim(); content = p.slice(1).join('|').trim(); }
                        else { content = inner.trim(); }
                    } else {
                        // Fallback parsing
                        const clean = reply.replace(/\[DIARY:|\]/g, '').trim();
                        const lines = clean.split('\n');
                        if(lines.length > 0) title = lines[0].substring(0, 15);
                        content = clean;
                    }

                    // 问题4修复：确保日记长度至少500字
                    if(!content || content.length < 100) {
                        content = "今天发生了很多事情。" + (content || "");
                        // If still too short, pad with reflection
                        if(content.length < 500) {
                            content += "\n\n回想起来，这一天充满了各种情绪和体验。每一个瞬间都值得记录，每一份感受都值得珍藏。生活就是这样，在平凡中孕育着不平凡，在日常中藏着惊喜。";
                        }
                    }

                    if(!store.diaries[c.id]) store.diaries[c.id] = [];
                    store.diaries[c.id].push({title: title, content: content, date: new Date().toLocaleString(), time: Date.now()});
                    save();
                    // Force refresh if detailed view is open
                    if(document.getElementById('layer-diary-detail').classList.contains('show') && activeDiaryContactId === c.id) {
                        openDiaryDetail(c.id);
                    }
                    return;
                }
                
                if(reply.includes('[TRANS_OP:')) {
                    const lastMsgIdx = (store.chats[activeChatId] || []).length - 1;
                    if(lastMsgIdx > -1) {
                        const lastMsg = store.chats[activeChatId][lastMsgIdx];
                        if(lastMsg && lastMsg.sender === 'me' && lastMsg.type === 'transfer' && !lastMsg.status) {
                            if(reply.includes('RECEIVE')) {
                                lastMsg.status = 'received';
                                store.user.balance += parseFloat(lastMsg.content.split('|')[0]);
                                store.bills.push({type:'in', amt:parseFloat(lastMsg.content.split('|')[0]), desc:'收到转账 from ' + c.name, time:Date.now()});
                                // Add a receipt message from AI to make it visible.
                                const receipt = { sender: 'ai', type: 'transfer_receipt', content: lastMsg.content, status: 'received', time: Date.now() };
                                store.chats[activeChatId].push(receipt);
                            } else {
                                lastMsg.status = 'returned';
                                store.user.balance += parseFloat(lastMsg.content.split('|')[0]);
                                store.bills.push({type:'in', amt:parseFloat(lastMsg.content.split('|')[0]), desc:'转账退回 from ' + c.name, time:Date.now()});
                                // Add a return message from AI to make it visible.
                                const receipt = { sender: 'ai', type: 'transfer_receipt', content: lastMsg.content, status: 'returned', time: Date.now() };
                                store.chats[activeChatId].push(receipt);
                            }
                            save();
                            renderHistory();
                        }
                    }
                }

                let heart = "";
                const hMatch = reply.match(/\[\s*HEARTBEAT\s*:([\s\S]*?)\]/i);
                if(hMatch) { heart = hMatch[1]; }
                
                // 修复：移除早期的类型判断逻辑，统一使用分割逻辑处理，避免内容被篡改导致分割失败
                // 增强Regex防止泄漏，去除代码块防止乱码，处理Markdown伪影
                let content = reply
                    .replace(/(\*\*|`)*\[\s*HEARTBEAT\s*:[\s\S]*?\](\*\*|`| )*/gi, '')
                    .replace(/\[\s*HEARTBEAT\s*:[\s\S]*$/gi, '') // 处理末尾未闭合的标签
                    .replace(/\[THOUGHT:[\s\S]*?\]/gi, '')
                    .replace(/\[TRANS_OP:[\s\S]*?\]/gi, '')
                    .replace(/```json/gi, '')
                    .replace(/```/g, '')
                    .replace(/\*\*\s*\*\*/g, '') // 去除空的加粗标记
                    .trim();
                
                // --- Message Splitting Logic ---
                if (content) {
                    const isGroupChat = c && c.isGroup;

                    if (isGroupChat) {
                        // New logic for handling multiple replies in a group chat
                        const replies = content.split(/\[Sender:\s*.*?\s*\]/g).filter(s => s && s.trim());
                        const senders = content.match(/\[Sender:\s*(.*?)\s*\]/g);

                        const processGroupReplies = async () => {
                            if (!senders || replies.length === 0) { // Fallback if AI fails format
                                console.warn("Group format failed, treating as single reply from a random member.");
                                const senderId = c.members[Math.floor(Math.random() * c.members.length)];
                                if (!store.chats[activeChatId]) store.chats[activeChatId] = [];
                                store.chats[activeChatId].push({ sender: senderId, type: 'text', content: content.replace(/\[Sender:.*?\]/g, '').trim(), heart: '', time: Date.now() });
                                save();
                                renderHistory();
                                return;
                            }
                            
                            for (let i = 0; i < replies.length; i++) {
                                if (!senders[i]) continue;
                                const senderName = senders[i].match(/\[Sender:\s*(.*?)\s*\]/)[1].trim();
                                const member = store.contacts.find(m => m.name === senderName && c.members.includes(m.id));
                                const senderId = member ? member.id : c.members[0]; // Fallback to first member
                                
                                const replyText = replies[i].trim();
                                if (!replyText) continue;
                                
                                // Simplified processing for group replies: treat each as a single text message for now.
                                // Complex actions like [IMG] within a multi-reply are hard to parse reliably.
                                const msgObj = { sender: senderId, type: 'text', content: replyText, heart: '', time: Date.now() };
                                if (!store.chats[activeChatId]) store.chats[activeChatId] = [];
                                store.chats[activeChatId].push(msgObj);

                                // Render this message, then wait
                                save();
                                renderHistory();
                                await new Promise(resolve => setTimeout(resolve, 600 + Math.random() * 800));
                            }
                        };
                        
                        await processGroupReplies();

                    } else { // Private chat logic remains the same
                        let senderId = 'ai';
                        let replyText = content;
                        const parts = replyText.split(/(\[VOICE:[\s\S]*?\]|\[STICKER:[\s\S]*?\]|\[IMG:[\s\S]*?\]|\[LOC:[\s\S]*?\]|\[TRANS:[\s\S]*?\]|\n|(?<=[。！？\?]))/g).filter(p => p && p.trim());

                        const processParts = async () => {
                            for (let i = 0; i < parts.length; i++) {
                                let part = parts[i];
                                let currentPart = part.trim();
                                if (!currentPart) continue;

                                let msgType = 'text';
                                let msgContent = currentPart;
                                let textVal = '';

                                if (currentPart.startsWith('[VOICE:')) {
                                    const match = currentPart.match(/\[VOICE:([\s\S]*?)\]/);
                                    if (match) { msgType = 'voice'; msgContent = Math.floor(Math.random() * 5 + 2) + "'"; textVal = match[1]; }
                                } else if (currentPart.startsWith('[STICKER:')) {
                                    const match = currentPart.match(/\[STICKER:([\s\S]*?)\]/);
                                    if (match) { msgType = 'image'; msgContent = match[1]; }
                                } else if (currentPart.startsWith('[IMG:')) {
                                    const match = currentPart.match(/\[IMG:([\s\S]*?)\]/);
                                    if (match) { msgType = 'image'; msgContent = textToImage(match[1], '#cccccc', '#000000'); }
                                } else if (currentPart.startsWith('[LOC:')) {
                                    const match = currentPart.match(/\[LOC:([\s\S]*?)\]/);
                                    if (match) { msgType = 'location'; msgContent = match[1]; }
                                } else if (currentPart.startsWith('[TRANS:')) {
                                    const match = currentPart.match(/\[TRANS:([\s\S]*?)\]/);
                                    if (match) { msgType = 'transfer'; msgContent = match[1]; }
                                }
                                
                                if (!store.chats[activeChatId]) store.chats[activeChatId] = [];
                                
                                const isLastPart = i === parts.length - 1;
                                let msgHeart = (isLastPart && heart) ? heart : "";
                                
                                const msgObj = { sender: senderId, type: msgType, content: msgContent, heart: msgHeart, time: Date.now() };
                                if (textVal) msgObj.textVal = textVal;

                                store.chats[activeChatId].push(msgObj);
                                
                                save();
                                renderHistory();
                                
                                await new Promise(resolve => setTimeout(resolve, 300));
                            }
                        };
                        
                        await processParts();
                    }
                    if(c) c.lastMsgTime = Date.now();
                    save();
                }

            } catch(e) {
                console.error('API Error in aiGenerate:', e);
                showToast(`AI生成失败: ${e.message || "未知错误"}`, "error");
                
                if(triggerType==='manual' && originalTitle) {
                    document.getElementById('chat-title').innerText = originalTitle;
                    removeLoadingBubble();
                }
            } finally {
                isGenerating = false;
            }
        }

        function showLoadingBubble() {
            const history = document.getElementById('chat-history');
            if(!history) return;
            const row = document.createElement('div');
            row.id = 'temp-loading-bubble';
            row.className = 'msg-row';
            const c = store.contacts.find(x=>x.id===activeChatId);
            const avatar = c?.avatar || 'https://via.placeholder.com/50';
            row.innerHTML = `<img src="${avatar}" class="avatar"><div class="bubble loading">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
            history.appendChild(row);
            history.scrollTop = history.scrollHeight;
        }

        function removeLoadingBubble() {
            const el = document.getElementById('temp-loading-bubble');
            if(el) el.remove();
        }

        let currentTtsMsg = null;

        async function playVoiceMessage(idx) {
            const msg = store.chats[activeChatId][idx];
            if (!msg) return;

            // 优化逻辑：实现点击语音条既能播放又能收回文字
            // 如果文字已展开，则收起文字并停止播放（如果正在播）
            if (msg.showText) {
                msg.showText = false;
                if (msg.ttsState === 'playing') {
                    const audio = document.getElementById('tts-audio');
                    audio.pause();
                    msg.ttsState = 'idle';
                    currentTtsMsg = null;
                }
                save();
                renderHistory(true);
                return;
            }

            // 如果文字未展开，则展开文字并继续播放
            msg.showText = true;
            // 不立即 save() 避免频繁IO，反正下面 renderHistory 会处理显示，播放状态改变时会 save

            // 1. 如果正在播放当前消息，则停止 (虽然上面的逻辑已经覆盖了这种情况，但保留作为保险)
            if (msg.ttsState === 'playing') {
                const audio = document.getElementById('tts-audio');
                audio.pause();
                msg.ttsState = 'idle';
                currentTtsMsg = null;
                renderHistory(true); // Keep scroll
                return;
            }

            // 2. 如果正在合成中，忽略点击
            if (msg.ttsState === 'loading') {
                renderHistory(true); // 确保文字展开状态被渲染
                return;
            }

            // 3. 如果有其他消息在播放，先停止它
            if (currentTtsMsg && currentTtsMsg !== msg) {
                const audio = document.getElementById('tts-audio');
                audio.pause();
                currentTtsMsg.ttsState = 'idle';
                // 这里不需要专门调用renderHistory，因为下面马上会调用
            }

            // 4. 开始处理
            currentTtsMsg = msg;
            msg.ttsState = 'loading';
            renderHistory(true); // Keep scroll

            const audio = document.getElementById('tts-audio');
            
            try {
                let blobUrl = msg.audioUrl;

                // 如果没有缓存，则发起请求
                if (!blobUrl) {
                    const text = msg.textVal || msg.content;
                    if (!text) throw new Error("无文本内容");
                    
                    // 仅当是AI发送且有配置Key时才调用API，或者是用户点击菜单强制播放
                    const contact = store.contacts.find(c => c.id === activeChatId);
                    const voiceId = contact?.settings?.voiceId;
                    const lang = contact?.settings?.voiceLang;
                    
                    const blob = await API.textToSpeech(text, voiceId, lang);
                    blobUrl = URL.createObjectURL(blob);
                    msg.audioUrl = blobUrl; // Session级缓存
                }

                // 播放音频
                audio.src = blobUrl;
                
                audio.onended = () => {
                    msg.ttsState = 'idle';
                    currentTtsMsg = null;
                    renderHistory(true); // Keep scroll
                };
                
                audio.onerror = () => {
                    console.error("Audio Play Error");
                    msg.ttsState = 'error';
                    delete msg.audioUrl; // 清除无效音频缓存
                    currentTtsMsg = null;
                    renderHistory(true);
                    toast("播放失败");
                };

                await audio.play();
                msg.ttsState = 'playing';
                renderHistory(true); // Keep scroll

            } catch (e) {
                console.error("TTS Error:", e);
                msg.ttsState = 'error';
                delete msg.audioUrl; // 发生错误时清除缓存
                currentTtsMsg = null;
                renderHistory(true);
                toast(e.message || "合成失败");
            }
        }


        async function aiRetry() {
            if (!store.chats[activeChatId] || store.chats[activeChatId].length === 0) return;

            // 修复：重回逻辑优化，防止出现乱码或格式错误
            // 循环向后删除所有最后连续的AI消息
            let lastMsg = store.chats[activeChatId][store.chats[activeChatId].length - 1];
            while (lastMsg && lastMsg.sender !== 'me') {
                store.chats[activeChatId].pop();
                lastMsg = store.chats[activeChatId][store.chats[activeChatId].length - 1];
            }

            save();
            renderHistory();
            
            // 重新生成AI回复，使用manual触发类型确保title变更为“输入中”
            // 强制使用retry前缀，避免与其他触发逻辑冲突
            aiGenerate('retry');
        }
        
        function calibrateWeather() {
             aiGenerate('calibrate_weather');
        }

        // --- MOMENT & DIARY GENERATION ---
        function showMomentGenerateModal() {
            const modal = document.getElementById('modal-moment-generate');
            const contactList = document.getElementById('moment-gen-contacts');
            selectedMomentContacts.clear();
            
            const privateContacts = store.contacts.filter(c => !c.isGroup);

            contactList.innerHTML = privateContacts.map(c => `
                <label style="display:flex; align-items:center; padding:8px; cursor:pointer;">
                    <input type="checkbox" onchange="toggleMomentContact('${c.id}')" style="margin-right:10px;">
                    <img src="${c.avatar}" class="avatar" style="width:32px; height:32px; margin-right:10px;">
                    <span>${c.name}</span>
                </label>
            `).join('');
            
            modal.style.display = 'flex';
        }

        function toggleMomentContact(id) {
            if(event.target.checked) selectedMomentContacts.add(id);
            else selectedMomentContacts.delete(id);
        }

        async function generateMoments() {
            const count = parseInt(document.getElementById('moment-gen-count').value) || 1;
            if(selectedMomentContacts.size === 0) return toast("请选择角色");
            
            document.getElementById('modal-moment-generate').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            for(const contactId of selectedMomentContacts) {
                for(let i=0; i<count; i++) {
                    await aiGenerate('generate_moment::'+contactId);
                    await new Promise(r => setTimeout(r, 500));
                }
            }
            
            document.getElementById('loading').style.display = 'none';
            renderMoments();
            toast("生成完成");
        }

        function showDiaryGenerateModal() {
            const modal = document.getElementById('modal-diary-generate');
            const contactList = document.getElementById('diary-gen-contacts');
            selectedDiaryContacts.clear();
            
            const privateContacts = store.contacts.filter(c => !c.isGroup);

            contactList.innerHTML = privateContacts.map(c => `
                <label style="display:flex; align-items:center; padding:8px; cursor:pointer;">
                    <input type="checkbox" onchange="toggleDiaryContact('${c.id}')" style="margin-right:10px;">
                    <img src="${c.avatar}" class="avatar" style="width:32px; height:32px; margin-right:10px;">
                    <span>${c.name}</span>
                </label>
            `).join('');
            
            modal.style.display = 'flex';
        }

        function toggleDiaryContact(id) {
            if(event.target.checked) selectedDiaryContacts.add(id);
            else selectedDiaryContacts.delete(id);
        }

        async function generateDiaries() {
            const count = parseInt(document.getElementById('diary-gen-count').value) || 1;
            if(selectedDiaryContacts.size === 0) return toast("请选择角色");
            
            document.getElementById('modal-diary-generate').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            for(const contactId of selectedDiaryContacts) {
                for(let i=0; i<count; i++) {
                    await aiGenerate('generate_diary::'+contactId);
                    await new Promise(r => setTimeout(r, 500));
                }
            }
            
            document.getElementById('loading').style.display = 'none';
            renderDiaryGrid();
            toast("日记生成完成");
        }

        // --- DIARY FUNCTIONS ---
        function openDiary() {
            document.getElementById('layer-diary').classList.add('show');
            renderDiaryGrid();
        }

        function renderDiaryGrid() {
            const grid = document.getElementById('diary-grid');
            const contacts = store.contacts.filter(c => store.diaries[c.id] && store.diaries[c.id].length > 0);
            
            grid.innerHTML = contacts.length === 0 ? '<div style="text-align:center; color:#999; margin-top:100px;">暂无日记<br>点击右上角生成</div>' : '';
            
            contacts.forEach(c => {
                grid.innerHTML += `
                    <div class="list-item" onclick="openDiaryDetail('${c.id}')" style="border-radius:12px; margin-bottom:10px; background:linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                        <img src="${c.avatar}" class="avatar">
                        <div class="list-content">
                            <div class="list-title" style="color:#fff;">${c.name}的日记</div>
                            <div class="list-sub" style="color:rgba(255,255,255,0.8);">${store.diaries[c.id].length}篇</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color:#fff;"></i>
                    </div>
                `;
            });
        }

        function openDiaryDetail(contactId) {
            activeDiaryContactId = contactId;
            const c = store.contacts.find(x=>x.id===contactId);
            document.getElementById('diary-detail-name').innerText = c.name + ' 的日记';
            document.getElementById('layer-diary-detail').classList.add('show');
            
            const content = document.getElementById('diary-detail-content');
            const diaries = store.diaries[contactId] || [];
            
            if(diaries.length === 0) {
                content.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">暂无日记</div>';
                return;
            }

            // Descending order
            const sorted = [...diaries].reverse();
            content.innerHTML = sorted.map((d,i) => {
                // Since we reversed, original index is length - 1 - i
                const originalIndex = diaries.length - 1 - i;
                return `
                <div class="list-item" onclick="readDiary('${contactId}', ${originalIndex})" style="border-radius:8px; margin-bottom:8px;">
                    <div class="list-content">
                        <div class="list-title">${d.title}</div>
                        <div class="list-sub">${d.date}</div>
                    </div>
                    <i class="fas fa-angle-right" style="color:#ddd;"></i>
                </div>
            `}).join('');
        }

        function readDiary(contactId, index) {
            activeDiaryContactId = contactId;
            activeDiaryIndex = index;
            const d = store.diaries[contactId][index];
            document.getElementById('diary-read-body').innerHTML = `
                <h2 style="margin-bottom:10px;">${d.title}</h2>
                <div style="color:#999; font-size:13px; margin-bottom:20px;">${d.date}</div>
                <div style="line-height:1.8; font-size:16px; white-space:pre-wrap;">${d.content}</div>
            `;
            document.getElementById('layer-diary-read').classList.add('show');
        }

        function editCurrentDiary() {
            const d = store.diaries[activeDiaryContactId][activeDiaryIndex];
            const newTitle = prompt("修改标题:", d.title);
            if(newTitle) {
                const newContent = prompt("修改内容 (支持换行):", d.content); 
                if(newContent) {
                    d.title = newTitle;
                    d.content = newContent;
                    save();
                    readDiary(activeDiaryContactId, activeDiaryIndex);
                    openDiaryDetail(activeDiaryContactId); 
                    toast("修改成功");
                }
            }
            document.getElementById('diary-read-menu').style.display = 'none';
        }

        function deleteCurrentDiary() {
            if(confirm("确定删除这篇日记?")) {
                store.diaries[activeDiaryContactId].splice(activeDiaryIndex, 1);
                save();
                document.getElementById('layer-diary-read').classList.remove('show');
                openDiaryDetail(activeDiaryContactId);
                toast("删除成功");
            }
            document.getElementById('diary-read-menu').style.display = 'none';
        }

        // --- PROACTIVE LOOP ---
        setInterval(() => {
            const now = Date.now();
            
            // Cycle Reminder Logic
            if (store.couple.reminderEnabled && store.couple.cycleDate && store.couple.careContacts && store.couple.careContacts.length > 0) {
                const todayStr = new Date().toISOString().split('T')[0];
                if (store.couple.lastReminderDate !== todayStr) {
                    const lastPeriod = new Date(store.couple.cycleDate);
                    const nextPeriod = new Date(lastPeriod.getTime() + store.couple.cycleLen * 24 * 60 * 60 * 1000);
                    const diffTime = nextPeriod - new Date();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays <= store.couple.reminderDaysBefore && diffDays > 0) {
                        store.couple.careContacts.forEach(cid => {
                            const c = store.contacts.find(x => x.id === cid);
                            if (c) {
                                // Trigger care message
                                activeChatId = cid;
                                aiGenerate(`cycle_care_reminder::${diffDays}`);
                            }
                        });
                        store.couple.lastReminderDate = todayStr;
                        save();
                    }
                }
            }

            store.contacts.forEach(c => {
                if(!c.settings) return;
                if(c.settings.autoMsg && c.settings.autoMsgInterval) {
                     const last = c.lastMsgTime || 0;
                     if(now - last > c.settings.autoMsgInterval * 60000) {
                         activeChatId = c.id;
                         aiGenerate('auto_msg');
                         c.lastMsgTime = now;
                     }
                }if(c.settings.autoMoment && Math.random() < 0.01) {
                    aiGenerate('generate_moment::'+c.id);
                }if(c.settings.autoDiary) {
                    const hour = new Date().getHours();
                    const targetHour = parseInt((c.settings.diaryTime||'22:00').split(':')[0]);
                    if(hour === targetHour && (!c.lastDiaryTime || now - c.lastDiaryTime > 3600000)) {
                        aiGenerate('generate_diary::'+c.id);
                        c.lastDiaryTime = now;
                    }
                }
            });
        }, 10000);

        // --- COMMON UI ---
        function showToast(message, type = 'info') { // types: info, success, error
            const toast = document.getElementById('toast');
            if(!toast) return;
            toast.textContent = message;
            toast.className = `show ${type}`;
            setTimeout(() => {
                toast.className = '';
            }, 2800);
        }
        function toast(msg) { // For backwards compatibility
            showToast(msg, 'info');
        }

        function showConfirm(title, text, onOk) {
            const modal = document.getElementById('modal-confirm');
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-text').innerText = text;
            modal.style.display = 'flex';

            const okBtn = document.getElementById('confirm-btn-ok');
            const cancelBtn = document.getElementById('confirm-btn-cancel');

            // Remove old listeners before adding new ones to prevent multiple executions
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            const okHandler = () => {
                onOk();
                modal.style.display = 'none';
            };

            const cancelHandler = () => {
                modal.style.display = 'none';
            };
            
            newOkBtn.addEventListener('click', okHandler);
            newCancelBtn.addEventListener('click', cancelHandler);
        }
        function togglePopup(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display==='flex' ? 'none' : 'flex';
        }
        function openApp(id) {
            document.getElementById('layer-desktop').classList.remove('active');
            const el = document.getElementById(`layer-${id}`);
            if(el.classList.contains('page')) el.classList.add('active'); else el.classList.add('show');
            
            if(id==='wechat') { 
                const contacts = document.getElementById('tab-contacts');
                const moments = document.getElementById('tab-moments');
                const me = document.getElementById('tab-me');
                
                contacts.classList.add('active');
                moments.classList.remove('active');
                me.classList.remove('active');

                const tabs = document.querySelectorAll('.nav-tab');
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
                tabs[2].classList.remove('active');

                renderContacts();
                renderMoments(); }
            if(id==='worldbook') renderWorldBooks();
            if(id==='couple') { coupleViewMode='list'; renderCouple(); }
            if(id==='perception') renderPerception();
            if(id==='stickers') renderStickerGallery();
            if(id==='music') renderMusicList();
            if(id==='beauty') renderBeautify();
            if(id==='settings') {
                document.getElementById('sys-url').value = store.system.url;
                document.getElementById('sys-key').value = store.system.key;
                
                // MiniMax Settings
                const mm = store.system.minimax || { version: 'official', groupId: '', apiKey: '', model: 'speech-01' };
                document.getElementById('mm-version').value = mm.version || 'official';
                document.getElementById('mm-group-id').value = mm.groupId || '';
                document.getElementById('mm-api-key').value = mm.apiKey || '';
                document.getElementById('mm-model').value = mm.model || 'speech-01';

                const sel = document.getElementById('sys-model');
                let found = false;
                for(let i=0; i<sel.options.length; i++) { if(sel.options[i].value === store.system.model) found = true; }
                if(!found) {const opt = document.createElement('option');
                     opt.value = store.system.model; opt.innerText = store.system.model;
                     sel.appendChild(opt);
                }
                sel.value = store.system.model;
                renderAPIPresets();
            }
        }
        function exitApp() {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.layer').forEach(e => e.classList.remove('show'));
            document.getElementById('layer-desktop').classList.add('active');
        }
        function closeLayer(id) {
            document.getElementById(id).classList.remove('show');
            if (id === 'layer-offline-mode') {
                const titleEl = document.querySelector('#layer-offline-mode .nav-title');
                if (titleEl) titleEl.innerText = '线下模式'; // Reset title
                offlineContactId = null; // Clear context
                stopOfflineSimulation();
            }
        }
        function switchTab(idx, el) {
            document.querySelectorAll('#layer-wechat .page').forEach(e => e.classList.remove('active'));
            const tabs = ['tab-contacts', 'tab-moments', 'tab-me'];document.getElementById(tabs[idx]).classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            if(el) el.classList.add('active');
            if(idx === 0) renderContacts();
            if(idx === 1) renderMoments();
        }
        function toggleAddMenu(e, id) { 
            e.stopPropagation(); 
            const el = document.getElementById(id==='couple'?'couple-add-menu':'wx-add-menu'); 
            // Close other menus first
            document.querySelectorAll('.add-menu').forEach(m => { if(m.id !== el.id) m.style.display = 'none'; });
            el.style.display = el.style.display==='flex'?'none':'flex'; 
        }
        function toggleWBMenu(e) {
            e.stopPropagation();
            const el = document.getElementById('wb-add-menu');
            document.querySelectorAll('.add-menu').forEach(m => { if(m.id !== el.id) m.style.display = 'none'; });
            el.style.display = el.style.display==='flex'?'none':'flex';
        }
        
        // Optimized Global Click Handler
        document.addEventListener('click', function(e) {
            // Close Popups/Menus if clicking outside
            if (!e.target.closest('.nav-icon') && !e.target.closest('.fa-smile') && !e.target.closest('.pop-menu') && !e.target.closest('.add-menu') && !e.target.closest('.sticker-panel') && !e.target.closest('.contact-menu')) {
                document.querySelectorAll('.pop-menu, .add-menu, .sticker-panel, .contact-menu').forEach(el => {
                    el.style.display = 'none';
                });
            }
            // Specific handling for msg-menu to prevent ghost clicks
            const mm = document.getElementById('msg-menu');
            if(mm && mm.style.display!=='none' && !mm.contains(e.target)) {
                mm.style.display='none';
            }
        }, true); // Use capture phase to ensure it catches clicks

        // --- DESKTOP RENDER ---
        function renderDesktop() {
            // The main app grid is now semi-static in the HTML for the new layout.
            // This function will now be used to update dynamic parts of the new desktop.

            // 1. Update Time and Date
            const timeEl = document.getElementById('desktop-time-val');
            const dateEl = document.getElementById('desktop-date-val');
            const perception = store.perception;
            const now = new Date();
            
            if (perception.master && perception.customTime && perception.timeVal) {
                timeEl.innerText = perception.timeVal;
            } else {
                timeEl.innerText = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }
            
            let useRealDate = true;
            if (perception.master && perception.customDate && perception.dateVal) {
                const d = new Date(perception.dateVal + 'T00:00:00');
                if (!isNaN(d.getTime())) {
                    dateEl.innerText = `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日 ${['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][d.getDay()]}`;
                    useRealDate = false;
                }
            }
            
            if (useRealDate) {
                 dateEl.innerText = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日 ${['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][now.getDay()]}`;
            }
            
            // 2. Update User Info Card
            if(!store.user.location) store.user.location = { province: '地点信息', address: ''};
            document.getElementById('desktop-user-name').innerText = store.user.desktopName ?? '用户名字';
            document.getElementById('desktop-user-signature').innerText = store.user.desktopSignature ?? '个性签名，点击设置';
            document.getElementById('desktop-user-avatar-img').src = store.user.desktopAvatar || 'https://via.placeholder.com/60';
            document.getElementById('desktop-user-location-province').innerText = store.user.location.province || '地点信息';
            document.getElementById('desktop-user-location-address').innerText = store.user.location.address || '';


            // 3. Update App Icons (if they are customized)
            // Desktop Icons
            const appIcons = [
                {id:'wechat', icon:'fab fa-weixin', defaultColor: '#07c160'},
                {id:'worldbook', icon:'fas fa-book', defaultColor: '#5856d6'},
                {id:'couple', icon:'fas fa-heart', defaultColor: '#ff758c'},
                {id:'perception', icon:'fas fa-brain', defaultColor: '#4facfe'},
            ];
            appIcons.forEach(app => {
                 const appItem = document.querySelector(`.app-item[onclick="openApp('${app.id}')"] .app-icon`);
                 if (appItem) {
                 const iconUrl = store.appIcons && store.appIcons[app.id];
                 if (iconUrl) {
                     appItem.style.backgroundImage = `url(${iconUrl})`;
                     appItem.style.backgroundSize = '100% 100%';
                     appItem.style.backgroundPosition = 'center center';
                     appItem.style.backgroundRepeat = 'no-repeat';
                     appItem.style.backgroundColor = 'transparent';
                     appItem.innerHTML = '';
                 } else {
                         appItem.style.backgroundImage = 'none';
                         appItem.style.backgroundColor = app.defaultColor;
                         appItem.innerHTML = `<i class="${app.icon}"></i>`;
                     }
                 }
            });

            // Dock Icons
            const dockIcons = [
                {id:'checkphone', icon:'fas fa-mobile-alt', defaultColor: '#eee'},
                {id:'beauty', icon:'fas fa-magic', defaultColor: '#eee'},
                {id:'settings', icon:'fas fa-cog', defaultColor: '#eee'},
            ];
            dockIcons.forEach(app => {
                 const dockItem = document.getElementById(`dock-icon-${app.id}`);
                 if (dockItem) {
                     const iconUrl = store.appIcons && store.appIcons[app.id];
                     if (iconUrl) {
                         dockItem.style.backgroundImage = `url(${iconUrl})`;
                         dockItem.style.backgroundSize = '100% 100%';
                         dockItem.style.backgroundPosition = 'center center';
                         dockItem.style.backgroundRepeat = 'no-repeat';
                         dockItem.style.backgroundColor = 'transparent';
                         dockItem.innerHTML = '';
                     } else {
                         dockItem.style.backgroundImage = 'none';
                         dockItem.style.backgroundColor = app.defaultColor;
                         dockItem.innerHTML = `<i class="${app.icon}"></i>`;
                     }
                 }
            });

            // 4. Update Custom Widget & Desktop Background
            if (store.appIcons && store.appIcons.desktopWidgetBg) {
                const widget = document.querySelector('.custom-widget');
                if (widget) widget.style.backgroundImage = `url(${store.appIcons.desktopWidgetBg})`;
            }
            if(store.desktopBg) {
                document.getElementById('desktop').style.backgroundImage = `url(${store.desktopBg})`;
            }
        }

        function openDesktopProfileEdit() {
            document.getElementById('desktop-p-edit-name').value = store.user.desktopName || '用户名字';
            document.getElementById('desktop-p-edit-sig').value = store.user.desktopSignature || '个性签名，点击设置';
            document.getElementById('modal-desktop-profile-edit').style.display = 'flex';
        }

        function saveDesktopProfileEdit() {
            store.user.desktopName = document.getElementById('desktop-p-edit-name').value;
            store.user.desktopSignature = document.getElementById('desktop-p-edit-sig').value;
            save();
            renderDesktop();
            document.getElementById('modal-desktop-profile-edit').style.display = 'none';
            toast("信息已更新", "success");
        }

        function editDesktopInfo() {
            const newName = prompt("编辑名字:", store.user.desktopName || "用户名字");
            if (newName !== null) {
                store.user.desktopName = newName;
                const newSig = prompt("编辑签名:", store.user.desktopSignature || "个性签名，点击设置");
                if (newSig !== null) {
                    store.user.desktopSignature = newSig;
                }
                save();
                renderDesktop();
                toast("信息已更新", "success");
            }
        }

        function openLocationEdit() {
            if(!store.user.location) store.user.location = { province: '', address: ''};
            document.getElementById('loc-edit-province').value = store.user.location.province || '';
            document.getElementById('loc-edit-address').value = store.user.location.address || '';
            document.getElementById('modal-location-edit').style.display = 'flex';
        }

        function saveLocationEdit() {
            store.user.location.province = document.getElementById('loc-edit-province').value;
            store.user.location.address = document.getElementById('loc-edit-address').value;
            save();
            renderDesktop();
            document.getElementById('modal-location-edit').style.display = 'none';
        }

        renderDesktop();

        // --- CHAT LOGIC ---
        function openChat(cid) {
            activeChatId = cid;
            const c = store.contacts.find(x=>x.id===cid);
            document.getElementById('chat-title').innerText = c.name;
            document.getElementById('layer-chat').classList.add('show');
            
            const bg = (c.settings && c.settings.bg) ? c.settings.bg : (c.bg || '');
            document.getElementById('chat-history').style.backgroundImage = bg ? `url(${bg})` : 'none';

            // Problem 2: For private chat, "Generate" is the main way to get AI reply.
            // The userSend logic will handle the auto-reply part.
            document.querySelector('.btn-gen').style.display = 'block'; 
            
            renderHistory();
        }
        
        function renderHistory(keepScroll = false) {
            const history = document.getElementById('chat-history');
            if(!history) return;
            
            const prevScroll = history.scrollTop;
            history.innerHTML = '';
            const msgs = store.chats[activeChatId] || [];
            msgs.forEach((m, idx) => appendMsgRow(m, idx, false)); // Don't scroll per item
            
            if (keepScroll) {
                history.scrollTop = prevScroll;
            } else {
                history.scrollTop = history.scrollHeight;
            }
        }

        // 统一处理气泡点击：多选模式下只做选择，否则执行原操作
        function handleBubbleClick(idx, originalAction) {
            if (isMultiSelect) {
                toggleSelectMsg(idx);
            } else if (originalAction) {
                originalAction();
            }
        }

        function appendMsgRow(m, idx, doScroll = true) {
            // This function is performance-critical. Using `createElement` and `appendChild`
            // is significantly faster than `innerHTML += ...` for list rendering.
            const history = document.getElementById('chat-history');
            if (!history) return;

            const currentChat = store.contacts.find(c => c.id === activeChatId);
            const isGroup = currentChat?.isGroup;
            const isMe = m.sender === 'me';

            const row = document.createElement('div');
            row.className = `msg-row ${isMe ? 'me' : ''}`;

            // 1. Create Avatar
            let avatarSrc;
            let senderName = '';
            if (isMe) {
                const userPersonaId = currentChat?.settings?.userPersona;
                const userPersona = userPersonaId ? store.personas.find(p => p.id === userPersonaId) : null;
                avatarSrc = userPersona?.avatar || store.user.avatar || 'https://via.placeholder.com/50';
            } else {
                const senderContact = isGroup ? store.contacts.find(c => c.id === m.sender) : currentChat;
                avatarSrc = senderContact?.avatar || 'https://via.placeholder.com/50';
                senderName = senderContact?.name || 'Unknown';
            }
            const avatarImg = document.createElement('img');
            avatarImg.src = avatarSrc;
            avatarImg.className = 'avatar';

            // 2. Create Bubble Container (for name + bubble)
            const bubbleContainer = document.createElement('div');
            bubbleContainer.style.cssText = `display: flex; flex-direction: column; max-width: 250px; align-items: ${isMe ? 'flex-end' : 'flex-start'};`;

            // 3. Add sender name label for group chats
            if (isGroup && !isMe) {
                const nameLabel = document.createElement('div');
                nameLabel.innerText = senderName;
                nameLabel.style.cssText = `font-size: 12px; color: #888; margin-bottom: 4px; margin-left: 0;`;
                bubbleContainer.appendChild(nameLabel);
            }

            // 4. Create and populate the main bubble
            const bubble = document.createElement('div');
            // 移除 ontouchstart 中的 selection toggle，只用于长按检测
            bubble.setAttribute('ontouchstart', `handleMsgTouchStart(${idx}, event)`);
            bubble.setAttribute('ontouchend', `handleMsgTouchEnd()`);
            bubble.setAttribute('onmousedown', `handleMsgMouseDown(${idx}, event)`);
            bubble.setAttribute('onmouseup', `handleMsgMouseUp()`);
            bubble.setAttribute('oncontextmenu', 'event.preventDefault()');

            // 默认点击行为：如果是多选模式，则触发选择
            bubble.onclick = () => handleBubbleClick(idx, null);

            // --- Bubble Content Logic ---
            switch (m.type) {
                case 'transfer':
                    const [amt, note] = m.content.split('|');
                    let title = isMe ? '转账给对方' : '转账给你';
                    let icon = 'yen-sign';
                    let statusClass = '';
                    let statusText = note || title;

                    if (m.status === 'received') { title = '已收款'; icon = 'check'; statusClass = 'done'; statusText = '已收款'; } 
                    else if (m.status === 'returned') { title = '已退回'; icon = 'undo'; statusClass = 'done'; statusText = '已退回'; }
                    
                    bubble.className = `bubble-transfer ${statusClass} ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    // 如果不在多选模式且未完成，才触发转账操作
                    if (!m.status) {
                        bubble.onclick = () => handleBubbleClick(idx, () => receiveTransfer(idx, m.sender));
                    }
                    bubble.innerHTML = `<div class="transfer-top"><div class="transfer-icon"><i class="fas fa-${icon}"></i></div><div class="transfer-info"><div class="transfer-amt">￥${amt}</div><div class="transfer-desc">${statusText}</div></div></div><div class="transfer-bottom">微信转账</div>`;
                    break;
                case 'transfer_receipt':
                    const [amtRec, noteRec] = m.content.split('|');
                    let titleRec = m.status === 'received' ? '已收款' : '已退回';
                    let iconRec = m.status === 'received' ? 'check' : 'undo';
                    let statusTextRec = m.status === 'received' ? '已收款' : '已退回';
                    
                    bubble.className = `bubble-transfer done ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    bubble.innerHTML = `<div class="transfer-top"><div class="transfer-icon"><i class="fas fa-${iconRec}"></i></div><div class="transfer-info"><div class="transfer-amt">￥${amtRec}</div><div class="transfer-desc">${statusTextRec}</div></div></div><div class="transfer-bottom">微信转账</div>`;
                    break;
                case 'location':
                    let locName = '位置', locAddr = '详细地址未知';
                    if (m.content && m.content.includes('|')) {
                        [locName, locAddr] = m.content.split('|');
                    } else if (m.content) {
                        locName = m.content;
                    }
                    bubble.className = `bubble-location ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    bubble.innerHTML = `<div class="loc-map"></div><div class="loc-info"><div class="loc-name">${locName}</div><div class="loc-addr">${locAddr}</div></div>`;
                    break;
                case 'image':
                    bubble.className = `bubble ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    bubble.style.cssText = 'background: transparent; border: none; padding: 0;';
                    // 对于图片，点击图片本身触发
                    const img = document.createElement('img');
                    img.src = m.content;
                    img.style.cssText = "max-width: 140px; border-radius: 4px;";
                    // 这里要小心，点击图片触发的是 handleBubbleClick
                    img.onclick = (e) => {
                        e.stopPropagation(); // 阻止冒泡，避免触发 bubble.onclick (如果有的话)
                        handleBubbleClick(idx, () => showBigImg(m.content));
                    };
                    bubble.appendChild(img);
                    // 清除 bubble 自身的 onclick，因为 img 占满了
                    bubble.onclick = null;
                    break;
                case 'voice':
                    bubble.className = `bubble voice ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    
                    let vIcon = 'fa-play';
                    let vText = m.content;
                    
                    if (m.ttsState === 'loading') {
                        vIcon = 'fa-spinner fa-spin';
                        vText = '合成中...';
                    } else if (m.ttsState === 'playing') {
                        vIcon = 'fa-pause';
                        vText = '播放中';
                    } else if (m.ttsState === 'error') {
                        vIcon = 'fa-exclamation-circle';
                        vText = '失败(点击重试)';
                    }
                    
                    bubble.innerHTML = `<i class="fas ${vIcon}" style="margin-right: 5px;"></i> ${vText}`;
                    bubble.onclick = () => handleBubbleClick(idx, () => playVoiceMessage(idx));
                    
                    if (m.showText && m.textVal) {
                        const textDiv = document.createElement('div');
                        textDiv.className = 'bubble';
                        textDiv.style.cssText = 'margin-top: 5px; background: #f0f0f0;';
                        textDiv.innerText = m.textVal;
                        // 文字部分也可以被选中
                        textDiv.onclick = () => handleBubbleClick(idx, null);
                        
                        bubbleContainer.appendChild(bubble);
                        bubbleContainer.appendChild(textDiv);
                        
                        row.appendChild(avatarImg);
                        row.appendChild(bubbleContainer);
                        history.appendChild(row);
                        
                        if (history.scrollHeight > history.clientHeight) {
                            history.scrollTop = history.scrollHeight;
                        }
                        return;
                    }
                    break;
                 case 'recalled':
                    bubble.className = `bubble recalled ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    bubble.innerText = m.content;
                    bubble.onclick = () => handleBubbleClick(idx, () => {
                         showConfirm("删除记录", "要删除这条撤回记录吗?", () => {
                            store.chats[activeChatId].splice(idx, 1);
                            save();
                            renderHistory();
                            toast("记录已删除");
                         });
                    });
                    break;
                default: // 'text'
                    bubble.className = `bubble ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    bubble.innerText = m.content;
                    break;
            }

            if (m.quote) {
                const quoteDiv = document.createElement('div');
                quoteDiv.className = 'bubble-quote';
                quoteDiv.innerText = m.quote;
                bubble.insertBefore(quoteDiv, bubble.firstChild);
            }

            bubbleContainer.appendChild(bubble);
            
            // 5. Assemble the row and append to history
            row.appendChild(avatarImg);
            row.appendChild(bubbleContainer);
            history.appendChild(row);

            // 6. Scroll to bottom
            if (doScroll && history.scrollHeight > history.clientHeight) {
                history.scrollTop = history.scrollHeight;
            }
        }

        // --- INTERACTION ---
        function openCustomInput(type, context = {}) {
             customInputType = type;
             window.customInputContext = context; // Store context globally
             const m = document.getElementById('modal-custom-input');
             const t = document.getElementById('custom-input-title');
             const i = document.getElementById('custom-input-val');
             const d = document.getElementById('custom-input-date');
             const a = document.getElementById('custom-input-area');
             
             m.style.display = 'flex';
             i.value = ''; a.value = ''; d.value = '';
             i.style.display = 'block'; a.style.display = 'none'; d.style.display = 'none';

             if(type==='moment-comment') { t.innerText = "发表评论"; a.style.display='block'; i.style.display='none'; a.placeholder = '请输入评论内容...'; }
             if(type==='voice-fake') { t.innerText = "伪装语音 (输入文字)"; a.style.display='block'; i.style.display='none'; }
             if(type==='image-fake') { t.innerText = "伪装图片 (输入描述)"; a.style.display='block'; i.style.display='none'; }
             if(type==='transfer') { t.innerText = "转账 (金额)"; }
             if(type==='location') {
                t.innerText = "发送位置";
                i.placeholder = "省/市";
                a.style.display = 'block';
                a.style.height = '40px';
                a.placeholder = "详细地址";
             }
             if(type==='recharge') { t.innerText = "充值 (金额)"; }
             if(type==='moment-text') { t.innerText = "发动态"; a.style.display='block'; i.style.display='none'; }
             if(type==='festival') { t.innerText = "添加节日"; d.style.display='block'; i.style.display='none'; }
             if(type==='wish') { t.innerText = "许愿 (内容)"; a.style.display='block'; i.style.display='none'; }
             if(type==='new-diary') { t.innerText = "写日记 (标题)"; a.style.display='block'; a.placeholder="内容..."; i.placeholder="标题"; i.style.display='block'; }
             if(type==='manual-memory') { t.innerText = "手动增加记忆"; a.style.display='block'; a.style.height='120px'; i.style.display='none'; a.placeholder="记录下重要的事..."; }
             if(type==='listen-chat') { t.innerText = "一起听 - 发送消息"; a.style.display='none'; i.style.display='block'; i.placeholder="输入内容 (将发送给对方)..."; }
        }

        function confirmCustomInput() {
             let val = '';
             const context = window.customInputContext || {};
             // BUG FIX: Add 'manual-memory' to types that read from the textarea
             if(['voice-fake','image-fake','moment-text','wish', 'manual-memory', 'moment-comment'].includes(customInputType)) val = document.getElementById('custom-input-area').value;
             else if(customInputType==='festival') val = document.getElementById('custom-input-date').value;
             else if(customInputType==='new-diary') val = document.getElementById('custom-input-val').value;
             else val = document.getElementById('custom-input-val').value;
             
             if(!val && customInputType !== 'new-diary') return; // Allow empty title for diary
             
             if(customInputType==='voice-fake') {const sec = Math.min(60, Math.max(1, Math.ceil(val.length / 3)));
                  if(!store.chats[activeChatId]) store.chats[activeChatId] = [];
                  const msgObj = { sender: 'me', type: 'voice', content: sec+"'", textVal: val, time: Date.now() };
                  store.chats[activeChatId].push(msgObj);
                  save(); 
                  appendMsgRow(msgObj, store.chats[activeChatId].length-1);
             }
             if(customInputType==='image-fake') {
                  // 使用 Canvas 本地生成，解决中文乱码
                  userSend('image', textToImage(val, '#cccccc', '#000000'));
             }
             if(customInputType==='transfer') {
                  const amt = parseFloat(val);
                  if(isNaN(amt)) return toast("金额无效");
                  if(store.user.balance < amt) return toast("余额不足");
                  store.user.balance -= amt;
                  store.bills.push({type:'out', amt, desc:'转账给'+store.contacts.find(x=>x.id===activeChatId)?.name, time:Date.now()});
                  userSend('transfer', `${amt}|转账`);
             }
             if(customInputType==='location') {
                  const val2 = document.getElementById('custom-input-area').value;
                  userSend('location', `${val}|${val2}`);
             }
             if(customInputType==='recharge') {
                  const amt = parseFloat(val);
                  if(isNaN(amt)) return toast("金额无效");
                  store.user.balance += amt;
                  store.bills.push({type:'in', amt, desc:'充值', time:Date.now()});
                  save(); openWallet();
             }
             if(customInputType==='moment-text') {
                  postMoment(val, null);
             }
             if(customInputType==='festival') {
                  const n = prompt("节日名称");
                  if(n) { store.perception.festivals.push({name:n, date:val}); save(); renderPerception(); }
             }
             if(customInputType==='wish') {
                  store.couple.wishes.push({id:Date.now(), text:val, author:'me', reply:''});
                  save(); renderCouple();
                  aiGenerate('wish_reply::'+val);
             }
             if(customInputType==='new-diary') {
                 const content = document.getElementById('custom-input-area').value;
                 if(activeDiaryContactId) {
                     if(!store.diaries[activeDiaryContactId]) store.diaries[activeDiaryContactId] = [];
                     store.diaries[activeDiaryContactId].push({title: val, content: content, date: new Date().toLocaleString(), time: Date.now()});
                     save();
                     // Refresh detail view if open
                     openDiaryDetail(activeDiaryContactId);
                 }
             }
             if(customInputType==='manual-memory') {
                 addManualMemory(val);
             }
             if(customInputType==='moment-comment') {
                if(val && val.trim()) {
                    const idx = context.idx;
                    const m = store.moments[idx];
                    if (m) {
                        if(!m.comments) m.comments = [];
                        m.comments.push({name:store.user.name, text:val});
                        save(); 
                        renderMoments();
                        
                        if(m.name !== store.user.name) {
                            const contact = store.contacts.find(c => c.name === m.name);
                            if(contact) {
                                setTimeout(() => {
                                    aiGenerate(`reply_moment_comment::${contact.id}::${m.id}::${val}::${store.user.name}`);
                                }, 500);
                            }
                        }
                    }
                }
             }

             if(customInputType==='listen-chat') {
                 sendListenChatFromModal(val);
             }
             
             save(); document.getElementById('modal-custom-input').style.display='none';
             window.customInputContext = {}; // Clear context
        }

        // 按住说话功能实现
        let voiceRecognition = null;
        let isRecording = false;
        let recordedText = '';

        function startVoice() {
            // 检查浏览器是否支持语音识别
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                toast("当前浏览器不支持语音识别", "error");
                return;
            }

            if (isRecording) return;
            
            try {
                isRecording = true;
                recordedText = '';
                
                // 初始化语音识别
                voiceRecognition = new SpeechRecognition();
                voiceRecognition.continuous = true;
                voiceRecognition.interimResults = true;
                voiceRecognition.lang = 'zh-CN';

                // 显示录音状态
                const inputField = document.getElementById('chat-input');
                const originalPlaceholder = inputField.placeholder;
                inputField.placeholder = '正在录音...';
                inputField.style.background = '#fff3cd';

                voiceRecognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    // 实时显示识别的文字
                    recordedText = finalTranscript || interimTranscript;
                    inputField.value = recordedText;
                };

                voiceRecognition.onerror = (event) => {
                    console.error('语音识别错误:', event.error);
                    isRecording = false;
                    inputField.placeholder = originalPlaceholder;
                    inputField.style.background = '#fff';
                    
                    if (event.error === 'no-speech') {
                        toast("未检测到语音", "error");
                    } else if (event.error === 'not-allowed') {
                        toast("请允许麦克风权限", "error");
                    } else {
                        toast("语音识别失败", "error");
                    }
                };

                voiceRecognition.onend = () => {
                    isRecording = false;
                    inputField.placeholder = originalPlaceholder;
                    inputField.style.background = '#fff';
                };

                voiceRecognition.start();
                toast("开始录音，松开发送");
                
            } catch (e) {
                console.error('启动语音识别失败:', e);
                isRecording = false;
                toast("启动录音失败", "error");
            }
        }

        function endVoice() {
            if (!isRecording || !voiceRecognition) return;
            
            try {
                voiceRecognition.stop();
                isRecording = false;
                
                // 等待一小段时间确保最后的识别结果被处理
                setTimeout(() => {
                    const inputField = document.getElementById('chat-input');
                    const text = inputField.value.trim();
                    
                    if (text) {
                        // 发送语音消息
                        if(!store.chats[activeChatId]) store.chats[activeChatId] = [];
                        const duration = Math.floor(Math.random() * 10 + 2);
                        const msgObj = { 
                            sender: 'me', 
                            type: 'voice', 
                            content: duration + "'", 
                            textVal: text, 
                            time: Date.now() 
                        };
                        store.chats[activeChatId].push(msgObj);
                        save(); 
                        appendMsgRow(msgObj, store.chats[activeChatId].length-1);
                        
                        // 清空输入框
                        inputField.value = '';
                        recordedText = '';
                        
                        toast("语音已发送");
                    } else {
                        toast("未识别到内容", "error");
                    }
                }, 300);
                
            } catch (e) {
                console.error('结束录音失败:', e);
                toast("结束录音失败", "error");
            }
        }
        function toggleVoiceText(idx) {
            const m = store.chats[activeChatId][idx];
            m.showText = !m.showText;
            save(); renderHistory();
        }
        
        function sendSticker(url, type, name = '') {
            if (type === 'emoji') {
                userSend('text', url);
            } else {
                userSend('image', url, { stickerName: name });
            }
        }

        function toggleStickerDrawer() {
            const panel = document.getElementById('sticker-panel');
            if (panel.style.display === 'grid') {
                panel.style.display = 'none';
            } else {
                renderStickerDrawer();
                panel.style.display = 'grid';
            }
        }
        
        function renderStickerDrawer() {
            const panel = document.getElementById('sticker-panel');
            panel.innerHTML = '';

            const contact = store.contacts.find(c => c.id === activeChatId);
            if (!contact || !contact.settings) {
                panel.innerHTML = '<div style="grid-column: 1 / -1; text-align:center; color:#999; padding:20px;">当前联系人未配置表情包</div>';
                return;
            }

            let stickersToShow = [];
            if(contact.settings.mountedCateIds && contact.settings.mountedCateIds.length > 0) {
                 const mountedCates = store.stickerCategories.filter(sc=>contact.settings.mountedCateIds.includes(sc.id));
                 mountedCates.forEach(cate => {
                    if (cate.stickers) stickersToShow.push(...cate.stickers);
                 });
            }

            if (stickersToShow.length === 0) {
                panel.innerHTML = '<div style="grid-column: 1 / -1; text-align:center; color:#999; padding:20px;">此联系人未挂载任何表情包</div>';
                return;
            }
            
            stickersToShow.forEach(s => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                if (s.type === 'emoji') {
                    item.innerText = s.url;
                    item.onclick = () => { userSend('text', s.url); panel.style.display = 'none'; };
                } else {
                    item.innerHTML = `<img src="${s.url}">`;
                    item.onclick = () => { userSend('image', s.url); panel.style.display = 'none'; };
                }
                panel.appendChild(item);
            });
        }

        function userSend(type, val, extra = {}) {
            const txt = val ||document.getElementById('chat-input').value;
            if(!txt && type==='text') return;

            if(!store.chats[activeChatId]) store.chats[activeChatId] = [];
            const msgObj = { sender: 'me', type, content: txt, time: Date.now(), ...extra };
            
            if(quoteContent) {
                msgObj.quote = quoteContent;
                cancelQuote();
            }

            store.chats[activeChatId].push(msgObj);
            const c = store.contacts.find(x=>x.id===activeChatId);
            if (c) c.lastMsgTime = Date.now();
            save(); 
            renderHistory();
            document.getElementById('chat-input').value = '';
            
            // Trigger AI response
            const currentChat = store.contacts.find(c => c.id === activeChatId);
            if (isOfflineInChat) {
                // Bug 2 Fix: Show loading bubble and generate reply for offline private chat
                showLoadingBubble();
                generateOfflineReplyInChat(txt);
            } else if (currentChat && currentChat.isGroup) {
                 setTimeout(() => aiGenerate(), 500);
            }
            
            // Memory Summary Trigger
            if (currentChat && currentChat.settings?.enableMemorySummary) {
                if(!currentChat.settings.msgCount) currentChat.settings.msgCount = 0;
                currentChat.settings.msgCount++;
                if (currentChat.settings.msgCount >= (currentChat.settings.memoryInterval || 20)) {
                    generateMemorySummary(activeChatId);
                    currentChat.settings.msgCount = 0; // Reset counter
                }
                save();
            }
        }
        function receiveTransfer(idx, sender) {
            const m = store.chats[activeChatId][idx];
            
            // If I sent it
            if(sender === 'me') {
                if(m.status === 'received') return toast("对方已收款");
                if(m.status === 'returned') return toast("钱款已退回");
                return toast("等待对方确认");
            }
            
            // If I received it
            if(m.status) return toast(m.status === 'received' ? "已收款" : "已退回");
            
            currentTransferMsgIdx = idx;
            document.getElementById('modal-transfer-action').style.display = 'flex';
        }

        function handleTransferAction(action) {
            const idx = currentTransferMsgIdx;
            if(idx === -1 || !store.chats[activeChatId]) return;
            
            const m = store.chats[activeChatId][idx];
            const amt = parseFloat(m.content.split('|')[0]);
            
            if(action === 'receive') {
                m.status = 'received';
                store.user.balance += amt;
                store.bills.push({type:'in', amt, desc:'收到转账', time:Date.now()});
                store.chats[activeChatId].push({ sender: 'me', type: 'transfer_receipt', content: m.content, status: 'received', time: Date.now() });
                showToast(`已收款 ￥${amt}`, 'success');
            } else if(action === 'return') {
                m.status = 'returned';
                // Note: Logic for returning money to sender (AI) is just visual here, AI balance not tracked.
                store.chats[activeChatId].push({ sender: 'me', type: 'transfer_receipt', content: m.content, status: 'returned', time: Date.now() });
                showToast("已退回转账", 'info');
            }
            
            save(); renderHistory();
            document.getElementById('modal-transfer-action').style.display = 'none';
        }
        function showThought() {
            const msgs = store.chats[activeChatId]||[];
            // 修复：向后查找最近的一条心声，确保退出重进后能看到上一轮的心声
            let lastMsg = null;
            for(let i=msgs.length-1; i>=0; i--) {
                if(msgs[i].heart) { lastMsg = msgs[i]; break; }
            }

            if(lastMsg && lastMsg.heart) {
                const heartData = lastMsg.heart.split('|');
                const html = `
                    <div style="font-size:14px; margin-bottom:5px;"><strong>位置:</strong> ${heartData[0]||'未知'}</div>
                    <div style="font-size:14px; margin-bottom:5px;"><strong>穿着:</strong> ${heartData[1]||'未知'}</div>
                    <div style="font-size:14px; margin-bottom:5px;"><strong>状态:</strong> ${heartData[2]||'未知'}</div>
                    <div style="font-size:14px; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">${heartData[3]||'无想法'}</div>
                `;
                document.getElementById('thought-text').innerHTML = html;
                document.getElementById('modal-thought').style.display = 'flex';
            } else {
                toast("暂无心声记录");
            }
        }

        function openHeartHistory() {
            document.getElementById('modal-thought').style.display = 'none';
            renderHeartHistory();
            document.getElementById('modal-heart-history').style.display = 'flex';
        }

        function renderHeartHistory() {
            const list = document.getElementById('heart-history-list');
            list.innerHTML = '';
            const msgs = store.chats[activeChatId] || [];
            const heartMsgs = msgs.map((m, i) => ({m, i})).filter(item => item.m.heart).reverse();

            if (heartMsgs.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">暂无历史记录</div>';
                return;
            }

            list.innerHTML = heartMsgs.map(item => {
                const { m, i } = item;
                const heartData = m.heart.split('|');
                const timeStr = new Date(m.time).toLocaleString();
                
                return `
                <div onclick="editHeartHistoryItem(${i})" style="background:#fff; padding:15px; border-radius:8px; margin-bottom:10px; border:1px solid #eee; box-shadow:0 1px 3px rgba(0,0,0,0.05); cursor:pointer;">
                    <div style="font-size:12px; color:#999; display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #f5f5f5; padding-bottom:5px;">
                        <span>${timeStr}</span>
                        <div>
                            <i class="fas fa-edit" style="margin-right:12px; color:#576b95;" onclick="event.stopPropagation(); editHeartHistoryItem(${i})"></i>
                            <i class="fas fa-trash" style="color:#fa5151; padding:5px;" onclick="event.stopPropagation(); deleteHeartHistoryItem(${i})"></i>
                        </div>
                    </div>
                    <div style="font-size:13px; line-height:1.5; margin-bottom:5px;">
                        <span style="color:#07c160; background:#e1ffc7; padding:2px 5px; border-radius:4px; margin-right:5px;">${heartData[0]||'未知'}</span> 
                        <span style="color:#ff758c; background:#ffeef1; padding:2px 5px; border-radius:4px; margin-right:5px;">${heartData[1]||'未知'}</span>
                        <span style="color:#f6c02d; background:#fff9c4; padding:2px 5px; border-radius:4px;">${heartData[2]||'未知'}</span>
                    </div>
                    <div style="font-size:14px; margin-top:8px; color:#333; background:#f9f9f9; padding:8px; border-radius:4px;">${heartData[3]||''}</div>
                </div>`;
            }).join('');
        }

        let editingHeartMsgIdx = null;

        function editHeartHistoryItem(idx) {
            const m = store.chats[activeChatId][idx];
            if (!m || !m.heart) return;
            
            editingHeartMsgIdx = idx;
            document.getElementById('heart-edit-title').innerText = "编辑心声";
            
            const parts = m.heart.split('|');
            document.getElementById('heart-loc').value = parts[0] || '';
            document.getElementById('heart-outfit').value = parts[1] || '';
            document.getElementById('heart-status').value = parts[2] || '';
            if (parts.length > 4) {
                 document.getElementById('heart-thought').value = parts.slice(3).join('|');
            } else {
                 document.getElementById('heart-thought').value = parts[3] || '';
            }
            
            document.getElementById('modal-heart-edit').style.display = 'flex';
        }

        function saveHeartEdit() {
            const loc = document.getElementById('heart-loc').value.trim();
            const outfit = document.getElementById('heart-outfit').value.trim();
            const status = document.getElementById('heart-status').value.trim();
            const thought = document.getElementById('heart-thought').value.trim();
            
            if(!loc && !outfit && !status && !thought) return toast("请至少填写一项内容");
            
            const heartStr = `${loc}|${outfit}|${status}|${thought}`;
            
            if (editingHeartMsgIdx !== null) {
                const m = store.chats[activeChatId][editingHeartMsgIdx];
                if (m) {
                    m.heart = heartStr;
                    toast("修改成功");
                }
            } else {
                if(!store.chats[activeChatId]) store.chats[activeChatId] = [];
                store.chats[activeChatId].push({
                    sender: 'ai',
                    type: 'text',
                    content: ' ', 
                    heart: heartStr,
                    time: Date.now(),
                    isHidden: true 
                });
                toast("添加成功");
            }
            
            save();
            renderHeartHistory();
            document.getElementById('modal-heart-edit').style.display = 'none';
        }

        function deleteHeartHistoryItem(idx) {
            showConfirm("删除心声", "确定删除这条心声吗? (消息本身不会被删除)", () => {
                const m = store.chats[activeChatId][idx];
                if (m) {
                    delete m.heart;
                    save();
                    renderHeartHistory();
                    toast("已删除");
                }
            });
        }

        function addHeartHistoryItem() {
            if (!activeChatId) return toast("请先进入聊天");
            editingHeartMsgIdx = null;
            document.getElementById('heart-edit-title').innerText = "添加心声";
            document.getElementById('heart-loc').value = '';
            document.getElementById('heart-outfit').value = '';
            document.getElementById('heart-status').value = '';
            document.getElementById('heart-thought').value = '';
            document.getElementById('modal-heart-edit').style.display = 'flex';
        }
        
        // --- CONTACTS ---
        function openContactModal() {
            document.getElementById('modal-contact').style.display = 'flex';
            document.getElementById('new-contact-name').value = '';
            document.getElementById('new-contact-persona').value = '';
            document.getElementById('new-contact-img').src = '';
            document.getElementById('new-contact-img').style.display='none';
        }
        function createContact() {
            const name = document.getElementById('new-contact-name').value;
            const persona = document.getElementById('new-contact-persona').value;
            const img = document.getElementById('new-contact-img').src;
            if(!name) return toast("请输入名字");
            
            store.contacts.push({
                id: 'c'+Date.now(), name, avatar: img || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`,
                persona: persona,
                settings: { 
                    autoMsg: false, autoMsgInterval: 30, autoMoment: false, autoDiary: false, diaryTime: '22:00', time: '', wb: '', userPersona: 'p1', bg: '', stickerGallery: '',
                    enablePerception: true, userVirtualCity: '', userRealCity: '', aiVirtualCity: '', aiRealCity: ''
                },
                pinned: false
            });
            save(); renderContacts(); document.getElementById('modal-contact').style.display='none';
        }
        
        function renderContacts() {
            const list = document.getElementById('contact-list');
            list.innerHTML = ''; // Clear previous content

            const sorted = [...store.contacts].sort((a, b) => {
                if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
                
                const lastMsgTimeA = a.lastMsgTime || 0;
                const lastMsgTimeB = b.lastMsgTime || 0;
                if (lastMsgTimeA !== lastMsgTimeB) return lastMsgTimeB - lastMsgTimeA;

                if (a.isGroup !== b.isGroup) return a.isGroup ? -1 : 1;
                return 0;
            });

            // Use a DocumentFragment for batch appending to improve performance
            const fragment = document.createDocumentFragment();

            sorted.forEach(c => {
                const item = document.createElement('div');
                item.className = 'list-item';
                if (c.pinned) item.style.background = '#f7f7f7';

                item.onclick = () => { if (!isLongPress) openChat(c.id); };
                item.ontouchstart = (e) => handleContactTouchStart(c.id, e);
                item.ontouchend = handleContactTouchEnd;
                item.onmousedown = (e) => handleContactMouseDown(c.id, e);
                item.onmouseup = handleContactMouseUp;
                item.oncontextmenu = (e) => e.preventDefault();

                // Avatar
                const avatar = document.createElement('img');
                avatar.src = c.avatar;
                avatar.className = 'avatar';
                item.appendChild(avatar);

                // Content
                const content = document.createElement('div');
                content.className = 'list-content';

                // Title
                const title = document.createElement('div');
                title.className = 'list-title';
                title.style.cssText = 'display:flex; align-items:center; gap:8px;';
                
                // Use textContent for security and performance
                const nameSpan = document.createElement('span');
                nameSpan.textContent = c.name;
                title.appendChild(nameSpan);

                if (c.isGroup) title.innerHTML += '<i class="fas fa-users" style="font-size:12px; color:#999;"></i>';
                if (c.pinned) title.innerHTML += '<i class="fas fa-thumbtack" style="font-size:12px; color:#ccc; margin-left:auto;"></i>';
                
                content.appendChild(title);

                // Subtitle
                let subText;
                const chatHistory = store.chats[c.id];
                if (chatHistory && chatHistory.length > 0) {
                    subText = getMsgText(chatHistory[chatHistory.length - 1]);
                } else {
                    subText = c.isGroup ? `群聊` : (c.persona || '');
                }
                const sub = document.createElement('div');
                sub.className = 'list-sub';
                sub.textContent = subText.substring(0, 22) + (subText.length > 22 ? '...' : '');
                content.appendChild(sub);

                item.appendChild(content);
                fragment.appendChild(item);
            });

            list.appendChild(fragment);
        }

        // --- GROUP CHAT ---
        function gotoAddGroup() {
            const layer = document.getElementById('layer-add-group');
            const list = document.getElementById('add-group-contact-list');
            
            const availableContacts = store.contacts.filter(c => !c.isGroup);
            
            selectedGroupContacts.clear();
            list.innerHTML = '';

            availableContacts.forEach(c => {
                list.innerHTML += `
                    <div class="list-item" onclick="toggleGroupContactSelect(this, '${c.id}')">
                        <div style="width:24px; height:24px; border:1px solid #ccc; border-radius:4px; margin-right:15px; display:flex; justify-content:center; align-items:center;" class="checkbox-icon">
                            <i class="fas fa-check" style="color:var(--primary); display:none;"></i>
                        </div>
                        <img src="${c.avatar}" class="avatar">
                        <div class="list-content">
                            <div class="list-title">${c.name}</div>
                        </div>
                    </div>
                `;
            });
            
            layer.classList.add('show');
            document.getElementById('wx-add-menu').style.display = 'none';
        }

        function toggleGroupContactSelect(el, contactId) {
            const checkbox = el.querySelector('.checkbox-icon i');
            if (selectedGroupContacts.has(contactId)) {
                selectedGroupContacts.delete(contactId);
                checkbox.style.display = 'none';
                el.style.background = '#fff';
            } else {
                selectedGroupContacts.add(contactId);
                checkbox.style.display = 'block';
                el.style.background = '#f7f7f7';
            }
        }

        function confirmCreateGroup() {
            if (selectedGroupContacts.size < 1) {
                return toast("请至少选择一位联系人");
            }

            const memberIds = Array.from(selectedGroupContacts);
            const members = store.contacts.filter(c => memberIds.includes(c.id));
            const groupName = `群聊 (${members.length + 1})`; // +1 for the user

            const newGroup = {
                id: 'g' + Date.now(),
                name: groupName,
                avatar: 'https://ui-avatars.com/api/?name=G&background=random&color=fff',
                isGroup: true,
                members: memberIds,
                settings: {
                     historyInteroperability: false,
                     enablePerception: true,
                }
            };

            store.contacts.unshift(newGroup); // Add to top of list
            save();
            renderContacts();
            closeLayer('layer-add-group');
            openChat(newGroup.id);
        }

        // --- CONTACT LONG PRESS ---
        function handleContactTouchStart(cid, e) {
            isLongPress = false;
            selectedContactId = cid;
            longPressTimer = setTimeout(() => { 
                isLongPress = true; 
                showContactMenu(e.touches[0].clientX, e.touches[0].clientY); 
            }, 500);
        }
        function handleContactTouchEnd() { 
            clearTimeout(longPressTimer);
        }
        function handleContactMouseDown(cid, e) {
            if(e.button !== 0) return; 
            isLongPress = false;
            selectedContactId = cid;
            clearTimeout(longPressTimer); // Prevent multiple timers
            longPressTimer = setTimeout(() => { 
                isLongPress = true; 
                showContactMenu(e.clientX, e.clientY); 
            }, 500);
        }
        function handleContactMouseUp() { 
            clearTimeout(longPressTimer);
        }
        
        function showContactMenu(x, y) {
            const menu = document.getElementById('contact-menu');
            const c = store.contacts.find(x=>x.id===selectedContactId);
            if(!c) return;
            
            document.getElementById('cm-pin').innerText = c.pinned ? "取消置顶" : "置顶聊天";
            
            menu.style.display = 'flex';
            
            // Measure first
            menu.style.visibility = 'hidden';
            menu.style.display = 'flex';
            const rect = menu.getBoundingClientRect();
            menu.style.visibility = 'visible';

            let finalX = x;
            let finalY = y;

            if (finalX + rect.width > window.innerWidth) {
                finalX = window.innerWidth - rect.width - 10;
            }
            if (finalX < 10) finalX = 10;

            if (finalY + rect.height > window.innerHeight) {
                finalY = window.innerHeight - rect.height - 10;
            }

            menu.style.left = finalX + 'px';
            menu.style.top = finalY + 'px';
        }
        
        function pinContact() {
            const c = store.contacts.find(x=>x.id===selectedContactId);
            if(c) {
                c.pinned = !c.pinned;
                save(); renderContacts();
                document.getElementById('contact-menu').style.display='none';
            }
        }
        
        function deleteContact() {
            const contact = store.contacts.find(x => x.id === selectedContactId);
            if (!contact) return;
            document.getElementById('contact-menu').style.display = 'none';
            showConfirm(
                `删除联系人`, 
                `确定要删除联系人 "${contact.name}" 吗？所有相关数据都将被清除。`,
                () => thoroughDeleteContact(selectedContactId)
            );
        }

        // --- MSG LONG PRESS & MENU ---
        function openWorldBookSelector() {
            const c = store.contacts.find(x => x.id === activeChatId);
            if (!c) return;

            const modal = document.getElementById('modal-wb-select');
            const listEl = document.getElementById('wb-select-list');
            const allWbs = store.worldbooks || [];
            
            // Initialize temp selection from stored settings
            tempSelectedWbIds = c.settings.mountedWbIds ? [...c.settings.mountedWbIds] : [];
            // For backward compatibility, if single wb is set, add it to the list
            if (c.settings.wb && !tempSelectedWbIds.includes(c.settings.wb)) {
                tempSelectedWbIds.push(c.settings.wb);
            }

            listEl.innerHTML = allWbs.map(wb => {
                const isSelected = tempSelectedWbIds.includes(wb.id);
                return `
                    <div onclick="toggleWbSelect(this, '${wb.id}')" class="sticker-select-item" style="padding:10px; border:1px solid ${isSelected ? '#07c160' : '#ddd'}; border-radius:6px; cursor:pointer; background:#fff; display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
                        <span>${wb.name}</span>
                        ${isSelected ? '<i class="fas fa-check" style="color:#07c160;"></i>' : ''}
                    </div>
                `;
            }).join('') || '<div style="color:#999; text-align:center;">暂无世界书</div>';

            modal.style.display = 'flex';
        }

        function toggleWbSelect(el, wbId) {
            const index = tempSelectedWbIds.indexOf(wbId);
            if (index > -1) {
                tempSelectedWbIds.splice(index, 1);
                el.style.borderColor = '#ddd';
                el.querySelector('.fa-check')?.remove();
            } else {
                tempSelectedWbIds.push(wbId);
                el.style.borderColor = '#07c160';
                if (!el.querySelector('.fa-check')) el.innerHTML += '<i class="fas fa-check" style="color:#07c160;"></i>';
            }
        }

        function saveChatWBSelection() {
            const c = store.contacts.find(x => x.id === activeChatId);
            if (c) {
                if (!c.settings) c.settings = {};
                c.settings.mountedWbIds = [...tempSelectedWbIds];
                c.settings.wb = ''; // Deprecate the old single selection
                save();
                // Force immediate save for critical setting to prevent data loss on refresh
                idb.set('AIChatOS_v8', store).catch(console.error);
                try {
                    localStorage.setItem('AIChatOS_v8_Core', JSON.stringify({
                        user: store.user,
                        theme: store.theme,
                        system: store.system,
                        contactsSettings: store.contacts.map(con => ({id: con.id, settings: con.settings, pinned: con.pinned}))
                    }));
                } catch(e) {}
                
                openChatSettings(); // Re-render settings to show new count
                toast("挂载成功");
            }
            document.getElementById('modal-wb-select').style.display = 'none';
        }

        function handleMsgTouchStart(idx, e) {
            isLongPress = false;
            // 移除这里的 toggleSelectMsg，改为 click 处理
            // 仅保留长按菜单检测
            if(isMultiSelect) return; 

            selectedMsgIdx = idx;
            longPressTimer = setTimeout(() => { 
                isLongPress = true; 
                showMsgMenu(e.touches[0].clientX, e.touches[0].clientY); 
            }, 500);
        }
        function handleMsgTouchEnd() { 
            clearTimeout(longPressTimer);
        }
        function handleMsgMouseDown(idx, e) {
            if(isMultiSelect) return; // 点击选择由 onclick 处理

            if(e.button !== 0) return;
            isLongPress = false;
            selectedMsgIdx = idx;
            longPressTimer = setTimeout(() => { 
                isLongPress = true; 
                showMsgMenu(e.clientX, e.clientY); 
            }, 500);
        }
        function handleMsgMouseUp() { 
            clearTimeout(longPressTimer);
        }

        function showMsgMenu(x, y) {
            const menu = document.getElementById('msg-menu');
            
            const m = store.chats[activeChatId] ? store.chats[activeChatId][selectedMsgIdx] : null;
            const playBtn = document.getElementById('menu-btn-play');
            
            if (m && m.sender !== 'me' && (m.type === 'text' || (m.type === 'voice' && m.textVal))) {
                playBtn.style.display = 'block';
            } else {
                playBtn.style.display = 'none';
            }

            menu.style.display = 'flex';
            
            // Measure
            menu.style.visibility = 'hidden';
            menu.style.display = 'flex';
            const rect = menu.getBoundingClientRect();
            menu.style.visibility = 'visible';

            let finalX = x;
            let finalY = y;

            if (finalX + rect.width > window.innerWidth) {
                finalX = window.innerWidth - rect.width - 10;
            }
            if (finalX < 10) finalX = 10;

            if (finalY + rect.height > window.innerHeight) {
                finalY = window.innerHeight - rect.height - 10;
            }

            menu.style.left = finalX + 'px';
            menu.style.top = finalY + 'px';
        }

        function menuPlayVoice() {
            playVoiceMessage(selectedMsgIdx);
            document.getElementById('msg-menu').style.display='none';
        }

        function menuQuote() {
            const m = store.chats[activeChatId][selectedMsgIdx];
            if(!m) return;
            quoteContent = (m.sender==='me'?'我':store.contacts.find(c=>c.id===activeChatId).name) + ": " + getMsgText(m);
            document.getElementById('quote-text').innerText = quoteContent;
            document.getElementById('quote-preview').style.display = 'flex';
            document.getElementById('msg-menu').style.display='none';
        }

        function cancelQuote() {
            quoteContent = null;
            document.getElementById('quote-preview').style.display = 'none';
        }

        function menuCopy() {
            const m = store.chats[activeChatId][selectedMsgIdx];
            if(m) {
                const text = getMsgText(m);
                navigator.clipboard.writeText(text).then(()=>toast("已复制"));
            }
            document.getElementById('msg-menu').style.display='none';
        }

        function menuEdit() {
            const m = store.chats[activeChatId][selectedMsgIdx];
            if(m) {
                // 问题16修复：定位消息编辑时保留完整信息
                if(m.type === 'location') {
                    const parts = m.content.split('|');
                    const title = parts[0] || '';
                    const detail = parts[1] || '';
                    
                    const newTitle = prompt("编辑位置标题:", title);
                    if(newTitle !== null) {
                        const newDetail = prompt("编辑具体地点:", detail);
                        if(newDetail !== null) {
                            m.content = newTitle + '|' + newDetail;
                            save(); renderHistory();
                        }
                    }
                } else {
                    const newText = prompt("编辑消息:", m.content);
                    if(newText !== null && newText !== m.content) {
                        m.content = newText;
                        if(m.type === 'voice') m.textVal = newText;
                        save(); renderHistory();
                    }
                }
            }
            document.getElementById('msg-menu').style.display='none';
        }

        function menuSelect() {
            isMultiSelect = true;
            document.getElementById('chat-history').classList.add('multi-select-mode'); // 修复：为聊天记录添加模式类
            document.getElementById('chat-select-bar').style.display = 'flex';
            toggleSelectMsg(selectedMsgIdx);
            document.getElementById('msg-menu').style.display='none';
        }
        
        function toggleSelectMsg(idx) {
            if(selectedMsgs.has(idx)) selectedMsgs.delete(idx);
            else selectedMsgs.add(idx);
            renderHistory(true);
        }

        function cancelSelect(keepScroll = false) {
            isMultiSelect = false;
            selectedMsgs.clear();
            document.getElementById('chat-history').classList.remove('multi-select-mode'); // 修复：移除模式类
            document.getElementById('chat-select-bar').style.display = 'none';
            renderHistory(keepScroll);
        }

        function deleteSelected() {
            if(selectedMsgs.size === 0) return;
            // 问题2修复：改用自定义确认框
            showConfirm("删除消息", `确定要删除 ${selectedMsgs.size} 条消息吗?`, () => {
                const sorted = Array.from(selectedMsgs).sort((a,b)=>b-a);
                sorted.forEach(idx => {
                    store.chats[activeChatId].splice(idx, 1);
                });
                save();
                // 修复：取消选择并保持滚动位置
                cancelSelect(true); 
                toast("删除成功");
            });
        }
        
        function menuDelete() {
             showConfirm("删除消息", "确定要删除这条消息吗?", () => {
                store.chats[activeChatId].splice(selectedMsgIdx, 1);
                save(); 
                renderHistory(true); // 修复：保持滚动位置
                toast("消息已删除");
             });
             document.getElementById('msg-menu').style.display='none';
        }

        function menuRecall() {
            const m = store.chats[activeChatId][selectedMsgIdx];
            if (!m) return;
            
            if (m.sender === 'me') {
                m.originalType = m.type;
                m.originalContent = m.content;
                m.type = 'recalled';
                m.content = '你撤回了一条消息';
            } else {
                // Allow recalling AI messages for simulation purposes
                m.originalType = m.type;
                m.originalContent = m.content;
                m.type = 'recalled';
                m.content = `对方撤回一条消息`;
            }
            m.recalled = true;
            
            save();
            renderHistory(true); // 修复：保持滚动位置
            toast("消息已撤回");
            document.getElementById('msg-menu').style.display = 'none';
        }

        function getMsgText(m) {
            if(m.type==='text') return m.content;
            if(m.type==='voice') return m.textVal || '[语音]';
            if(m.type==='image') return '[图片]';
            if(m.type==='transfer') return '[转账]';
            if(m.type==='location') return '[位置] ' + m.content;
            return m.content;
        }
        
        // Close menu on click elsewhere (Duplicate logic handled in window.onclick above, removing this listener)

        // --- CHAT SETTINGS ---
        function openChatSettings() {
             const c = store.contacts.find(x=>x.id===activeChatId);
             if(!c) return;
             document.getElementById('layer-chat-settings').classList.add('show');
             
             if(!c.settings) c.settings = { autoMsg: false, autoMsgInterval: 30, autoMoment: false, autoDiary: false, diaryTime: '22:00', time: '', wb: '', userPersona: 'p1', bg: '', stickerGallery: '' };
             
             let settingsHTML = '';
             if (c.isGroup) {
                // [FIX-1] 恢复群聊核心设置界面
                const mountedWbCount = c.settings.mountedWbIds ? c.settings.mountedWbIds.length : (c.settings.wb ? 1 : 0);
                const allCates = store.stickerCategories || [];
                 const currentCateIds = c.settings.mountedCateIds || [];
                 const enableMemory = c.settings.enableMemorySummary || false;
                 const memoryInterval = c.settings.memoryInterval || 20;

                settingsHTML = `
                <div style="text-align:center; padding:20px;">
                    <div class="upload-box" style="width:80px; height:80px; border-radius:50%; margin:0 auto; background:#fff;" onclick="uploadImg('edit-contact-avatar')"><img src="${c.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;"></div>
                    <input id="edit-c-name" value="${c.name}" style="margin-top:10px; text-align:center; border:none; background:transparent; font-size:18px; font-weight:bold;">
                </div>
                 <div class="group-box">
                     <div class="form-cell"><span class="form-label"><b>记忆总结系统</b></span><div class="switch"><input type="checkbox" id="edit-c-memory-enable" ${enableMemory?'checked':''} onchange="document.getElementById('memory-interval-cell').style.display=this.checked?'flex':'none'"><span class="slider"></span></div></div>
                     <div class="form-cell" id="memory-interval-cell" style="display:${enableMemory?'flex':'none'};"><span class="form-label">触发间隔(条)</span><input type="number" id="edit-c-memory-interval" value="${memoryInterval}" style="width:50px; text-align:right; border: 1px solid #ddd; border-radius: 4px; padding: 2px 5px;"></div>
                 </div>
                <div class="group-box">
                     <div class="form-cell"><span class="form-label">历史互通 (记忆共享)</span><div class="switch"><input type="checkbox" id="edit-c-history" ${c.settings.historyInteroperability?'checked':''}><span class="slider"></span></div></div>
                </div>
                <div class="group-box">
                    <div class="form-cell" onclick="openWorldBookSelector()"><span class="form-label">挂载世界书</span><span class="form-val">${mountedWbCount}个</span><i class="fas fa-chevron-right form-arrow"></i></div>
                    <div class="form-cell" onclick="toggleStickerMount()"><span class="form-label">挂载表情分类</span><span class="form-val" id="sticker-count">${currentCateIds.length}个</span><i class="fas fa-chevron-right form-arrow"></i></div>
                    <div id="sticker-mount-area" style="display:none; padding:10px; background:#f9f9f9; flex-direction:column; gap:5px;">
                        ${allCates.length>0 ? allCates.map(cate => `<div onclick="toggleStickerSelect(this, '${cate.id}')" class="sticker-select-item" style="padding:10px; border:1px solid ${currentCateIds.includes(cate.id)?'#07c160':'#ddd'}; border-radius:6px; cursor:pointer; background:#fff; display:flex; justify-content:space-between; align-items:center;"><span>${cate.name}</span> ${currentCateIds.includes(cate.id) ? '<i class="fas fa-check" style="color:#07c160;"></i>' : ''}</div>`).join('') : '<div style="font-size:12px; color:#999;">无分类</div>'}
                    </div>
                </div>
                 <div class="group-box">
                     <div class="form-cell"><span class="form-label">聊天背景</span><button onclick="uploadImg('chat-bg')" style="font-size:12px; padding:5px 10px;">上传</button></div>
                     <div class="form-cell"><span class="form-label">天气与时间感知</span><div class="switch"><input type="checkbox" id="edit-c-perc-en" ${c.settings.enablePerception!==false?'checked':''}><span class="slider"></span></div></div>
                </div>
                `;
             } else {
                // Full settings for private chat
                const mountedWbCount = c.settings.mountedWbIds ? c.settings.mountedWbIds.length : (c.settings.wb ? 1 : 0);
                const pOpts = store.personas.map(p=>`<option value="${p.id}" ${c.settings.userPersona===p.id?'selected':''}>${p.name}</option>`).join('');
                const allCates = store.stickerCategories || [];
                const currentCateIds = c.settings.mountedCateIds || [];
                const enableMemory = c.settings.enableMemorySummary || false;
                const memoryInterval = c.settings.memoryInterval || 20;

                settingsHTML = `
                    <div style="text-align:center; padding:20px;">
                        <div class="upload-box" style="width:80px; height:80px; border-radius:50%; margin:0 auto; background:#fff;" onclick="uploadImg('edit-contact-avatar')"><img src="${c.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;"></div>
                        <input id="edit-c-name" value="${c.name}" style="margin-top:10px; text-align:center; border:none; background:transparent; font-size:18px; font-weight:bold;">
                    </div>
                    <div class="group-box">
                         <div class="form-cell"><span class="form-label"><b>记忆总结系统</b></span><div class="switch"><input type="checkbox" id="edit-c-memory-enable" ${enableMemory?'checked':''} onchange="document.getElementById('memory-interval-cell').style.display=this.checked?'flex':'none'"><span class="slider"></span></div></div>
                         <div class="form-cell" id="memory-interval-cell" style="display:${enableMemory?'flex':'none'};"><span class="form-label">触发间隔(条)</span><input type="number" id="edit-c-memory-interval" value="${memoryInterval}" style="width:50px; text-align:right; border: 1px solid #ddd; border-radius: 4px; padding: 2px 5px;"></div>
                     </div>
                    <div class="group-box">
                        <div class="form-cell" style="flex-direction:column; align-items:center;">
                            <span class="form-label" style="font-weight:bold; margin-bottom:5px;">人设</span>
                            <textarea id="edit-c-persona" style="width:100%; height:100px; border:1px solid #eee; padding:5px; resize:none; border-radius:5px;">${c.persona || ''}</textarea>
                        </div>
                    </div>
                    <div class="group-box">
                        <div class="form-cell" onclick="openWorldBookSelector()"><span class="form-label">挂载世界书</span><span class="form-val">${mountedWbCount}个</span><i class="fas fa-chevron-right form-arrow"></i></div>
                        <div class="form-cell"><span class="form-label">我的身份</span><select id="edit-c-up" style="width:150px;">${pOpts}</select></div>
                        <div class="form-cell"><span class="form-label">聊天背景</span><button onclick="uploadImg('chat-bg')" style="font-size:12px; padding:5px 10px;">上传</button></div>
                        <div class="form-cell" onclick="toggleStickerMount()"><span class="form-label">挂载表情分类</span><span class="form-val" id="sticker-count">${currentCateIds.length}个</span><i class="fas fa-chevron-right form-arrow"></i></div>
                        <div id="sticker-mount-area" style="display:none; padding:10px; background:#f9f9f9; flex-direction:column; gap:5px;">
                            ${allCates.length>0 ? allCates.map(cate => `<div onclick="toggleStickerSelect(this, '${cate.id}')" class="sticker-select-item" style="padding:10px; border:1px solid ${currentCateIds.includes(cate.id)?'#07c160':'#ddd'}; border-radius:6px; cursor:pointer; background:#fff; display:flex; justify-content:space-between; align-items:center;"><span>${cate.name}</span> ${currentCateIds.includes(cate.id) ? '<i class="fas fa-check" style="color:#07c160;"></i>' : ''}</div>`).join('') : '<div style="font-size:12px; color:#999;">无分类</div>'}
                        </div>
                    </div>
                    <div class="group-box">
                        <div class="form-cell"><span class="form-label">主动发消息</span><div class="switch"><input type="checkbox" id="edit-c-auto" ${c.settings.autoMsg?'checked':''}><span class="slider"></span></div></div>
                        <div class="form-cell"><span class="form-label">主动间隔(分)</span><input type="number" id="edit-c-auto-int" value="${c.settings.autoMsgInterval||30}" style="width:50px; text-align:right;"></div>
                        <div class="form-cell"><span class="form-label">主动发动态</span><div class="switch"><input type="checkbox" id="edit-c-auto-mom" ${c.settings.autoMoment?'checked':''}><span class="slider"></span></div></div>
                        <div class="form-cell"><span class="form-label">定时写日记</span><div class="switch"><input type="checkbox" id="edit-c-auto-dia" ${c.settings.autoDiary?'checked':''}><span class="slider"></span></div></div>
                        <div class="form-cell"><span class="form-label">日记时间</span><input type="time" id="edit-c-dia-time" value="${c.settings.diaryTime||'22:00'}" style="border:none;"></div>
                        <div class="form-cell"><span class="form-label">强制禁止动作描写</span><div class="switch"><input type="checkbox" id="edit-c-no-action" ${c.settings.noActionDescription?'checked':''}><span class="slider"></span></div></div>
                        <div class="form-cell"><span class="form-label">线下/线上记忆互通</span><div class="switch"><input type="checkbox" id="edit-c-mem-interop" ${c.settings.memoryInterop?'checked':''}><span class="slider"></span></div></div>
                    </div>
                    <h3 style="margin:10px 15px; color:#555;">语音设置</h3>
                    <div class="group-box">
                        <div class="form-cell">
                            <span class="form-label">开启语音合成 (TTS)</span>
                            <div class="switch"><input type="checkbox" id="edit-c-enable-tts" ${c.settings.enableTTS?'checked':''}><span class="slider"></span></div>
                        </div>
                        <div class="form-cell">
                            <span class="form-label">音色ID</span>
                            <input id="edit-c-voice-id" value="${c.settings.voiceId||'male-qn-qingse'}" style="border:1px solid #e5e5e5; border-radius:8px; padding:8px; width:150px; text-align:center;" placeholder="输入音色ID">
                        </div>
                        <div class="form-cell">
                            <span class="form-label">语言</span>
                            <select id="edit-c-voice-lang">
                                <option value="zh" ${(!c.settings.voiceLang || c.settings.voiceLang==='zh')?'selected':''}>中文 (Chinese)</option>
                                <option value="en" ${c.settings.voiceLang==='en'?'selected':''}>英文 (English)</option>
                                <option value="ja" ${c.settings.voiceLang==='ja'?'selected':''}>日语 (Japanese)</option>
                                <option value="ko" ${c.settings.voiceLang==='ko'?'selected':''}>韩语 (Korean)</option>
                                <option value="es" ${c.settings.voiceLang==='es'?'selected':''}>西班牙语 (Spanish)</option>
                                <option value="fr" ${c.settings.voiceLang==='fr'?'selected':''}>法语 (French)</option>
                                <option value="de" ${c.settings.voiceLang==='de'?'selected':''}>德语 (German)</option>
                                <option value="id" ${c.settings.voiceLang==='id'?'selected':''}>印尼语 (Indonesian)</option>
                            </select>
                        </div>
                    </div>
                    <h3 style="margin:10px 15px; color:#555;">感知设置</h3>
                    <div class="group-box">
                        <div class="form-cell"><span class="form-label">天气与时间感知</span><div class="switch"><input type="checkbox" id="edit-c-perc-en" ${c.settings.enablePerception!==false?'checked':''}><span class="slider"></span></div></div>
                        <div class="form-cell" style="flex-direction:column; align-items:flex-start; background:#f9f9f9;"><span class="form-label" style="font-size:14px; font-weight:bold; margin-bottom:5px;">用户所在地</span><div style="width:100%; display:flex; gap:10px; margin-bottom:5px;"><input id="edit-c-user-v-city" placeholder="虚拟城市" value="${c.settings.userVirtualCity||''}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;"><input id="edit-c-user-r-city" placeholder="真实城市" value="${c.settings.userRealCity||''}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;"></div></div>
                        <div class="form-cell" style="flex-direction:column; align-items:flex-start; background:#f9f9f9;"><span class="form-label" style="font-size:14px; font-weight:bold; margin-bottom:5px;">AI 所在地 (留空则同用户)</span><div style="width:100%; display:flex; gap:10px; margin-bottom:5px;"><input id="edit-c-ai-v-city" placeholder="虚拟城市" value="${c.settings.aiVirtualCity||''}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;"><input id="edit-c-ai-r-city" placeholder="真实城市" value="${c.settings.aiRealCity||''}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;"></div></div>
                    </div>
                `;
             }
             document.getElementById('chat-settings-content').innerHTML = settingsHTML;
             
             const btn = document.getElementById('btn-pin-contact');
             if(btn) {
                 btn.innerText = c.pinned ? "取消置顶" : "置顶";
                 btn.style.background = c.pinned ? "#ddd" : "#576b95";
                 btn.style.color = c.pinned ? "#333" : "#fff";
             }
        }
        let tempMountedCateIds = [];
        
        function toggleStickerMount() {
            const area = document.getElementById('sticker-mount-area');
            const c = store.contacts.find(x=>x.id===activeChatId);
            if(!c) return;
            // Init temp list
            tempMountedCateIds = c.settings.mountedCateIds || [];
            area.style.display = area.style.display === 'none' ? 'flex' : 'none';
        }
        
        function toggleStickerSelect(el, id) {
            if(tempMountedCateIds.includes(id)) {
                tempMountedCateIds = tempMountedCateIds.filter(x=>x!==id);
                el.style.borderColor = '#ddd';
                el.querySelector('.fa-check')?.remove();
            } else {
                tempMountedCateIds.push(id);
                el.style.borderColor = '#07c160';
                if(!el.querySelector('.fa-check')) el.innerHTML += '<i class="fas fa-check" style="color:#07c160;"></i>';
            }
            document.getElementById('sticker-count').innerText = tempMountedCateIds.length + '个';
        }

        function saveChatSettings() {
            const c = store.contacts.find(x=>x.id===activeChatId);
            if(!c) return;
            
            // [FIX-1] 重构设置保存逻辑，兼容群聊和私聊
            // 通用设置
            c.name = document.getElementById('edit-c-name').value;
            c.settings.enablePerception = document.getElementById('edit-c-perc-en').checked;

            // 记忆总结设置
            const memoryEnableEl = document.getElementById('edit-c-memory-enable');
            if (memoryEnableEl) {
                c.settings.enableMemorySummary = memoryEnableEl.checked;
                const memoryIntervalEl = document.getElementById('edit-c-memory-interval');
                if (memoryIntervalEl) {
                     c.settings.memoryInterval = parseInt(memoryIntervalEl.value) || 20;
                }
            }

            if (c.isGroup) {
                // 仅群聊设置
                const historyEl = document.getElementById('edit-c-history');
                if(historyEl) c.settings.historyInteroperability = historyEl.checked;
            } else { 
                // 仅私聊设置
                c.persona = document.getElementById('edit-c-persona').value;
                c.settings.userPersona = document.getElementById('edit-c-up').value;
                c.settings.autoMsg = document.getElementById('edit-c-auto').checked;
                c.settings.autoMsgInterval = parseInt(document.getElementById('edit-c-auto-int').value);
                c.settings.autoMoment = document.getElementById('edit-c-auto-mom').checked;
                c.settings.autoDiary = document.getElementById('edit-c-auto-dia').checked;
                c.settings.diaryTime = document.getElementById('edit-c-dia-time').value;
                c.settings.noActionDescription = document.getElementById('edit-c-no-action').checked;
                c.settings.memoryInterop = document.getElementById('edit-c-mem-interop').checked;
                c.settings.userVirtualCity = document.getElementById('edit-c-user-v-city').value;
                c.settings.userRealCity = document.getElementById('edit-c-user-r-city').value;
                c.settings.aiVirtualCity = document.getElementById('edit-c-ai-v-city').value;
                c.settings.aiRealCity = document.getElementById('edit-c-ai-r-city').value;
                c.settings.enableTTS = document.getElementById('edit-c-enable-tts').checked;
                c.settings.voiceId = document.getElementById('edit-c-voice-id').value;
                c.settings.voiceLang = document.getElementById('edit-c-voice-lang').value;
            }

            // 通用的挂载表情包设置
            const area = document.getElementById('sticker-mount-area');
            if(area && area.style.display !== 'none') {
                c.settings.mountedCateIds = [...tempMountedCateIds];
            }
            
            save(); 
            renderContacts();
            renderHistory(); // Refresh chat view to reflect persona/avatar changes
            document.getElementById('chat-title').innerText = c.name; 
            toast("设置已保存");
        }
        
        function pinContactToggle() {
            const c = store.contacts.find(x=>x.id===activeChatId);
            if(c) {
                c.pinned = !c.pinned;
                save(); renderContacts();
                const btn = document.getElementById('btn-pin-contact');
                if(btn) {
                    btn.innerText = c.pinned ? "取消置顶" : "置顶";
                    btn.style.background = c.pinned ? "#ddd" : "#576b95";
                    btn.style.color = c.pinned ? "#333" : "#fff";
                }
                toast(c.pinned ? "已置顶" : "已取消置顶");
            }
        }
        
        function deleteContactFromSettings() {
            const contact = store.contacts.find(x => x.id === activeChatId);
            if (!contact) return;
            showConfirm(
                `删除联系人`,
                `确定要删除联系人 "${contact.name}" 吗？此操作将清除该联系人的聊天记录、日记、动态等所有数据，且不可恢复。`,
                () => thoroughDeleteContact(activeChatId, true)
            );
        }

        function thoroughDeleteContact(contactId, fromSettings = false) {
            const contact = store.contacts.find(x => x.id === contactId);
            if (!contact) return;

            const name = contact.name;

            // 1. Delete Contact
            store.contacts = store.contacts.filter(x => x.id !== contactId);
            
            // 2. Delete Chat History
            delete store.chats[contactId];
            
            // 3. Delete Diaries
            delete store.diaries[contactId];
            
            // 4. Delete Moments (by name)
            if (name) {
                store.moments = store.moments.filter(m => m.name !== name);
            }
            
            // 5. Unbind from Couple space if they are the partner
            if (store.couple.partnerId === contactId) {
                store.couple = { partnerId: null, start: '', wishes: [], anniversaries: [], cycleDate: '', cycleLen: 28 };
            }

            // [NEW] 6. Delete Offline Chat
            if (store.offlineChats) {
                delete store.offlineChats[contactId];
            }

            // [NEW] 7. Remove from any groups
            store.contacts.forEach(c => {
                if (c.isGroup && c.members && c.members.includes(contactId)) {
                    c.members = c.members.filter(mId => mId !== contactId);
                }
            });

            save();
            renderContacts();
            renderMoments(); // Refresh moments as some might be deleted
            toast(`已彻底删除联系人: ${name}`);

            if (fromSettings) {
                document.getElementById('layer-chat-settings').classList.remove('show');
                document.getElementById('layer-chat').classList.remove('show');
            }
        }

        function saveSysSettings() {
             let url = document.getElementById('sys-url').value;
             if(url.endsWith('/')) url = url.slice(0,-1);
             store.system.url = url;
             store.system.key = document.getElementById('sys-key').value;
             store.system.model = document.getElementById('sys-model').value;
             store.system.temp = document.getElementById('sys-temp').value;
             
             // Save MiniMax settings
             if(!store.system.minimax) store.system.minimax = {};
             store.system.minimax.version = document.getElementById('mm-version').value;
             store.system.minimax.groupId = document.getElementById('mm-group-id').value;
             store.system.minimax.apiKey = document.getElementById('mm-api-key').value;
             store.system.minimax.model = document.getElementById('mm-model').value;
             
             save(); toast("系统配置已保存");
        }

        async function fetchModels() {
             const url = document.getElementById('sys-url').value;
             const key = document.getElementById('sys-key').value;
             showToast("正在拉取模型...", "info");
             try {
                 const data = await API.fetchModels(url, key);
                 const models = Array.isArray(data) ? data : (data.data || []);
                 
                 const sel = document.getElementById('sys-model');
                 sel.innerHTML = '';
                 models.forEach(m => {
                     const opt = document.createElement('option');
                     const id = m.id || m;
                     opt.value = id; opt.innerText = id;
                     sel.appendChild(opt);
                 });
                 
                 store.system.url = url;
                 store.system.key = key;
                 if(models.length > 0 && !models.find(m => (m.id || m) === store.system.model)) {
                     store.system.model = (models[0].id || models[0]);
                 }
                 save(); 
                 showToast("模型列表已更新", "success");
             } catch(e) {
                 console.error(e);
                 // Error toast already shown by API.fetchModels
             }
        }

        async function fetchModelsForPreset() {
             const url = document.getElementById('preset-url').value;
             const key = document.getElementById('preset-key').value;
             showToast("正在拉取...", "info");
             try {
                 const data = await API.fetchModels(url, key);
                 const models = Array.isArray(data) ? data : (data.data || []);
                 
                 if(models.length > 0) {
                     const input = document.getElementById('preset-model');
                     const modelNames = models.map(m => m.id || m);
                     input.value = modelNames[0]; // Default to first
                     
                     const p = document.getElementById('modal-picker');
                     const l = document.getElementById('picker-list');
                     document.getElementById('picker-title').innerText = "选择模型";
                     l.innerHTML = modelNames.map(m => `<div class="list-item" onclick="document.getElementById('preset-model').value='${m}'; document.getElementById('modal-picker').style.display='none'">${m}</div>`).join('');
                     p.style.display='flex';
                     
                     showToast("拉取成功，请选择", "success");
                 } else {
                     showToast("未找到可用模型", "error");
                 }
             } catch(e) {
                 console.error(e);
                 // Error already handled
             }
        }

        // --- API PRESETS ---
        function renderAPIPresets() {
            const list = document.getElementById('api-preset-list');
            if(!store.apiPresets) store.apiPresets = [];
            
            list.innerHTML = store.apiPresets.length === 0 ? '<div style="padding:20px; text-align:center; color:#999;">暂无预设</div>' : '';
            
            store.apiPresets.forEach((p,i) => {
                list.innerHTML += `<div class="form-cell">
                        <span class="form-label">${p.name}</span>
                        <button onclick="loadAPIPreset(${i})" style="padding:5px 10px; border:none; background:var(--primary); color:#fff; border-radius:4px; margin-right:10px;">加载</button><button onclick="deleteAPIPreset(${i})" style="padding:5px 10px; border:none; background:#fa5151; color:#fff; border-radius:4px;">删除</button>
                    </div>
                `;
            });
        }

        function openAPIPresetModal() {
            document.getElementById('modal-api-preset').style.display = 'flex';
            document.getElementById('preset-name').value = '';
            document.getElementById('preset-url').value = '';
            document.getElementById('preset-key').value = '';
            document.getElementById('preset-model').value = '';
        }

        function saveAPIPreset() {
            const name = document.getElementById('preset-name').value;
            const url = document.getElementById('preset-url').value;
            const key = document.getElementById('preset-key').value;
            const model = document.getElementById('preset-model').value;
            
            if(!name || !url || !key || !model) return toast("请填写完整信息");
            
            if(!store.apiPresets) store.apiPresets = [];
            store.apiPresets.push({name, url, key, model});
            save(); renderAPIPresets();document.getElementById('modal-api-preset').style.display = 'none';
            toast("预设已保存");
        }

        function loadAPIPreset(idx) {
            const p = store.apiPresets[idx];
            document.getElementById('sys-url').value = p.url;
            document.getElementById('sys-key').value = p.key;
            
            const sel = document.getElementById('sys-model');
            let found = false;
            for(let i=0; i<sel.options.length; i++) {
                if(sel.options[i].value === p.model) { found = true; break; }
            }
            if(!found) {
                const opt = document.createElement('option');
                opt.value = p.model; opt.innerText = p.model;
                sel.appendChild(opt);
            }
            sel.value = p.model;
            
            toast("预设已加载: " + p.name);
        }

        function deleteAPIPreset(idx) {
            if(confirm("确定删除此预设?")) {
                store.apiPresets.splice(idx, 1);
                save(); renderAPIPresets();
            }
        }

        // --- MOMENTS ---
        function renderMoments() {
            const feed = document.getElementById('moments-feed');
            const bg = store.user.momentBg || 'https://via.placeholder.com/800x600/333/666';
            
            // 使用传统的innerHTML方式，但优化结构
            let html = `
                <div style="height:300px; background:url(${bg}) center/cover; position:relative; cursor:pointer;" onclick="uploadImg('moment-bg')">
                    <div style="position:absolute; bottom:-20px; right:20px; display:flex; align-items:flex-end;">
                        <div style="color:#fff; font-weight:bold; margin-bottom:30px; margin-right:10px; text-shadow:0 1px 2px #000;">${store.user.name}</div>
                        <img src="${store.user.avatar||'https://via.placeholder.com/100'}" style="width:70px; height:70px; border-radius:8px; border:2px solid #fff; background:#fff;">
                    </div>
                </div>
                <div style="height:40px;"></div>
            `;
            
            store.moments.forEach((m, idx) => {
                const liked = m.likes && m.likes.includes('me');
                const likeColor = liked ? '#fa5151' : '#576b95';
                const comments = m.comments || [];
                
                html += `
                    <div style="padding:15px; border-bottom:1px solid #eee; background:#fff;">
                        <div style="display:flex; gap:10px;">
                            <img src="${m.avatar}" class="avatar" style="width:40px; height:40px;">
                            <div style="flex:1;">
                                <div style="color:#576b95; font-weight:bold; font-size:15px;">${m.name}</div>
                                <div style="margin:5px 0; font-size:15px;">${m.content}</div>
                                ${m.img ? `<img src="${m.img}" style="max-width:200px; max-height:200px; border-radius:4px; margin-top:5px; cursor:pointer;" onclick="showBigImg('${m.img}')">` : ''}
                                
                                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                                    <span style="font-size:12px; color:#999;">${new Date(m.time).toLocaleTimeString()}</span>
                                    <div style="display:flex; gap:15px; align-items:center;">
                                        <div style="cursor:pointer; color:${likeColor}; display:flex; align-items:center; gap:4px;" onclick="toggleLike(${idx})">
                                            <i class="${liked?'fas':'far'} fa-heart"></i> ${liked?'':'点赞'}
                                        </div>
                                        <div style="cursor:pointer; color:#576b95; display:flex; align-items:center; gap:4px;" onclick="addComment(${idx})">
                                            <i class="far fa-comment"></i> 评论
                                        </div>
                                        <i class="fas fa-trash" style="color:#ddd; cursor:pointer;" onclick="deleteMoment(${idx})"></i>
                                    </div>
                                </div>
                                
                                ${(m.likes?.length > 0 || comments.length > 0) ? `
                                    <div style="background:#f7f7f7; padding:8px; margin-top:10px; border-radius:4px;">
                                        ${m.likes?.length > 0 ? `<div style="color:#576b95; font-size:13px; margin-bottom:5px;"><i class="far fa-heart"></i> ${m.likes.includes('me')?'我':''}${m.likes.length>1?', ...':''}</div>` : ''}
                                        ${comments.map(cm => `<div style="font-size:13px; margin-bottom:2px;"><span style="color:#576b95; font-weight:500;">${cm.name}${cm.replyTo?` 回复 ${cm.replyTo}`:''}:</span> ${cm.text}</div>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            feed.innerHTML = html;
        }
        
        function showMomentActionSheet() {
            document.getElementById('modal-moment-action').style.display='flex';
        }
        
        function postMoment(t, i) {
             if (!t) return toast("请输入内容");
             const mId = Date.now();
             store.moments.unshift({
                 id: mId,
                 name: store.user.name, 
                 avatar: store.user.avatar, 
                 content: t, 
                 img: i, 
                 time: mId,
                 likes: [],
                 comments: []
             });
             save(); 
             renderMoments();
             toast("朋友圈已发布");
             
             // 修复：确保所有AI联系人都对用户的动态发表评论
             const allAIContacts = store.contacts.filter(c => !c.isGroup);
             allAIContacts.forEach((c, idx) => {
                 // 使用错开的延迟来模拟真实世界的响应时间
                 setTimeout(() => {
                    aiGenerate(`comment_user_moment::${c.id}::${mId}::${t.substring(0,20)}`);
                 }, 2000 + Math.random() * 5000 * idx);
             });
        }
        
        function deleteMoment(idx) {
            showConfirm("删除动态", "确定要删除这条动态吗？", () => {
                store.moments.splice(idx, 1);
                save();
                renderMoments();
                toast("动态已删除", "success");
            });
        }
        
        function toggleLike(idx) {
            const m = store.moments[idx];
            if(!m.likes) m.likes = [];
            
            if(m.likes.includes('me')) {
                m.likes = m.likes.filter(x=>x!=='me');
            } else {
                m.likes.push('me');
            }
            save(); renderMoments();
        }
        
        function addComment(idx) {
            openCustomInput('moment-comment', { idx: idx });
        }

        // --- ME ---
        function openProfileEdit() {
             document.getElementById('p-edit-name').value = store.user.name;
             document.getElementById('p-edit-wxid').value = store.user.wxid;
             document.getElementById('modal-profile-edit').style.display='flex';
        }
        function saveProfileEdit() {
             store.user.name = document.getElementById('p-edit-name').value;
             store.user.wxid = document.getElementById('p-edit-wxid').value;
             save(); document.getElementById('my-name').innerText=store.user.name;document.getElementById('my-wxid').innerText=store.user.wxid;
             document.getElementById('modal-profile-edit').style.display='none';
        }
        function openWallet() {document.getElementById('layer-wallet').classList.add('show');
            document.getElementById('wallet-amt').innerText = store.user.balance.toFixed(2);
            const bills = store.bills || [];
            document.getElementById('wallet-bill').innerHTML = bills.map(b=>`<div class="list-item"><div class="list-title">${b.desc}</div><div class="list-sub">${b.type==='out'?'-':'+'}${b.amt}</div></div>`).join('');}

        // --- PERSONA MGMT ---
        function openPersonaMgmt() {document.getElementById('layer-persona-mgmt').classList.add('show'); renderPersonas(); }
        function openPersonaModal(id = null) {
            editingPersonaId = id;
            const modal = document.getElementById('modal-persona');
            const title = modal.querySelector('h3');
            
            if (id) {
                const p = store.personas.find(x => x.id === id);
                if (!p) return;
                title.innerText = '编辑人设';
                document.getElementById('new-p-name').value = p.name;
                document.getElementById('new-p-desc').value = p.desc;
                document.getElementById('new-persona-img').src = p.avatar || '';
                document.getElementById('new-persona-img').style.display = p.avatar ? 'block' : 'none';
            } else {
                title.innerText = '新建人设';
                document.getElementById('new-p-name').value = '';
                document.getElementById('new-p-desc').value = '';
                document.getElementById('new-persona-img').src = '';
                document.getElementById('new-persona-img').style.display = 'none';
            }
            modal.style.display = 'flex';
        }

        function saveNewPersona() {
             const n = document.getElementById('new-p-name').value;
             const d = document.getElementById('new-p-desc').value;
             const img = document.getElementById('new-persona-img').src;
             if(!n) return toast("请输入名称");
             
             if (editingPersonaId) {
                const p = store.personas.find(x => x.id === editingPersonaId);
                if (p) {
                    p.name = n;
                    p.desc = d;
                    p.avatar = img;
                    toast("人设已更新");
                }
             } else {
                store.personas.push({id:'p'+Date.now(), name:n, desc:d, avatar:img});
                toast("人设已创建");
             }
             
             save(); renderPersonas(); document.getElementById('modal-persona').style.display='none';
             editingPersonaId = null;
        }

        function deletePersona(id) {
            if (id === 'p1') return toast("默认人设不能删除", "error");
            if (confirm("确定删除这个人设吗？")) {
                store.personas = store.personas.filter(p => p.id !== id);
                // Also reset any contacts using this persona to default
                store.contacts.forEach(c => {
                    if (c.settings && c.settings.userPersona === id) {
                        c.settings.userPersona = 'p1';
                    }
                });
                save();
                renderPersonas();
                toast("人设已删除");
            }
        }

        function renderPersonas() {
             const l = document.getElementById('persona-list'); l.innerHTML = '';
             store.personas.forEach(p => {
                 l.innerHTML += `<div class="group-box" style="padding:15px; display:flex; align-items:center;">
                    <img src="${p.avatar||'https://via.placeholder.com/50'}" class="avatar" style="margin-right:10px;">
                    <div style="flex:1;"><strong>${p.name}</strong><p>${p.desc}</p></div>
                    <i class="fas fa-edit" style="cursor:pointer; color:#999; margin-left:10px;" onclick="openPersonaModal('${p.id}')"></i>
                    ${p.id !== 'p1' ? `<i class="fas fa-trash" style="cursor:pointer; color:#fa5151; margin-left:10px;" onclick="deletePersona('${p.id}')"></i>` : ''}
                </div>`;
             });
        }

        // --- WORLD BOOK ---
        function openWBModal() { 
            document.getElementById('new-wb-name').value = '';
            document.getElementById('new-wb-content').value = '';
            document.getElementById('new-wb-cate-sel').value = '';
            document.getElementById('modal-wb').style.display='flex'; 
            updateCategorySelect();
        }
        function openCategoryModal() {document.getElementById('modal-category').style.display='flex';
        }
        function saveCategory() {
            const name = document.getElementById('new-category-name').value;
            if(!name) return toast("请输入分类名称");
            if(!store.categories) store.categories = [];
            store.categories.push(name);
            save(); 
            document.getElementById('modal-category').style.display='none';
            toast("分类已创建", "success");
            // Refresh both the worldbook view and the category selector in the modal
            renderWorldBooks();
            updateCategorySelect();
        }
        function updateCategorySelect() {
            const sel = document.getElementById('new-wb-cate-sel');
            sel.innerHTML = '<option value="">无分类</option>';
            (store.categories||[]).forEach(c => {
                sel.innerHTML += `<option value="${c}">${c}</option>`;
            });
        }
        function saveNewWorldBook() {
             const n = document.getElementById('new-wb-name').value;
             const c = document.getElementById('new-wb-content').value;
             const cate = document.getElementById('new-wb-cate-sel').value;
             if(!n) return toast("请输入名称");
             if(!store.worldbooks) store.worldbooks = [];
             store.worldbooks.push({id:'wb'+Date.now(), name:n, content:c, cate});
             save(); renderWorldBooks(); document.getElementById('modal-wb').style.display='none';
        }
        let activeWBCategory = 'all';

        function renderWorldBooks() {
             // Render Category Bar
             const catBar = document.getElementById('wb-category-bar');
             const categories = ['全部', ...(store.categories || [])];
             catBar.innerHTML = categories.map((c, i) => {
                const val = i === 0 ? 'all' : c;
                // Add long-press/context-menu handlers, but not for "全部"
                const interactionHandlers = i > 0 ? `
                    oncontextmenu="showWBCategoryMenu(event, '${val}')"
                    ontouchstart="handleWBCategoryTouchStart(event, '${val}')"
                    ontouchend="handleWBCategoryTouchEnd()"` : '';
                return `<div class="wb-cate-chip ${activeWBCategory === val ? 'active' : ''}" onclick="filterWorldBook('${val}')" ${interactionHandlers}>${c}</div>`;
             }).join('');

             // Render List
             const l = document.getElementById('wb-list'); 
             l.innerHTML='';
             
             let list = store.worldbooks || [];
             if(activeWBCategory !== 'all') {
                 list = list.filter(w => w.cate === activeWBCategory);
             }
             
             if(list.length === 0) {
                 l.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">暂无内容</div>';
             } else {
                 list.forEach((w, idx) => {
                    const item = document.createElement('div');
                    item.className = 'group-box wb-item';
                    item.style.padding = '15px';
                    
                    // Header click to toggle collapse, but ignore if clicking buttons
                    item.onclick = function(e) { 
                        if(!e.target.closest('.wb-btn') && !e.target.closest('textarea')) {
                            this.classList.toggle('collapsed'); 
                        }
                    };

                    item.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <strong>${w.name}</strong> 
                                ${w.cate ? `<span style="background:#f0f0f0; padding:2px 8px; border-radius:4px; font-size:12px; margin-left:5px;">${w.cate}</span>` : ''}
                            </div>
                            <button class="wb-btn edit" onclick="editWbItem(this, '${w.id}')">编辑</button>
                        </div>
                        <div class="wb-content" id="wb-content-${w.id}">${w.content}</div>
                        <div class="wb-edit-area" id="wb-edit-${w.id}">
                            <textarea id="wb-textarea-${w.id}">${w.content}</textarea>
                            <div class="wb-btn-row">
                                <button class="wb-btn del" onclick="deleteWbItem('${w.id}')">删除</button>
                                <button class="wb-btn cancel" onclick="cancelEditWbItem('${w.id}')">取消</button>
                                <button class="wb-btn save" onclick="saveWbItem('${w.id}')">保存</button>
                            </div>
                        </div>
                    `;
                    l.appendChild(item);
                 });
             }
        }

        function editWbItem(btn, id) {
            const item = btn.closest('.wb-item');
            item.classList.remove('collapsed'); // Ensure expanded
            document.getElementById(`wb-content-${id}`).style.display = 'none';
            document.getElementById(`wb-edit-${id}`).style.display = 'block';
            btn.style.display = 'none';
        }

        function cancelEditWbItem(id) {
            document.getElementById(`wb-content-${id}`).style.display = 'block';
            document.getElementById(`wb-edit-${id}`).style.display = 'none';
            // Show edit button again
            const item = document.getElementById(`wb-edit-${id}`).closest('.wb-item');
            item.querySelector('.wb-btn.edit').style.display = 'inline-block';
        }

        function saveWbItem(id) {
            const newContent = document.getElementById(`wb-textarea-${id}`).value;
            const wb = store.worldbooks.find(w => w.id === id);
            if(wb) {
                wb.content = newContent;
                save();
                renderWorldBooks();
                toast("已保存");
            }
        }

        function deleteWbItem(id) {
            if(confirm("确定删除这条世界书内容吗？")) {
                store.worldbooks = store.worldbooks.filter(w => w.id !== id);
                save();
                renderWorldBooks();
                toast("已删除");
            }
        }
        
        function filterWorldBook(cat) {
            activeWBCategory = cat;
            renderWorldBooks();
        }

        function handleWBCategoryTouchStart(e, catName) {
            isLongPress = false;
            activeWBCategoryName = catName;
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                showWBCategoryMenu(e, catName);
            }, 500);
        }

        function handleWBCategoryTouchEnd() {
            clearTimeout(longPressTimer);
        }

        function showWBCategoryMenu(e, catName) {
            e.preventDefault();
            e.stopPropagation();
            activeWBCategoryName = catName;
            const menu = document.getElementById('wb-category-menu');
            
            // Use clientX/Y from touch or mouse event
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;

            menu.style.display = 'flex';
            const rect = menu.getBoundingClientRect();
            menu.style.left = `${Math.min(x, window.innerWidth - rect.width - 10)}px`;
            menu.style.top = `${Math.min(y, window.innerHeight - rect.height - 10)}px`;
        }

        function renameWBCategory() {
            if (!activeWBCategoryName) return;
            const newName = prompt(`重命名分类 "${activeWBCategoryName}":`);
            if (newName && newName.trim() !== activeWBCategoryName) {
                const oldName = activeWBCategoryName;
                // Update category in the main list
                const index = store.categories.indexOf(oldName);
                if (index > -1) {
                    store.categories[index] = newName;
                }
                // Update all worldbooks using this category
                (store.worldbooks || []).forEach(wb => {
                    if (wb.cate === oldName) {
                        wb.cate = newName;
                    }
                });
                // If the renamed category was the active one, update it
                if (activeWBCategory === oldName) {
                    activeWBCategory = newName;
                }
                save();
                renderWorldBooks();
                toast('分类已重命名', 'success');
            }
            document.getElementById('wb-category-menu').style.display = 'none';
        }

        function deleteWBCategory() {
            if (!activeWBCategoryName) return;
            showConfirm('删除分类', `确定要删除分类 "${activeWBCategoryName}" 吗？该分类下的世界书将变为“无分类”。`, () => {
                const nameToDelete = activeWBCategoryName;
                // Remove from categories list
                store.categories = (store.categories || []).filter(c => c !== nameToDelete);
                // Un-categorize associated world books
                (store.worldbooks || []).forEach(wb => {
                    if (wb.cate === nameToDelete) {
                        wb.cate = '';
                    }
                });
                // If the deleted category was active, switch to 'all'
                if (activeWBCategory === nameToDelete) {
                    activeWBCategory = 'all';
                }
                save();
                renderWorldBooks();
                toast('分类已删除');
            });
            document.getElementById('wb-category-menu').style.display = 'none';
        }


        // --- COUPLE ---
        function openCoupleSelector() {
            coupleViewMode = 'selector';
            renderCouple();
        }
        
        function gotoCoupleDetail() {
            coupleViewMode = 'detail';
            renderCouple();
        }

        function renderCouple() {
            if(!store.couple) store.couple = { partnerId: null, start: '', wishes: [], anniversaries: [], cycleDate:'', cycleLen:28 };
            
            const area = document.getElementById('couple-content-area');
            if(!area) return;
            area.innerHTML = '';

            if (coupleViewMode === 'list') {
                 let html = `
                    <div class="nav-bar" style="background:#ededed; color:#000; position:relative; margin-top:54px;">
                        <div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-title">情侣空间</div>
                        <div class="nav-icon" onclick="openCoupleSelector()"><i class="fas fa-plus"></i></div>
                    </div>
                    <div class="scroll-y" style="background:#f2f2f2; padding:20px;">
                 `;
                 
                 if (store.couple.partnerId) {
                     const p = store.contacts.find(x=>x.id===store.couple.partnerId);
                     const days = store.couple.start ? Math.floor((new Date() - new Date(store.couple.start))/(1000*60*60*24)) : 0;
                     html += `
                        <div onclick="gotoCoupleDetail()" style="background:#fff; border-radius:12px; padding:20px; display:flex; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                             <div style="position:relative;">
                                 <img src="${store.user.avatar||'https://via.placeholder.com/50'}" style="width:50px; height:50px; border-radius:50%; border:2px solid #fff;">
                                 <img src="${p?p.avatar:'https://via.placeholder.com/50'}" style="width:50px; height:50px; border-radius:50%; border:2px solid #fff; margin-left:-15px;">
                             </div>
                             <div style="margin-left:15px; flex:1;">
                                 <div style="font-weight:bold; font-size:16px;">我和${p?p.name:'TA'}</div>
                                 <div style="color:#ff758c; font-size:13px; margin-top:5px;">已相爱 ${days} 天</div>
                             </div>
                <i class="fas fa-chevron-right" style="color:#ccc;"></i>
                        </div>
                     `;
                 } else {
                     html += `<div style="text-align:center; color:#999; margin-top:100px;">暂无情侣关系<br>点击右上角建立</div>`;
                 }
                 html += `</div>`;
                 area.innerHTML = html;
                } else if (coupleViewMode === 'selector') {
                 let html = `
                    <div class="nav-bar" style="background:#fff; color:#000; position:relative; margin-top:64px;">
                        <div class="nav-icon" onclick="coupleViewMode='list';renderCouple()"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-title">选择另一半</div>
                        <div class="nav-icon"></div>
                    </div>
                    <div class="scroll-y" style="background:#f2f2f2; padding:15px;">
                        <div style="color:#777; margin-bottom:10px; font-size:13px; padding-left:5px;">选择联系人建立关系</div>
                        ${store.contacts.map(c=>`
                            <div class="list-item" onclick="bindCouple('${c.id}')" style="border-radius:12px; margin-bottom:10px;">
                                <img src="${c.avatar}" class="avatar">
                                <div class="list-content"><div class="list-title">${c.name}</div></div>
                                <i class="fas fa-heart" style="color:#e5e5e5;"></i>
                            </div>`).join('')}
                    </div>
                 `;
                 area.innerHTML = html;

            } else if (coupleViewMode === 'detail') {
                const days = store.couple.start ? Math.floor((new Date() - new Date(store.couple.start))/(1000*60*60*24)) : 0;
                let html = `
                    <div class="nav-bar" style="background:transparent; position:absolute; top:54px; width:100%; border:none; color:#fff; z-index:100;">
                        <div class="nav-icon" onclick="coupleViewMode='list';renderCouple()" style="color:#fff;"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-title" style="color:#fff; font-size:20px; font-weight:bold;">情侣空间</div>
                        <div class="nav-icon" style="color:#fff;" onclick="toggleAddMenu(event, 'couple')"><i class="fas fa-cog"></i></div>
                    </div>
                     <div class="add-menu" id="couple-add-menu">
                        <div class="add-item" onclick="openCoupleDateModal()">设置开始日期</div>
                        <div class="add-item" onclick="openAnniversaryModal()">添加纪念日</div>
                        <div class="add-item" onclick="unbindCouple()">解除关系</div>
                    </div>
                    <div class="scroll-y" style="background:#f2f2f2;">
                        <div class="couple-pink-header">
                            <div style="font-size:18px; opacity:0.9; margin-bottom:5px;">我们在一起</div>
                            <div class="couple-days-num">${days}</div>
                            <div style="font-size:18px; opacity:0.9;">天</div>
                        </div>
                        <div class="couple-card"><h3 style="margin:0 0 15px; color:#ff758c;"><i class="fas fa-venus"></i> 经期助手</h3>
                             <div class="group-box" style="margin:0 0 20px; border:1px solid #ffeef1; background:#fffafa;">
                                 <div class="form-cell"><span class="form-label">最近经期</span><input type="date" id="cycle-date" class="form-val" style="border:none; background:transparent;" value="${store.couple.cycleDate}" onchange="updateCycle(this.value)"></div>
                                 <div class="form-cell"><span class="form-label">周期长度</span><input type="number" id="cycle-len" class="form-val" value="${store.couple.cycleLen}" style="border:none; width:50px; background:transparent;" onchange="updateCycleLen(this.value)"> 天</div>
                                 <div class="form-cell">
                                    <span class="form-label">经期关怀提醒</span>
                                    <div class="switch"><input type="checkbox" id="cycle-remind-en" ${store.couple.reminderEnabled?'checked':''} onchange="saveCoupleCycleSettings()"><span class="slider"></span></div>
                                 </div>
                                 <div id="cycle-settings-more" style="display:${store.couple.reminderEnabled?'block':'none'}">
                                     <div class="form-cell"><span class="form-label">提前提醒天数</span><input type="number" id="cycle-remind-days" class="form-val" value="${store.couple.reminderDaysBefore||3}" style="border:none; width:50px; background:transparent;" onchange="saveCoupleCycleSettings()"> 天</div>
                                     <div class="form-cell" onclick="openCycleContactSelector()">
                                         <span class="form-label">关怀大使 (自动提醒)</span>
                                         <span class="form-val">${(store.couple.careContacts||[]).length}人</span>
                                         <i class="fas fa-chevron-right form-arrow"></i>
                                     </div>
                                 </div>
                             </div>
                             
                             <h3 style="margin:0 0 15px; color:#ff758c;"><i class="fas fa-gift"></i> 纪念日</h3>
                             <div style="margin-bottom:20px;">
                                 ${(store.couple.anniversaries||[]).length === 0 ? '<div style="color:#999; text-align:center; padding:10px;">暂无纪念日</div>' : ''}
                                 ${(store.couple.anniversaries||[]).map(a=>`<div class="list-item" style="border-radius:12px; margin-bottom:8px; border:1px solid #eee;"><div class="list-title">${a.name}</div><div class="list-sub" style="margin-left:auto;">${a.date}<span style="font-size:12px; background:#ffeef1; color:#ff758c; padding:2px 6px; border-radius:4px;">${a.repeat==='year'?'每年':'一次'}</span></div></div>`).join('')}
                             </div>
                             
                             <h3 style="margin:0 0 15px; color:#ff758c; display:flex; justify-content:space-between; align-items:center;"><span><i class="fas fa-star"></i> 心愿单</span> <i class="fas fa-plus-circle" style="cursor:pointer;" onclick="openCustomInput('wish')"></i></h3>
                             <div>
                                ${(store.couple.wishes||[]).length === 0 ? '<div style="color:#999; text-align:center; padding:10px;">许个愿吧~ AI会帮你规划</div>' : ''}
                                ${(store.couple.wishes||[]).map(w=>`
                                    <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:10px; border-left:4px solid ${w.author==='me'?'#ff758c':'#a18cd1'};">
                                        <div style="font-size:15px; color:#333; margin-bottom:8px;">${w.text}</div>
                                        ${w.reply ? `<div style="background:#fff; padding:10px; border-radius:8px; font-size:13px; color:#666; display:flex; gap:8px;"><i class="fas fa-robot" style="color:#ff758c; margin-top:2px;"></i><div>${w.reply}</div></div>` : ''}
                                    </div>
                                `).join('')}
                             </div>
                        </div>
                    </div>
                `;
                area.innerHTML = html;
            }
        }
        
        function bindCouple(id) {
            store.couple.partnerId = id;
            store.couple.start = new Date().toISOString();
            save(); 
            coupleViewMode = 'detail';
            renderCouple();
        }
        function unbindCouple() { 
            if(confirm("解除关系?")) { 
                store.couple = {partnerId:null, start:'', cycleDate:'', anniversaries:[], wishes:[]}; 
                save(); coupleViewMode='list'; renderCouple(); 
            } 
        }
        function openCoupleDateModal() {
            document.getElementById('modal-couple-date').style.display='flex';
            if(store.couple.start) {
                document.getElementById('couple-start-date').value = store.couple.start.split('T')[0];
            }
        }
        function saveCoupleStartDate() {
            const dateVal = document.getElementById('couple-start-date').value;
            if(dateVal) {
                store.couple.start = new Date(dateVal).toISOString();
                save(); renderCouple();
                document.getElementById('modal-couple-date').style.display='none';
                toast("日期已设置");
            }
        }
        function updateCycle(v) { store.couple.cycleDate=v; save(); }
        function updateCycleLen(v) { store.couple.cycleLen=parseInt(v); save(); }
        
        function saveCoupleCycleSettings() {
            store.couple.reminderEnabled = document.getElementById('cycle-remind-en').checked;
            store.couple.reminderDaysBefore = parseInt(document.getElementById('cycle-remind-days').value) || 3;
            document.getElementById('cycle-settings-more').style.display = store.couple.reminderEnabled ? 'block' : 'none';
            save();
        }

        let tempCycleContacts = [];
        function openCycleContactSelector() {
            tempCycleContacts = store.couple.careContacts ? [...store.couple.careContacts] : [];
            const modal = document.getElementById('modal-wb-select'); // Reuse generic list modal style, but logic differs
            
            const listEl = document.getElementById('wb-select-list');
            const modalTitle = modal.querySelector('h3');
            const confirmBtn = modal.querySelector('button:last-child');
            const cancelBtn = modal.querySelector('button:first-child');
            
            modalTitle.innerText = "选择关怀大使";
            
            // Filter out groups only (allow all private contacts)
            const candidates = store.contacts.filter(c => !c.isGroup);
            
            listEl.innerHTML = candidates.map(c => {
                const isSelected = tempCycleContacts.includes(c.id);
                return `
                    <div onclick="toggleCycleContact(this, '${c.id}')" class="sticker-select-item" style="padding:10px; border:1px solid ${isSelected ? '#ff758c' : '#ddd'}; border-radius:6px; cursor:pointer; background:#fff; display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${c.avatar}" style="width:30px; height:30px; border-radius:50%;">
                            <span>${c.name}</span>
                        </div>
                        ${isSelected ? '<i class="fas fa-check" style="color:#ff758c;"></i>' : ''}
                    </div>
                `;
            }).join('') || '<div style="color:#999; text-align:center;">没有可选的联系人</div>';

            // Override buttons
            confirmBtn.onclick = confirmCycleContacts;
            cancelBtn.onclick = () => { modal.style.display = 'none'; }; // Close
            
            modal.style.display = 'flex';
        }

        function toggleCycleContact(el, id) {
            const index = tempCycleContacts.indexOf(id);
            if (index > -1) {
                tempCycleContacts.splice(index, 1);
                el.style.borderColor = '#ddd';
                el.querySelector('.fa-check')?.remove();
            } else {
                tempCycleContacts.push(id);
                el.style.borderColor = '#ff758c';
                if (!el.querySelector('.fa-check')) el.innerHTML += '<i class="fas fa-check" style="color:#ff758c;"></i>';
            }
        }

        function confirmCycleContacts() {
            store.couple.careContacts = [...tempCycleContacts];
            save();
            renderCouple(); // Refresh UI to show count
            document.getElementById('modal-wb-select').style.display = 'none';
            toast("关怀大使已设置");
        }

        function openAnniversaryModal() { document.getElementById('modal-anniv').style.display='flex'; }
        function saveAnniversary() {const n = document.getElementById('ani-name').value;
             const d = document.getElementById('ani-date').value;
             const r = document.getElementById('ani-repeat').value;
             if(!n || !d) return toast("请填写完整信息");
             if(!store.couple.anniversaries) store.couple.anniversaries = [];
             store.couple.anniversaries.push({name:n, date:d, repeat:r});
             save(); renderCouple(); document.getElementById('modal-anniv').style.display='none';}

        // --- LISTEN TOGETHER & MUSIC ---
        // Entry point: Open contact selector
        function openMusic() { 
            const list = document.getElementById('listen-contact-list');
            list.innerHTML = `
                <div class="list-item" onclick="startListenTogether(null)">
                    <div class="avatar" style="background:#333; display:flex; justify-content:center; align-items:center; color:#fff;"><i class="fas fa-user"></i></div>
                    <div class="list-content"><div class="list-title">独自聆听</div></div>
                    <i class="fas fa-chevron-right" style="color:#ddd;"></i>
                </div>
            `;
            
            const contacts = store.contacts.filter(c => !c.isGroup);
            contacts.forEach(c => {
                list.innerHTML += `
                    <div class="list-item" onclick="startListenTogether('${c.id}')">
                        <img src="${c.avatar}" class="avatar">
                        <div class="list-content"><div class="list-title">${c.name}</div></div>
                        <i class="fas fa-chevron-right" style="color:#ddd;"></i>
                    </div>
                `;
            });
            
            document.getElementById('modal-listen-contact').style.display = 'flex';
        }

        let listenTimerInterval = null;
        let listenLyricInterval = null;
        let currentListenPage = 0;

        // Swipe Logic
        let listenTouchStartX = 0;
        let listenTouchStartY = 0;
        const listenSwipeContainer = document.getElementById('listen-swipe-container');

        listenSwipeContainer.addEventListener('touchstart', (e) => {
            listenTouchStartX = e.changedTouches[0].screenX;
            listenTouchStartY = e.changedTouches[0].screenY;
        }, {passive: true});

        listenSwipeContainer.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            handleListenSwipe(touchEndX, touchEndY);
        }, {passive: true});
        
        // Also support mouse swipe for desktop testing
        listenSwipeContainer.addEventListener('mousedown', (e) => {
            listenTouchStartX = e.screenX;
            listenTouchStartY = e.screenY;
        });
        
        listenSwipeContainer.addEventListener('mouseup', (e) => {
            handleListenSwipe(e.screenX, e.screenY);
        });

        function handleListenSwipe(endX, endY) {
            const diffX = endX - listenTouchStartX;
            const diffY = endY - listenTouchStartY;
            
            // Horizontal swipe must be significant and dominant
            if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 0) {
                    // Right swipe -> Go to Page 0 (Vinyl)
                    if (currentListenPage === 1) {
                        currentListenPage = 0;
                        updateListenPageUI();
                    }
                } else {
                    // Left swipe -> Go to Page 1 (Lyrics)
                    if (currentListenPage === 0) {
                        currentListenPage = 1;
                        updateListenPageUI();
                    }
                }
            } else if (Math.abs(diffX) < 10 && Math.abs(diffY) < 10) {
                // Treated as a click if movement is very small
                // If on Page 0 (Vinyl area), toggle page. (Optional convenience)
                // But user asked for touch slide, so maybe disable click toggle to avoid conflict.
                // Keeping click toggle only for vinyl page empty area might be good UX.
                // For now, let's strictly follow "slide" instruction and disable click-toggle to avoid "not smooth" issues.
            }
        }

        function startListenTogether(partnerId) {
            document.getElementById('modal-listen-contact').style.display = 'none';
            
            store.listenState.active = true;
            store.listenState.partnerId = partnerId;
            store.listenState.minimized = false;
            store.listenState.startTime = Date.now();
            store.listenState.accumulatedTime = 0;
            
            // Reset Page
            currentListenPage = 0;
            updateListenPageUI();

            // Setup UI
            const meImg = document.getElementById('listen-avatar-me-img');
            const partnerImg = document.getElementById('listen-avatar-partner-img');
            const partnerBox = document.getElementById('listen-avatar-partner');
            const partnerName = document.getElementById('listen-partner-name');
            const myBox = document.getElementById('listen-avatar-me').parentElement; // Get container
            
            meImg.src = store.user.avatar || 'https://via.placeholder.com/80';
            
            // Sync Vinyl BG
            const vinyl = document.getElementById('listen-vinyl');
            if(store.listenState.vinylBg) {
                vinyl.style.backgroundImage = `url(${store.listenState.vinylBg})`;
            }

            const wave = document.getElementById('listen-connect-wave');
            if (partnerId) {
                const c = store.contacts.find(x => x.id === partnerId);
                partnerImg.src = c.avatar;
                partnerBox.style.display = 'block';
                if(wave) wave.classList.add('active');
                
                // Reset positions
                document.getElementById('listen-avatar-me').classList.remove('me-center');
                document.getElementById('listen-avatar-me').style.transform = 'translate(-140%, 10px)';
                document.getElementById('listen-avatar-me').style.left = '50%';
                
                partnerName.innerText = `与 ${c.name} 一起听`;
            } else {
                partnerBox.style.display = 'none';
                if(wave) wave.classList.remove('active');
                document.getElementById('listen-avatar-me').style.transform = 'translate(-50%, 10px)'; 
                document.getElementById('listen-avatar-me').style.left = '50%';
                partnerName.innerText = '独自聆听';
            }
            
            document.getElementById('listen-player-modal').style.display = 'flex';
            document.getElementById('listen-float-ball').classList.remove('show');
            
            // Start Timer
            if(listenTimerInterval) clearInterval(listenTimerInterval);
            listenTimerInterval = setInterval(() => {
                store.listenState.accumulatedTime++;
                document.getElementById('listen-time-val').innerText = `已一起聆听 ${Math.floor(store.listenState.accumulatedTime / 60)} 分钟`;
                
                // Achievements
                const mins = Math.floor(store.listenState.accumulatedTime / 60);
                const badge = document.getElementById('listen-achievement');
                if(mins >= 60) badge.innerHTML = '<div class="achievement-badge"><i class="fas fa-medal"></i></div>';
                else badge.innerHTML = '';
            }, 1000);

            // Sync with current music if playing
            if(store.musics && store.musics.length > 0) {
                updateListenUI();
                // Ensure lyrics are parsed and displayed if returning to active session
                if(store.musics[store.listenState.curMusicIdx]) {
                    parseLyrics(store.musics[store.listenState.curMusicIdx].lrc || '');
                }
            }
        }

        function toggleListenPage() {
            currentListenPage = currentListenPage === 0 ? 1 : 0;
            updateListenPageUI();
        }

        function updateListenPageUI() {
            const wrapper = document.getElementById('listen-swipe-wrapper');
            wrapper.style.transform = `translateX(-${currentListenPage * 50}%)`;
            
            document.querySelectorAll('.listen-dot').forEach((d, i) => {
                if(i === currentListenPage) d.classList.add('active');
                else d.classList.remove('active');
            });
        }

        function closeListenPlayer() {
            document.getElementById('listen-player-modal').style.display = 'none';
            document.getElementById('listen-float-ball').classList.remove('show');
            store.listenState.active = false;
            
            const audio = document.getElementById('global-audio');
            audio.pause();
            store.listenState.playing = false;
            
            // Stop Breathe & Wave
            document.getElementById('listen-avatar-me').classList.remove('glow');
            document.getElementById('listen-avatar-partner').classList.remove('glow');
            const wave = document.getElementById('listen-connect-wave');
            if(wave) wave.classList.remove('active');
            
            if(listenTimerInterval) clearInterval(listenTimerInterval);
            if(listenLyricInterval) clearInterval(listenLyricInterval);
        }

        function minimizeListenPlayer() {
            document.getElementById('listen-player-modal').style.display = 'none';
            store.listenState.minimized = true;
            document.getElementById('listen-float-ball').classList.add('show');
            // Ensure float ball is visible by forcing style if needed, though class 'show' does transform
            document.getElementById('listen-float-ball').style.display = 'flex'; 
            updateFloatBall();
        }

        function maximizeListenPlayer() {
            document.getElementById('listen-player-modal').style.display = 'flex';
            store.listenState.minimized = false;
            document.getElementById('listen-float-ball').classList.remove('show');
        }

        function updateFloatBall() {
            const ball = document.getElementById('listen-float-ball');
            const img = document.getElementById('listen-float-img');
            const info = document.getElementById('listen-float-info');
            
            if(store.listenState.playing) ball.classList.add('playing');
            else ball.classList.remove('playing');
            
            // Sync Vinyl BG to Float Ball
            if(store.listenState.vinylBg) {
                img.src = store.listenState.vinylBg;
            } else {
                img.src = 'https://png.pngtree.com/png-vector/20220623/ourmid/pngtree-vinyl-record-png-image_5323868.png';
            }
            
            const currentMusic = store.musics[store.listenState.curMusicIdx];
            info.innerText = currentMusic ? currentMusic.name : '未播放';
        }

        // Music Controls
        let tempMusicData = { url: '', name: '', lrc: '' };

        function openMusicUpload() {
            tempMusicData = { url: '', name: '', lrc: '' }; // Reset
            document.getElementById('music-add-name').value = '';
            document.getElementById('music-add-url').value = '';
            document.getElementById('music-file-status').style.display = 'none';
            document.getElementById('lyrics-status').innerText = '未选择';
            document.getElementById('modal-music').style.display = 'flex';
        }

        function handleVinylUpload(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                store.listenState.vinylBg = e.target.result;
                document.getElementById('listen-vinyl').style.backgroundImage = `url(${e.target.result})`;
                save();
                toast("唱片封面已更换");
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function confirmAddMusic() {
            const name = document.getElementById('music-add-name').value || '未知歌曲';
            let url = document.getElementById('music-add-url').value;
            
            // Priority: Local File > URL Input
            if(tempMusicData.url) url = tempMusicData.url;
            
            if(!url) return toast("请上传文件或输入链接");
            
            if(!store.musics) store.musics = [];
            store.musics.push({
                name: name, 
                url: url, 
                lrc: tempMusicData.lrc || ''
            });
            save();
            toast("音乐已添加");
            
            // If it's the first song, play it automatically
            if(store.musics.length === 1) {
                store.listenState.curMusicIdx = 0;
                playListenMusic(0);
            }
            document.getElementById('modal-music').style.display='none';
        }

        // Modified play logic
        function playListenMusic(idx) {
            if(!store.musics || store.musics.length === 0) return;
            if(idx < 0 || idx >= store.musics.length) return;
            
            store.listenState.curMusicIdx = idx;
            const m = store.musics[idx];
            const audio = document.getElementById('global-audio');
            
            audio.src = m.url;
            audio.play().then(() => {
                store.listenState.playing = true;
                updateListenUI();
            }).catch(e => {
                console.error(e);
                store.listenState.playing = false;
                updateListenUI();
            });
            
            // Parse lyrics
            parseLyrics(m.lrc || '');
            
            updateListenUI();
        }

        function toggleListenPlay() {
            const audio = document.getElementById('global-audio');
            if(audio.paused) {
                audio.play();
                store.listenState.playing = true;
            } else {
                audio.pause();
                store.listenState.playing = false;
            }
            updateListenUI();
        }

        function prevListenMusic() {
            let newIdx = store.listenState.curMusicIdx - 1;
            if(newIdx < 0) newIdx = store.musics.length - 1;
            playListenMusic(newIdx);
        }

        function nextListenMusic() {
            let newIdx = store.listenState.curMusicIdx + 1;
            if(store.listenState.mode === 'random') {
                newIdx = Math.floor(Math.random() * store.musics.length);
            } else if (newIdx >= store.musics.length) {
                newIdx = 0;
            }
            playListenMusic(newIdx);
        }
        
        function toggleListenMode() {
            const modes = ['order', 'random', 'loop'];
            let idx = modes.indexOf(store.listenState.mode);
            store.listenState.mode = modes[(idx + 1) % 3];
            updateListenUI();
            toast("模式: " + (store.listenState.mode==='order'?'顺序播放':(store.listenState.mode==='random'?'随机播放':'单曲循环')));
        }

        function seekListenMusic(e) {
            const bar = document.getElementById('listen-progress-bar');
            const audio = document.getElementById('global-audio');
            if(!audio.duration) return;
            
            const rect = bar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audio.currentTime = percent * audio.duration;
        }

        function updateListenUI() {
            const audio = document.getElementById('global-audio');
            const playBtn = document.getElementById('listen-play-icon');
            const vinyl = document.getElementById('listen-vinyl');
            const modeIcon = document.getElementById('listen-mode-icon');
            const meBox = document.getElementById('listen-avatar-me');
            const partnerBox = document.getElementById('listen-avatar-partner');
            
            // Play/Pause state
            if(store.listenState.playing) {
                playBtn.className = 'fas fa-pause';
                vinyl.classList.add('playing');
                // Breath Effect for BOTH
                meBox.classList.add('glow');
                if(store.listenState.partnerId) partnerBox.classList.add('glow');
            } else {
                playBtn.className = 'fas fa-play';
                vinyl.classList.remove('playing');
                // Stop Breath
                meBox.classList.remove('glow');
                partnerBox.classList.remove('glow');
            }
            
            // Mode Icon
            if(store.listenState.mode === 'order') modeIcon.className = 'fas fa-list-ol';
            if(store.listenState.mode === 'random') modeIcon.className = 'fas fa-random';
            if(store.listenState.mode === 'loop') modeIcon.className = 'fas fa-redo';
            
            // Float ball
            updateFloatBall();
        }

        // Global Audio Events Hook
        const gAudio = document.getElementById('global-audio');
        gAudio.ontimeupdate = () => {
            const cur = gAudio.currentTime;
            const dur = gAudio.duration || 1;
            const percent = (cur / dur) * 100;
            
            document.getElementById('listen-progress-fill').style.width = percent + '%';
            document.getElementById('listen-cur-time').innerText = formatTime(cur);
            document.getElementById('listen-total-time').innerText = formatTime(dur);
            
            syncLyrics(cur);
            
            // Highpoint emoji (Simulated at 70% progress)
            if(percent > 65 && percent < 70 && Math.random() < 0.05) {
                showMusicEmoji('🔥');
            }
        };
        gAudio.onended = () => {
            if(store.listenState.mode === 'loop') {
                gAudio.currentTime = 0;
                gAudio.play();
            } else {
                nextListenMusic();
            }
        };

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        // Lyrics Logic
        function parseLyrics(lrcText) {
            store.listenState.lyrics = [];
            // 获取全屏歌词容器
            const containerFull = document.getElementById('listen-lyrics-full-content');
            
            if(!lrcText) {
                containerFull.innerHTML = '<div class="lyric-line-full active">暂无歌词</div>';
                return;
            }
            
            const lines = lrcText.split('\n');
            const regex = /\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/;
            
            lines.forEach(line => {
                const match = line.match(regex);
                if(match) {
                    const min = parseInt(match[1]);
                    const sec = parseInt(match[2]);
                    const ms = parseInt(match[3]);
                    const text = match[4].trim();
                    if(text) {
                        store.listenState.lyrics.push({
                            time: min * 60 + sec + ms / 1000,
                            text: text
                        });
                    }
                }
            });
            
            // Render Full Page Lyrics
            containerFull.innerHTML = store.listenState.lyrics.map((l, i) => `<div class="lyric-line-full" id="lyric-full-${i}" onclick="seekToLyric(${l.time})">${l.text}</div>`).join('');
        }

        function seekToLyric(time) {
            const audio = document.getElementById('global-audio');
            if(audio && !isNaN(time)) {
                audio.currentTime = time;
                audio.play(); // Seek and play
                store.listenState.playing = true;
                updateListenUI();
            }
        }

        function syncLyrics(time) {
            if(!store.listenState.lyrics.length) return;
            
            let activeIdx = -1;
            for(let i = 0; i < store.listenState.lyrics.length; i++) {
                if(time >= store.listenState.lyrics[i].time) {
                    activeIdx = i;
                } else {
                    break;
                }
            }
            
            if(activeIdx !== -1 && activeIdx !== store.listenState.currentLine) {
                store.listenState.currentLine = activeIdx;
                
                // Update Full Page Lyrics
                document.querySelectorAll('.lyric-line-full').forEach(el => el.classList.remove('active'));
                const elFull = document.getElementById(`lyric-full-${activeIdx}`);
                if(elFull) {
                    elFull.classList.add('active');
                    // Scroll logic for full page
                    elFull.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function showMusicEmoji(emoji) {
            const area = document.getElementById('listen-emoji-area');
            const el = document.createElement('div');
            el.className = 'listen-emoji';
            el.innerText = emoji;
            el.style.left = (Math.random() * 80 + 10) + '%';
            el.style.bottom = '20%';
            area.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        // Playlist
        function toggleListenPlaylist() {
            const drawer = document.getElementById('listen-playlist-drawer');
            if(drawer.classList.contains('show')) {
                drawer.classList.remove('show');
                // Auto exit manage mode on close
                if (isListenPlaylistManageMode) toggleListenPlaylistManageMode();
            } else {
                renderListenPlaylist();
                drawer.classList.add('show');
            }
        }

        function toggleListenPlaylistManageMode() {
            isListenPlaylistManageMode = !isListenPlaylistManageMode;
            selectedPlaylistItems.clear();
            
            const manageBtn = document.getElementById('listen-playlist-manage-btn');
            const modeBtn = document.getElementById('listen-playlist-mode-btn');
            
            if(isListenPlaylistManageMode) {
                manageBtn.style.display = 'block';
                modeBtn.innerText = '取消';
            } else {
                manageBtn.style.display = 'none';
                modeBtn.innerText = '管理';
            }
            renderListenPlaylist();
        }

        function togglePlaylistItemSelection(idx) {
            if(selectedPlaylistItems.has(idx)) selectedPlaylistItems.delete(idx);
            else selectedPlaylistItems.add(idx);
            renderListenPlaylist();
        }

        function deleteSelectedPlaylistItems() {
            if(selectedPlaylistItems.size === 0) return toast("请选择要删除的歌曲");
            
            showConfirm("删除歌曲", `确定要删除选中的 ${selectedPlaylistItems.size} 首歌曲吗?`, () => {
                // Delete logic
                const sorted = Array.from(selectedPlaylistItems).sort((a,b) => b-a); // Descending
                sorted.forEach(idx => {
                    store.musics.splice(idx, 1);
                });
                
                // Adjust current playing index if needed
                if(store.listenState.curMusicIdx >= store.musics.length) {
                    store.listenState.curMusicIdx = 0;
                    store.listenState.playing = false; // Stop playing if list modified significantly
                }
                
                save();
                toggleListenPlaylistManageMode(); // Exit manage mode
                renderListenPlaylist();
                toast("删除成功");
            });
        }

        // Handle Long Press for Playlist Item
        let playlistLongPressTimer = null;
        function handlePlaylistTouchStart(idx) {
            playlistLongPressTimer = setTimeout(() => {
                if(!isListenPlaylistManageMode) {
                    toggleListenPlaylistManageMode();
                    togglePlaylistItemSelection(idx);
                }
            }, 600);
        }
        function handlePlaylistTouchEnd() {
            if(playlistLongPressTimer) clearTimeout(playlistLongPressTimer);
        }

        function renderListenPlaylist() {
            const list = document.getElementById('listen-playlist-content');
            list.innerHTML = store.musics.map((m, i) => {
                let content = '';
                if (isListenPlaylistManageMode) {
                    const isSelected = selectedPlaylistItems.has(i);
                    content = `
                        <div class="list-item" onclick="togglePlaylistItemSelection(${i})" style="background:transparent; border-bottom:1px solid rgba(255,255,255,0.1); padding:12px 0;">
                            <div style="margin-right:15px; width:20px; height:20px; border:1px solid rgba(255,255,255,0.5); border-radius:4px; display:flex; justify-content:center; align-items:center; background:${isSelected?'var(--primary)':'transparent'}; border-color:${isSelected?'var(--primary)':'rgba(255,255,255,0.5)'}">
                                ${isSelected ? '<i class="fas fa-check" style="font-size:12px; color:#fff;"></i>' : ''}
                            </div>
                            <div style="color:#fff; flex:1; font-size:14px;">${m.name}</div>
                        </div>
                    `;
                } else {
                    content = `
                        <div class="list-item" 
                             onclick="playListenMusic(${i})" 
                             ontouchstart="handlePlaylistTouchStart(${i})"
                             ontouchend="handlePlaylistTouchEnd()"
                             onmousedown="if(event.button===0) handlePlaylistTouchStart(${i})"
                             onmouseup="handlePlaylistTouchEnd()"
                             style="background:transparent; border-bottom:1px solid rgba(255,255,255,0.1); padding:12px 0;">
                            <div style="color:${i===store.listenState.curMusicIdx?'var(--primary)':'#fff'}; flex:1; font-size:14px;">${m.name}</div>
                            <i class="fas fa-play" style="color:rgba(255,255,255,0.5); font-size:12px;"></i>
                        </div>
                    `;
                }
                return content;
            }).join('');
        }

        // Chat & Interactive
        async function sendListenChatFromModal(text) {
            if(!text) return;
            const input = document.getElementById('listen-bubble-input-me');
            input.value = text; // Show text in bubble
            
            // Partner reply simulation
            if(store.listenState.partnerId) {
                try {
                    const c = store.contacts.find(x => x.id === store.listenState.partnerId);
                    // Simple API call for short reply
                    const data = await API.chatCompletion([
                        { role: 'system', content: `You are ${c.name}. Persona: ${c.persona}. You are listening to music with user. User said: "${text}". Reply in Chinese, extremely briefly (max 10 Chinese characters).` },
                        { role: 'user', content: text }
                    ]);
                    const reply = data.choices[0].message.content.substring(0, 10);
                    showBubblePartner(reply);
                } catch(e) {
                    console.error(e);
                }
            } else {
                toast("还没有邀请好友哦");
            }
        }

        function showBubblePartner(text) {
            // const b = document.getElementById('listen-bubble-partner');
            const t = document.getElementById('listen-bubble-text-partner');
            t.innerText = text;
            // b.style.display = 'block';
            
            // Reset to ellipsis
            setTimeout(() => {
                t.innerText = '...';
            }, 4000);
        }

        // --- STICKERS ---
        function openStickerGallery() {
            // Migration check
            if(!store.stickerCategories) {
                store.stickerCategories = [{id:'default', name:'默认', stickers:[{url:'😀', type:'emoji'}]}];
                if(store.stickers && store.stickers.length > 0) {
                     store.stickerCategories[0].stickers = store.stickerCategories[0].stickers.concat(store.stickers.filter(s=>s.url!=='😀'));
                }
                store.stickers = []; 
                save();
            }
            
            document.getElementById('layer-stickers').classList.add('show'); 
            renderStickerCategories();
        }

        function toggleStickerManageMode() {
            isStickerManageMode = !isStickerManageMode;
            const menu = document.getElementById('sticker-menu');
            const bar = document.getElementById('sticker-manage-bar');
            
            if (isStickerManageMode) {
                menu.style.display = 'none';
                bar.style.display = 'flex';
                selectedStickers.clear();
            } else {
                bar.style.display = 'none';
                selectedStickers.clear();
            }
            renderStickerGallery();
        }

        function toggleStickerSelection(idx) {
            if (selectedStickers.has(idx)) selectedStickers.delete(idx);
            else selectedStickers.add(idx);
            renderStickerGallery();
        }

        function deleteSelectedStickers() {
            if (selectedStickers.size === 0) return toast("请选择要删除的表情");
            showConfirm("删除表情", `确定删除选中的 ${selectedStickers.size} 个表情吗？`, () => {
                const cate = store.stickerCategories.find(c => c.id === activeStickerCateId);
                if (cate) {
                    // Filter out selected indices
                    // Sort indices desc to delete safely
                    const indices = Array.from(selectedStickers).sort((a, b) => b - a);
                    indices.forEach(i => cate.stickers.splice(i, 1));
                    
                    save();
                    toggleStickerManageMode(); // Exit manage mode
                    toast("删除成功");
                }
            });
        }
        
        function openStickerMenu(e) {
            e.stopPropagation();
            const el = document.getElementById('sticker-menu');
            document.querySelectorAll('.add-menu').forEach(m => { if(m.id !== el.id) m.style.display = 'none'; });
            el.style.display = el.style.display==='flex'?'none':'flex';
        }

        function addStickerCategoryPopup() {
            document.getElementById('modal-sticker-cate').style.display='flex';
            document.getElementById('sticker-menu').style.display='none';
        }
        
        function saveStickerCategory() {
            const n = document.getElementById('new-sticker-cate-name').value;
            if(!n) return toast("请输入分类名");
            if (!store.stickerCategories) store.stickerCategories = [];
            store.stickerCategories.push({id:'sc'+Date.now(), name:n, stickers:[]});
            save(); 
            renderStickerCategories(); 
            document.getElementById('modal-sticker-cate').style.display='none';
            toast("分类已创建");
        }

        function addStickerPopup() { 
            const s = document.getElementById('sticker-add-cate-sel');
            s.innerHTML = store.stickerCategories.map(c=>`<option value="${c.id}" ${c.id===activeStickerCateId?'selected':''}>${c.name}</option>`).join('');
            document.getElementById('modal-sticker').style.display='flex'; 
            document.getElementById('sticker-menu').style.display='none';
        }
        
        function showStickerInput(type) {
            document.getElementById('sticker-url-area').style.display = type==='url'?'block':'none';
            document.getElementById('sticker-local-area').style.display = type==='local'?'block':'none';
        }
        
        function confirmAddSticker() {
            const targetCateId = document.getElementById('sticker-add-cate-sel').value;
            const cate = store.stickerCategories.find(c=>c.id===targetCateId);
            if(!cate) return;

            if(document.getElementById('sticker-url-area').style.display==='block') {
                const u = document.getElementById('sticker-url-in').value;
                if(u) cate.stickers.push({url:u, type:'image'});
            }
            save(); 
            if(activeStickerCateId === targetCateId) renderStickerGallery(); 
            document.getElementById('modal-sticker').style.display='none';
            toast("表情已添加");
        }
        
        function renderStickerCategories() {
            const sb = document.getElementById('sticker-categories');
            sb.innerHTML = '';
            store.stickerCategories.forEach(c => {
                sb.innerHTML += `<div class="sticker-cate-tab ${activeStickerCateId===c.id?'active':''}" onclick="switchStickerCate('${c.id}')">${c.name}</div>`;
            });
            renderStickerGallery();
        }
        
        function switchStickerCate(id) {
            activeStickerCateId = id;
            renderStickerCategories(); // Re-render to update active state
        }

        function renderStickerGallery() {
            const g = document.getElementById('sticker-gallery-grid'); 
            g.innerHTML='';
            const cate = store.stickerCategories.find(c=>c.id===activeStickerCateId);
            if(!cate) return;

            cate.stickers.forEach((s, idx) => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.style.position = 'relative';
                
                // 1. Render Sticker Content
                if (s.type === 'emoji') {
                    item.innerText = s.url;
                } else {
                    const img = document.createElement('img');
                    img.src = s.url;
                    item.appendChild(img);
                }

                // 2. Interaction Logic
                if (isStickerManageMode) {
                    const isSelected = selectedStickers.has(idx);
                    if (isSelected) {
                        item.style.border = '2px solid var(--primary)';
                        const check = document.createElement('div');
                        check.innerHTML = '<i class="fas fa-check"></i>';
                        check.style.cssText = 'position:absolute; top:0; right:0; background:var(--primary); color:#fff; border-radius:0 0 0 8px; padding:2px 5px; font-size:10px;';
                        item.appendChild(check);
                    }
                    // Overlay div to capture clicks in manage mode
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:absolute; top:0; left:0; width:100%; height:100%; z-index:10;';
                    overlay.onclick = () => toggleStickerSelection(idx);
                    item.appendChild(overlay);
                } else {
                    // Normal mode interaction
                    if (s.type === 'emoji') {
                        item.onclick = () => { sendSticker(s.url, 'emoji', s.name); };
                    } else {
                        // For images, the click on img was causing issues in previous logic if applied to container
                        // Here we apply to the item container since it wraps the img
                        item.onclick = () => { sendSticker(s.url, 'image', s.name); };
                    }
                    
                    // Add Long Press Handlers
                    item.ontouchstart = (e) => handleStickerTouchStart(idx, e);
                    item.ontouchend = handleStickerTouchEnd;
                    item.onmousedown = (e) => handleStickerMouseDown(idx, e);
                    item.onmouseup = handleStickerMouseUp;
                    item.oncontextmenu = (e) => e.preventDefault();
                }
                
                // Name label if it has a custom name (for AI recog)
                if(s.name) {
                    const nameLabel = document.createElement('div');
                    nameLabel.innerText = s.name;
                    nameLabel.style.cssText = 'position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.5); color:#fff; font-size:10px; text-align:center; padding:2px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; z-index: 5; pointer-events: none;';
                    item.appendChild(nameLabel);
                }

                g.appendChild(item);
            });
        }

        // Sticker Long Press Logic
        function handleStickerTouchStart(idx, e) {
            isLongPress = false;
            selectedStickerIdx = idx;
            longPressTimer = setTimeout(() => { 
                isLongPress = true; 
                showStickerContextMenu(e.touches[0].clientX, e.touches[0].clientY); 
            }, 500);
        }
        function handleStickerTouchEnd() { clearTimeout(longPressTimer); }
        function handleStickerMouseDown(idx, e) {
            if(e.button !== 0) return;
            isLongPress = false;
            selectedStickerIdx = idx;
            longPressTimer = setTimeout(() => { 
                isLongPress = true; 
                showStickerContextMenu(e.clientX, e.clientY); 
            }, 500);
        }
        function handleStickerMouseUp() { clearTimeout(longPressTimer); }

        function showStickerContextMenu(x, y) {
            const menu = document.getElementById('sticker-context-menu');
            menu.style.display = 'flex';
            const rect = menu.getBoundingClientRect();
            
            let finalX = x;
            let finalY = y;
            if (finalX + rect.width > window.innerWidth) finalX = window.innerWidth - rect.width - 10;
            if (finalY + rect.height > window.innerHeight) finalY = window.innerHeight - rect.height - 10;
            
            menu.style.left = finalX + 'px';
            menu.style.top = finalY + 'px';
        }

        function renameSticker() {
            const cate = store.stickerCategories.find(c => c.id === activeStickerCateId);
            if (!cate || selectedStickerIdx === null) return;
            
            const sticker = cate.stickers[selectedStickerIdx];
            const newName = prompt("为表情包命名 (用于AI识别):", sticker.name || "");
            
            if (newName !== null) {
                sticker.name = newName;
                save();
                renderStickerGallery();
                toast("命名已更新");
            }
            document.getElementById('sticker-context-menu').style.display = 'none';
        }

        function deleteSingleSticker() {
            const cate = store.stickerCategories.find(c => c.id === activeStickerCateId);
            if (!cate || selectedStickerIdx === null) return;
            
            showConfirm("删除表情", "确定要删除这个表情吗?", () => {
                cate.stickers.splice(selectedStickerIdx, 1);
                save();
                renderStickerGallery();
                toast("删除成功");
            });
            document.getElementById('sticker-context-menu').style.display = 'none';
        }
        
        function showBigImg(url) {
            document.getElementById('big-img-el').src = url;
            document.getElementById('modal-big-img').style.display = 'flex';
        }

        // --- PERCEPTION ---
        // 模拟大数据分析环境
        function analyzeEnvironment(city, dateStr, timeStr) {
            const now = dateStr ? new Date(dateStr) : new Date();
            const month = now.getMonth() + 1; // 1-12
            const hour = timeStr ? parseInt(timeStr.split(':')[0]) : new Date().getHours();
            
            // 1. 判断半球 (Big Data Simulation)
            const southCities = ['悉尼', '墨尔本', '里约', '开普敦', '布宜诺斯艾利斯', '奥克兰', '圣地亚哥'];
            const isSouth = southCities.some(c => city.includes(c));
            const hemisphere = isSouth ? '南半球' : '北半球';
            
            // 2. 季节判断 (Season Judgment)
            let season = '未知';
            if (isSouth) {
                if (month >= 9 && month <= 11) season = '春季';
                else if (month === 12 || month <= 2) season = '夏季';
                else if (month >= 3 && month <= 5) season = '秋季';
                else season = '冬季';
            } else {
                if (month >= 3 && month <= 5) season = '春季';
                else if (month >= 6 && month <= 8) season = '夏季';
                else if (month >= 9 && month <= 11) season = '秋季';
                else season = '冬季';
            }

            // 3. 时区推算 (Timezone Logic)
            let timezone = 'UTC+8'; // 默认国内
            if (city.includes('伦敦')) timezone = 'UTC+0';
            else if (city.includes('纽约') || city.includes('华盛顿')) timezone = 'UTC-5';
            else if (city.includes('洛杉矶') || city.includes('旧金山')) timezone = 'UTC-8';
            else if (city.includes('东京')) timezone = 'UTC+9';
            else if (city.includes('巴黎') || city.includes('柏林') || city.includes('罗马')) timezone = 'UTC+1';
            else if (city.includes('悉尼')) timezone = 'UTC+10';
            else if (city.includes('莫斯科')) timezone = 'UTC+3';
            else if (city.includes('迪拜')) timezone = 'UTC+4';

            // 4. 温度推算 (Temperature Estimation)
            let baseTemp = 20;
            if (season === '春季') baseTemp = 18;
            if (season === '夏季') baseTemp = 28;
            if (season === '秋季') baseTemp = 22;
            if (season === '冬季') baseTemp = 5;
            
            // 昼夜温差
            if (hour < 6 || hour > 20) baseTemp -= 5;
            else if (hour > 11 && hour < 15) baseTemp += 3;
            
            // 纬度/城市微调
            if (city.includes('哈尔滨') || city.includes('莫斯科')) baseTemp -= 15;
            if (city.includes('三亚') || city.includes('曼谷') || city.includes('新加坡')) baseTemp = 30;
            
            // 随机波动
            const temp = Math.floor(baseTemp + (Math.random() * 4 - 2));

            return {
                season,
                hemisphere,
                timezone,
                temp: temp + '°C'
            };
        }

        function savePerception() {
             const p = store.perception;
             p.master = document.getElementById('perc-master').checked;
             
             p.customDate = document.getElementById('perc-custom-date').checked;
             p.dateVal = document.getElementById('perc-date-val').value;
             
             p.customTime = document.getElementById('perc-custom-time').checked;
             p.timeVal = document.getElementById('perc-time-val').value;
             
             p.customCity = document.getElementById('perc-custom-city').checked;
             p.cityVal = document.getElementById('perc-city-val').value;
             p.realCityVal = document.getElementById('perc-real-city-val').value;
             
             p.customWeather = document.getElementById('perc-custom-weather').checked;
             p.weatherVal = document.getElementById('perc-weather-val').value;
             
             p.customTemp = document.getElementById('perc-custom-temp').checked;
             p.tempVal = document.getElementById('perc-temp-val').value;
             
             p.customClimate = document.getElementById('perc-custom-climate').checked;
             
             save();
             renderPerception();
        }

        function renderPerception() {
             const p = store.perception;
             
             let displayWeather = "未知";
             let displayTemp = "--";
             let displayLoc = "未知";
             let envData = { season: '--', hemisphere: '--', timezone: '--', temp: '--' };
             
             if (p.master) {
                 // 确定使用的地点和时间
                 const targetCity = (p.customCity && p.cityVal) ? p.cityVal : (p.realCityVal || '上海');
                 displayLoc = targetCity;
                 
                 const targetDate = (p.customDate && p.dateVal) ? p.dateVal : new Date().toISOString().split('T')[0];
                 const targetTime = (p.customTime && p.timeVal) ? p.timeVal : new Date().toTimeString().slice(0,5);
                 
                 // 调用“大数据”分析
                 envData = analyzeEnvironment(targetCity, targetDate, targetTime);
                 
                 if (p.customWeather && p.weatherVal) {
                     displayWeather = p.weatherVal;
                 } else {
                     displayWeather = p.weather || '晴朗';
                 }
                 
                 // 自定义温度优先
                 if (p.customTemp && p.tempVal) {
                     displayTemp = p.tempVal + '°C';
                 } else if (p.customWeather && !p.tempVal && !p.customTemp) {
                      // 如果只定义了天气没定义温度，用推算
                      displayTemp = envData.temp;
                 } else {
                     // 默认推算
                     displayTemp = envData.temp;
                 }
             } else {
                 displayWeather = "感知已关闭";
             }

             document.getElementById('perc-weather').innerText = displayWeather;
             document.getElementById('perc-weather-temp').innerText = displayTemp;
             document.getElementById('perc-loc').innerText = displayLoc;
             document.getElementById('perc-season').innerText = envData.season;
             document.getElementById('perc-hemisphere').innerText = envData.hemisphere;
             document.getElementById('perc-timezone').innerText = envData.timezone;

             // Controls
             document.getElementById('perc-master').checked = p.master;
             
             document.getElementById('perc-custom-date').checked = p.customDate;
             document.getElementById('perc-date-val').value = p.dateVal;
             document.getElementById('perc-date-val').disabled = !p.customDate;
             
             document.getElementById('perc-custom-time').checked = p.customTime;
             document.getElementById('perc-time-val').value = p.timeVal;
             document.getElementById('perc-time-val').disabled = !p.customTime;
             
             document.getElementById('perc-custom-city').checked = p.customCity;
             document.getElementById('perc-city-val').value = p.cityVal || '';
             document.getElementById('perc-real-city-val').value = p.realCityVal || '';
             document.getElementById('perc-city-val').disabled = !p.customCity;
             document.getElementById('perc-real-city-val').disabled = !p.customCity;

             document.getElementById('perc-custom-weather').checked = p.customWeather;
             document.getElementById('perc-weather-val').value = p.weatherVal || '';
             document.getElementById('perc-weather-val').disabled = !p.customWeather;

             document.getElementById('perc-custom-temp').checked = p.customTemp;
             document.getElementById('perc-temp-val').value = p.tempVal || '';
             document.getElementById('perc-temp-val').disabled = !p.customTemp;

             document.getElementById('perc-custom-climate').checked = p.customClimate;
             document.getElementById('perc-climate-val').innerText = p.climateVal || '点击选择';
             document.getElementById('perc-climate-val').style.color = p.customClimate ? '#333' : '#aaa';
             document.getElementById('perc-climate-val').style.pointerEvents = p.customClimate ? 'auto' : 'none';

             const l = document.getElementById('festival-list'); l.innerHTML='';
             (p.festivals||[]).forEach(f => l.innerHTML+=`<div class="list-item"><div class="list-title">${f.name}</div><div class="list-sub">${f.date}</div></div>`);
        }

        function selectClimate(c) {
            store.perception.climateVal = c; 
            save(); 
            renderPerception(); 
            document.getElementById('modal-picker').style.display='none';
        }
        function picker(type) {
            if(type==='climate') {
                const opts = ['热带雨林','热带草原','热带沙漠','亚热带季风','地中海','温带海洋','温带季风','温带大陆','极地'];
                const p = document.getElementById('modal-picker');
                const l = document.getElementById('picker-list');
                document.getElementById('picker-title').innerText = "选择气候";
                l.innerHTML = opts.map(o=>`<div class="list-item" onclick="selectClimate('${o}')">${o}</div>`).join('');
                p.style.display='flex';
            }}
        function selectClimate(c) {
            store.perception.climate = c; save(); renderPerception(); document.getElementById('modal-picker').style.display='none';
        }

        // --- CHECK PHONE CORE ---
        async function aiGeneratePhone(type, context) {
            document.getElementById('loading').style.display = 'block';
            try {
                let sysPrompt = "You are an AI generating realistic content for a simulated 'Phone Check' game.";
                let prompt = "";
                let targetName = activeCheckPhoneContactName || "Someone";
                
                let targetC = null;
                if (activeCheckPhoneContactName) {
                    targetC = store.contacts.find(x => x.name === activeCheckPhoneContactName);
                } else if (store.couple.partnerId) {
                    targetC = store.contacts.find(x => x.id === store.couple.partnerId);
                }
                
                let worldBookContent = 'None';
                if (targetC) {
                    sysPrompt += ` Target Persona: ${targetC.name}, ${targetC.persona}.`;
                    targetName = targetC.name;
                    
                    // Add Worldbook context
                    if (targetC.settings?.mountedWbIds && Array.isArray(targetC.settings.mountedWbIds)) {
                        const mountedBooks = store.worldbooks.filter(wb => targetC.settings.mountedWbIds.includes(wb.id));
                        if (mountedBooks.length > 0) {
                            worldBookContent = mountedBooks.map(wb => `[${wb.name}]:\n${wb.content}`).join('\n\n');
                        }
                    }
                }

            const userName = store.user.name || "User";
            const userRelatedContext = `Your responses must feel authentic to the character you are playing, not like an AI assistant. You must read the character's persona, world book, and chat history to inform your reply. World Book Context: ${worldBookContent}. IMPORTANT: At least one or two of the generated items MUST be related to "${userName}" (the user playing the game). For example, a chat log with "${userName}" should be included.`;

            if(type === 'contacts') prompt = `Generate 8 realistic contact names for ${targetName}'s phone. These should be people in ${targetName}'s life (e.g. Mom, Boss, Colleague, Delivery). One contact MUST BE "${userName}" (the user). Ensure NO contact is named "${targetName}" (the phone owner) or "Me" or "我". The contacts should be appropriate for ${targetName}'s persona (age, gender, role). Use Chinese. Format: [CONTACT:Name]`;
            
            if(type === 'chat') {
                if (context === userName) return true;
                prompt = `Generate a realistic WeChat chat log on ${targetName}'s phone between ${targetName} ('Me') and '${context}' (Them). 8-15 messages. The content must be about ${targetName}'s virtual life and relationship with ${context}. Avoid mentioning ${userName}. Use Chinese. Format: [MSG:Time|Sender|Content]`;
            }
            
            if(type === 'memo') prompt = `Generate 5 realistic phone memos for ${targetName}. Use FIRST PERSON perspective (as ${targetName}). Mix of tasks and personal thoughts. When mentioning ${userName}, use their name "${userName}". Content length MUST be between 100 and 500 characters. Date format MUST be time only (e.g. "14:30", "09:15"), NO year/month/day. Use Chinese. Format: [MEMO:Title|Time|Content]`;
            
            if(type === 'search') prompt = `Generate 8 realistic browser search histories for ${targetName}. Use THIRD PERSON perspective for descriptions if needed. Include recent timestamps (last 24h). Use Chinese. Format: [SEARCH:Time|Query|ResultTitle|ResultDesc|ClickReason]. Example: [SEARCH:14:30|如何养猫|新手养猫指南|知乎高赞回答...|因为${targetName}最近想养猫]`;
            
            if(type === 'usage') prompt = `Generate a daily digital footprint timeline for ${targetName}. Use THIRD PERSON perspective. e.g. "${targetName} opened WeChat", "${targetName} charged the phone". Do NOT use "I" or "Me". 8-12 items. Use Chinese. Format: [USE:Time|Type(App/Sys)|Description]. Example: [USE:08:00|Sys|${targetName}的闹钟响起]`;
            
            if(type === 'shopping') prompt = `Generate 3-6 recent shopping cart items or orders for ${targetName}. Based on their persona and interests. ${userRelatedContext} Use Chinese. Format: [SHOP:ItemName|Platform|Status/Price|Reason]. Example: [SHOP:吉他教程|淘宝|已下单 ￥29|想学新技能]`;
            
            if(type === 'interests') prompt = `Generate 8-12 interest keywords or tags for ${targetName}, derived from their recent chats and browsing. ${userRelatedContext} Use Chinese. Format: [INT:Keyword|Heat(1-10)|Evidence]. Example: [INT:摄影|8|最近经常搜索相机参数]`;

                const data = await API.chatCompletion([{role:'system', content:sysPrompt}, {role:'user', content:prompt}]);
                if (!data || !data.choices || data.choices.length === 0) throw new Error("Invalid response");
                const text = data.choices[0].message.content;

                if(type === 'contacts') {
                    store.phoneData.contacts = Array.from(text.matchAll(/\[CONTACT:(.*?)\]/g), m => ({name: m[1]}));
                    if(store.phoneData.contacts.length===0) store.phoneData.contacts = [{name:'Mom'},{name:'Ex'},{name:'Boss'}];
                }
                if(type === 'chat') {
                    store.phoneData.chats[context] = Array.from(text.matchAll(/\[MSG:(.*?)\|(.*?)\|(.*?)\]/g), m => ({time:m[1], sender:m[2], content:m[3]}));
                }
                if(type === 'memo') {
                    store.phoneData.memo = Array.from(text.matchAll(/\[MEMO:(.*?)\|(.*?)\|(.*?)\]/g), m => ({title:m[1], date:m[2], content:m[3]}));
                }
                if(type === 'search') {
                    store.phoneData.search = Array.from(text.matchAll(/\[SEARCH:(.*?)\|(.*?)\|(.*?)\|(.*?)\|(.*?)\]/g), m => ({time:m[1], query:m[2], resultTitle:m[3], resultDesc:m[4], clickReason:m[5]}));
                    // Fallback for old format if AI messes up
                    if(store.phoneData.search.length === 0) {
                        store.phoneData.search = Array.from(text.matchAll(/\[SEARCH:(.*?)\|(.*?)\]/g), m => ({time:m[1], query:m[2], resultTitle:'搜索结果', resultDesc:'无详细预览', clickReason:'未知'}));
                    }
                }
                if(type === 'usage') {
                    store.phoneData.usage = Array.from(text.matchAll(/\[USE:(.*?)\|(.*?)\|(.*?)\]/g), m => ({time:m[1], type:m[2], desc:m[3]}));
                }
                if(type === 'shopping') {
                    store.phoneData.shopping = Array.from(text.matchAll(/\[SHOP:(.*?)\|(.*?)\|(.*?)\|(.*?)\]/g), m => ({item:m[1], platform:m[2], price:m[3], reason:m[4]}));
                }
                if(type === 'interests') {
                    store.phoneData.interests = Array.from(text.matchAll(/\[INT:(.*?)\|(.*?)\|(.*?)\]/g), m => ({keyword:m[1], heat:parseInt(m[2]), evidence:m[3]}));
                }
                
                save();
                document.getElementById('loading').style.display = 'none';
                return true;
            } catch(e) {
                console.error("aiGeneratePhone Error:", e);
                document.getElementById('loading').style.display = 'none';
                return false;
            }
        }

        // New Check Phone Entry Point
        function selectCheckPhoneContact() {
            const list = document.getElementById('checkphone-contact-list');
            // Problem 5: Filter out group chats
            const privateContacts = store.contacts.filter(c => !c.isGroup);
            list.innerHTML = privateContacts.map(c => 
                `<div class="list-item" onclick="startCheckPhone('${c.name}')">
                    <img src="${c.avatar}" class="avatar">
                    <div class="list-content"><div class="list-title">${c.name}</div></div>
                </div>`
            ).join('');
            if (privateContacts.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding: 20px; color: #999;">没有可用的私聊联系人</div>';
            }
            document.getElementById('modal-checkphone-contact').style.display = 'flex';
        }

        function startCheckPhone(name) {
            activeCheckPhoneContactName = name;
            document.getElementById('modal-checkphone-contact').style.display = 'none';
            document.getElementById('checkphone-container').innerHTML = `
                 <div style="background:transparent; padding:20px; text-align:center;">
                     <div style="font-size:20px; font-weight:bold; color:#333; text-shadow:0 1px 2px rgba(255,255,255,0.8);">正在查看 ${name} 的手机</div>
                     <div style="font-size:12px; color:#666; margin-top:5px;">数据基于人设生成</div>
                 </div>
                 <div class="phone-list-container">
                    <div class="phone-feature-card" onclick="openPhoneFunc('contacts')">
                        <div class="pfc-icon-box" style="background:linear-gradient(135deg, #34c759, #30b34d);"><i class="fas fa-address-book"></i></div>
                        <div class="pfc-content">
                            <div class="pfc-title">通讯录</div>
                            <div class="pfc-desc">查看联系人列表</div>
                        </div>
                        <i class="fas fa-chevron-right pfc-arrow"></i>
                    </div>
                    
                    <div class="phone-feature-card" onclick="openPhoneFunc('memo')">
                        <div class="pfc-icon-box" style="background:linear-gradient(135deg, #ffcc00, #f7b500);"><i class="fas fa-sticky-note"></i></div>
                        <div class="pfc-content">
                            <div class="pfc-title">备忘录</div>
                            <div class="pfc-desc">查看记事本内容</div>
                        </div>
                        <i class="fas fa-chevron-right pfc-arrow"></i>
                    </div>

                    <div class="phone-feature-card" onclick="openPhoneFunc('search')">
                        <div class="pfc-icon-box" style="background:linear-gradient(135deg, #007aff, #0062cc);"><i class="fas fa-search"></i></div>
                        <div class="pfc-content">
                            <div class="pfc-title">搜索记录</div>
                            <div class="pfc-desc" id="preview-search">最近搜索了内容...</div>
                        </div>
                        <i class="fas fa-chevron-right pfc-arrow"></i>
                    </div>

                    <div class="phone-feature-card" onclick="openPhoneFunc('usage')">
                        <div class="pfc-icon-box" style="background:linear-gradient(135deg, #5856d6, #4a48b8);"><i class="fas fa-chart-bar"></i></div>
                        <div class="pfc-content">
                            <div class="pfc-title">手机使用简报</div>
                            <div class="pfc-desc" id="preview-usage">今日使用时长...</div>
                        </div>
                        <i class="fas fa-chevron-right pfc-arrow"></i>
                    </div>

                    <div class="phone-feature-card" onclick="openPhoneFunc('shopping')">
                        <div class="pfc-icon-box" style="background:linear-gradient(135deg, #ff9500, #d47e04);"><i class="fas fa-shopping-cart"></i></div>
                        <div class="pfc-content">
                            <div class="pfc-title">购物车/消费</div>
                            <div class="pfc-desc" id="preview-shopping">近期消费记录...</div>
                        </div>
                        <i class="fas fa-chevron-right pfc-arrow"></i>
                    </div>

                    <div class="phone-feature-card" onclick="openPhoneFunc('interests')">
                        <div class="pfc-icon-box" style="background:linear-gradient(135deg, #ff2d55, #d61e42);"><i class="fas fa-heart"></i></div>
                        <div class="pfc-content">
                            <div class="pfc-title">兴趣雷达</div>
                            <div class="pfc-desc" id="preview-interests">近期关注关键词...</div>
                        </div>
                        <i class="fas fa-chevron-right pfc-arrow"></i>
                    </div>
                </div>
                <button class="full-btn red" onclick="exitCheckPhone()" style="margin-top:20px;">退出查看</button>
            `;
            // Clear old data to force refresh for new person
            store.phoneData = { contacts: [], memo: [], usage: [], search: [], chats: {}, shopping: [], interests: [] };
        }

        function exitCheckPhone() {
            activeCheckPhoneContactName = null;
            document.getElementById('checkphone-container').innerHTML = `
                 <div style="text-align:center; padding:50px; color:#999;">
                     <i class="fas fa-mobile-alt" style="font-size:64px; margin-bottom:20px; color:#ccc;"></i>
                     <div>请先选择要查看的联系人</div>
                     <button onclick="selectCheckPhoneContact()" style="margin-top:20px; padding:10px 25px; background:var(--primary); color:#fff; border:none; border-radius:6px; font-size:16px;">选择联系人</button>
                 </div>
            `;
            exitApp();
        }

        async function openPhoneFunc(type) {
             if(!activeCheckPhoneContactName) return toast("请先选择联系人");
             const layerMap = { 
                 contacts: 'layer-phone-contacts', 
                 chat_list: 'layer-phone-chat',
                 memo: 'layer-phone-memo', 
                 search: 'layer-phone-search', 
                 usage: 'layer-phone-usage',
                 shopping: 'layer-phone-shopping',
                 interests: 'layer-phone-interests'
             };
             
             if(type === 'chat_list') {
                 openPhoneChat(store.user.name || "User");
                 return; 
             }

             const el = document.getElementById(layerMap[type]);
             if(el) el.classList.add('show');
             
             if(type === 'contacts') {
                 if(!store.phoneData.contacts || store.phoneData.contacts.length === 0) await refreshPhoneData('contacts');
                 else renderPhoneContacts();
             }
             else if(type === 'memo') {
                 if(!store.phoneData.memo || store.phoneData.memo.length === 0) await refreshPhoneData('memo');
                 else renderPhoneMemos();
             }
             else if(type === 'search') {
                 if(!store.phoneData.search || store.phoneData.search.length === 0) await refreshPhoneData('search');
                 else renderPhoneSearch();
             }
             else if(type === 'usage') {
                 if(!store.phoneData.usage || store.phoneData.usage.length === 0) await refreshPhoneData('usage');
                 else renderPhoneUsage();
             }
             else if(type === 'shopping') {
                 if(!store.phoneData.shopping || store.phoneData.shopping.length === 0) await refreshPhoneData('shopping');
                 else renderPhoneShopping();
             }
             else if(type === 'interests') {
                 if(!store.phoneData.interests || store.phoneData.interests.length === 0) await refreshPhoneData('interests');
                 else renderPhoneInterests();
             }
        }

        async function refreshPhoneData(type) {
             const success = await aiGeneratePhone(type);
             if(success) {
                 if(type==='contacts') renderPhoneContacts();
                 if(type==='memo') renderPhoneMemos();
                 if(type==='search') renderPhoneSearch();
                 if(type==='usage') renderPhoneUsage();
                 if(type==='shopping') renderPhoneShopping();
                 if(type==='interests') renderPhoneInterests();
             }
        }

        function renderPhoneContacts() {
             const l = document.getElementById('phone-contacts-list');
             const userName = store.user.name || "User";
             let contacts = (store.phoneData.contacts||[]);
             
             // 1. 过滤掉生成的联系人中可能重复出现的“我”、当前用户名、以及被查看者自己
             const ownerName = activeCheckPhoneContactName;
             contacts = contacts.filter(c => c.name !== userName && c.name !== '我' && c.name !== 'Me' && c.name !== ownerName);
             
             // 2. 去重
             const uniqueContacts = [];
             const seen = new Set();
             contacts.forEach(c => {
                 if (!seen.has(c.name)) {
                     seen.add(c.name);
                     uniqueContacts.push(c);
                 }
             });
             
             // 3. 将真实用户(User)置顶，作为唯一真实入口
             const finalContacts = [{name: userName, isReal: true}, ...uniqueContacts];
             
             l.innerHTML = finalContacts.map(c => {
                 const avatarBg = c.isReal ? '#07c160' : '#ddd'; // 真实用户用绿色突出
                 return `<div class="list-item" onclick="openPhoneChat('${c.name}')">
                    <div class="avatar" style="background:${avatarBg}; display:flex; justify-content:center; align-items:center; color:#fff; font-weight:bold;">${c.name[0]}</div>
                    <div class="list-content"><div class="list-title">${c.name}</div></div>
                    <i class="fas fa-chevron-right" style="color:#ddd;"></i>
                 </div>`;
             }).join('');
        }

        async function openPhoneChat(name) {
             document.getElementById('phone-chat-title').innerText = name;
             document.getElementById('layer-phone-chat').classList.add('show');
             
            const targetC = store.contacts.find(c => c.name === activeCheckPhoneContactName); // The AI whose phone is being checked.
            const isUserChat = name === (store.user.name || "User");

            if (isUserChat) {
                // No generation needed, just render the real history.
                renderPhoneChat(name, true, targetC.id);
            } else {
                // Generate fake chat for other contacts.
                if(!store.phoneData.chats) store.phoneData.chats = {};
                if(!store.phoneData.chats[name]) {
                    const success = await aiGeneratePhone('chat', name);
                    if(!success) return;
                }
                renderPhoneChat(name, false, null);
            }
        }

        function renderPhoneChat(name, isRealHistory, realContactId) {
            const h = document.getElementById('phone-chat-history');
            if (!h) return;
            h.innerHTML = '';

            const msgs = isRealHistory ? (store.chats[realContactId] || []) : (store.phoneData.chats[name] || []);

            // 在“查手机”视图中：
            // Owner = 手机的主人（被查看的联系人） => 消息显示在右边 (class 'me')
            // Other = 对话的另一方（如果是真实历史，就是User；如果是虚拟历史，就是虚拟联系人） => 消息显示在左边
            
            const ownerName = activeCheckPhoneContactName;
            const ownerContact = store.contacts.find(c => c.name === ownerName);
            const ownerAvatarSrc = ownerContact?.avatar || `https://ui-avatars.com/api/?name=${(ownerName || '我')[0]}&background=95ec69&color=fff`;
            
            // 对方的头像（如果是User，用User头像；否则生成）
            let otherAvatarSrc;
            if (isRealHistory) {
                otherAvatarSrc = store.user.avatar || `https://ui-avatars.com/api/?name=${(store.user.name || 'User')[0]}&background=ddd&color=fff`;
            } else {
                otherAvatarSrc = `https://ui-avatars.com/api/?name=${name[0]}&background=ddd&color=fff`;
            }

            msgs.forEach(m => {
                let isOwnerSender = false; // 是否是手机主人发送的消息（右侧）

                if (isRealHistory) {
                    // 真实历史数据结构：
                    // sender === 'me'  -> 是User发的 -> 在查手机视角，这是“对方”，应在左边 (isOwnerSender = false)
                    // sender === 'ai'  -> 是联系人发的 -> 在查手机视角，这是“主人”，应在右边 (isOwnerSender = true)
                    // 所以需要反转逻辑
                    if (m.sender !== 'me') {
                        isOwnerSender = true;
                    }
                } else {
                    // 虚拟历史数据结构：
                    // 通常生成的格式是 Sender = 'Me'/'我'/'主人名' 表示主人发送
                    // Sender = 'Mom'/'Boss' 等表示对方发送
                    const s = m.sender.toLowerCase();
                    if (s === 'me' || s === '我' || s === ownerName.toLowerCase()) {
                        isOwnerSender = true;
                    }
                }
                
                // 时间显示（简单处理，避免过多重复）
                // 实际项目中可以增加判断，只在间隔较久时显示时间
                const timeDiv = document.createElement('div');
                timeDiv.className = 'phone-chat-time';
                // 处理时间格式，兼容真实时间戳和生成的时间字符串
                let timeDisplay = m.time;
                if (typeof m.time === 'number') {
                    const d = new Date(m.time);
                    timeDisplay = `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
                }
                timeDiv.innerText = timeDisplay;
                h.appendChild(timeDiv);

                const row = document.createElement('div');
                row.className = 'msg-row' + (isOwnerSender ? ' me' : '');

                const avatar = document.createElement('img');
                avatar.className = 'avatar';
                avatar.src = isOwnerSender ? ownerAvatarSrc : otherAvatarSrc;
                
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                // 处理特殊消息类型文本
                if (m.type === 'image') bubble.innerText = '[图片]';
                else if (m.type === 'voice') bubble.innerText = '[语音]';
                else if (m.type === 'location') bubble.innerText = '[位置]';
                else if (m.type === 'transfer') bubble.innerText = '[转账]';
                else bubble.innerText = m.content;
                
                // 组装DOM
                // 注意：CSS样式 .msg-row.me 会自动处理 flex-direction: row-reverse
                row.appendChild(avatar);
                row.appendChild(bubble);
                
                h.appendChild(row);
            });
            
            // 确保滚动到底部
            setTimeout(() => {
                if (h) h.scrollTop = h.scrollHeight;
            }, 100);
        }

        function renderPhoneMemos() {
             const l = document.getElementById('phone-memo-list');
             l.innerHTML = (store.phoneData.memo||[]).map((m,i) => 
                 `<div class="memo-item" onclick="openMemoDetail(${i})">
                    <div class="memo-title">${m.title}</div>
                    <div class="memo-date">${m.date}</div>
                    <div style="font-size:13px; color:#666; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; margin-top:5px;">${m.content}</div>
                 </div>`
             ).join('');
        }

        function openMemoDetail(idx) {
             const m = store.phoneData.memo[idx];
             document.getElementById('memo-det-title').innerText = m.title;
             document.getElementById('memo-det-date').innerText = m.date;
             document.getElementById('memo-det-content').innerHTML = m.content;
             document.getElementById('phone-memo-detail').style.display = 'flex';
        }

        function renderPhoneSearch() {
             const l = document.getElementById('phone-search-list');
             if(!store.phoneData.search || store.phoneData.search.length === 0) {
                 l.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">暂无搜索记录</div>';
                 return;
             }
             
             // Update preview text on main list
             const previewEl = document.getElementById('preview-search');
             if(previewEl) previewEl.innerText = `最近24小时搜索了${store.phoneData.search.length}条内容`;

             l.innerHTML = store.phoneData.search.map((s, i) => 
                 `<div class="browser-item" onclick="toggleSearchExpand(${i})">
                    <div class="browser-header">
                        <div class="browser-icon"><i class="fas fa-search"></i></div>
                        <div class="browser-info">
                            <div class="browser-query">${s.query}</div>
                            <div class="browser-url">百度搜索 • ${s.time}</div>
                        </div>
                        <i class="fas fa-chevron-down" style="color:#ddd; font-size:12px; transition:transform 0.2s;" id="search-arrow-${i}"></i>
                    </div>
                    <div class="search-expand-panel" id="search-panel-${i}" onclick="event.stopPropagation()">
                        <div class="search-res-title">${s.resultTitle || '搜索结果加载中...'}</div>
                        <div class="search-res-desc">${s.resultDesc || '...'}</div>
                        <div class="search-ai-note"><i class="fas fa-mouse-pointer"></i> ${s.clickReason || '点击了此结果'}</div>
                    </div>
                 </div>`
             ).join('');
        }

        function toggleSearchExpand(idx) {
            const panel = document.getElementById(`search-panel-${idx}`);
            const arrow = document.getElementById(`search-arrow-${idx}`);
            const isHidden = panel.style.display === 'none' || panel.style.display === '';
            
            // Close others
            document.querySelectorAll('.search-expand-panel').forEach(p => p.style.display = 'none');
            document.querySelectorAll('[id^="search-arrow-"]').forEach(a => a.style.transform = 'rotate(0deg)');
            
            if(isHidden) {
                panel.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            }
        }
        
        function renderPhoneUsage() {
            const container = document.getElementById('phone-usage-content');
            if(!store.phoneData.usage || store.phoneData.usage.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">暂无使用数据</div>';
                return;
            }

            // Calculate total time (mock logic or sum duration if available)
            // Since we generate events, let's just count App usage events
            const appEvents = store.phoneData.usage.filter(u => u.type === 'App');
            const hours = Math.floor(appEvents.length * 0.5) + 1; // Mock calculation
            
            const previewEl = document.getElementById('preview-usage');
            if(previewEl) previewEl.innerText = `今日屏幕使用时长：${hours}小时${Math.floor(Math.random()*59)}分`;

            let html = `
                <div class="timeline-container">
            `;
            
            store.phoneData.usage.forEach(u => {
                let icon = 'circle';
                if(u.type === 'App') icon = 'mobile-alt';
                if(u.type === 'Sys') icon = 'cog';
                if(u.desc.includes('充电')) icon = 'bolt';
                if(u.desc.includes('Wi-Fi')) icon = 'wifi';
                
                html += `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-time">${u.time}</div>
                        <div class="timeline-content">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <i class="fas fa-${icon}" style="color:var(--primary); opacity:0.7;"></i>
                                <span>${u.desc}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderPhoneShopping() {
            const l = document.getElementById('phone-shopping-list');
            if(!store.phoneData.shopping || store.phoneData.shopping.length === 0) {
                l.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">购物车空空如也</div>';
                return;
            }
            
            const previewEl = document.getElementById('preview-shopping');
            if(previewEl) previewEl.innerText = `待发货订单：${store.phoneData.shopping.length}件`;

            l.innerHTML = store.phoneData.shopping.map(s => `
                <div class="shopping-card">
                    <div class="shop-icon"><i class="fas fa-shopping-bag"></i></div>
                    <div class="shop-info">
                        <div class="shop-title">${s.item}</div>
                        <div class="shop-meta">
                            <span><i class="fas fa-store-alt"></i> ${s.platform}</span>
                            <span style="color:#fa5151; font-weight:bold;">${s.price}</span>
                        </div>
                        <div class="shop-note">${s.reason}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderPhoneInterests() {
            const c = document.getElementById('phone-interests-content');
            if(!store.phoneData.interests || store.phoneData.interests.length === 0) {
                c.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">暂无数据</div>';
                return;
            }

            const previewEl = document.getElementById('preview-interests');
            if(previewEl) {
                const topKw = store.phoneData.interests.slice(0,2).map(k=>k.keyword).join('、');
                previewEl.innerText = `近期高频词：${topKw}`;
            }

            let html = `<div class="interest-cloud">`;
            store.phoneData.interests.forEach((int, i) => {
                const isHot = int.heat > 7;
                html += `<div class="interest-tag ${isHot ? 'hot' : ''}" onclick="toggleInterestEvidence(${i})">
                    ${int.keyword} ${isHot ? '<i class="fas fa-fire"></i>' : ''}
                </div>`;
            });
            html += `</div><div id="interest-evidence-area" class="interest-evidence"></div>`;
            
            c.innerHTML = html;
        }

        function toggleInterestEvidence(idx) {
            const area = document.getElementById('interest-evidence-area');
            const int = store.phoneData.interests[idx];
            area.innerHTML = `
                <div style="font-weight:bold; margin-bottom:5px; color:#333;">关联线索：</div>
                <div class="evidence-box">"${int.evidence}"</div>
            `;
            area.style.display = 'block';
        }

        // --- BUBBLE CUSTOMIZATION ---
        function updateBubblePreview() {
            const bubbleSize = document.getElementById('bubble-size-slider').value;
            const bubblePadding = document.getElementById('bubble-padding-slider').value;
            const bubbleSpacing = document.getElementById('bubble-spacing-slider').value;
            const avatarSize = document.getElementById('avatar-size-slider').value;
            const avatarRadius = document.getElementById('avatar-radius-slider').value;
            
            // Update value displays
            document.getElementById('bubble-size-val').innerText = bubbleSize + 'px';
            document.getElementById('bubble-padding-val').innerText = bubblePadding + 'px';
            document.getElementById('bubble-spacing-val').innerText = bubbleSpacing;
            document.getElementById('avatar-size-val').innerText = avatarSize + 'px';
            document.getElementById('avatar-radius-val').innerText = avatarRadius + 'px';
            
            // Apply to preview elements
            const previewBubbles = document.querySelectorAll('#bubble-preview-area .bubble');
            const previewAvatars = document.querySelectorAll('#bubble-preview-area .avatar');
            
            previewBubbles.forEach(bubble => {
                bubble.style.maxWidth = bubbleSize + 'px';
                bubble.style.padding = bubblePadding + 'px ' + (bubblePadding * 1.4) + 'px';
                bubble.style.lineHeight = bubbleSpacing;
            });
            
            previewAvatars.forEach(avatar => {
                avatar.style.width = avatarSize + 'px';
                avatar.style.height = avatarSize + 'px';
                avatar.style.borderRadius = avatarRadius + 'px';
            });
        }
        
        function applyBubbleStyles() {
            const bubbleSize = document.getElementById('bubble-size-slider').value;
            const bubblePadding = document.getElementById('bubble-padding-slider').value;
            const bubbleSpacing = document.getElementById('bubble-spacing-slider').value;
            const avatarSize = document.getElementById('avatar-size-slider').value;
            const avatarRadius = document.getElementById('avatar-radius-slider').value;
            
            // Apply to CSS variables
            const root = document.documentElement.style;
            root.setProperty('--bubble-size', bubbleSize + 'px');
            root.setProperty('--bubble-padding', bubblePadding + 'px ' + (bubblePadding * 1.4) + 'px');
            root.setProperty('--bubble-spacing', bubbleSpacing);
            root.setProperty('--avatar-size', avatarSize + 'px');
            root.setProperty('--avatar-radius', avatarRadius + 'px');
            
            // Save to store
            if (!store.bubbleStyles) store.bubbleStyles = {};
            store.bubbleStyles = {
                size: bubbleSize,
                padding: bubblePadding,
                spacing: bubbleSpacing,
                avatarSize: avatarSize,
                avatarRadius: avatarRadius
            };
            save();
            
            toast('样式已应用', 'success');
        }
        
        function resetBubbleStyles() {
            // Reset to defaults
            document.getElementById('bubble-size-slider').value = 240;
            document.getElementById('bubble-padding-slider').value = 10;
            document.getElementById('bubble-spacing-slider').value = 1.5;
            document.getElementById('avatar-size-slider').value = 48;
            document.getElementById('avatar-radius-slider').value = 8;
            
            updateBubblePreview();
            applyBubbleStyles();
            
            toast('已重置为默认样式', 'info');
        }
        
        function loadBubbleStyles() {
            if (store.bubbleStyles) {
                const root = document.documentElement.style;
                root.setProperty('--bubble-size', store.bubbleStyles.size + 'px');
                root.setProperty('--bubble-padding', store.bubbleStyles.padding + 'px ' + (store.bubbleStyles.padding * 1.4) + 'px');
                root.setProperty('--bubble-spacing', store.bubbleStyles.spacing);
                root.setProperty('--avatar-size', store.bubbleStyles.avatarSize + 'px');
                root.setProperty('--avatar-radius', store.bubbleStyles.avatarRadius + 'px');
            }
        }

        // --- BEAUTIFY ---
        function renderBeautify() {
             if(!store.appIcons) store.appIcons = { wechat:'', worldbook:'', couple:'', perception:'', checkphone:'', beauty:'', settings:'' };
             
             const grid = document.getElementById('beautify-grid');
             if(!grid) return;

             grid.innerHTML = 
                ['wechat','worldbook','couple','perception','checkphone','beauty','settings'].map(id => {
                    const icon = store.appIcons[id] || '';
                    // Fix: If icon exists, transparent bg. If not, grey bg. Using 100% 100% to ensure corner alignment
                    const style = icon ? `background-color:transparent; background-image:url(${icon}); background-size:100% 100%; background-position:center; background-repeat:no-repeat;` : 'background-color:#eee;';
                    return `<div style="display:flex; flex-direction:column; align-items:center;" onclick="changeAppIcon('${id}')">
                        <div style="width:50px; height:50px; border-radius:12px; ${style} display:flex; justify-content:center; align-items:center;">${icon?'':'<i class="fas fa-image" style="color:#aaa;"></i>'}</div>
                        <span style="font-size:12px; margin-top:5px;">${id}</span>
                    </div>`;
                }).join('');
        }
        function changeAppIcon(id) {tempImgTarget = 'icon-'+id;
             document.getElementById('file-input').click();
        }

        // --- THEME ---
        function applyTheme(themeToApply) {
            const root = document.documentElement.style;
            root.setProperty('--text-main', themeToApply.mainColor);
            root.setProperty('--font-size-main', themeToApply.mainSize);
            root.setProperty('--text-sub', themeToApply.subColor);
            root.setProperty('--font-size-sub', themeToApply.subSize);
            root.setProperty('--text-status-bar', themeToApply.statusBarColor);
            root.setProperty('--text-desktop', themeToApply.desktopTextColor || '#ffffff');
            
            // 状态栏开关逻辑
            const statusBar = document.querySelector('.status-bar');
            const navBars = document.querySelectorAll('.nav-bar');
            const showStatus = themeToApply.showStatusBar !== false; // 默认为 true
            
            if (statusBar) {
                statusBar.style.display = showStatus ? 'flex' : 'none';
            }
            
            // 调整导航栏顶部间距
            navBars.forEach(nav => {
                // 如果是绝对定位在顶部的导航栏（如微信首页）
                if (nav.parentElement && nav.parentElement.id === 'tab-contacts') {
                     nav.style.marginTop = showStatus ? '44px' : '0px';
                }
                // 如果是普通页面的导航栏，通常不需要特殊 margin-top，除非它是 fixed/sticky
                // 检查 CSS: .nav-bar { margin-top: 44px; ... }
                // 对于 position:relative 的 nav-bar，如果它是页面第一个元素，且上面原本是 status-bar
                if (window.getComputedStyle(nav).position === 'relative' || nav.style.position === 'relative') {
                     // 简单处理：全局 CSS 中 .nav-bar 有 margin-top: 44px
                     // 我们需要动态修改这个行为，或者给 body 加 class
                }
            });
            
            // 更稳健的做法：修改 CSS 变量或添加 Body Class
            if (showStatus) {
                document.body.classList.remove('no-status-bar');
                // 恢复 .nav-bar 的 margin-top
                const styleEl = document.getElementById('status-bar-style-override');
                if (styleEl) styleEl.remove();
            } else {
                document.body.classList.add('no-status-bar');
                // 注入样式覆盖
                let styleEl = document.getElementById('status-bar-style-override');
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = 'status-bar-style-override';
                    document.head.appendChild(styleEl);
                }
                styleEl.innerHTML = `
                    .nav-bar { margin-top: 0 !important; } 
                    #desktop { padding-top: 20px !important; }
                    .page { padding-top: 0 !important; }
                    #tab-contacts { padding-top: 0 !important; }
                    #tab-contacts .nav-bar { margin-top: 0 !important; }
                    #contact-list { padding-top: 44px !important; } /* Nav bar height */
                    .add-menu { top: 50px !important; } /* Adjust popup menus */
                    #layer-wechat .add-menu { top: 44px !important; }
                    .status-bar { display: none !important; }
                `;
            }
        }

        function loadTheme() {
            if (!store.theme) {
                 store.theme = {
                    mainColor: '#111111', mainSize: '16px',
                    subColor: '#777777', subSize: '14px',
                    statusBarColor: '#000000',
                    desktopTextColor: '#FFFFFF',
                    showStatusBar: true
                };
            }
            applyTheme(store.theme);
            // also update the input controls in settings
            document.getElementById('theme-main-color').value = store.theme.mainColor;
            document.getElementById('theme-main-size').value = parseInt(store.theme.mainSize);
            document.getElementById('theme-main-size-val').textContent = store.theme.mainSize;
            document.getElementById('theme-sub-color').value = store.theme.subColor;
            document.getElementById('theme-sub-size').value = parseInt(store.theme.subSize);
            document.getElementById('theme-sub-size-val').textContent = store.theme.subSize;
            document.getElementById('theme-status-color').value = store.theme.statusBarColor;
            document.getElementById('theme-desktop-color').value = store.theme.desktopTextColor || '#FFFFFF';
            document.getElementById('theme-show-status').checked = store.theme.showStatusBar !== false;
        }

        function saveTheme() {
            store.theme.mainColor = document.getElementById('theme-main-color').value;
            store.theme.mainSize = document.getElementById('theme-main-size').value + 'px';
            store.theme.subColor = document.getElementById('theme-sub-color').value;
            store.theme.subSize = document.getElementById('theme-sub-size').value + 'px';
            store.theme.statusBarColor = document.getElementById('theme-status-color').value;
            store.theme.desktopTextColor = document.getElementById('theme-desktop-color').value;
            store.theme.showStatusBar = document.getElementById('theme-show-status').checked;
            applyTheme(store.theme);
            save();
            toast("主题已保存");
        }
        
        function resetTheme() {
             const defaultTheme = {
                mainColor: '#111111', mainSize: '16px',
                subColor: '#777777', subSize: '14px',
                statusBarColor: '#000000',
                desktopTextColor: '#FFFFFF',
                showStatusBar: true
            };
            store.theme = defaultTheme;
            loadTheme(); // this will apply and update controls
            save();
            toast("主题已重置");
        }

        // --- DATA MGMT ---
        function exportData() {
            try {
                const dataStr = JSON.stringify(store);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = "AIChatOS_Backup_" + new Date().toISOString().slice(0,10) + ".json";
                
                document.body.appendChild(a);
                
                // Detecting iOS to provide specific feedback if needed, 
                // though standard download usually works on modern iOS Safari.
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                
                setTimeout(() => {
                    a.click();
                    document.body.removeChild(a);
                    // Delay revocation to ensure download starts on iOS
                    setTimeout(() => URL.revokeObjectURL(url), 60000); 
                    
                    if(isIOS) {
                        toast("请在弹出的窗口中选择'下载'或'保存到文件'");
                    } else {
                        toast("导出已触发");
                    }
                }, 100);
            } catch(e) {
                console.error("Export failed:", e);
                toast("导出失败: " + e.message);
            }
        }

        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Show loading indicator
            const loading = document.getElementById('loading');
            if(loading) loading.style.display = 'block';
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    if (!content) throw new Error("文件内容为空");
                    
                    const data = JSON.parse(content);
                    
                    // Robust validation check
                    if (data && (data.user || data.contacts)) {
                        // Merge with default DB structure to ensure compatibility
                        for (let key in DB) {
                            if (data[key] === undefined) {
                                data[key] = DB[key];
                            }
                        }
                        
                        // Async save to ensure DB write completes before reload
                        store = data;
                        
                        // Use the existing save mechanism but also force IDB write immediately
                        idb.set('AIChatOS_v8', store).then(() => {
                            if(loading) loading.style.display = 'none';
                            toast("数据导入成功，即将刷新...", "success");
                            setTimeout(() => location.reload(), 1500);
                        }).catch(err => {
                            console.error("Save after import failed:", err);
                            if(loading) loading.style.display = 'none';
                            toast("导入后保存失败: " + err.message, "error");
                        });
                        
                    } else {
                        throw new Error("无效的备份文件格式");
                    }
                } catch(err) {
                    console.error("Import failed:", err);
                    if(loading) loading.style.display = 'none';
                    toast("导入失败: " + err.message, "error");
                }
            };
            
            reader.onerror = function() {
                if(loading) loading.style.display = 'none';
                toast("读取文件失败", "error");
            };
            
            reader.readAsText(file);
            // Reset file input to allow importing the same file again
            input.value = '';
        }

        // --- VOICE CALL LOGIC ---
        function startVoiceCall() {
            if (!activeChatId) return toast("请先选择联系人");
            const contact = store.contacts.find(c => c.id === activeChatId);
            
            // Stop Music if playing
            const gAudio = document.getElementById('global-audio');
            if(!gAudio.paused) {
                gAudio.pause();
                store.listenState.playing = false;
                updateListenUI(); // Ensure UI reflects pause
            }

            // UI Init
            document.getElementById('vc-avatar-img').src = contact.avatar || 'https://via.placeholder.com/120';
            document.getElementById('vc-status').innerText = "正在呼叫...";
            document.getElementById('vc-subtitle').innerText = "";
            document.getElementById('vc-timer').innerText = "00:00";
            document.getElementById('vc-history-content').innerHTML = ''; // Clear history
            document.getElementById('layer-voice-call').classList.add('show');
            
            // State Init
            store.callState.active = true;
            store.callState.startTime = Date.now();
            store.callState.micMuted = false;
            store.callState.speakerOn = true;
            
            // Start Timer
            if(store.callState.timerInterval) clearInterval(store.callState.timerInterval);
            store.callState.timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - store.callState.startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('vc-timer').innerText = `${m}:${s}`;
            }, 1000);
            
            // Audio & Speech Init
            initAudioCapture();
            
            // Fake Connection Delay
            setTimeout(() => {
                document.getElementById('vc-status').innerText = "通话中";
                playVoiceSystemSound('connect');
            }, 1500);
        }

        function endVoiceCall() {
            store.callState.active = false;
            document.getElementById('layer-voice-call').classList.remove('show');
            if(store.callState.timerInterval) clearInterval(store.callState.timerInterval);
            
            // Stop Recognition
            if(store.callState.recognition) {
                try { store.callState.recognition.stop(); } catch(e) {}
            }
            
            // Stop TTS if playing
            const audio = document.getElementById('tts-audio');
            audio.pause();
            
            // Reset UI
            document.getElementById('vc-avatar-pulse').classList.remove('speaking');
            playVoiceSystemSound('hangup');
        }

        function toggleVCMute() {
            store.callState.micMuted = !store.callState.micMuted;
            const btn = document.getElementById('vc-btn-mute');
            if(store.callState.micMuted) {
                btn.classList.add('active');
                if(store.callState.recognition) store.callState.recognition.stop();
            } else {
                btn.classList.remove('active');
                initAudioCapture(); // Restart recognition
            }
        }

        function toggleVCSpeaker() {
            store.callState.speakerOn = !store.callState.speakerOn;
            const btn = document.getElementById('vc-btn-speaker');
            if(store.callState.speakerOn) btn.classList.add('active');
            else btn.classList.remove('active');
            // In a real app, this would switch audio output device
        }

        function toggleVCKeyboard() {
            const area = document.getElementById('vc-text-input-box');
            area.style.display = area.style.display === 'flex' ? 'none' : 'flex';
            if(area.style.display === 'flex') document.getElementById('vc-input').focus();
        }
        
        function toggleVCMinimize() {
            document.getElementById('layer-voice-call').classList.remove('show');
            toast("通话在后台继续");
            // Add a floating bubble for return if needed (simplified for now)
        }
        
        function toggleVCMore() {
            const panel = document.getElementById('vc-history-panel');
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        }

        function appendVoiceLog(sender, textOrObj) {
            const item = document.createElement('div');
            item.className = 'vc-log-item ' + sender;
            
            // Sender Label
            const senderLabel = document.createElement('div');
            senderLabel.className = 'vc-log-sender ' + sender;
            senderLabel.innerText = sender === 'me' ? '我' : (store.contacts.find(c=>c.id===activeChatId)?.name || 'AI');
            item.appendChild(senderLabel);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'vc-log-content';

            if (typeof textOrObj === 'object') {
                if (textOrObj.action) {
                    const actionDiv = document.createElement('div');
                    actionDiv.className = 'vc-log-action';
                    actionDiv.innerText = `*${textOrObj.action}*`;
                    contentDiv.appendChild(actionDiv);
                }
                const textDiv = document.createElement('div');
                textDiv.className = 'vc-log-text';
                textDiv.innerText = textOrObj.text;
                contentDiv.appendChild(textDiv);
            } else {
                const textDiv = document.createElement('div');
                textDiv.className = 'vc-log-text';
                textDiv.innerText = textOrObj;
                contentDiv.appendChild(textDiv);
            }
            
            item.appendChild(contentDiv);
            
            const box = document.getElementById('vc-history-content');
            box.appendChild(item);
            box.scrollTop = box.scrollHeight;
        }

        function initAudioCapture() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Browser does not support SpeechRecognition");
                // Do not toast error repeatedly, just fallback gracefully (user can use keyboard)
                return; 
            }
            
            try {
                if (store.callState.recognition) {
                    store.callState.recognition.onend = null; // Prevent loop
                    store.callState.recognition.stop();
                }

                const recognition = new SpeechRecognition();
                recognition.continuous = false; 
                recognition.interimResults = true;
                recognition.lang = 'zh-CN';

                recognition.onstart = () => {
                    document.getElementById('vc-mic-wave').classList.add('active');
                };

                recognition.onerror = (event) => {
                    console.error("Speech recognition error", event.error);
                    document.getElementById('vc-mic-wave').classList.remove('active');
                    // Silently restart if allowed error type
                    if (event.error === 'no-speech' || event.error === 'network') {
                        // ignore
                    }
                };

                recognition.onend = () => {
                    document.getElementById('vc-mic-wave').classList.remove('active');
                    // Restart logic: Only if active, not muted, and not AI speaking
                    if(store.callState.active && !store.callState.micMuted && !store.callState.isSpeaking) {
                        setTimeout(() => {
                            try { recognition.start(); } catch(e) { console.log("Resume rec failed", e); }
                        }, 100);
                    }
                };

                recognition.onresult = (event) => {
                    let interim = '';
                    let final = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            final += event.results[i][0].transcript;
                        } else {
                            interim += event.results[i][0].transcript;
                        }
                    }
                    
                    if (interim) document.getElementById('vc-subtitle').innerText = "我: " + interim;
                    
                    if (final) {
                        document.getElementById('vc-subtitle').innerText = "我: " + final;
                        appendVoiceLog('me', final);
                        processVoiceInput(final);
                    }
                };

                store.callState.recognition = recognition;
                recognition.start();
            } catch(e) {
                console.error("Init Audio Capture Failed:", e);
            }
        }

        function sendVoiceCallText() {
            const text = document.getElementById('vc-input').value;
            if(!text) return;
            document.getElementById('vc-subtitle').innerText = "我: " + text;
            processVoiceInput(text);
            document.getElementById('vc-input').value = '';
            document.getElementById('vc-text-input-box').style.display = 'none';
        }

        async function processVoiceInput(text) {
            if(!text) return;
            
            // AI Processing Visuals
            document.getElementById('vc-status').innerText = "对方思考中...";
            store.callState.isSpeaking = true; // Stop listening while AI speaks
            if(store.callState.recognition) store.callState.recognition.stop();

            // Generate AI Response
            await aiGenerateVoiceCall(text);
        }

        async function aiGenerateVoiceCall(text) {
            const contact = store.contacts.find(c => c.id === activeChatId);
            
            // 获取世界书内容
            let worldBookContent = 'None';
            if (contact.settings?.mountedWbIds && Array.isArray(contact.settings.mountedWbIds)) {
                const mountedBooks = store.worldbooks.filter(wb => contact.settings.mountedWbIds.includes(wb.id));
                if (mountedBooks.length > 0) {
                    worldBookContent = mountedBooks.map(wb => `[${wb.name}]:\n${wb.content}`).join('\n\n');
                }
            }
            
            const sysPrompt = `You are ${contact.name}. Persona: ${contact.persona}. 
            World Book Context: ${worldBookContent}
            User said: "${text}".
            You are in a Voice Call. 
            
            CRITICAL FORMAT REQUIREMENT:
            You MUST alternate between action descriptions and dialogue.
            Format: [ACTION]动作描写[/ACTION][DIALOGUE]语言内容[/DIALOGUE]
            
            Example:
            [ACTION]轻笑着摇了摇头[/ACTION][DIALOGUE]你真是的，总是这样[/DIALOGUE][ACTION]叹了口气[/ACTION][DIALOGUE]不过我还是很喜欢你这样[/DIALOGUE]
            
            Rules:
            1. Start with an action tag
            2. Follow with dialogue tag
            3. Alternate between them
            4. Keep each segment short (5-15 characters)
            5. Use natural, conversational Chinese
            6. Actions should describe tone, gesture, or emotion
            
            Do NOT use JSON. Do NOT use markdown. Just use the tag format above.`;

            try {
                const data = await API.chatCompletion([
                    {role: 'system', content: sysPrompt},
                    {role: 'user', content: text}
                ]);
                let content = data.choices[0].message.content.trim();
                
                // 解析交替格式
                const actionRegex = /\[ACTION\](.*?)\[\/ACTION\]/g;
                const dialogueRegex = /\[DIALOGUE\](.*?)\[\/DIALOGUE\]/g;
                
                const actions = [];
                const dialogues = [];
                
                let match;
                while ((match = actionRegex.exec(content)) !== null) {
                    actions.push(match[1]);
                }
                while ((match = dialogueRegex.exec(content)) !== null) {
                    dialogues.push(match[1]);
                }
                
                // 如果解析失败，使用原始内容
                if (actions.length === 0 && dialogues.length === 0) {
                    const resObj = { action: "", text: content, tts_text: content };
                    document.getElementById('vc-status').innerText = "通话中";
                    document.getElementById('vc-subtitle').innerText = resObj.text;
                    appendVoiceLog('ai', resObj);
                    await playVoiceCallAudio(resObj.tts_text);
                    return;
                }
                
                // 交替播放动作和对话
                document.getElementById('vc-status').innerText = "通话中";
                
                for (let i = 0; i < Math.max(actions.length, dialogues.length); i++) {
                    const action = actions[i] || "";
                    const dialogue = dialogues[i] || "";
                    
                    if (action) {
                        document.getElementById('vc-subtitle').innerText = `*${action}*`;
                        appendVoiceLog('ai', { action: action, text: "" });
                        await new Promise(resolve => setTimeout(resolve, 800)); // 短暂停顿
                    }
                    
                    if (dialogue) {
                        document.getElementById('vc-subtitle').innerText = dialogue;
                        appendVoiceLog('ai', { action: "", text: dialogue });
                        await playVoiceCallAudio(dialogue);
                    }
                }

            } catch(e) {
                console.error("Voice Call Error:", e);
                document.getElementById('vc-status').innerText = "连接不稳定";
                store.callState.isSpeaking = false;
                initAudioCapture(); 
            }
        }

        async function playVoiceCallAudio(text) {
            const contact = store.contacts.find(c => c.id === activeChatId);
            
            // Check if MiniMax TTS is enabled for this contact
            if (!contact.settings?.enableTTS) {
                // If TTS disabled, just simulate a delay for reading time then resume listening
                const readTime = Math.max(1500, text.length * 200);
                document.getElementById('vc-avatar-pulse').classList.add('speaking');
                
                setTimeout(() => {
                    document.getElementById('vc-avatar-pulse').classList.remove('speaking');
                    store.callState.isSpeaking = false;
                    initAudioCapture();
                }, readTime);
                return;
            }

            document.getElementById('vc-avatar-pulse').classList.add('speaking');
            
            try {
                const blob = await API.textToSpeech(text, contact.settings?.voiceId, contact.settings?.voiceLang);
                const url = URL.createObjectURL(blob);
                const audio = document.getElementById('tts-audio');
                audio.src = url;
                
                audio.onended = () => {
                    document.getElementById('vc-avatar-pulse').classList.remove('speaking');
                    store.callState.isSpeaking = false;
                    initAudioCapture(); 
                };
                
                await audio.play();
            } catch(e) {
                console.error("TTS Play Error:", e);
                // Only show error if enabled and failed
                if (contact.settings?.enableTTS) {
                    showToast("语音合成失败", "error");
                }
                document.getElementById('vc-avatar-pulse').classList.remove('speaking');
                store.callState.isSpeaking = false;
                initAudioCapture();
            }
        }

        function playVoiceSystemSound(type) {
            // Simulated system sounds
            // In real app, play specific audio files
        }

        // --- UTILS ---
        const DEFAULT_BUBBLE_CSS = `/* --- 高级气泡CSS美化全集 --- */

/* 1. 基础布局调整 */
.msg-row {
  margin-bottom: 15px; /* 增加消息间距 */
  align-items: flex-end; /* 头像底部对齐 */
}

/* 2. 头像样式 */
.avatar {
  border-radius: 12px !important; /* 方圆角头像 */
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.avatar:active {
  transform: scale(0.95);
}

/* 3. 气泡通用样式 */
.bubble {
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  border: none !important;
  position: relative;
  transition: all 0.2s;
  max-width: 260px !important; /* 限制最大宽度 */
}

/* 4. 对方(AI) 气泡 - 白底风格 */
.msg-row:not(.me) .bubble {
  background: #ffffff;
  color: #333;
  border-radius: 2px 18px 18px 18px; /* 特殊圆角: 左上尖角 */
  margin-left: 5px;
}
/* 对方气泡小三角 (伪元素实现) */
.msg-row:not(.me) .bubble::before {
  content: '';
  position: absolute;
  left: -6px; top: 0;
  border-right: 6px solid #ffffff;
  border-top: 6px solid transparent;
  border-bottom: 6px solid transparent;
}

/* 5. 我(User) 气泡 - 渐变风格 */
.msg-row.me .bubble {
  background: linear-gradient(135deg, #07c160, #10ad58);
  color: white;
  border-radius: 18px 2px 18px 18px; /* 特殊圆角: 右上尖角 */
  margin-right: 5px;
}
/* 我方气泡小三角 */
.msg-row.me .bubble::after {
  content: '';
  position: absolute;
  right: -6px; top: 0;
  border-left: 6px solid #07c160;
  border-top: 6px solid transparent;
  border-bottom: 6px solid transparent;
}

/* 6. 图片消息样式 */
.bubble img {
  border-radius: 8px !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
/* 去除图片气泡的背景和内边距 */
.msg-row:not(.me) .bubble:has(img),
.msg-row.me .bubble:has(img) {
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}
/* 隐藏图片气泡的小三角 */
.bubble:has(img)::before,
.bubble:has(img)::after {
  display: none !important;
}

/* 7. 语音消息样式 */
.bubble.voice {
  display: flex;
  align-items: center;
  min-width: 80px;
  cursor: pointer;
}
.bubble.voice i {
  font-size: 14px;
}
.msg-row:not(.me) .bubble.voice i { color: #555; margin-right: 8px; }
.msg-row.me .bubble.voice { flex-direction: row-reverse; }
.msg-row.me .bubble.voice i { color: #fff; margin-left: 8px; margin-right:0; }

/* 8. 转账/红包消息样式 */
.bubble-transfer {
  background: #fa9d3b !important; /* 橙色背景 */
  border-radius: 12px !important;
  color: white !important;
  width: 240px !important;
  overflow: hidden;
}
.bubble-transfer .transfer-top {
  padding: 15px;
  background: transparent;
}
.bubble-transfer .transfer-icon {
  border: 2px solid rgba(255,255,255,0.8);
}
.bubble-transfer .transfer-bottom {
  background: rgba(255,255,255,0.15); /* 半透明底部 */
  color: rgba(255,255,255,0.9);
  border-top: none;
}
/* 已收款/退回状态 */
.bubble-transfer.done {
  background: #f7e2c5 !important; /* 变浅 */
  opacity: 1;
}
.bubble-transfer.done .transfer-bottom {
  color: #999;
  background: #fff;
}

/* 9. 地理位置消息 */
.bubble-location {
  border-radius: 12px;
  border: 1px solid #eee;
}
.bubble-location .loc-info {
  background: #fff;
}
.bubble-location .loc-name {
  font-weight: bold;
}

/* 10. 撤回消息样式 */
.bubble.recalled {
  background: transparent !important;
  box-shadow: none !important;
  color: #999 !important;
  font-size: 12px !important;
  padding: 5px 0 !important;
  text-align: center;
  width: 100%;
  max-width: 100% !important;
}
.msg-row:has(.recalled) {
  justify-content: center; /* 让撤回消息居中 */
}
/* 隐藏撤回消息的头像 (可选) */
.msg-row:has(.recalled) .avatar {
  display: none;
}

/* 11. 引用消息预览框 (输入栏上方) */
.quote-preview {
  background: #f1f1f1;
  border-radius: 8px;
  border-left: 4px solid #07c160;
  color: #666;
  font-size: 13px;
  margin: 0 10px 10px 10px;
}
/* 12. 气泡内引用样式 */
.bubble-quote {
  margin-bottom: 5px;
  padding: 6px 8px;
  background: rgba(0,0,0,0.05);
  border-left: 3px solid rgba(0,0,0,0.2);
  font-size: 12px;
  color: inherit;
  opacity: 0.8;
  border-radius: 4px;
  white-space: pre-wrap;
  display: block;
}
`;

        const DEFAULT_GLOBAL_CSS = `/* --- 高级全局UI主题模板 --- */

/* 1. 核心变量覆盖 */
:root {
  --primary: #5856D6 !important; /* iOS 紫色主题 */
  --bg-grey: #f2f2f7 !important;
  --text-main: #000000 !important;
  --text-sub: #8e8e93 !important;
  --radius-box: 18px !important; /* 更大的圆角 */
  --radius-btn: 12px !important;
}

/* 2. 背景与毛玻璃效果 */
body {
  background-color: #000;
}
#device {
  background-color: #fff;
}
/* 导航栏毛玻璃 */
.nav-bar {
  background: rgba(255, 255, 255, 0.85) !important;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
  position: sticky; top: 0; /* 确保吸顶 */
}
.nav-title {
  font-weight: 700 !important;
  letter-spacing: -0.5px;
}

/* 3. 列表项美化 (联系人/设置) */
.list-item, .form-cell {
  background: #fff;
  transition: background 0.2s;
}
.list-item:active, .form-cell:active {
  background: #f2f2f7 !important;
}
/* 分组圆角效果 (类似iOS设置) */
.group-box {
  border-radius: 12px !important;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.02);
  margin: 15px !important;
}
/* 去除最后一条分割线 */
.list-item:last-child, .form-cell:last-child {
  border-bottom: none !important;
}

/* 4. 输入栏美化 */
.input-bar {
  background: rgba(249, 249, 249, 0.95) !important;
  backdrop-filter: blur(10px);
  border-top: 0.5px solid rgba(0,0,0,0.1) !important;
  padding-bottom: 34px !important; /* 适配 iPhone 底部条 */
}
.input-field {
  background: #fff !important;
  border: 1px solid #e5e5ea !important;
  border-radius: 20px !important;
  padding-left: 15px !important;
  box-shadow: 0 1px 4px rgba(0,0,0,0.03);
}
.btn-send {
  background: var(--primary) !important;
  border-radius: 50% !important;
  width: 36px; height: 36px;
  font-size: 13px;
  display: flex; justify-content: center; align-items: center;
  padding: 0 !important;
  box-shadow: 0 2px 6px rgba(88, 86, 214, 0.4);
}

/* 5. 底部标签栏 (微信式) */
.wx-tab-bar {
  background: rgba(247, 247, 247, 0.95) !important;
  backdrop-filter: blur(10px);
  border-top: 0.5px solid rgba(0,0,0,0.1) !important;
  padding-bottom: 20px !important; /* 适配底部条 */
  height: 70px !important;
}
.nav-tab.active {
  color: var(--primary) !important;
}

/* 6. 弹窗与模态框 */
.modal-box {
  border-radius: 24px !important;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
  transform: scale(1);
  animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes modalPop {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* 7. 按钮通用样式 */
.full-btn {
  border-radius: 12px !important;
  font-weight: 600 !important;
  background: var(--primary) !important;
  box-shadow: 0 4px 12px rgba(88, 86, 214, 0.3);
  transition: transform 0.1s;
}
.full-btn:active {
  transform: scale(0.98);
}
`;

        function restoreDefaultCSS(type) {
            const css = type === 'bubble' ? DEFAULT_BUBBLE_CSS : DEFAULT_GLOBAL_CSS;
            document.getElementById(`css-${type}`).value = css;
            applyCustomCSS(type);
            toast("已还原默认样式");
        }

        function textToImage(text, bgCol='#e0e0e0', textCol='#333') {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const font = 'bold 40px "PingFang SC", "Microsoft YaHei", sans-serif';
            ctx.font = font;
            
            // Adjust canvas to fit text
            const maxWidth = 580;
            const lineHeight = 50;
            const padding = 20;
            
            let lines = [];
            let currentLine = '';
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const testLine = currentLine + char;
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && i > 0) {
                    lines.push(currentLine);
                    currentLine = char;
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);
            
            canvas.width = Math.min(ctx.measureText(text).width + padding * 2, maxWidth + padding * 2);
            if (lines.length > 1) {
                canvas.width = maxWidth + padding * 2;
            }
            canvas.height = lines.length * lineHeight + padding * 2;
            
            // Re-apply font settings after canvas resize
            ctx.font = font;
            ctx.fillStyle = bgCol;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = textCol;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const yStart = (canvas.height / 2) - ((lines.length - 1) * lineHeight / 2);
            
            lines.forEach((line, index) => {
                ctx.fillText(line, canvas.width / 2, yStart + (index * lineHeight));
            });
            
            return canvas.toDataURL('image/png');
        }

        function uploadImg(target) {
            tempImgTarget=target; 
            const fi = document.getElementById('file-input');
            fi.multiple = (target === 'sticker-batch'); 
            
            if (target === 'music-file') fi.accept = '.mp3,audio/*';
            else if (target === 'lyrics-file') fi.accept = '.lrc,.txt';
            else fi.accept = 'image/*';
            
            fi.value = '';
            fi.click(); 
        }
        
        // Cropper Logic
        let cropperInstance = null;
        function startCropper(url) {
            const img = document.getElementById('cropper-img');
            img.src = url;
            document.getElementById('modal-cropper').style.display = 'flex';
            
            if(cropperInstance) cropperInstance.destroy();
            
            cropperInstance = new Cropper(img, {
                aspectRatio: 1, // Icons are square
                viewMode: 1,
                autoCropArea: 1,
                dragMode: 'move'
            });
        }

        function closeCropper() {
            document.getElementById('modal-cropper').style.display = 'none';
            if(cropperInstance) {
                cropperInstance.destroy();
                cropperInstance = null;
            }
            document.getElementById('file-input').value = '';
        }

        function finishCrop() {
            if(!cropperInstance) return;
            // Get cropped canvas
            const canvas = cropperInstance.getCroppedCanvas({
                width: 150, // Optimal size for icons
                height: 150,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            if (!canvas) return;

            const finalUrl = canvas.toDataURL('image/jpeg', 0.9);
            
            // Apply logic specifically for icons
            if (tempImgTarget && tempImgTarget.startsWith('icon-')) {
                const appId = tempImgTarget.replace('icon-','');
                if(!store.appIcons) store.appIcons = {};
                store.appIcons[appId] = finalUrl;
                save();
                renderDesktop(); 
                renderBeautify(); 
                toast("图标已修改", "success");
            }
            
            closeCropper();
        }

        document.getElementById('file-input').onchange = function(e) {
            if (e.target.files.length === 0) return;

            const handleFile = (file) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const u = event.target.result;
                    
                    // Intercept for App Icons to use Cropper
                    if (tempImgTarget && tempImgTarget.startsWith('icon-')) {
                        startCropper(u);
                        return; // Stop further processing here, wait for crop finish
                    }

                    // 问题1修复：优化图片压缩逻辑，确保移动端正常显示
                    const compressImage = (dataUrl, callback) => {
                        const img = new Image();
                        img.onload = () => {
                            try {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                
                                // 优化：针对图标使用更小的尺寸
                                const isIcon = tempImgTarget && tempImgTarget.startsWith('icon-');
                                const maxSize = isIcon ? 150 : 800; 
                                
                                if (width > height && width > maxSize) {
                                    height = (height * maxSize) / width;
                                    width = maxSize;
                                } else if (height > maxSize) {
                                    width = (width * maxSize) / height;
                                    height = maxSize;
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d', { alpha: true });
                                
                                // 不添加白色背景，保持透明度
                                ctx.clearRect(0, 0, width, height);
                                // 填充白色背景，防止JPEG透明变黑
                                ctx.fillStyle = '#ffffff';
                                ctx.fillRect(0, 0, width, height);
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                // 优化：使用JPEG格式并降低质量以大幅节省空间 (解决存储满问题)
                                const compressed = canvas.toDataURL('image/jpeg', 0.7);
                                callback(compressed);
                            } catch (e) {
                                console.error('图片压缩失败:', e);
                                toast('图片处理失败，使用原图', 'error');
                                callback(dataUrl);
                            }
                        };
                        img.onerror = () => {
                            console.error('图片加载失败');
                            toast('图片加载失败，请重试', 'error');
                            callback(dataUrl);
                        };
                        img.crossOrigin = 'anonymous'; // 处理跨域图片
                        img.src = dataUrl;
                    };

                    const processImage = (finalUrl) => {
                        switch(tempImgTarget) {
                            case 'desktop-user-avatar':
                                store.user.desktopAvatar = finalUrl;
                                save();
                                document.getElementById('desktop-user-avatar-img').src = finalUrl;
                                toast("主页头像已更新", "success");
                                break;
                            case 'desktop-widget-bg':
                                if(!store.appIcons) store.appIcons = {};
                                store.appIcons.desktopWidgetBg = finalUrl;
                                save();
                                const widget = document.querySelector('.custom-widget');
                                if (widget) widget.style.backgroundImage = `url(${finalUrl})`;
                                toast("组件背景已更新", "success");
                                break;
                            case 'new-contact-avatar':
                                document.getElementById('new-contact-img').src=finalUrl; 
                                document.getElementById('new-contact-img').style.display='block';
                                break;
                            case 'edit-contact-avatar':
                                const c = store.contacts.find(x=>x.id===activeChatId);
                                if(c) { c.avatar = finalUrl; openChatSettings(); toast("头像已更新", "success"); }
                                break;
                            case 'moment-bg':
                                store.user.momentBg = finalUrl;
                                renderMoments();
                                toast("朋友圈背景已更新", "success");
                                break;
                            case 'post-moment':
                                postMoment(prompt("配文:")||'', finalUrl);
                                break;
                            case 'music-file':
                                tempMusicData.url = finalUrl;
                                tempMusicData.name = file.name.replace(/\.[^/.]+$/, "");
                                // Auto fill name if empty
                                const nameInput = document.getElementById('music-add-name');
                                if(!nameInput.value) nameInput.value = tempMusicData.name;
                                document.getElementById('music-file-status').style.display = 'block';
                                document.getElementById('music-file-status').innerText = '文件已就绪: ' + file.name;
                                toast("MP3已就绪");
                                break;
                            case 'lyrics-file':
                                tempMusicData.lrc = finalUrl;
                                document.getElementById('lyrics-status').innerText = file.name;
                                toast("歌词已就绪");
                                break;
                            case 'desktop-bg':
                                store.desktopBg = finalUrl;
                                document.getElementById('desktop').style.backgroundImage = `url(${finalUrl})`;
                                toast("主页背景已修改", "success");
                                break;
                            case 'my-avatar':
                                store.user.avatar=finalUrl; 
                                document.getElementById('my-avatar').src=finalUrl; 
                                toast("微信头像已更新", "success");
                                break;
                            case 'chat-bg':
                                const contact = store.contacts.find(x=>x.id===activeChatId);
                                if(contact) {
                                    if(!contact.settings) contact.settings={}; 
                                    contact.settings.bg=finalUrl; 
                                    document.getElementById('chat-history').style.backgroundImage = `url(${finalUrl})`;
                                    toast("聊天背景应用成功", "success");
                                }
                                break;
                            case 'send-photo':
                                userSend('image', finalUrl);
                                break;
                            case 'new-persona-avatar':
                                document.getElementById('new-persona-img').src=finalUrl;
                                document.getElementById('new-persona-img').style.display='block';
                                break;
                            default:
                                if (tempImgTarget.startsWith('icon-')) {
                                    const appId = tempImgTarget.replace('icon-','');
                                    if(!store.appIcons) store.appIcons = {};
                                    store.appIcons[appId] = finalUrl;
                                    save();
                                    renderDesktop(); 
                                    renderBeautify(); 
                                    toast("图标已修改", "success");
                                }
                                break;
                        }
                    };

                    // 问题1修复：确保所有图片都经过压缩处理
                    // 修复：图标上传不压缩，避免变白
                    if (tempImgTarget === 'music-file' || tempImgTarget.startsWith('icon-')) {
                        processImage(u);
                    } else {
                        compressImage(u, (compressed) => {
                            processImage(compressed);
                            save(); // 确保保存
                        });
                    }
                };
                
                if (tempImgTarget === 'lyrics-file') {
                    reader.readAsText(file);
                } else {
                    reader.readAsDataURL(file);
                }
            };

            if (tempImgTarget === 'sticker-batch') {
                const targetCateId = document.getElementById('sticker-add-cate-sel').value;
                const cate = store.stickerCategories.find(c => c.id === targetCateId);
                if (!cate) return toast("添加失败: 未找到分类", "error");

                let processed = 0;
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            const maxSize = 400;
                            
                            if (width > height && width > maxSize) {
                                height = (height * maxSize) / width;
                                width = maxSize;
                            } else if (height > maxSize) {
                                width = (width * maxSize) / height;
                                height = maxSize;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            const compressed = canvas.toDataURL('image/jpeg', 0.7);
                            
                            cate.stickers.push({url: compressed, type: 'image'});
                            processed++;
                            
                            if (processed === e.target.files.length) {
                                save();
                                if (activeStickerCateId === targetCateId) renderStickerGallery();
                                toast("表情已添加", "success");
                            }
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });
                document.getElementById('modal-sticker').style.display = 'none';
            } else {
                const file = e.target.files[0];
                if (file) handleFile(file);
            }
        }
        
        function testLink(id, type) {
            const u = document.getElementById(id).value;
            if(!u) return toast("请输入链接");
            if(type==='audio') { const a=new Audio(u); a.onloadedmetadata=()=>toast("有效"); a.onerror=()=>toast("无效"); }
            else { const i=new Image(); i.onload=()=>toast("有效"); i.onerror=()=>toast("无效"); i.src=u; }
        }

        // --- MEMORY SUMMARY SYSTEM ---
        function openMemorySystem() {
            if (!activeChatId) return;
            document.getElementById('layer-memory-system').classList.add('show');
            renderMemorySystem();
            const extMenu = document.getElementById('ext-menu');
            if (extMenu) extMenu.style.display = 'none';
        }

        function renderMemorySystem() {
            const listEl = document.getElementById('memory-list');
            if (!listEl) return;
            
            const summaries = (store.memorySummaries && store.memorySummaries[activeChatId]) ? [...store.memorySummaries[activeChatId]].reverse() : [];
            
            if (summaries.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#999; padding:50px;">暂无记忆总结<br>开启功能后将自动生成</div>';
                return;
            }

            listEl.innerHTML = summaries.map(memo => `
                <div class="list-item">
                    <div class="list-content">
                        <div class="memo-date">${new Date(memo.date).toLocaleString()}</div>
                        <div class="memo-content">${memo.content.replace(/\n/g, '<br>')}</div>
                    </div>
                    <div class="memo-actions">
                        <i class="fas fa-edit" onclick="editMemory('${memo.id}')"></i>
                        <i class="fas fa-trash" onclick="deleteMemory('${memo.id}')"></i>
                    </div>
                </div>
            `).join('');
        }

        async function generateMemorySummary(contactId, source = 'online') {
            if (!contactId) return;
            // toast("正在生成对话总结...", "info"); // Optional: silent update for offline mode? Or keep it.

            let chatHistory = [];
            if (source === 'online') {
                chatHistory = (store.chats[contactId] || []).slice(-30);
            } else {
                chatHistory = (store.offlineChats[contactId] || []).slice(-30);
            }
             
            if (chatHistory.length < 5) return; 

            const historyText = chatHistory.map(m => {
                let senderName = '我';
                if (source === 'online') {
                    senderName = m.sender === 'me' ? '我' : store.contacts.find(c=>c.id===contactId).name;
                } else {
                    // Offline chat format
                    senderName = m.sender === 'user' ? '我' : store.contacts.find(c=>c.id===contactId).name;
                }
                return `${senderName}: ${m.content}`;
            }).join('\n');
            const sysPrompt = `请根据以下对话记录，生成一个简洁、精炼的摘要，捕捉对话的核心要点和情感。摘要应在50-100字之间。`;
            
            try {
                const data = await API.chatCompletion([
                    { role: 'system', content: sysPrompt },
                    { role: 'user', content: historyText }
                ]);
                const summaryText = data.choices[0].message.content;
                
                if (!store.memorySummaries) store.memorySummaries = {};
                if (!store.memorySummaries[contactId]) store.memorySummaries[contactId] = [];

                store.memorySummaries[contactId].push({
                    id: 'memo' + Date.now(),
                    date: Date.now(),
                    content: summaryText
                });
                save();
                toast("对话总结已生成并保存", "success");
                
                // If the memory system is currently open, refresh it
                if (document.getElementById('layer-memory-system').classList.contains('show')) {
                    renderMemorySystem();
                }

            } catch (e) {
                console.error("Failed to generate memory summary:", e);
                toast("总结生成失败", "error");
            }
        }
        
        function addManualMemory(content) {
            if (!activeChatId || !content) return;
            if (!store.memorySummaries) store.memorySummaries = {};
            if (!store.memorySummaries[activeChatId]) store.memorySummaries[activeChatId] = [];

            store.memorySummaries[activeChatId].push({
                id: 'memo' + Date.now(),
                date: Date.now(),
                content: content
            });
            save();
            toast("记忆已添加", "success");
            renderMemorySystem();
        }

        function editMemory(memoId) {
            const memories = store.memorySummaries[activeChatId];
            const memory = memories.find(m => m.id === memoId);
            if (!memory) return;

            editingMemoryId = memoId;
            const modal = document.getElementById('modal-edit-memory');
            document.getElementById('edit-memory-content').value = memory.content;
            modal.style.display = 'flex';
        }
        
        function saveEditedMemory() {
            if (!editingMemoryId) return;
            const memories = store.memorySummaries[activeChatId];
            const memory = memories.find(m => m.id === editingMemoryId);
            if (!memory) return;
            
            const newContent = document.getElementById('edit-memory-content').value.trim();
            if (!newContent) return toast("内容不能为空", "error");
            
            memory.content = newContent;
            save();
            renderMemorySystem();
            
            document.getElementById('modal-edit-memory').style.display = 'none';
            editingMemoryId = null;
            toast("记忆已更新", "success");
        }

        function deleteMemory(memoId) {
            showConfirm("删除记忆", "确定要删除这条记忆吗？", () => {
                let memories = store.memorySummaries[activeChatId];
                if (memories) {
                    store.memorySummaries[activeChatId] = memories.filter(m => m.id !== memoId);
                    save();
                    renderMemorySystem();
                    toast("删除成功");
                }
            });
        }


        // --- NEW FEATURES LOGIC ---

        // --- CSS & Font Customization ---
        function applyCustomCSS(type) {
            const css = document.getElementById(`css-${type}`).value;
            let styleEl = document.getElementById(`custom-style-${type}`);
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = `custom-style-${type}`;
                document.head.appendChild(styleEl);
            }
            styleEl.innerHTML = css;
            
            // Save the applied CSS to localStorage to persist it
            if (!store.customCSS) store.customCSS = {};
            store.customCSS[type] = css;
            save();
            
            toast(`${type === 'bubble' ? '气泡' : '界面'}样式已应用`);
        }

        function saveCSSPreset(type) {
            const css = document.getElementById(`css-${type}`).value;
            if (!css.trim()) return toast("内容为空，无法保存", "error");

            const presetName = prompt("请输入预设名称:");
            if (!presetName || !presetName.trim()) return;

            if (!store.cssPresets) store.cssPresets = { bubble: {}, global: {} };
            if (!store.cssPresets[type]) store.cssPresets[type] = {};
            
            store.cssPresets[type][presetName] = css;
            save();
            
            toast("预设已保存: " + presetName, "success");
            initCSSCustomization(); // Refresh preset selectors
        }

        function loadCSSPreset(type, presetName) {
            if (!presetName) return;
            const css = store.cssPresets?.[type]?.[presetName];
            if (css !== undefined) {
                document.getElementById(`css-${type}`).value = css;
                applyCustomCSS(type);
                toast("已加载预设: " + presetName);
            }
        }
        
        async function applyCustomFont() {
            const url = document.getElementById('font-url-input').value.trim();
            if (!url) return toast("请输入字体URL", "error");

            toast("正在加载字体...", "info");

            const fontName = 'CustomGlobalFont';
            const font = new FontFace(fontName, `url(${url})`);

            try {
                await font.load();
                document.fonts.add(font);
                
                let styleEl = document.getElementById('custom-font-style');
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = 'custom-font-style';
                    document.head.appendChild(styleEl);
                }

                // 使用 * 通配符确保覆盖所有元素
                styleEl.innerHTML = `
                    * {
                        font-family: '${fontName}', -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Arial, sans-serif !important;
                    }
                    /* 保持图标字体不被覆盖 */
                    .fas, .far, .fab, .fa {
                        font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;
                    }
                `;

                if (!store.customFont) store.customFont = {};
                store.customFont.url = url;
                save();

                toast("字体应用成功!", "success");
            } catch (e) {
                console.error("Font load error:", e);
                toast("字体加载失败，可能是链接无效或存在跨域(CORS)限制。", "error");
            }
        }

        function initCSSCustomization() {
            // 1. Load and apply saved custom CSS on startup
            if (store.customCSS) {
                if (store.customCSS.bubble) {
                    document.getElementById('css-bubble').value = store.customCSS.bubble;
                    applyCustomCSS('bubble');
                }
                if (store.customCSS.global) {
                    document.getElementById('css-global').value = store.customCSS.global;
                    applyCustomCSS('global');
                }
            }

            // 2. Load and apply saved custom font on startup
            if (store.customFont && store.customFont.url) {
                 document.getElementById('font-url-input').value = store.customFont.url;
                 applyCustomFont();
            }

            // 3. Populate preset selectors
            if (!store.cssPresets) store.cssPresets = { bubble: {}, global: {} };
            const bubbleSelector = document.getElementById('preset-selector-bubble');
            const globalSelector = document.getElementById('preset-selector-global');
            
            bubbleSelector.innerHTML = '<option value="">选择预设</option>';
            for (const name in (store.cssPresets.bubble || {})) {
                bubbleSelector.innerHTML += `<option value="${name}">${name}</option>`;
            }

            globalSelector.innerHTML = '<option value="">选择预设</option>';
            for (const name in (store.cssPresets.global || {})) {
                globalSelector.innerHTML += `<option value="${name}">${name}</option>`;
            }

            // 4. Set default CSS templates
            if (!document.getElementById('css-bubble').value) {
                document.getElementById('css-bubble').value = `/* --- 高级气泡CSS美化全集 --- */

/* 1. 基础布局调整 */
.msg-row {
  margin-bottom: 15px; /* 增加消息间距 */
  align-items: flex-end; /* 头像底部对齐 */
}

/* 2. 头像样式 */
.avatar {
  border-radius: 12px !important; /* 方圆角头像 */
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.avatar:active {
  transform: scale(0.95);
}

/* 3. 气泡通用样式 */
.bubble {
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  border: none !important;
  position: relative;
  transition: all 0.2s;
  max-width: 260px !important; /* 限制最大宽度 */
}

/* 4. 对方(AI) 气泡 - 白底风格 */
.msg-row:not(.me) .bubble {
  background: #ffffff;
  color: #333;
  border-radius: 2px 18px 18px 18px; /* 特殊圆角: 左上尖角 */
  margin-left: 5px;
}
/* 对方气泡小三角 (伪元素实现) */
.msg-row:not(.me) .bubble::before {
  content: '';
  position: absolute;
  left: -6px; top: 0;
  border-right: 6px solid #ffffff;
  border-top: 6px solid transparent;
  border-bottom: 6px solid transparent;
}

/* 5. 我(User) 气泡 - 渐变风格 */
.msg-row.me .bubble {
  background: linear-gradient(135deg, #07c160, #10ad58);
  color: white;
  border-radius: 18px 2px 18px 18px; /* 特殊圆角: 右上尖角 */
  margin-right: 5px;
}
/* 我方气泡小三角 */
.msg-row.me .bubble::after {
  content: '';
  position: absolute;
  right: -6px; top: 0;
  border-left: 6px solid #07c160;
  border-top: 6px solid transparent;
  border-bottom: 6px solid transparent;
}

/* 6. 图片消息样式 */
.bubble img {
  border-radius: 8px !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
/* 去除图片气泡的背景和内边距 */
.msg-row:not(.me) .bubble:has(img),
.msg-row.me .bubble:has(img) {
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}
/* 隐藏图片气泡的小三角 */
.bubble:has(img)::before,
.bubble:has(img)::after {
  display: none !important;
}

/* 7. 语音消息样式 */
.bubble.voice {
  display: flex;
  align-items: center;
  min-width: 80px;
  cursor: pointer;
}
.bubble.voice i {
  font-size: 14px;
}
.msg-row:not(.me) .bubble.voice i { color: #555; margin-right: 8px; }
.msg-row.me .bubble.voice { flex-direction: row-reverse; }
.msg-row.me .bubble.voice i { color: #fff; margin-left: 8px; margin-right:0; }

/* 8. 转账/红包消息样式 */
.bubble-transfer {
  background: #fa9d3b !important; /* 橙色背景 */
  border-radius: 12px !important;
  color: white !important;
  width: 240px !important;
  overflow: hidden;
}
.bubble-transfer .transfer-top {
  padding: 15px;
  background: transparent;
}
.bubble-transfer .transfer-icon {
  border: 2px solid rgba(255,255,255,0.8);
}
.bubble-transfer .transfer-bottom {
  background: rgba(255,255,255,0.15); /* 半透明底部 */
  color: rgba(255,255,255,0.9);
  border-top: none;
}
/* 已收款/退回状态 */
.bubble-transfer.done {
  background: #f7e2c5 !important; /* 变浅 */
  opacity: 1;
}
.bubble-transfer.done .transfer-bottom {
  color: #999;
  background: #fff;
}

/* 9. 地理位置消息 */
.bubble-location {
  border-radius: 12px;
  border: 1px solid #eee;
}
.bubble-location .loc-info {
  background: #fff;
}
.bubble-location .loc-name {
  font-weight: bold;
}

/* 10. 撤回消息样式 */
.bubble.recalled {
  background: transparent !important;
  box-shadow: none !important;
  color: #999 !important;
  font-size: 12px !important;
  padding: 5px 0 !important;
  text-align: center;
  width: 100%;
  max-width: 100% !important;
}
.msg-row:has(.recalled) {
  justify-content: center; /* 让撤回消息居中 */
}
/* 隐藏撤回消息的头像 (可选) */
.msg-row:has(.recalled) .avatar {
  display: none;
}

/* 11. 引用消息预览框 (输入栏上方) */
.quote-preview {
  background: #f1f1f1;
  border-radius: 8px;
  border-left: 4px solid #07c160;
  color: #666;
  font-size: 13px;
  margin: 0 10px 10px 10px;
}
/* 12. 气泡内引用样式 */
.bubble-quote {
  margin-bottom: 5px;
  padding: 6px 8px;
  background: rgba(0,0,0,0.05);
  border-left: 3px solid rgba(0,0,0,0.2);
  font-size: 12px;
  color: inherit;
  opacity: 0.8;
  border-radius: 4px;
  white-space: pre-wrap;
  display: block;
}
`;
            }
            if (!document.getElementById('css-global').value) {
                document.getElementById('css-global').value = `/* --- 高级全局UI主题模板 --- */

/* 1. 核心变量覆盖 */
:root {
  --primary: #5856D6 !important; /* iOS 紫色主题 */
  --bg-grey: #f2f2f7 !important;
  --text-main: #000000 !important;
  --text-sub: #8e8e93 !important;
  --radius-box: 18px !important; /* 更大的圆角 */
  --radius-btn: 12px !important;
}

/* 2. 背景与毛玻璃效果 */
body {
  background-color: #000;
}
#device {
  background-color: #fff;
}
/* 导航栏毛玻璃 */
.nav-bar {
  background: rgba(255, 255, 255, 0.85) !important;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
  position: sticky; top: 0; /* 确保吸顶 */
}
.nav-title {
  font-weight: 700 !important;
  letter-spacing: -0.5px;
}

/* 3. 列表项美化 (联系人/设置) */
.list-item, .form-cell {
  background: #fff;
  transition: background 0.2s;
}
.list-item:active, .form-cell:active {
  background: #f2f2f7 !important;
}
/* 分组圆角效果 (类似iOS设置) */
.group-box {
  border-radius: 12px !important;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.02);
  margin: 15px !important;
}
/* 去除最后一条分割线 */
.list-item:last-child, .form-cell:last-child {
  border-bottom: none !important;
}

/* 4. 输入栏美化 */
.input-bar {
  background: rgba(249, 249, 249, 0.95) !important;
  backdrop-filter: blur(10px);
  border-top: 0.5px solid rgba(0,0,0,0.1) !important;
  padding-bottom: 34px !important; /* 适配 iPhone 底部条 */
}
.input-field {
  background: #fff !important;
  border: 1px solid #e5e5ea !important;
  border-radius: 20px !important;
  padding-left: 15px !important;
  box-shadow: 0 1px 4px rgba(0,0,0,0.03);
}
.btn-send {
  background: var(--primary) !important;
  border-radius: 50% !important;
  width: 36px; height: 36px;
  font-size: 13px;
  display: flex; justify-content: center; align-items: center;
  padding: 0 !important;
  box-shadow: 0 2px 6px rgba(88, 86, 214, 0.4);
}

/* 5. 底部标签栏 (微信式) */
.wx-tab-bar {
  background: rgba(247, 247, 247, 0.95) !important;
  backdrop-filter: blur(10px);
  border-top: 0.5px solid rgba(0,0,0,0.1) !important;
  padding-bottom: 20px !important; /* 适配底部条 */
  height: 70px !important;
}
.nav-tab.active {
  color: var(--primary) !important;
}

/* 6. 弹窗与模态框 */
.modal-box {
  border-radius: 24px !important;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
  transform: scale(1);
  animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes modalPop {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* 7. 按钮通用样式 */
.full-btn {
  border-radius: 12px !important;
  font-weight: 600 !important;
  background: var(--primary) !important;
  box-shadow: 0 4px 12px rgba(88, 86, 214, 0.3);
  transition: transform 0.1s;
}
.full-btn:active {
  transform: scale(0.98);
}
`;
            }
        }

        // Offline Mode
        let offlineSettings = {
            mode: 'page',
            minWords: 300,
            maxWords: 1000,
            style: '故事化',
            aiName: 'AI助手',
            aiAvatar: '',
            userPerspective: '第一人称',
            aiPerspective: '第三人称'
        };

        function showOfflineModeChoice() {
            if (!activeChatId) return toast("无效的聊天上下文", "error");
            document.getElementById('modal-offline-choice').style.display = 'flex';
            const extMenu = document.getElementById('ext-menu');
            if (extMenu) extMenu.style.display = 'none';
        }

        function chooseOfflineMode(mode) {
            document.getElementById('modal-offline-choice').style.display = 'none';
            offlineContactId = activeChatId;
            const contact = store.contacts.find(c => c.id === offlineContactId);
            
            // Init avatars and names
            offlineSettings.aiName = contact.name;
            offlineSettings.aiAvatar = contact.avatar || `https://ui-avatars.com/api/?name=${contact.name[0]}`;
            
            if (mode === 'page') {
                // Enter Independent Page Mode
                const layer = document.getElementById('layer-offline-mode');
                // document.getElementById('offline-title').innerText = `${contact.name} - 线下模式`;
                document.getElementById('offline-user-avatar').src = store.user.avatar || 'https://via.placeholder.com/50';
                document.getElementById('offline-ai-avatar').src = contact.avatar || 'https://via.placeholder.com/50';
                
                layer.classList.add('show');
                startOfflineSimulation(false); // Start Sim
                renderOfflineChat();
            } else {
                // 问题1修复：进入私聊线下模式时，隐藏“生成”按钮
                document.querySelector('.btn-gen').style.display = 'none';
                // Enter Chat Embedded Mode
                isOfflineInChat = true;
                
                // Modify Chat Layer Header
                document.getElementById('chat-nav-bar').style.display = 'none';
                document.getElementById('chat-offline-header').style.display = 'block';
                
                // Init Header Info
                document.getElementById('chat-offline-user-avatar').src = store.user.avatar || 'https://via.placeholder.com/50';
                document.getElementById('chat-offline-ai-avatar').src = contact.avatar || 'https://via.placeholder.com/50';
                
                startOfflineSimulation(true); // Start Sim linked to chat header
                toast("已进入私聊线下模式");
            }
        }

        function exitOfflineInChat() {
            isOfflineInChat = false;
            document.getElementById('chat-offline-header').style.display = 'none';
            document.getElementById('chat-nav-bar').style.display = 'flex';
            document.querySelector('.btn-gen').style.display = 'block'; // 恢复“生成”按钮
            stopOfflineSimulation();
            toast("已退出线下模式");
        }

        function openOfflineSettings() {
            // document.getElementById('offline-mode-type').value = offlineSettings.mode; // Removed from modal per request? No, keep logic just in case
            document.getElementById('offline-min-words').value = offlineSettings.minWords;
            document.getElementById('offline-max-words').value = offlineSettings.maxWords;
            document.getElementById('offline-style').value = offlineSettings.style;
            document.getElementById('offline-user-persp').value = offlineSettings.userPerspective || '第一人称';
            document.getElementById('offline-ai-persp').value = offlineSettings.aiPerspective || '第三人称';
            document.getElementById('modal-offline-settings').style.display = 'flex';
        }

        function saveOfflineSettings() {
            // offlineSettings.mode = document.getElementById('offline-mode-type').value;
            offlineSettings.minWords = parseInt(document.getElementById('offline-min-words').value) || 300;
            offlineSettings.maxWords = parseInt(document.getElementById('offline-max-words').value) || 1000;
            offlineSettings.style = document.getElementById('offline-style').value;
            offlineSettings.userPerspective = document.getElementById('offline-user-persp').value;
            offlineSettings.aiPerspective = document.getElementById('offline-ai-persp').value;
            document.getElementById('modal-offline-settings').style.display = 'none';
            toast('设置已保存');
        }
        
        function renderOfflineChat() {
            const historyContainer = document.getElementById('offline-chat-history');
            if (!historyContainer) return;
            historyContainer.innerHTML = '';
            const chatHistory = (store.offlineChats && store.offlineChats[offlineContactId]) ? store.offlineChats[offlineContactId] : [];

            chatHistory.forEach((msg, index) => {
                const isUser = msg.sender === 'user';
                const now = new Date(msg.time);
                const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
                
                const senderName = isUser ? store.user.name : offlineSettings.aiName;
                const senderAvatar = isUser ? (store.user.avatar || `https://ui-avatars.com/api/?name=${store.user.name[0]}`) : offlineSettings.aiAvatar;

                // Process Content for Layout Rules & Highlights
                const len = msg.content.length;
                let bodyClass = 'offline-msg-body';
                let processedContent = msg.content;
                
                if (len < 30) {
                    bodyClass += ' short-text';
                } else if (len > 100) {
                    bodyClass += ' offline-long-text';
                    // Attempt visual centering of first line via a wrapper span (CSS limitation workaround)
                    const lines = processedContent.split('\n');
                    if(lines.length > 0) {
                        lines[0] = `<div style="text-align:center; margin-bottom:10px;">${lines[0]}</div>`;
                        processedContent = lines.join('\n');
                    }
                }
                
                // Highlight important parts (Basic heuristic: Text inside 【】 or ** **)
                processedContent = processedContent
                    .replace(/【(.*?)】/g, '<span class="offline-highlight">$1</span>')
                    .replace(/\*\*(.*?)\*\*/g, '<span class="offline-highlight">$1</span>');

                const box = document.createElement('div');
                box.className = 'offline-msg-box';
                box.innerHTML = `
                    <div class="offline-msg-header ${isUser ? 'user' : ''}">
                        <button class="offline-delete-btn" onclick="deleteOfflineMessage(${index})" title="删除消息">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="offline-sender">
                            <img src="${senderAvatar}" class="avatar">
                            <span>${senderName}</span>
                        </div>
                        <div class="offline-meta">
                            <span>${timeStr}</span>
                            <i class="fas fa-edit edit-icon" onclick="editOfflineMessage(${index})"></i>
                        </div>
                    </div>
                    <div class="${bodyClass}" id="offline-msg-body-${index}">
                        ${processedContent.replace(/\n/g, '<br>')}
                    </div>
                `;
                historyContainer.appendChild(box);
            });

            historyContainer.scrollTop = historyContainer.scrollHeight;
        }

        // Offline Simulation Logic (Heart Rate & Distance)
        let offlineSimInterval = null;
        let isSimulatingInChat = false;
        
        function startOfflineSimulation(inChat) {
            isSimulatingInChat = inChat;
            if(offlineSimInterval) clearInterval(offlineSimInterval);
            
            // Initial update
            updateOfflineSim();
            
            offlineSimInterval = setInterval(() => {
                updateOfflineSim();
            }, 3000); // Only update heart rate regularly
        }
        
        function stopOfflineSimulation() {
            if(offlineSimInterval) clearInterval(offlineSimInterval);
        }
        
        function updateOfflineSim() {
            const userHR = 70 + Math.floor(Math.random() * 20); // 70-90
            const aiHR = 72 + Math.floor(Math.random() * 20); // 72-92
            
            // Update UI elements based on current mode
            const prefix = isSimulatingInChat ? 'chat-offline-' : 'offline-';
            
            const uHrEl = document.getElementById(prefix + 'user-hr');
            const aHrEl = document.getElementById(prefix + 'ai-hr');
            
            if(uHrEl) uHrEl.innerText = userHR;
            if(aHrEl) aHrEl.innerText = aiHR;
            
            // Distance is NOT random anymore, only updated by AI reply
        }

        function sendOfflineMessage() {
            const input = document.getElementById('offline-chat-input');
            const text = input.value.trim();
            if (!text || !offlineContactId) return;

            if (!store.offlineChats) store.offlineChats = {};
            if (!store.offlineChats[offlineContactId]) store.offlineChats[offlineContactId] = [];

            store.offlineChats[offlineContactId].push({ sender: 'user', content: text, time: Date.now() });
            
            // Add a placeholder for AI response
            store.offlineChats[offlineContactId].push({ sender: 'ai', content: '正在生成中...', time: Date.now() });
            save();
            renderOfflineChat();
            
            input.value = '';

            // Call AI generation
            generateOfflineReply(text);
        }

        async function generateOfflineReplyInChat(userInput) {
            let responseText = await getOfflineTextFromAI(userInput, true);
            removeLoadingBubble();

            // Dynamic Data Parsing from response
            const statusMatch = responseText.match(/\[STATUS:Dist=(.*?)\|HR=(.*?)\]/);
            if (statusMatch) {
                const dist = statusMatch[1].replace('m','').trim();
                const hr = statusMatch[2].replace('bpm','').trim();
                
                document.getElementById('chat-offline-distance').innerText = dist;
                document.getElementById('chat-offline-ai-hr').innerText = hr;
                
                responseText = responseText.replace(statusMatch[0], '').trim();
            }
            
            const msgObj = { sender: 'ai', type: 'text', content: responseText, time: Date.now() };
            store.chats[activeChatId].push(msgObj);
            save();
            renderHistory();
        }

        async function generateOfflineReply(userInput, isChatMode = false) {
            let historyList = [];
            if (isChatMode) {
                // In chat mode, we use store.chats
                historyList = store.chats[offlineContactId];
            } else {
                // In independent page mode, we use store.offlineChats
                if (!store.offlineChats) store.offlineChats = {};
                historyList = store.offlineChats[offlineContactId];
            }
            
            if(!historyList) historyList = []; // Safety

            if(!store.system.key) {
                const lastMsg = historyList[historyList.length - 1];
                if(lastMsg) lastMsg.content = "错误：请先配置API Key";
                save();
                if(isChatMode) renderHistory(); else renderOfflineChat();
                return;
            }
            
            let responseText = await getOfflineTextFromAI(userInput, isChatMode);
            
            // Dynamic Data Parsing (Dist & HR)
            // Format: [STATUS:Dist=X|HR=Y]
            const statusMatch = responseText.match(/\[STATUS:Dist=(.*?)\|HR=(.*?)\]/);
            if (statusMatch) {
                const dist = statusMatch[1].replace('m','').trim();
                const hr = statusMatch[2].replace('bpm','').trim();
                
                const prefix = isChatMode ? 'chat-offline-' : 'offline-';
                const distEl = document.getElementById(prefix + 'distance');
                const hrEl = document.getElementById(prefix + 'ai-hr');
                if(distEl) distEl.innerText = dist;
                if(hrEl) hrEl.innerText = hr;
                
                // Remove status tag from content
                responseText = responseText.replace(statusMatch[0], '').trim();
            }
            
            const lastMsg = historyList[historyList.length - 1];
            if (lastMsg && lastMsg.sender === 'ai') {
                lastMsg.content = responseText;
                save();
                if(isChatMode) renderHistory(); else renderOfflineChat();
            }
        }
        
        async function getOfflineTextFromAI(userInput, isChatMode) {
             try {
                let systemContent;
                const messages = [];
                const contact = store.contacts.find(c => c.id === offlineContactId);

                if (contact) {
                    // Add Worldbook context
                    let worldBookContent = 'None';
                    if (contact.settings?.mountedWbIds && Array.isArray(contact.settings.mountedWbIds)) {
                        const mountedBooks = store.worldbooks.filter(wb => contact.settings.mountedWbIds.includes(wb.id));
                        if (mountedBooks.length > 0) {
                            worldBookContent = mountedBooks.map(wb => `[${wb.name}]:\n${wb.content}`).join('\n\n');
                        }
                    }

                    // Perspective Settings
                    const uPersp = offlineSettings.userPerspective || '第一人称';
                    const aPersp = offlineSettings.aiPerspective || '第三人称';

                    // Context-aware prompt
                    systemContent = `You are ${contact.name}. Persona: ${contact.persona}. World Book context: ${worldBookContent}.
                    User has sent you a message: "${userInput}".
                    
                    SETTINGS:
                    - User Perspective: ${uPersp}
                    - Your Perspective: ${aPersp}
                    
                    MANDATORY: You must generate status data based on the current scenario at the very beginning of your reply.
                    Format: [STATUS:Dist=X|HR=Y]
                    - Dist: Distance in meters based on scenario. Only change this if the scenario implies movement.
                    - HR: Your current heart rate.
                    
                    Then, based on input and history, write a long-form text (300-1000 words) in "${offlineSettings.style}" style.
                    Use the specified perspectives.
                    The output should be pure text without markdown formatting (except the STATUS tag at start).`;
                    
                    messages.push({ role: "system", content: systemContent });
                    
                    // Add past chat history for context
                    // Use the correct history source
                    const sourceHistory = isChatMode ? store.chats[offlineContactId] : store.offlineChats[offlineContactId];
                    const history = (sourceHistory || []).slice(-10);
                    
                    history.forEach(m => {
                        let role = 'user';
                        if (isChatMode) {
                            role = m.sender === 'me' ? 'user' : 'assistant';
                        } else {
                            role = m.sender === 'user' ? 'user' : 'assistant';
                        }
                        messages.push({ role: role, content: getMsgText(m) });
                    });
                } else {
                    systemContent = "System Error: Contact not found.";
                    messages.push({ role: "system", content: systemContent });
                }

                // Add the latest user input
                messages.push({ role: "user", content: userInput });

                const data = await API.chatCompletion(messages);
                if (!data || !data.choices || data.choices.length === 0) {
                    throw new Error("Invalid API response");
                }
                return data.choices[0].message.content;
             } catch(e) {
                console.error("getOfflineTextFromAI error", e);
                return "生成失败: " + e.message;
             }
        }

        function regenerateOfflineReply() {
            const currentOfflineChat = store.offlineChats[offlineContactId] || [];
            if (currentOfflineChat.length < 2) return toast('没有可重新生成的内容');
            
            const lastUserMsg = currentOfflineChat.slice().reverse().find(m => m.sender === 'user');
            if (!lastUserMsg) return toast('找不到上一条用户消息');

            const lastAiMsgIndex = currentOfflineChat.length - 1;
            const lastAiMsg = currentOfflineChat[lastAiMsgIndex];
            if (lastAiMsg.sender !== 'ai') return toast('最后一条消息不是AI回复');

            lastAiMsg.content = '正在重新生成...';
            save();
            renderOfflineChat();

            generateOfflineReply(lastUserMsg.content);
        }

        function editOfflineMessage(index) {
            const currentOfflineChat = store.offlineChats[offlineContactId] || [];
            const msg = currentOfflineChat[index];
            if (!msg) return;
            const bodyEl = document.getElementById(`offline-msg-body-${index}`);
            const headerEl = bodyEl.previousElementSibling;
            const editIcon = headerEl.querySelector('.edit-icon');

            if (bodyEl.isContentEditable) {
                // Currently in edit mode, so save changes
                const newContent = bodyEl.innerText.trim();
                bodyEl.contentEditable = false;
                bodyEl.style.backgroundColor = 'transparent';
                bodyEl.style.border = 'none';
                bodyEl.style.padding = '15px';
                bodyEl.innerHTML = newContent.replace(/\n/g, '<br>');

                editIcon.className = 'fas fa-edit edit-icon';

                if (msg.content !== newContent) {
                    msg.content = newContent;
                    save();
                    
                    // 修复：编辑后覆盖下一条AI消息而不是生成新的
                    if (msg.sender === 'user') {
                        const nextAiMsgIndex = currentOfflineChat.findIndex((m, i) => i > index && m.sender === 'ai');
                        if (nextAiMsgIndex > -1) {
                            const aiMsg = currentOfflineChat[nextAiMsgIndex];
                            aiMsg.content = '正在根据修改重新生成...';
                            renderOfflineChat();
                            // 传递目标索引，让生成函数覆盖而不是添加
                            generateOfflineReply(newContent, false, nextAiMsgIndex);
                        } else {
                           renderOfflineChat();
                        }
                    } else {
                       renderOfflineChat();
                    }
                }
            } else {
                // Enter edit mode
                bodyEl.contentEditable = true;
                bodyEl.innerHTML = bodyEl.innerHTML.replace(/<br\s*\/?>/gi, '\n');
                bodyEl.style.backgroundColor = '#fff';
                bodyEl.style.border = '1px solid var(--primary)';
                bodyEl.style.borderRadius = '6px';
                bodyEl.style.padding = '14px';
                bodyEl.focus();
                
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(bodyEl);
                selection.removeAllRanges();
                selection.addRange(range);
                
                editIcon.className = 'fas fa-save edit-icon';
            }
        }

        function deleteOfflineMessage(index) {
            const currentOfflineChat = store.offlineChats[offlineContactId] || [];
            if (!currentOfflineChat[index]) return;
            
            // 使用自定义确认弹窗
            showConfirm("删除消息", "确定要删除这条消息吗？此操作不可恢复。", () => {
                // 真实删除：从数组中移除
                currentOfflineChat.splice(index, 1);
                save();
                renderOfflineChat();
                toast("消息已删除", "success");
            });
        }

        // Moments AI Interaction
        function toggleAiMomentInteraction(enabled) {
            store.user.aiMomentInteraction = enabled;
            save();
            toast('朋友圈AI互评已' + (enabled ? '开启' : '关闭'));
        }

        // --- CLEAR RECORDS LOGIC ---
        function openClearRecordsModal() {
            if (!activeChatId) return toast("无效的会话");
            document.getElementById('chk-clear-chat').checked = true;
            document.getElementById('chk-clear-memory').checked = false;
            document.getElementById('modal-clear-records').style.display = 'flex';
        }

        function confirmClearRecordsSelection() {
            const clearChat = document.getElementById('chk-clear-chat').checked;
            const clearMemory = document.getElementById('chk-clear-memory').checked;

            if (!clearChat && !clearMemory) {
                return toast("请至少选择一项要清除的内容");
            }

            let msg = "确定要清除";
            if (clearChat) msg += " [聊天记录]";
            if (clearMemory) msg += " [记忆数据]";
            msg += " 吗？此操作不可恢复。";

            document.getElementById('modal-clear-records').style.display = 'none';
            
            showConfirm("确认清除", msg, () => {
                executeClearRecords(clearChat, clearMemory);
            });
        }

        function executeClearRecords(deleteChat, deleteMemory) {
            if (!activeChatId) return;
            
            if (deleteChat) {
                if (store.chats[activeChatId]) {
                    store.chats[activeChatId] = [];
                }
            }
            
            if (deleteMemory) {
                if (store.memorySummaries && store.memorySummaries[activeChatId]) {
                    delete store.memorySummaries[activeChatId];
                }
            }
            
            save();
            toast("清除成功", "success");
            renderHistory();
            renderMemorySystem();
        }

        // --- INIT ---
        // Bind slider event
        document.getElementById('sys-temp').addEventListener('input', function() {
            document.getElementById('sys-temp-val').textContent = this.value;
        });

        // Start the async initialization process
        initStore();
        
        // Time Loop
        setInterval(() => {
            const now = new Date();
            // Update status bar clock
            document.getElementById('clock').innerText = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            // Update new desktop clock if visible
            const desktopTimeEl = document.getElementById('desktop-time-val');
            const desktopDateEl = document.getElementById('desktop-date-val');
            const perception = store.perception;
            
            if (desktopTimeEl && desktopDateEl) {
                if (perception.master && perception.customTime && perception.timeVal) {
                    desktopTimeEl.innerText = perception.timeVal;
                } else {
                    desktopTimeEl.innerText = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                }
                 if (perception.master && perception.customDate && perception.dateVal) {
                    const d = new Date(perception.dateVal + 'T00:00:00'); // Ensure it's parsed as local time
                    desktopDateEl.innerText = `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日 ${['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][d.getDay()]}`;
                } else {
                    desktopDateEl.innerText = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日 ${['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][now.getDay()]}`;
                }
            }

        }, 1000);

        // --- iOS/Mobile Viewport Height Fix ---
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            document.body.style.height = 'calc(var(--vh, 1vh) * 100)';
            const device = document.getElementById('device');
            if(device) device.style.height = 'calc(var(--vh, 1vh) * 100)';
        }
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', () => { setTimeout(setViewportHeight, 100); });
        setViewportHeight(); // Set on initial load

        // 问题3修复: 实现悬浮球拖动
        const floatBall = document.getElementById('listen-float-ball');
        let isDragging = false;
        let wasDragged = false; // Flag to distinguish drag from click
        let offsetX, offsetY;

        const handleDragStart = (e) => {
            if (e.target.closest('.float-ball-hover-info')) return;
            isDragging = true;
            wasDragged = false;
            floatBall.style.transition = 'none';
            const touch = e.type === 'touchstart' ? e.touches[0] : e;
            offsetX = touch.clientX - floatBall.getBoundingClientRect().left;
            offsetY = touch.clientY - floatBall.getBoundingClientRect().top;
            if (e.type === 'touchstart') e.preventDefault();
        };

        const handleDragMove = (e) => {
            if (!isDragging) return;
            wasDragged = true;
            if (e.type === 'touchmove') e.preventDefault();
            const touch = e.type === 'touchmove' ? e.touches[0] : e;
            let x = touch.clientX - offsetX;
            let y = touch.clientY - offsetY;

            const maxX = window.innerWidth - floatBall.offsetWidth;
            const maxY = window.innerHeight - floatBall.offsetHeight;

            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));

            floatBall.style.left = x + 'px';
            floatBall.style.top = y + 'px';
            // Important: Remove right property to allow left to take control
            floatBall.style.right = 'auto'; 
        };

        const handleDragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            floatBall.style.transition = 'left 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), top 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
            
            // Snap to nearest edge
            const finalPos = floatBall.getBoundingClientRect();
            if (finalPos.left + (finalPos.width / 2) < window.innerWidth / 2) {
                floatBall.style.left = '0px';
            } else {
                floatBall.style.left = (window.innerWidth - finalPos.width) + 'px';
            }
        };

        // Override the onclick with a click handler that checks wasDragged flag
        floatBall.addEventListener('click', (e) => {
            if(wasDragged) {
                e.preventDefault();
                e.stopPropagation();
            } else {
                maximizeListenPlayer();
            }
        }, true); // Use capture phase

        floatBall.addEventListener('mousedown', handleDragStart);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);

        floatBall.addEventListener('touchstart', handleDragStart, { passive: false });
        document.addEventListener('touchmove', handleDragMove, { passive: false });
        document.addEventListener('touchend', handleDragEnd);

    </script>
</body>
</html>
